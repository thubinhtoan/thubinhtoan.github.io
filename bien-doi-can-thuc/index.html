<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huy·ªÅn Tho·∫°i T√°i Sinh - To√°n 9 B√†i 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
            user-select: none;
        }

        .title-font {
            font-family: 'Cinzel', serif;
        }

        /* --- Game World Visuals --- */
        #world-container {
            position: relative;
            height: 300px;
            width: 100%;
            background: linear-gradient(to bottom, #1e293b, #0f172a); /* Dark/Dead world start */
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 1.5s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* Classes for world states */
        .world-stage-1 { background: linear-gradient(to bottom, #3b3028, #1c1917); } /* Barren */
        .world-stage-2 { background: linear-gradient(to bottom, #78350f, #451a03); } /* Earth awakening */
        .world-stage-3 { background: linear-gradient(to bottom, #14532d, #064e3b); } /* Grass growing */
        .world-stage-4 { background: linear-gradient(to bottom, #0ea5e9, #10b981); } /* Water & Life */
        .world-stage-5 { background: linear-gradient(to bottom, #f59e0b, #ec4899, #8b5cf6); } /* Magic/Phoenix */

        .world-element {
            position: absolute;
            transition: all 1s ease-out;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            filter: grayscale(100%);
        }

        .world-element.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: grayscale(0%);
        }

        /* Elements positioning */
        #tree-1 { bottom: 20px; left: 10%; font-size: 4rem; }
        #tree-2 { bottom: 20px; right: 15%; font-size: 5rem; }
        #river { bottom: 0; width: 100%; height: 40px; background: #3b82f6; opacity: 0; transition: opacity 2s; }
        #flower-1 { bottom: 30px; left: 30%; font-size: 2rem; }
        #flower-2 { bottom: 25px; right: 40%; font-size: 2rem; }
        #phoenix { 
            top: 20%; left: 50%; transform: translateX(-50%) scale(0); 
            font-size: 8rem; 
            transition: all 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 30px #f59e0b;
        }
        #phoenix.active { transform: translateX(-50%) scale(1); }

        /* --- UI Components --- */
        .btn-answer {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #475569;
            backdrop-filter: blur(5px);
            transition: all 0.2s;
        }
        .btn-answer:hover {
            background: rgba(51, 65, 85, 0.9);
            border-color: #94a3b8;
            transform: translateY(-2px);
        }
        .btn-answer:active { transform: scale(0.98); }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.4s; background-color: #ef4444 !important; border-color: #b91c1c !important; }

        .correct-anim {
            background-color: #22c55e !important;
            border-color: #15803d !important;
            box-shadow: 0 0 15px #22c55e;
        }

        /* Math Display Enhancement */
        .math-text {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.1em;
        }
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        .fraction > span {
            display: block;
            padding: 0 2px;
        }
        .fraction span.numerator { border-bottom: 1px solid currentColor; }
        .fraction span.denominator { border-top: 1px solid transparent; }
        
        /* Feedback Overlay */
        #feedback-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
        .feedback-item {
            font-size: 6rem;
            opacity: 0;
            transform: scale(0);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .feedback-item.show { opacity: 1; transform: scale(1); }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4">

    <!-- Start Screen -->
    <div id="start-screen" class="w-full max-w-4xl bg-slate-900 border-4 border-slate-700 rounded-3xl p-8 text-center shadow-2xl z-10">
        <h1 class="title-font text-5xl md:text-7xl text-yellow-500 mb-2 text-shadow">Huy·ªÅn Tho·∫°i T√°i Sinh</h1>
        <h2 class="text-2xl text-cyan-400 mb-6 font-bold">Chinh Ph·ª•c Bi·∫øn ƒê·ªïi CƒÉn Th·ª©c</h2>
        
        <p class="text-lg text-slate-300 mb-8 leading-relaxed max-w-2xl mx-auto">
            V√πng ƒë·∫•t n√†y ƒë√£ b·ªã l√£ng qu√™n. Ch·ªâ c√≥ tr√≠ tu·ªá c·ªßa b·∫°n m·ªõi c√≥ th·ªÉ kh√¥i ph·ª•c s·ª± s·ªëng.
            H√£y tr·∫£ l·ªùi ƒë√∫ng 15 c√¢u h·ªèi v·ªÅ <span class="text-yellow-300">Bi·∫øn ƒë·ªïi bi·ªÉu th·ª©c ch·ª©a cƒÉn th·ª©c b·∫≠c hai</span> ƒë·ªÉ ƒë√°nh th·ª©c Ph∆∞·ª£ng Ho√†ng Huy·ªÅn Tho·∫°i!
        </p>

        <div class="grid grid-cols-2 gap-4 text-left max-w-lg mx-auto bg-slate-800 p-4 rounded-xl mb-8 border border-slate-700">
            <div class="flex items-center gap-2"><span class="text-green-400 text-xl">‚óè</span> 6 C√¢u Nh·∫≠n Bi·∫øt</div>
            <div class="flex items-center gap-2"><span class="text-blue-400 text-xl">‚óè</span> 5 C√¢u Th√¥ng Hi·ªÉu</div>
            <div class="flex items-center gap-2"><span class="text-purple-400 text-xl">‚óè</span> 3 C√¢u V·∫≠n D·ª•ng</div>
            <div class="flex items-center gap-2"><span class="text-red-400 text-xl">‚óè</span> 1 C√¢u V·∫≠n D·ª•ng Cao</div>
        </div>

        <button onclick="startGame()" class="group relative px-8 py-4 bg-yellow-600 hover:bg-yellow-500 text-white font-bold text-2xl rounded-xl transition-all hover:scale-105 shadow-[0_0_20px_rgba(234,179,8,0.5)]">
            <span class="relative z-10">B·∫Øt ƒê·∫ßu H√†nh Tr√¨nh</span>
            <div class="absolute inset-0 h-full w-full bg-yellow-400 rounded-xl blur opacity-0 group-hover:opacity-30 transition duration-200"></div>
        </button>
    </div>

    <!-- Game Interface -->
    <div id="game-screen" class="hidden w-full max-w-3xl flex-col">
        <!-- Visual World -->
        <div id="world-container">
            <div id="river" class="world-element"></div>
            <div id="tree-1" class="world-element">üå≥</div>
            <div id="tree-2" class="world-element">üå≤</div>
            <div id="flower-1" class="world-element">üåª</div>
            <div id="flower-2" class="world-element">üå∑</div>
            <div id="phoenix" class="world-element floating">ü¶Ö</div> <!-- Using Eagle emoji as Phoenix representation -->
            <div class="absolute top-2 right-2 text-white/50 text-sm">C·∫•p ƒë·ªô Th·∫ø Gi·ªõi: <span id="world-level">Hoang T√†n</span></div>
        </div>

        <!-- HUD -->
        <div class="flex justify-between items-end mb-4 px-2">
            <div>
                <div class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-1" id="q-difficulty">Nh·∫≠n Bi·∫øt</div>
                <div class="text-3xl font-bold text-white">C√¢u <span id="q-current">1</span><span class="text-slate-500 text-xl">/15</span></div>
            </div>
            <div class="text-right">
                <div class="text-slate-400 text-sm">ƒêi·ªÉm Tinh Th·ªÉ</div>
                <div class="text-3xl font-bold text-yellow-400" id="score">0</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-slate-800 h-3 rounded-full mb-6 overflow-hidden border border-slate-700">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500" style="width: 0%"></div>
        </div>

        <!-- Question Card -->
        <div class="bg-slate-800/80 p-6 md:p-8 rounded-2xl border border-slate-600 shadow-xl backdrop-blur-sm relative min-h-[200px] flex flex-col justify-center">
            <div id="question-text" class="text-xl md:text-2xl font-medium text-center leading-relaxed mb-2">
                <!-- Question content goes here -->
            </div>
        </div>

        <!-- Options Grid -->
        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <!-- Buttons injected by JS -->
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="hidden w-full max-w-3xl bg-slate-900 border-4 border-yellow-600 rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
        
        <div class="relative z-10">
            <div class="text-8xl mb-4 animate-bounce">üî•</div>
            <h1 class="title-font text-5xl text-yellow-400 mb-2">Huy·ªÅn Tho·∫°i ƒê√£ T√°i Sinh!</h1>
            <p class="text-slate-300 text-xl mb-8">V√πng ƒë·∫•t ƒë√£ xanh t∆∞∆°i tr·ªü l·∫°i nh·ªù tr√≠ tu·ªá c·ªßa b·∫°n.</p>
            
            <div class="bg-slate-800 p-6 rounded-xl inline-block mb-8 border border-slate-700">
                <div class="text-slate-400 text-sm uppercase">T·ªïng ƒêi·ªÉm</div>
                <div class="text-6xl font-bold text-white" id="final-score">0</div>
            </div>

            <div>
                <button onclick="location.reload()" class="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg shadow-lg transition transform hover:scale-105">
                    Ch∆°i L·∫°i
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Emojis -->
    <div id="feedback-overlay">
        <div id="feedback-emoji" class="feedback-item"></div>
    </div>

    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <script>
        // --- GAME DATA ---
        // Questions: 6 NB, 5 TH, 3 VD, 1 VDC
        const questions = [
            // M·ª©c ƒë·ªô: NH·∫¨N BI·∫æT (6 c√¢u)
            {
                q: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒë√∫ng v·ªõi m·ªçi s·ªë th·ª±c a?",
                a: [
                    "&radic;(a<sup>2</sup>) = a",
                    "&radic;(a<sup>2</sup>) = -a",
                    "&radic;(a<sup>2</sup>) = |a|",
                    "&radic;(a<sup>2</sup>) = a<sup>2</sup>"
                ],
                correct: 2,
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "V·ªõi hai bi·ªÉu th·ª©c A, B m√† A &ge; 0, B &ge; 0, c√¥ng th·ª©c n√†o sau ƒë√¢y ƒë√∫ng?",
                a: [
                    "&radic;(A.B) = &radic;A . &radic;B",
                    "&radic;(A.B) = &radic;A + &radic;B",
                    "&radic;(A.B) = A . &radic;B",
                    "&radic;(A+B) = &radic;A + &radic;B"
                ],
                correct: 0,
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "Bi·ªÉu th·ª©c li√™n h·ª£p c·ªßa bi·ªÉu th·ª©c (&radic;3 - 1) l√†:",
                a: [
                    "&radic;3 - 1",
                    "&radic;3 + 1",
                    "-&radic;3 + 1",
                    "1 - &radic;3"
                ],
                correct: 1,
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "Khi ƒë∆∞a th·ª´a s·ªë ra ngo√†i d·∫•u cƒÉn c·ªßa bi·ªÉu th·ª©c &radic;(a<sup>2</sup>b) v·ªõi a &ge; 0, b &ge; 0, ta ƒë∆∞·ª£c:",
                a: [
                    "a&radic;b",
                    "-a&radic;b",
                    "|a|&radic;b",
                    "b&radic;a"
                ],
                correct: 0,
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "ƒêi·ªÅu ki·ªán x√°c ƒë·ªãnh c·ªßa bi·ªÉu th·ª©c &radic;(A/B) l√†:",
                a: [
                    "A.B &ge; 0",
                    "A &ge; 0 v√† B > 0",
                    "A.B &ge; 0 v√† B &ne; 0",
                    "A/B > 0"
                ],
                correct: 2, // A/B >= 0 <=> AB >= 0 v√† B != 0
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "Ph√©p bi·∫øn ƒë·ªïi l√†m m·∫•t cƒÉn th·ª©c ·ªü m·∫´u s·ªë g·ªçi l√†:",
                a: [
                    "Khai ph∆∞∆°ng",
                    "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u",
                    "R√∫t g·ªçn ph√¢n th·ª©c",
                    "ƒê∆∞a th·ª´a s·ªë v√†o trong d·∫•u cƒÉn"
                ],
                correct: 1,
                level: "NH·∫¨N BI·∫æT"
            },

            // M·ª©c ƒë·ªô: TH√îNG HI·ªÇU (5 c√¢u)
            {
                q: "R√∫t g·ªçn bi·ªÉu th·ª©c: &radic;12 - &radic;3",
                a: [
                    "&radic;9",
                    "3",
                    "&radic;3",
                    "2&radic;3"
                ],
                correct: 2, // 2sqrt(3) - sqrt(3) = sqrt(3)
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u c·ªßa bi·ªÉu th·ª©c <div class='fraction'><span class='numerator'>6</span><span class='denominator'>&radic;3</span></div>",
                a: [
                    "2&radic;3",
                    "6&radic;3",
                    "3&radic;3",
                    "2"
                ],
                correct: 0,
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "Gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c (&radic;5 - 2)(&radic;5 + 2) l√†:",
                a: [
                    "1",
                    "3",
                    "&radic;5",
                    "9"
                ],
                correct: 0, // 5 - 4 = 1
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "ƒê∆∞a th·ª´a s·ªë v√†o trong d·∫•u cƒÉn: 2&radic;5",
                a: [
                    "&radic;10",
                    "&radic;20",
                    "&radic;7",
                    "&radic;40"
                ],
                correct: 1, // sqrt(4*5) = sqrt(20)
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "R√∫t g·ªçn bi·ªÉu th·ª©c: 5&radic;a - 2&radic;a + &radic;(9a) (v·ªõi a &ge; 0)",
                a: [
                    "6&radic;a",
                    "3&radic;a",
                    "12&radic;a",
                    "4&radic;a"
                ],
                correct: 0, // 5 - 2 + 3 = 6
                level: "TH√îNG HI·ªÇU"
            },

            // M·ª©c ƒë·ªô: V·∫¨N D·ª§NG (3 c√¢u)
            {
                q: "R√∫t g·ªçn bi·ªÉu th·ª©c: A = &radic;(9 - 4&radic;5) - &radic;5",
                a: [
                    "-2",
                    "2",
                    "0",
                    "2&radic;5 - 2"
                ],
                correct: 0, // sqrt((sqrt(5)-2)^2) - sqrt(5) = sqrt(5) - 2 - sqrt(5) = -2
                level: "V·∫¨N D·ª§NG"
            },
            {
                q: "(V·∫≠n d·ª•ng th·ª±c t·∫ø) M·ªôt m·∫£nh v∆∞·ªùn h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i &radic;48 m v√† chi·ªÅu r·ªông &radic;27 m. Di·ªán t√≠ch m·∫£nh v∆∞·ªùn l√†:",
                a: [
                    "36 m<sup>2</sup>",
                    "12&radic;3 m<sup>2</sup>",
                    "75 m<sup>2</sup>",
                    "&radic;75 m<sup>2</sup>"
                ],
                correct: 0, // sqrt(16*3)*sqrt(9*3) = 4sqrt(3)*3sqrt(3) = 12*3 = 36
                level: "V·∫¨N D·ª§NG"
            },
            {
                q: "T√¨m x bi·∫øt: &radic;(4x + 20) - 3&radic;(x + 5) + 2 = 0",
                a: [
                    "x = 4",
                    "x = -1",
                    "x = -4",
                    "x = 0"
                ],
                correct: 1, // 2sqrt(x+5) - 3sqrt(x+5) + 2 = 0 => -sqrt(x+5) = -2 => sqrt(x+5)=2 => x+5=4 => x=-1
                level: "V·∫¨N D·ª§NG"
            },

            // M·ª©c ƒë·ªô: V·∫¨N D·ª§NG CAO (1 c√¢u)
            {
                q: "Cho bi·ªÉu th·ª©c P = <div class='fraction'><span class='numerator'>x - 1</span><span class='denominator'>&radic;x - 1</span></div> - &radic;x v·ªõi x &ge; 0, x &ne; 1. Gi√° tr·ªã c·ªßa P l√†:",
                a: [
                    "1",
                    "-1",
                    "&radic;x",
                    "2&radic;x"
                ],
                correct: 0, // (sqrt(x)-1)(sqrt(x)+1)/(sqrt(x)-1) - sqrt(x) = sqrt(x) + 1 - sqrt(x) = 1
                level: "V·∫¨N D·ª§NG CAO"
            }
        ];

        // --- GAME STATE ---
        let currentQIndex = 0;
        let score = 0;
        let isAnswering = false;

        // --- AUDIO ---
        // Audio Context setup for generated sounds (No external files needed)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playCorrectSound() {
            // Magical chime
            playTone(600, 'sine', 0.1);
            setTimeout(() => playTone(800, 'sine', 0.1), 100);
            setTimeout(() => playTone(1200, 'sine', 0.4), 200);
        }

        function playWrongSound() {
            // Low thud
            playTone(150, 'sawtooth', 0.3);
            setTimeout(() => playTone(100, 'sawtooth', 0.3), 100);
        }

        function playWinSound() {
            // Victory fanfare
            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 'square', 0.4), i * 150);
            });
        }

        // --- LOGIC ---
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            
            currentQIndex = 0;
            score = 0;
            updateWorldState(0);
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQIndex >= questions.length) {
                endGame();
                return;
            }

            const q = questions[currentQIndex];
            
            // Update UI Stats
            document.getElementById('q-current').innerText = currentQIndex + 1;
            document.getElementById('score').innerText = score;
            document.getElementById('q-difficulty').innerText = q.level;
            document.getElementById('progress-bar').style.width = `${(currentQIndex / questions.length) * 100}%`;

            // Color code difficulty
            const diffEl = document.getElementById('q-difficulty');
            if (q.level === "NH·∫¨N BI·∫æT") diffEl.className = "text-green-400 text-sm font-bold uppercase tracking-wider mb-1";
            else if (q.level === "TH√îNG HI·ªÇU") diffEl.className = "text-blue-400 text-sm font-bold uppercase tracking-wider mb-1";
            else if (q.level === "V·∫¨N D·ª§NG") diffEl.className = "text-purple-400 text-sm font-bold uppercase tracking-wider mb-1";
            else diffEl.className = "text-red-400 text-sm font-bold uppercase tracking-wider mb-1";

            // Render Question Math
            document.getElementById('question-text').innerHTML = q.q;

            // Render Options
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            
            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "btn-answer w-full p-4 rounded-xl text-lg font-medium text-slate-200 shadow-lg text-center flex items-center justify-center min-h-[80px]";
                btn.innerHTML = `<span class="math-text">${opt}</span>`;
                btn.onclick = () => checkAnswer(idx, q.correct, btn);
                grid.appendChild(btn);
            });

            isAnswering = false;
        }

        function checkAnswer(selected, correct, btn) {
            if (isAnswering) return;
            isAnswering = true;

            const allBtns = document.querySelectorAll('.btn-answer');

            if (selected === correct) {
                // Correct
                btn.classList.add('correct-anim');
                score += 10;
                playCorrectSound();
                showFeedback("üòç");
                fireConfetti();
                
                // Update World based on progress milestones
                // 15 questions. Stages at: 3, 6, 9, 12, 15
                if ((currentQIndex + 1) % 3 === 0) {
                    updateWorldState(Math.floor((currentQIndex + 1) / 3));
                }

            } else {
                // Wrong
                btn.classList.add('shake');
                // Show correct one
                allBtns[correct].classList.add('correct-anim');
                playWrongSound();
                showFeedback("üò¢");
            }

            setTimeout(() => {
                currentQIndex++;
                loadQuestion();
            }, 1500);
        }

        function showFeedback(emoji) {
            const el = document.getElementById('feedback-emoji');
            el.innerText = emoji;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1000);
        }

        function updateWorldState(stage) {
            const world = document.getElementById('world-container');
            const tree1 = document.getElementById('tree-1');
            const tree2 = document.getElementById('tree-2');
            const river = document.getElementById('river');
            const f1 = document.getElementById('flower-1');
            const f2 = document.getElementById('flower-2');
            const phoenix = document.getElementById('phoenix');
            const wLevel = document.getElementById('world-level');

            // Reset classes
            world.className = "";
            
            if (stage === 0) {
                world.classList.add('world-stage-1');
                wLevel.innerText = "Hoang T√†n";
            } else if (stage === 1) { // 3 questions
                world.classList.add('world-stage-2');
                tree1.classList.add('active');
                wLevel.innerText = "M·∫ßm S·ªëng";
            } else if (stage === 2) { // 6 questions
                world.classList.add('world-stage-3');
                tree1.classList.add('active');
                tree2.classList.add('active');
                wLevel.innerText = "H·ªìi Sinh";
            } else if (stage === 3) { // 9 questions
                world.classList.add('world-stage-4');
                tree1.classList.add('active');
                tree2.classList.add('active');
                river.style.opacity = 1;
                wLevel.innerText = "Th·ªãnh V∆∞·ª£ng";
            } else if (stage === 4) { // 12 questions
                world.classList.add('world-stage-4');
                tree1.classList.add('active');
                tree2.classList.add('active');
                river.style.opacity = 1;
                f1.classList.add('active');
                f2.classList.add('active');
                wLevel.innerText = "R·ª±c R·ª°";
            } else if (stage === 5) { // 15 questions (Win)
                world.classList.add('world-stage-5');
                tree1.classList.add('active');
                tree2.classList.add('active');
                river.style.opacity = 1;
                f1.classList.add('active');
                f2.classList.add('active');
                phoenix.classList.add('active');
                wLevel.innerText = "HUY·ªÄN THO·∫†I";
            }
        }

        function endGame() {
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            document.getElementById('final-score').innerText = score;
            playWinSound();
            fireConfetti();
            setTimeout(fireConfetti, 500);
            setTimeout(fireConfetti, 1000);
        }

        // --- CONFETTI EFFECT ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let particles = [];
        const colors = ['#fcd34d', '#22d3ee', '#f87171', '#a78bfa', '#34d399'];

      function fireConfetti() {
    for (let i = 0; i < 100; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            vx: Math.random() * 4 - 2,
            vy: Math.random() * 4 + 2,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 10 + 5,
            rotation: Math.random() * 360,
            rotationSpeed: Math.random() * 10 - 5
        });
    }
    if (!isConfettiRunning) {
        isConfettiRunning = true;
        requestAnimationFrame(updateConfetti);
    }
}
        function updateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.rotation += p.rotationSpeed;

                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                ctx.restore();

                if (p.y > canvas.height) {
                    particles.splice(i, 1);
                    i--;
                }
            }
           if (particles.length > 0) {
    requestAnimationFrame(updateConfetti);
} else {
    isConfettiRunning = false;
}
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

    </script>
</body>
</html>
