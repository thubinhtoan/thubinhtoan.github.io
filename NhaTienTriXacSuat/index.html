<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh√† Ti√™n Tri X√°c Su·∫•t - To√°n 8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- MathJax -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, #ede9fe 0%, #c4b5fd 100%); /* Violet theme */
            min-height: 100vh;
        }

        .card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(124, 58, 237, 0.15), 0 10px 10px -5px rgba(124, 58, 237, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border-width: 2px;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
            background-color: #f5f3ff;
            border-color: #8b5cf6;
        }

        .option-btn.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #14532d !important;
        }

        .option-btn.wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #7f1d1d !important;
        }

        .feedback-enter {
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="w-full max-w-3xl">
        <!-- Start Screen -->
        <div id="start-screen" class="card p-10 text-center">
            <div class="mb-6 inline-flex p-6 bg-purple-100 rounded-full animate-bounce shadow-inner">
                <span class="text-6xl">üîÆ</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-black text-purple-800 mb-4">Nh√† Ti√™n Tri X√°c Su·∫•t</h1>
            <p class="text-gray-600 mb-8 text-lg font-medium">To√°n 8 - Ch∆∞∆°ng 9: X√°c su·∫•t l√≠ thuy·∫øt & Th·ª±c nghi·ªám<br>D·ª± ƒëo√°n t∆∞∆°ng lai b·∫±ng to√°n h·ªçc!</p>
            
            <div class="grid grid-cols-2 gap-4 mb-10 text-left">
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-200 hover:bg-purple-100 transition">
                    <div class="font-bold text-purple-800 mb-1">üé≤ Th·ª±c nghi·ªám</div>
                    <div class="text-sm text-purple-600">D·ª±a tr√™n k·∫øt qu·∫£ th√≠ nghi·ªám</div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 hover:bg-indigo-100 transition">
                    <div class="font-bold text-indigo-800 mb-1">üß† L√≠ thuy·∫øt</div>
                    <div class="text-sm text-indigo-600">D·ª±a tr√™n t√≠nh to√°n logic</div>
                </div>
            </div>

            <button onclick="startGame()" class="w-full md:w-auto px-10 py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-2xl shadow-xl shadow-purple-200 transform transition hover:-translate-y-1 text-xl flex items-center justify-center gap-3 mx-auto">
                <span>Kh√°m Ph√° Ngay</span> ‚ú®
            </button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <!-- Header -->
            <div class="flex justify-between items-end mb-6 px-2">
                <div>
                    <span class="text-purple-700 text-xs font-bold uppercase tracking-wider block mb-1">Th·ª≠ th√°ch</span>
                    <div class="text-3xl font-black text-gray-800"><span id="current-question">1</span><span class="text-gray-400 text-xl">/15</span></div>
                </div>
                <div class="text-right">
                    <div class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-xl shadow-sm border border-purple-100">
                        <span class="text-yellow-400 text-xl">‚≠ê</span>
                        <span class="text-2xl font-black text-purple-600" id="score">0</span>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-white rounded-full h-4 mb-8 p-1 shadow-sm border border-purple-100">
                <div id="progress" class="bg-gradient-to-r from-purple-400 to-indigo-500 h-full rounded-full progress-bar shadow-md" style="width: 0%"></div>
            </div>

            <!-- Question Card -->
            <div class="card p-6 md:p-10 mb-6 relative overflow-hidden border-b-8 border-purple-200">
                <div id="level-badge" class="badge bg-green-100 text-green-700 absolute top-6 right-6">Nh·∫≠n bi·∫øt</div>
                
                <h2 id="question-text" class="text-xl md:text-2xl font-bold text-gray-800 mt-6 mb-8 leading-relaxed">
                    <!-- Question goes here -->
                </h2>

                <div id="options-container" class="grid gap-3 md:gap-4">
                    <!-- Options injected here -->
                </div>
            </div>

            <!-- Feedback Area -->
            <div id="feedback-area" class="hidden feedback-enter">
                <div id="feedback-card" class="card p-6 border-l-8 shadow-2xl transform scale-100">
                    <div class="flex flex-col md:flex-row items-start gap-5">
                        <div id="feedback-icon" class="text-5xl filter drop-shadow-md shrink-0">üòé</div>
                        <div class="flex-1">
                            <h3 id="feedback-title" class="text-2xl font-bold mb-2 text-purple-700">Ch√≠nh x√°c!</h3>
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wide">Gi·∫£i th√≠ch:</div>
                            <p id="feedback-text" class="text-gray-700 leading-relaxed text-lg font-medium"></p>
                        </div>
                    </div>
                    <button onclick="nextQuestion()" class="mt-6 w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-4 px-6 rounded-xl transition flex items-center justify-center gap-2 shadow-lg group">
                        C√¢u ti·∫øp theo <span class="group-hover:translate-x-1 transition-transform">‚ûú</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden card p-10 text-center">
            <div class="mb-8 relative">
                <div class="absolute inset-0 bg-purple-200 rounded-full opacity-20 blur-xl animate-pulse"></div>
                <div class="inline-block p-8 rounded-full bg-yellow-50 border-4 border-yellow-200 mb-6 relative z-10">
                    <span class="text-7xl">üèÜ</span>
                </div>
                <h2 class="text-4xl font-extrabold text-gray-800 mb-3">K·∫øt Qu·∫£ Chung Cu·ªôc</h2>
                <p class="text-gray-500 text-lg">B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc b√†i ki·ªÉm tra!</p>
            </div>

            <div class="bg-purple-50 rounded-2xl p-8 mb-8 border-2 border-purple-100 border-dashed">
                <div class="text-purple-500 font-bold uppercase text-xs tracking-widest mb-2">T·ªïng ƒëi·ªÉm ƒë·∫°t ƒë∆∞·ª£c</div>
                <div class="text-6xl font-black text-purple-600 mb-4" id="final-score">0</div>
                <div class="h-1 w-24 bg-purple-200 mx-auto rounded-full mb-4"></div>
                <p id="result-message" class="text-gray-700 font-bold text-xl">Tuy·ªát v·ªùi!</p>
            </div>

            <button onclick="location.reload()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-10 rounded-xl shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2 mx-auto w-full md:w-auto">
                <span class="text-xl">üîÑ</span> Ch∆°i L·∫°i
            </button>
        </div>
    </div>

    <!-- Sounds -->
    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3"></audio>
    <audio id="sound-finish" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

   <script>
  // ====== DATA ======
  const questions = [
    // 6 C√¢u Nh·∫≠n bi·∫øt
    {
      level: "Nh·∫≠n bi·∫øt",
      question: "X√°c su·∫•t th·ª±c nghi·ªám c·ªßa bi·∫øn c·ªë A sau n l·∫ßn th·ª≠ ƒë∆∞·ª£c t√≠nh theo c√¥ng th·ª©c n√†o?",
      options: ["$n(A) \\cdot n$", "$\\frac{n(A)}{n}$", "$\\frac{n}{n(A)}$", "$n(A) + n$"],
      correct: 1,
      rationale: "X√°c su·∫•t th·ª±c nghi·ªám l√† t·ªâ s·ªë gi·ªØa s·ªë l·∫ßn bi·∫øn c·ªë x·∫£y ra ($n(A)$) v√† t·ªïng s·ªë l·∫ßn th·ª±c hi·ªán ph√©p th·ª≠ ($n$)."
    },
    {
      level: "Nh·∫≠n bi·∫øt",
      question: "Khi s·ªë l·∫ßn th·ª±c hi·ªán ph√©p th·ª≠ $n$ c√†ng l·ªõn, m·ªëi quan h·ªá gi·ªØa x√°c su·∫•t th·ª±c nghi·ªám v√† x√°c su·∫•t l√≠ thuy·∫øt l√† g√¨?",
      options: ["X√°c su·∫•t th·ª±c nghi·ªám ng√†y c√†ng xa x√°c su·∫•t l√≠ thuy·∫øt", "X√°c su·∫•t th·ª±c nghi·ªám b·∫±ng 0", "X√°c su·∫•t th·ª±c nghi·ªám c√†ng g·∫ßn x√°c su·∫•t l√≠ thuy·∫øt", "Kh√¥ng c√≥ m·ªëi li√™n h·ªá n√†o"],
      correct: 2,
      rationale: "Theo lu·∫≠t s·ªë l·ªõn, khi s·ªë l·∫ßn th·ª≠ c√†ng nhi·ªÅu, t·∫ßn su·∫•t xu·∫•t hi·ªán (x√°c su·∫•t th·ª±c nghi·ªám) s·∫Ω h·ªôi t·ª• v·ªÅ x√°c su·∫•t l√≠ thuy·∫øt."
    },
    {
      level: "Nh·∫≠n bi·∫øt",
      question: "Lo·∫°i x√°c su·∫•t n√†o c√≥ th·ªÉ ƒë∆∞·ª£c t√≠nh to√°n ch√≠nh x√°c tr∆∞·ªõc khi th·ª±c hi·ªán th√≠ nghi·ªám (v·ªõi ƒëi·ªÅu ki·ªán l√≠ t∆∞·ªüng)?",
      options: ["X√°c su·∫•t th·ª±c nghi·ªám", "X√°c su·∫•t l√≠ thuy·∫øt", "C·∫£ hai lo·∫°i", "Kh√¥ng lo·∫°i n√†o c·∫£"],
      correct: 1,
      rationale: "X√°c su·∫•t l√≠ thuy·∫øt ƒë∆∞·ª£c t√≠nh d·ª±a tr√™n gi·∫£ ƒë·ªãnh c√°c k·∫øt qu·∫£ ƒë·ªìng kh·∫£ nƒÉng m√† kh√¥ng c·∫ßn th·ª±c hi·ªán th√≠ nghi·ªám."
    },
    {
      level: "Nh·∫≠n bi·∫øt",
      question: "Trong th√≠ nghi·ªám tung ƒë·ªìng xu 50 l·∫ßn, c√≥ 28 l·∫ßn xu·∫•t hi·ªán m·∫∑t Ng·ª≠a. S·ªë 50 ƒë∆∞·ª£c g·ªçi l√† g√¨?",
      options: ["S·ªë l·∫ßn bi·∫øn c·ªë x·∫£y ra", "X√°c su·∫•t th·ª±c nghi·ªám", "T·ªïng s·ªë l·∫ßn th·ª±c hi·ªán ph√©p th·ª≠ ($n$)", "S·ªë k·∫øt qu·∫£ thu·∫≠n l·ª£i l√≠ thuy·∫øt"],
      correct: 2,
      rationale: "50 l√† t·ªïng s·ªë l·∫ßn ch√∫ng ta th·ª±c hi·ªán h√†nh ƒë·ªông tung ƒë·ªìng xu, k√Ω hi·ªáu l√† $n$."
    },
    {
      level: "Nh·∫≠n bi·∫øt",
      question: "Trong th√≠ nghi·ªám tung ƒë·ªìng xu 50 l·∫ßn, c√≥ 28 l·∫ßn xu·∫•t hi·ªán m·∫∑t Ng·ª≠a. S·ªë 28 ƒë∆∞·ª£c g·ªçi l√† g√¨?",
      options: ["T·ªïng s·ªë l·∫ßn th·ª≠", "S·ªë l·∫ßn bi·∫øn c·ªë 'm·∫∑t Ng·ª≠a' x·∫£y ra ($n(A)$)", "X√°c su·∫•t l√≠ thuy·∫øt", "X√°c su·∫•t th·ª±c nghi·ªám"],
      correct: 1,
      rationale: "28 l√† s·ªë l·∫ßn s·ª± ki·ªán quan t√¢m (m·∫∑t Ng·ª≠a) th·ª±c t·∫ø ƒë√£ x·∫£y ra trong th√≠ nghi·ªám."
    },
    {
      level: "Nh·∫≠n bi·∫øt",
      question: "X√°c su·∫•t (c·∫£ l√≠ thuy·∫øt v√† th·ª±c nghi·ªám) lu√¥n nh·∫≠n gi√° tr·ªã trong kho·∫£ng n√†o?",
      options: ["T·ª´ -1 ƒë·∫øn 1", "T·ª´ 0 ƒë·∫øn 100", "T·ª´ 0 ƒë·∫øn 1", "Lu√¥n l·ªõn h∆°n 1"],
      correct: 2,
      rationale: "X√°c su·∫•t lu√¥n l√† m·ªôt s·ªë kh√¥ng √¢m v√† nh·ªè h∆°n ho·∫∑c b·∫±ng 1 (ho·∫∑c t·ª´ 0% ƒë·∫øn 100%)."
    },

    // 5 C√¢u Th√¥ng hi·ªÉu
    {
      level: "Th√¥ng hi·ªÉu",
      question: "Gieo m·ªôt con x√∫c x·∫Øc 20 l·∫ßn, th·∫•y c√≥ 4 l·∫ßn xu·∫•t hi·ªán m·∫∑t 6 ch·∫•m. X√°c su·∫•t th·ª±c nghi·ªám c·ªßa bi·∫øn c·ªë 'm·∫∑t 6 ch·∫•m' l√† bao nhi√™u?",
      options: ["$\\frac{1}{6}$", "$\\frac{1}{5}$", "$\\frac{4}{6}$", "$\\frac{1}{4}$"],
      correct: 1,
      rationale: "X√°c su·∫•t th·ª±c nghi·ªám = $\\frac{4}{20} = \\frac{1}{5}$ (hay 0.2)."
    },
    {
      level: "Th√¥ng hi·ªÉu",
      question: "X√°c su·∫•t l√≠ thuy·∫øt c·ªßa bi·∫øn c·ªë 'Gieo ƒë∆∞·ª£c m·∫∑t s·ªë ch·∫µn' khi gieo m·ªôt con x√∫c x·∫Øc c√¢n ƒë·ªëi l√†:",
      options: ["0.2", "0.5", "0.33", "0.66"],
      correct: 1,
      rationale: "C√°c m·∫∑t ch·∫µn l√† {2, 4, 6} (3 k·∫øt qu·∫£). T·ªïng s·ªë k·∫øt qu·∫£ l√† 6. $P = \\frac{3}{6} = 0.5$."
    },
    {
      level: "Th√¥ng hi·ªÉu",
      question: "B·∫°n An tung ƒë·ªìng xu 100 l·∫ßn, ƒë∆∞·ª£c 55 l·∫ßn Ng·ª≠a. B·∫°n B√¨nh tung 1000 l·∫ßn, ƒë∆∞·ª£c 495 l·∫ßn Ng·ª≠a. K·∫øt qu·∫£ c·ªßa b·∫°n n√†o ƒë√°ng tin c·∫≠y h∆°n ƒë·ªÉ ∆∞·ªõc l∆∞·ª£ng x√°c su·∫•t l√≠ thuy·∫øt?",
      options: ["B·∫°n An", "B·∫°n B√¨nh", "C·∫£ hai nh∆∞ nhau", "Kh√¥ng th·ªÉ so s√°nh"],
      correct: 1,
      rationale: "S·ªë l·∫ßn th·ª≠ c√†ng l·ªõn (1000 > 100) th√¨ ƒë·ªô tin c·∫≠y c√†ng cao v√† k·∫øt qu·∫£ c√†ng g·∫ßn v·ªõi x√°c su·∫•t l√≠ thuy·∫øt."
    },
    {
      level: "Th√¥ng hi·ªÉu",
      question: "Trong m·ªôt h·ªôp k√≠n c√≥ c√°c th·∫ª s·ªë. Sau 50 l·∫ßn r√∫t (c√≥ ho√†n l·∫°i), th·∫•y th·∫ª s·ªë 5 xu·∫•t hi·ªán 10 l·∫ßn. X√°c su·∫•t th·ª±c nghi·ªám c·ªßa bi·∫øn c·ªë 'R√∫t ƒë∆∞·ª£c th·∫ª s·ªë 5' l√†:",
      options: ["10%", "20%", "50%", "5%"],
      correct: 1,
      rationale: "$P_e = \\frac{10}{50} = 0.2 = 20\\%$."
    },
    {
      level: "Th√¥ng hi·ªÉu",
      question: "N·∫øu tung m·ªôt ƒë·ªìng xu c√¢n ƒë·ªëi 10 l·∫ßn v√† c·∫£ 10 l·∫ßn ƒë·ªÅu ra S·∫•p. X√°c su·∫•t l√≠ thuy·∫øt ƒë·ªÉ l·∫ßn th·ª© 11 ra S·∫•p l√† bao nhi√™u?",
      options: ["G·∫ßn b·∫±ng 1", "L·ªõn h∆°n 0.5", "0.5", "Nh·ªè h∆°n 0.5"],
      correct: 2,
      rationale: "C√°c l·∫ßn tung ƒë·ªôc l·∫≠p v·ªõi nhau. D√π qu√° kh·ª© th·∫ø n√†o, x√°c su·∫•t l√≠ thuy·∫øt cho m·ªôt l·∫ßn tung c·ªßa ƒë·ªìng xu c√¢n ƒë·ªëi v·∫´n lu√¥n l√† 0.5."
    },

    // 3 C√¢u V·∫≠n d·ª•ng
    {
      level: "V·∫≠n d·ª•ng",
      question: "X√°c su·∫•t l√≠ thuy·∫øt c·ªßa vi·ªác gieo x√∫c x·∫Øc ra m·∫∑t 1 ch·∫•m l√† $\\frac{1}{6}$. N·∫øu gieo 600 l·∫ßn, theo l√≠ thuy·∫øt, ta *k·ª≥ v·ªçng* m·∫∑t 1 ch·∫•m xu·∫•t hi·ªán kho·∫£ng bao nhi√™u l·∫ßn?",
      options: ["60 l·∫ßn", "100 l·∫ßn", "50 l·∫ßn", "6 l·∫ßn"],
      correct: 1,
      rationale: "S·ªë l·∫ßn k·ª≥ v·ªçng = $600 \\times \\frac{1}{6} = 100$ l·∫ßn."
    },
    {
      level: "V·∫≠n d·ª•ng (Th·ª±c t·∫ø)",
      question: "Ki·ªÉm tra ng·∫´u nhi√™n 500 b√≥ng ƒë√®n th√¨ th·∫•y c√≥ 15 b√≥ng b·ªã h·ªèng. H√£y ∆∞·ªõc l∆∞·ª£ng x√°c su·∫•t m·ªôt b√≥ng ƒë√®n b·ªã h·ªèng c·ªßa l√¥ h√†ng n√†y.",
      options: ["0.03", "0.15", "0.05", "0.3"],
      correct: 0,
      rationale: "∆Ø·ªõc l∆∞·ª£ng = $\\frac{15}{500} = 0.03$."
    },
    {
      level: "V·∫≠n d·ª•ng",
      question: "M·ªôt x·∫° th·ªß b·∫Øn 100 ph√°t s√∫ng, tr√∫ng t√¢m 85 ph√°t. D·ª±a v√†o x√°c su·∫•t th·ª±c nghi·ªám, d·ª± ƒëo√°n trong 20 ph√°t b·∫Øn ti·∫øp theo, x·∫° th·ªß s·∫Ω tr√∫ng t√¢m kho·∫£ng bao nhi√™u ph√°t?",
      options: ["15 ph√°t", "16 ph√°t", "17 ph√°t", "19 ph√°t"],
      correct: 2,
      rationale: "X√°c su·∫•t tr√∫ng = $\\frac{85}{100} = 0.85$. D·ª± ƒëo√°n = $20 \\times 0.85 = 17$ ph√°t."
    },

    // 1 C√¢u V·∫≠n d·ª•ng cao
    {
      level: "V·∫≠n d·ª•ng cao",
      question: "Trong h·ªôp c√≥ m·ªôt s·ªë bi xanh v√† bi ƒë·ªè. Bi·∫øt s·ªë bi xanh l√† 20. Th·ª±c hi·ªán l·∫•y bi (c√≥ ho√†n l·∫°i) 100 l·∫ßn, th·∫•y 40 l·∫ßn ƒë∆∞·ª£c bi ƒë·ªè. H√£y ∆∞·ªõc l∆∞·ª£ng t·ªïng s·ªë bi c√≥ trong h·ªôp.",
      options: ["33 vi√™n", "30 vi√™n", "40 vi√™n", "50 vi√™n"],
      correct: 0,
      rationale: "∆Ø·ªõc l∆∞·ª£ng $P(ƒë·ªè)=0.4 \\Rightarrow P(xanh)=0.6$. $\\frac{20}{T·ªïng} \\approx 0.6 \\Rightarrow T·ªïng \\approx \\frac{20}{0.6} \\approx 33.3$ ‚âà 33."
    }
  ];

  // ====== STATE ======
  let currentQuestionIndex = 0;
  let score = 0;
  let isAnswering = false;

  // ====== UTILS ======
  function shuffleInPlace(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ====== AUDIO ======
  const soundCorrect = document.getElementById('sound-correct');
  const soundWrong = document.getElementById('sound-wrong');
  const soundFinish = document.getElementById('sound-finish');

  function playSound(type) {
    const el = type === 'correct' ? soundCorrect : type === 'wrong' ? soundWrong : soundFinish;
    if (!el) return;
    el.currentTime = 0;
    el.play().catch(() => {});
  }

  // ====== GAME ======
  function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    loadQuestion();
  }

  function loadQuestion() {
    isAnswering = true;
    const q = questions[currentQuestionIndex];

    // Header
    document.getElementById('current-question').innerText = currentQuestionIndex + 1;
    document.getElementById('score').innerText = score;
    document.getElementById('progress').style.width =
      `${(currentQuestionIndex / questions.length) * 100}%`;

    // Question (MathJax)
    document.getElementById('question-text').innerHTML = q.question;

    // Badge
    const badge = document.getElementById('level-badge');
    badge.innerText = q.level;
    let badgeClass = "badge absolute top-6 right-6 ";
    if (q.level.includes("Nh·∫≠n bi·∫øt")) badgeClass += "bg-blue-100 text-blue-700";
    else if (q.level.includes("Th√¥ng hi·ªÉu")) badgeClass += "bg-green-100 text-green-700";
    else if (q.level.includes("V·∫≠n d·ª•ng cao")) badgeClass += "bg-red-100 text-red-700";
    else badgeClass += "bg-yellow-100 text-yellow-700";
    badge.className = badgeClass;

    // Reset feedback
    const feedbackArea = document.getElementById('feedback-area');
    feedbackArea.classList.add('hidden');
    feedbackArea.classList.remove('feedback-enter');

    // ===== Random ƒë√°p √°n + c·∫≠p nh·∫≠t correct =====
    const optionObjs = q.options.map((text, idx) => ({
      text,
      isCorrect: idx === q.correct
    }));
    shuffleInPlace(optionObjs);

    // L∆∞u correct theo th·ª© t·ª± m·ªõi (ƒë·ªÉ ch·∫•m)
    q._shuffled = optionObjs;
    q._correctIndex = optionObjs.findIndex(o => o.isCorrect);

    // Render options
    const container = document.getElementById('options-container');
    container.innerHTML = '';

    optionObjs.forEach((optObj, index) => {
      const btn = document.createElement('button');
      btn.className = `option-btn w-full text-left p-5 rounded-xl border-2 border-purple-100 bg-white text-gray-700 font-bold text-lg flex items-center shadow-sm`;
      btn.onclick = () => checkAnswer(index, btn);
      btn.innerHTML = `
        <span class="inline-flex items-center justify-center w-10 h-10 bg-purple-50 rounded-lg text-purple-600 font-extrabold mr-4 text-lg border border-purple-100 shrink-0">
          ${String.fromCharCode(65 + index)}
        </span>
        <span>${optObj.text}</span>
      `;
      container.appendChild(btn);
    });

    // Typeset MathJax (c·∫£ c√¢u + ƒë√°p √°n)
    if (window.MathJax) MathJax.typesetPromise();
  }

  function checkAnswer(selectedIndex, btnElement) {
    if (!isAnswering) return;
    isAnswering = false;

    const q = questions[currentQuestionIndex];
    const correctIndex = q._correctIndex; // d√πng correct sau khi shuffle
    const buttons = document.querySelectorAll('.option-btn');

    buttons.forEach(btn => btn.disabled = true);

    const isCorrect = selectedIndex === correctIndex;

    if (isCorrect) {
      btnElement.classList.add('correct');
      score += 10;
      document.getElementById('score').innerText = score;
      playSound('correct');
      fireConfetti();
      showFeedback(true, q.rationale);
    } else {
      btnElement.classList.add('wrong');
      buttons[correctIndex].classList.add('correct');
      playSound('wrong');
      showFeedback(false, q.rationale);
    }
  }

  function showFeedback(isCorrect, rationale) {
    const area = document.getElementById('feedback-area');
    const title = document.getElementById('feedback-title');
    const text = document.getElementById('feedback-text');
    const icon = document.getElementById('feedback-icon');

    area.classList.remove('hidden');
    void area.offsetWidth;
    area.classList.add('feedback-enter');

    if (isCorrect) {
      title.innerText = "Ch√≠nh x√°c! üéâ";
      title.className = "text-2xl font-bold mb-2 text-green-600";
      icon.innerText = "ü§©";
    } else {
      title.innerText = "Ch∆∞a ƒë√∫ng r·ªìi... üòÖ";
      title.className = "text-2xl font-bold mb-2 text-red-600";
      icon.innerText = "ü§î";
    }

    text.innerHTML = rationale;
    if (window.MathJax) MathJax.typesetPromise([text]);
  }

  function nextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) loadQuestion();
    else showResult();
  }

  function showResult() {
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = score;
    playSound('finish');
    fireConfetti();

    const msg = document.getElementById('result-message');
    if (score >= 130) msg.innerText = "ƒê·ªânh c·ªßa ch√≥p! B·∫°n l√† b·∫≠c th·∫ßy ti√™n tri! üîÆ";
    else if (score >= 100) msg.innerText = "L√†m t·ªët l·∫Øm! Ki·∫øn th·ª©c r·∫•t v·ªØng v√†ng! üëç";
    else if (score >= 70) msg.innerText = "Kh√° ·ªïn! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©! üí™";
    else msg.innerText = "H√£y √¥n l·∫°i b√†i v√† th·ª≠ l·∫°i n√†o! üìö";
  }

  function fireConfetti() {
    var count = 200;
    var defaults = { origin: { y: 0.7 } };
    function fire(particleRatio, opts) {
      confetti(Object.assign({}, defaults, opts, {
        particleCount: Math.floor(count * particleRatio)
      }));
    }
    fire(0.25, { spread: 26, startVelocity: 55 });
    fire(0.2, { spread: 60 });
    fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
    fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
    fire(0.1, { spread: 120, startVelocity: 45 });
  }
</script>
</body>
</html>
