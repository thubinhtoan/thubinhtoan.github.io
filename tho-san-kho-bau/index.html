<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ª£ SƒÉn Kho B√°u: B√≠ M·∫≠t CƒÉn Th·ª©c - To√°n 9</title>

  <!-- ‚úÖ MathJax (HI·ªÇN TH·ªä D·∫§U CƒÇN ƒê·∫¶Y ƒê·ª¶) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    :root {
      --primary: #8B4513;
      --secondary: #DAA520;
      --bg-color: #FEF9E7;
      --text-color: #3e2723;
      --success: #2E7D32;
      --error: #C62828;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #2c3e50;
      background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%2334495e" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-color);
    }

    #game-container {
      width: 100%;
      max-width: 900px;
      background-color: var(--bg-color);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      overflow: hidden;
      border: 8px solid var(--primary);
      position: relative;
    }

    header {
      background-color: var(--primary);
      color: var(--secondary);
      padding: 15px;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 4px solid #5D4037;
    }

    .game-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stats {
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      gap: 20px;
    }

    .screen {
      padding: 30px;
      text-align: center;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .hidden { display: none !important; }

    #start-screen h1 {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .btn {
      background: linear-gradient(to bottom, #DAA520, #B8860B);
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 1.2rem;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      box-shadow: 0 4px 0 #8B4513;
      margin-top: 20px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #8B4513; }
    .btn:active { transform: translateY(2px); box-shadow: 0 0 0 #8B4513; }

    #question-area { width: 100%; }

    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--secondary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .level-badge {
      display: inline-block;
      padding: 6px 16px;
      background-color: #607D8B;
      color: white;
      border-radius: 15px;
      font-size: 0.95rem;
      margin-bottom: 15px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .question-text {
      font-size: 1.8rem;
      margin-bottom: 22px;
      color: var(--text-color);
      font-weight: 700;
      line-height: 1.25;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%;
      max-width: 800px;
      align-items: stretch;
    }

    .option-btn {
      background-color: white;
      border: 2px solid #D7CCC8;
      padding: 18px 16px;
      font-size: 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #4e342e;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 78px;

      /* ‚úÖ tr√°nh MathJax b·ªã c·∫Øt d·∫•u cƒÉn */
      overflow: visible;
    }

    .option-btn:hover:not(:disabled) {
      background-color: #FFF8E1;
      border-color: var(--secondary);
      transform: scale(1.02);
    }

    .option-btn.correct {
      background-color: #C8E6C9;
      border-color: var(--success);
      color: var(--success);
    }

    .option-btn.wrong {
      background-color: #FFCDD2;
      border-color: var(--error);
      color: var(--error);
      opacity: 0.75;
    }

    /* ‚úÖ Khung gi·∫£i th√≠ch: ch·ªØ to h∆°n */
    #rationale-box {
      margin-top: 18px;
      padding: 18px 18px;
      border-radius: 12px;
      background-color: #FFF3E0;
      border-left: 6px solid var(--secondary);
      text-align: left;
      animation: slideIn 0.25s ease;
      width: 100%;
      max-width: 820px;
    }

    #rationale-title {
      font-weight: 900;
      color: var(--primary);
      margin-bottom: 8px;
      display: block;
      font-size: 1.3rem;
    }

    #rationale-content {
      font-size: 1.3rem; /* ‚úÖ C√î MU·ªêN TO H∆†N: tƒÉng l√™n 1.3rem */
      line-height: 1.35;
      color: #4e342e;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .score-big {
      font-size: 4rem;
      color: var(--primary);
      font-weight: bold;
      margin: 20px 0;
    }

    .message {
      font-size: 1.5rem;
      color: #555;
      margin-bottom: 30px;
    }

    #confetti-canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    /* ‚úÖ MathJax SVG: tr√°nh xu·ªëng d√≤ng v√† tr√°nh b·ªã c·∫Øt */
    .mjx-container { overflow: visible !important; }
    mjx-container { overflow: visible !important; }

    @media (max-width: 650px) {
      .options-grid { grid-template-columns: 1fr; }
      .question-text { font-size: 1.45rem; }
      .stats { font-size: 0.95rem; gap: 10px; }
      #rationale-content { font-size: 1.12rem; }
    }
  </style>
</head>

<body>
<div id="game-container">
  <canvas id="confetti-canvas"></canvas>

  <header>
    <div class="game-title">üóùÔ∏è Th·ª£ SƒÉn Kho B√°u</div>
    <div class="stats">
      <span>C√¢u: <span id="q-current">1</span>/15</span>
      <span>ƒêi·ªÉm: <span id="score">0</span></span>
    </div>
  </header>

  <!-- START SCREEN -->
  <div id="start-screen" class="screen">
    <div style="font-size: 4rem; margin-bottom: 10px;">üíé</div>
    <h1>B√≠ M·∫≠t CƒÉn Th·ª©c</h1>
    <p style="font-size: 1.2rem; max-width: 650px; margin-bottom: 20px;">
      Ch√†o m·ª´ng c√°c em ƒë·∫øn v·ªõi cu·ªôc phi√™u l∆∞u! H√£y d√πng ki·∫øn th·ª©c v·ªÅ
      <b>‚ÄúBi·∫øn ƒë·ªïi ƒë∆°n gi·∫£n bi·ªÉu th·ª©c ch·ª©a cƒÉn th·ª©c b·∫≠c hai‚Äù</b> ƒë·ªÉ m·ªü kh√≥a kho b√°u.
    </p>
    <p style="color: #666;">Gi√°o vi√™n: C√¥ Thu B√¨nh</p>
    <button class="btn" onclick="startGame()">B·∫Øt ƒê·∫ßu H√†nh Tr√¨nh</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen" class="screen hidden">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

    <div id="question-area">
      <span id="level-badge" class="level-badge">Nh·∫≠n Bi·∫øt</span>
      <div id="question-text" class="question-text">C√¢u h·ªèi s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>

      <div id="options-container" class="options-grid"></div>

      <div id="rationale-box" class="hidden">
        <span id="rationale-title">üí° Gi·∫£i th√≠ch:</span>
        <div id="rationale-content">N·ªôi dung gi·∫£i th√≠ch...</div>
        <div style="text-align: right; margin-top: 10px;">
          <button class="btn" onclick="nextQuestion()" style="padding: 10px 28px; font-size: 1rem;">Ti·∫øp t·ª•c ‚û°Ô∏è</button>
        </div>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="end-screen" class="screen hidden">
    <div style="font-size: 4rem;">üèÜ</div>
    <h1 style="color: var(--primary);">Ho√†n Th√†nh Nhi·ªám V·ª•!</h1>
    <div class="score-big" id="final-score">0</div>
    <p class="message" id="end-message">B·∫°n l√†m r·∫•t t·ªët!</p>
    <button class="btn" onclick="location.reload()">Ch∆°i L·∫°i</button>
  </div>
</div>

<script>
  // =========================
  // ‚úÖ DATA (ƒê√É CHUY·ªÇN SANG LaTeX ƒë·ªÉ cƒÉn th·ª©c hi·ªÉn th·ªã ƒë·∫πp)
  // =========================
  const rawQuestions = [
    // --- NH·∫¨N BI·∫æT (6) ---
    {
      level: "Nh·∫≠n Bi·∫øt",
      question: "V·ªõi $A$ l√† bi·ªÉu th·ª©c b·∫•t k·ª≥, $\\sqrt{A^2}$ b·∫±ng bao nhi√™u?",
      options: ["$A$", "$-A$", "$|A|$", "$A^2$"],
      correct: 2,
      rationale: "Theo h·∫±ng ƒë·∫≥ng th·ª©c cƒÉn b·∫≠c hai: $\\sqrt{A^2}=|A|$."
    },
    {
      level: "Nh·∫≠n Bi·∫øt",
      question: "ƒêi·ªÅu ki·ªán ƒë·ªÉ $\\sqrt{AB}=\\sqrt{A}\\,\\sqrt{B}$ l√† g√¨?",
      options: ["$A\\ge 0$ v√† $B\\ge 0$", "$A<0$ v√† $B<0$", "$A\\ge 0$ v√† $B<0$", "$A,B$ t√πy √Ω"],
      correct: 0,
      rationale: "Quy t·∫Øc khai ph∆∞∆°ng m·ªôt t√≠ch y√™u c·∫ßu c√°c th·ª´a s·ªë kh√¥ng √¢m: $A\\ge 0,\\;B\\ge 0$."
    },
    {
      level: "Nh·∫≠n Bi·∫øt",
      question: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh $\\sqrt{3^2\\cdot 2}$ l√†:",
      options: ["$3\\sqrt{2}$", "$2\\sqrt{3}$", "$6$", "$\\sqrt{6}$"],
      correct: 0,
      rationale: "$\\sqrt{3^2\\cdot2}=\\sqrt{3^2}\\,\\sqrt2=3\\sqrt2$."
    },
    {
      level: "Nh·∫≠n Bi·∫øt",
      question: "ƒê∆∞a th·ª´a s·ªë ra ngo√†i d·∫•u cƒÉn: $\\sqrt{4x}$ v·ªõi $x\\ge 0$",
      options: ["$4\\sqrt{x}$", "$2\\sqrt{x}$", "$x\\sqrt{4}$", "$-2\\sqrt{x}$"],
      correct: 1,
      rationale: "V√¨ $4=2^2$ n√™n $\\sqrt{4x}=\\sqrt{2^2}\\,\\sqrt{x}=2\\sqrt{x}$ (v·ªõi $x\\ge 0$)."
    },
    {
      level: "Nh·∫≠n Bi·∫øt",
      question: "ƒê∆∞a th·ª´a s·ªë v√†o trong d·∫•u cƒÉn: $3\\sqrt{2}$",
      options: ["$\\sqrt6$", "$\\sqrt{12}$", "$\\sqrt{18}$", "$\\sqrt9$"],
      correct: 2,
      rationale: "$3\\sqrt2=\\sqrt{3^2\\cdot2}=\\sqrt{9\\cdot2}=\\sqrt{18}$."
    },
    {
      level: "Nh·∫≠n Bi·∫øt",
      question: "Ph√©p bi·∫øn ƒë·ªïi l√†m m·∫•t cƒÉn th·ª©c ·ªü m·∫´u g·ªçi l√† g√¨?",
      options: ["Khai ph∆∞∆°ng", "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u", "ƒê∆∞a th·ª´a s·ªë ra ngo√†i", "R√∫t g·ªçn ph√¢n th·ª©c"],
      correct: 1,
      rationale: "ƒê√¢y l√† ƒë·ªãnh nghƒ©a c·ªßa ph√©p tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u."
    },

    // --- TH√îNG HI·ªÇU (5) ---
    {
      level: "Th√¥ng Hi·ªÉu",
      question: "T√≠nh gi√° tr·ªã: $\\sqrt8+\\sqrt{18}$",
      options: ["$\\sqrt{26}$", "$5\\sqrt2$", "$2\\sqrt{13}$", "$7$"],
      correct: 1,
      rationale: "$\\sqrt8+\\sqrt{18}=\\sqrt{4\\cdot2}+\\sqrt{9\\cdot2}=2\\sqrt2+3\\sqrt2=5\\sqrt2$."
    },
    {
      level: "Th√¥ng Hi·ªÉu",
      question: "V·ªõi $x<0$, r√∫t g·ªçn $\\sqrt{x^2}$ l√†:",
      options: ["$x$", "$-x$", "$|-x|$", "$x^2$"],
      correct: 1,
      rationale: "$\\sqrt{x^2}=|x|$. V√¨ $x<0$ n√™n $|x|=-x$."
    },
    {
      level: "Th√¥ng Hi·ªÉu",
      question: "T√≠nh: $\\sqrt2\\cdot\\sqrt8$",
      options: ["$\\sqrt{10}$", "$4$", "$16$", "$2\\sqrt2$"],
      correct: 1,
      rationale: "$\\sqrt2\\cdot\\sqrt8=\\sqrt{16}=4$."
    },
    {
      level: "Th√¥ng Hi·ªÉu",
      question: "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u c·ªßa $\\dfrac{1}{\\sqrt3}$",
      options: ["$3$", "$\\dfrac{\\sqrt3}{3}$", "$\\dfrac{3}{\\sqrt3}$", "$\\dfrac{1}{3}$"],
      correct: 1,
      rationale: "Nh√¢n c·∫£ t·ª≠ v√† m·∫´u v·ªõi $\\sqrt3$: $\\dfrac1{\\sqrt3}=\\dfrac{\\sqrt3}{3}$."
    },
    {
      level: "Th√¥ng Hi·ªÉu",
      question: "R√∫t g·ªçn $\\sqrt{27a}-\\sqrt{3a}$ (v·ªõi $a\\ge 0$)",
      options: ["$2\\sqrt{3a}$", "$3\\sqrt{a}$", "$\\sqrt{24a}$", "$4\\sqrt{3a}$"],
      correct: 0,
      rationale: "$\\sqrt{27a}-\\sqrt{3a}=\\sqrt{9\\cdot3a}-\\sqrt{3a}=3\\sqrt{3a}-\\sqrt{3a}=2\\sqrt{3a}$."
    },

    // --- V·∫¨N D·ª§NG (3) ---
    {
      level: "V·∫≠n D·ª•ng",
      question: "T√¨m $x$ bi·∫øt $\\sqrt{9x}=6$ (v·ªõi $x\\ge 0$)",
      options: ["$x=2$", "$x=4$", "$x=36$", "$x=9$"],
      correct: 1,
      rationale: "$\\sqrt{9x}=3\\sqrt{x}$. Suy ra $3\\sqrt{x}=6\\Rightarrow\\sqrt{x}=2\\Rightarrow x=4$."
    },
    {
      level: "V·∫≠n D·ª•ng Th·ª±c T·∫ø",
      question: "M·ªôt m·∫£nh ƒë·∫•t h√¨nh vu√¥ng c√≥ di·ªán t√≠ch $50\\,m^2$. ƒê·ªô d√†i c·∫°nh l√†:",
      options: ["$25\\,m$", "$5\\sqrt2\\,m$", "$10\\,m$", "$50\\,m$"],
      correct: 1,
      rationale: "C·∫°nh $=\\sqrt{50}=\\sqrt{25\\cdot2}=5\\sqrt2\\,(m)$."
    },
    {
      level: "V·∫≠n D·ª•ng",
      question: "R√∫t g·ªçn $\\sqrt{(2-\\sqrt5)^2}$",
      options: ["$2-\\sqrt5$", "$\\sqrt5-2$", "$\\pm(2-\\sqrt5)$", "$3$"],
      correct: 1,
      rationale: "$\\sqrt{A^2}=|A|$. ·ªû ƒë√¢y $A=2-\\sqrt5<0$ n√™n $|2-\\sqrt5|=-(2-\\sqrt5)=\\sqrt5-2$."
    },

    // --- V·∫¨N D·ª§NG CAO (1) ---
    {
      level: "V·∫≠n D·ª•ng Cao",
      question: "R√∫t g·ªçn $A=\\sqrt{9-4\\sqrt5}$",
      options: ["$3-2\\sqrt5$", "$\\sqrt5-2$", "$2-\\sqrt5$", "$5-\\sqrt2$"],
      correct: 1,
      rationale: "$9-4\\sqrt5=(\\sqrt5-2)^2$ n√™n $\\sqrt{9-4\\sqrt5}=|\\sqrt5-2|=\\sqrt5-2$ (v√¨ $\\sqrt5>2$)."
    }
  ];

  // =========================
  // ‚úÖ CHU·∫®N B·ªä: random A/B/C/D + c√¢n t∆∞∆°ng ƒë·ªëi ƒë√°p √°n ƒë√∫ng
  // =========================
  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function shuffleKeepCorrect(q, desiredPos, maxTries = 40) {
    // t·∫°o c√°c ho√°n v·ªã v√† ch·ªçn c√°i ƒë∆∞a ƒë√°p √°n ƒë√∫ng v√†o v·ªã tr√≠ mong mu·ªën (n·∫øu ƒë∆∞·ª£c)
    const n = q.options.length;
    for (let t = 0; t < maxTries; t++) {
      const idx = shuffleArray([...Array(n).keys()]);
      const newOptions = idx.map(i => q.options[i]);
      const newCorrect = idx.indexOf(q.correct);
      if (newCorrect === desiredPos) {
        return { ...q, options: newOptions, correct: newCorrect };
      }
    }
    // n·∫øu kh√¥ng kh·ªõp th√¨ random th∆∞·ªùng
    const idx = shuffleArray([...Array(n).keys()]);
    const newOptions = idx.map(i => q.options[i]);
    const newCorrect = idx.indexOf(q.correct);
    return { ...q, options: newOptions, correct: newCorrect };
  }

  function prepareQuestionsBalanced(raw) {
    const n = raw.length;
    const target = [0,0,0,0].map(() => Math.floor(n / 4));
    for (let i = 0; i < (n % 4); i++) target[i]++; // chia d∆∞: A,B,C,... nh·∫≠n th√™m 1

    const count = [0,0,0,0];
    const prepared = [];

    raw.forEach(q => {
      // ch·ªçn v·ªã tr√≠ ƒëang thi·∫øu nhi·ªÅu nh·∫•t
      let desiredPos = 0;
      let bestNeed = -Infinity;
      for (let p = 0; p < 4; p++) {
        const need = target[p] - count[p];
        if (need > bestNeed) { bestNeed = need; desiredPos = p; }
      }

      const sq = shuffleKeepCorrect(q, desiredPos);
      count[sq.correct]++;
      prepared.push(sq);
    });

    return prepared;
  }

  const questions = prepareQuestionsBalanced(rawQuestions);

  // =========================
  // GAME STATE
  // =========================
  let currentQuestionIndex = 0;
  let score = 0;
  let isAnswering = true;

  // =========================
  // AUDIO (gi·ªØ nh·∫π)
  // =========================
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(type) {
    if (!audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'correct') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
      osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.45);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.45);
    } else if (type === 'wrong') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(150, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.22, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.28);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.28);
    } else if (type === 'end') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(440, audioCtx.currentTime);
      osc.frequency.setValueAtTime(554, audioCtx.currentTime + 0.2);
      osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.22, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.1);
      osc.start();
      osc.stop(audioCtx.currentTime + 1.1);
    }
  }

  // =========================
  // MATHJAX REFRESH
  // =========================
  function typesetMath() {
    if (window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetClear?.();
      window.MathJax.typesetPromise();
    }
  }

  // =========================
  // LOGIC
  // =========================
  function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    currentQuestionIndex = 0;
    score = 0;
    document.getElementById('score').innerText = score;
    loadQuestion();
  }

  function loadQuestion() {
    const q = questions[currentQuestionIndex];

    document.getElementById('q-current').innerText = currentQuestionIndex + 1;
    document.getElementById('level-badge').innerText = q.level;

    // ‚úÖ d√πng innerHTML ƒë·ªÉ MathJax ch·∫°y
    document.getElementById('question-text').innerHTML = q.question;

    // Progress
    const pct = (currentQuestionIndex / questions.length) * 100;
    document.getElementById('progress-fill').style.width = pct + "%";

    // Options
    const container = document.getElementById('options-container');
    container.innerHTML = '';

    q.options.forEach((opt, index) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.innerHTML = `<span style="font-weight:900;margin-right:10px;">${String.fromCharCode(65+index)}.</span> <span>${opt}</span>`;
      btn.onclick = () => checkAnswer(index, btn);
      container.appendChild(btn);
    });

    // Hide rationale
    document.getElementById('rationale-box').classList.add('hidden');
    isAnswering = true;

    // ‚úÖ render MathJax
    typesetMath();
  }

  function checkAnswer(selectedIndex, btnElement) {
    if (!isAnswering) return;
    isAnswering = false;

    const q = questions[currentQuestionIndex];
    const buttons = document.querySelectorAll('.option-btn');

    if (selectedIndex === q.correct) {
      btnElement.classList.add('correct');
      btnElement.innerHTML += " <span style='margin-left:8px;'>üòÉ</span>";
      score += 10;
      document.getElementById('score').innerText = score;
      playSound('correct');
      fireConfetti();
    } else {
      btnElement.classList.add('wrong');
      btnElement.innerHTML += " <span style='margin-left:8px;'>üò¢</span>";
      buttons[q.correct].classList.add('correct');
      playSound('wrong');
    }

    buttons.forEach(b => b.disabled = true);

    const rBox = document.getElementById('rationale-box');
    document.getElementById('rationale-content').innerHTML = q.rationale;
    rBox.classList.remove('hidden');

    // ‚úÖ render MathJax c·∫£ ph·∫ßn gi·∫£i th√≠ch
    typesetMath();
  }

  function nextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) loadQuestion();
    else endGame();
  }

  function endGame() {
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('end-screen').classList.remove('hidden');

    document.getElementById('final-score').innerText = score + "/" + (questions.length * 10);
    const msg = document.getElementById('end-message');

    playSound('end');
    fireConfetti();

    if (score >= (questions.length * 10) * 0.87) msg.innerText = "Xu·∫•t s·∫Øc! C√¥ Thu B√¨nh r·∫•t t·ª± h√†o v·ªÅ em!";
    else if (score >= (questions.length * 10) * 0.67) msg.innerText = "L√†m t·ªët l·∫Øm! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c.";
    else msg.innerText = "C·ªë g·∫Øng th√™m nh√©! H√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch.";
  }

  // =========================
  // CONFETTI
  // =========================
  function fireConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;

    const particles = [];
    const colors = ['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#00bcd4','#009688','#4CAF50','#FFEB3B','#FFC107','#FF9800'];

    for (let i = 0; i < 120; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        w: Math.random() * 10 + 5,
        h: Math.random() * 10 + 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        speed: Math.random() * 5 + 2,
        angle: Math.random() * 6.2
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let active = false;

      particles.forEach(p => {
        p.y += p.speed;
        p.angle += 0.1;
        ctx.fillStyle = p.color;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
        if (p.y < canvas.height) active = true;
      });

      if (active) requestAnimationFrame(draw);
    }
    draw();
  }
</script>

</body>
</html>
