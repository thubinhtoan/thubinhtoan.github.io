<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ª£ SƒÉn Kho B√°u: B√≠ M·∫≠t CƒÉn Th·ª©c - To√°n 9</title>

  <!-- ‚úÖ MathJax (HI·ªÇN TH·ªä D·∫§U CƒÇN ƒê·∫¶Y ƒê·ª¶) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    :root {
      --primary: #8B4513;
      --secondary: #DAA520;
      --bg-color: #FEF9E7;
      --text-color: #3e2723;
      --success: #2E7D32;
      --error: #C62828;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #2c3e50;
      background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%2334495e" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-color);
    }

    #game-container {
      width: 100%;
      max-width: 900px;
      background-color: var(--bg-color);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      overflow: hidden;
      border: 8px solid var(--primary);
      position: relative;
    }

    header {
      background-color: var(--primary);
      color: var(--secondary);
      padding: 15px;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 4px solid #5D4037;
    }

    .game-title {
      font-size: 1.5rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stats {
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      gap: 20px;
    }

    .screen {
      padding: 30px;
      text-align: center;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .hidden { display: none !important; }

    #start-screen h1 {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .btn {
      background: linear-gradient(to bottom, #DAA520, #B8860B);
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 1.2rem;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      box-shadow: 0 4px 0 #8B4513;
      margin-top: 20px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #8B4513; }
    .btn:active { transform: translateY(2px); box-shadow: 0 0 0 #8B4513; }

    #question-area { width: 100%; }

    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--secondary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .level-badge {
      display: inline-block;
      padding: 6px 16px;
      background-color: #607D8B;
      color: white;
      border-radius: 15px;
      font-size: 0.95rem;
      margin-bottom: 15px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .question-text {
      font-size: 1.8rem;
      margin-bottom: 22px;
      color: var(--text-color);
      font-weight: 700;
      line-height: 1.25;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%;
      max-width: 800px;
      align-items: stretch;
    }

    .option-btn {
      background-color: white;
      border: 2px solid #D7CCC8;
      padding: 18px 16px;
      font-size: 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #4e342e;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 78px;

      /* ‚úÖ tr√°nh MathJax b·ªã c·∫Øt d·∫•u cƒÉn */
      overflow: visible;
    }

    .option-btn:hover:not(:disabled) {
      background-color: #FFF8E1;
      border-color: var(--secondary);
      transform: scale(1.02);
    }

    .option-btn.correct {
      background-color: #C8E6C9;
      border-color: var(--success);
      color: var(--success);
    }

    .option-btn.wrong {
      background-color: #FFCDD2;
      border-color: var(--error);
      color: var(--error);
      opacity: 0.75;
    }

    /* ‚úÖ Khung gi·∫£i th√≠ch: ch·ªØ to h∆°n */
    #rationale-box {
      margin-top: 18px;
      padding: 18px 18px;
      border-radius: 12px;
      background-color: #FFF3E0;
      border-left: 6px solid var(--secondary);
      text-align: left;
      animation: slideIn 0.25s ease;
      width: 100%;
      max-width: 820px;
    }

    #rationale-title {
      font-weight: 900;
      color: var(--primary);
      margin-bottom: 8px;
      display: block;
      font-size: 1.3rem;
    }

    #rationale-content {
      font-size: 1.3rem; /* ‚úÖ C√î MU·ªêN TO H∆†N: tƒÉng l√™n 1.3rem */
      line-height: 1.35;
      color: #4e342e;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .score-big {
      font-size: 4rem;
      color: var(--primary);
      font-weight: bold;
      margin: 20px 0;
    }

    .message {
      font-size: 1.5rem;
      color: #555;
      margin-bottom: 30px;
    }

    #confetti-canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    /* ‚úÖ MathJax SVG: tr√°nh xu·ªëng d√≤ng v√† tr√°nh b·ªã c·∫Øt */
    .mjx-container { overflow: visible !important; }
    mjx-container { overflow: visible !important; }

    @media (max-width: 650px) {
      .options-grid { grid-template-columns: 1fr; }
      .question-text { font-size: 1.45rem; }
      .stats { font-size: 0.95rem; gap: 10px; }
      #rationale-content { font-size: 1.12rem; }
    }
  </style>
</head>

<body>
<div id="game-container">
  <canvas id="confetti-canvas"></canvas>

  <header>
    <div class="game-title">üóùÔ∏è Th·ª£ SƒÉn Kho B√°u</div>
    <div class="stats">
      <span>C√¢u: <span id="q-current">1</span>/15</span>
      <span>ƒêi·ªÉm: <span id="score">0</span></span>
    </div>
  </header>

  <!-- START SCREEN -->
  <div id="start-screen" class="screen">
    <div style="font-size: 4rem; margin-bottom: 10px;">üíé</div>
    <h1>B√≠ M·∫≠t CƒÉn Th·ª©c</h1>
    <p style="font-size: 1.2rem; max-width: 650px; margin-bottom: 20px;">
      Ch√†o m·ª´ng c√°c em ƒë·∫øn v·ªõi cu·ªôc phi√™u l∆∞u! H√£y d√πng ki·∫øn th·ª©c v·ªÅ
      <b>‚ÄúBi·∫øn ƒë·ªïi ƒë∆°n gi·∫£n bi·ªÉu th·ª©c ch·ª©a cƒÉn th·ª©c b·∫≠c hai‚Äù</b> ƒë·ªÉ m·ªü kh√≥a kho b√°u.
    </p>
    <p style="color: #666;">Gi√°o vi√™n: C√¥ Thu B√¨nh</p>
    <button class="btn" onclick="startGame()">B·∫Øt ƒê·∫ßu H√†nh Tr√¨nh</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen" class="screen hidden">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

    <div id="question-area">
      <span id="level-badge" class="level-badge">Nh·∫≠n Bi·∫øt</span>
      <div id="question-text" class="question-text">C√¢u h·ªèi s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>

      <div id="options-container" class="options-grid"></div>

      <div id="rationale-box" class="hidden">
        <span id="rationale-title">üí° Gi·∫£i th√≠ch:</span>
        <div id="rationale-content">N·ªôi dung gi·∫£i th√≠ch...</div>
        <div style="text-align: right; margin-top: 10px;">
          <button class="btn" onclick="nextQuestion()" style="padding: 10px 28px; font-size: 1rem;">Ti·∫øp t·ª•c ‚û°Ô∏è</button>
        </div>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="end-screen" class="screen hidden">
    <div style="font-size: 4rem;">üèÜ</div>
    <h1 style="color: var(--primary);">Ho√†n Th√†nh Nhi·ªám V·ª•!</h1>
    <div class="score-big" id="final-score">0</div>
    <p class="message" id="end-message">B·∫°n l√†m r·∫•t t·ªët!</p>
    <button class="btn" onclick="location.reload()">Ch∆°i L·∫°i</button>
  </div>
</div>

<script>
  // =========================
  // ‚úÖ DATA (ƒê√É CHUY·ªÇN SANG LaTeX ƒë·ªÉ cƒÉn th·ª©c hi·ªÉn th·ªã ƒë·∫πp)
  // =========================
const rawQuestions = [
  // Nh·∫≠n bi·∫øt
  {
    id: 1,
    level: "Nh·∫≠n bi·∫øt",
    question: 
      "C√¥ng th·ª©c kh·ª≠ m·∫´u c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(\\sqrt{\\frac{A}{B}}\\)<br/>" +
      "v·ªõi $AB \\ge 0$ v√† $B \\ne 0$ l√† g√¨?",
    options: [
      "$\\frac{\\sqrt{AB}}{B}$",
      "$\\frac{\\sqrt{AB}}{|B|}$",
      "$\\frac{A\\sqrt{B}}{B}$",
      "$A\\sqrt{B}$"
    ],
    correct: 1,
    rationale:
      "Theo quy t·∫Øc kh·ª≠ m·∫´u, ta nh√¢n c·∫£ t·ª≠ v√† m·∫´u v·ªõi $B$ ƒë·ªÉ m·∫´u tr·ªü th√†nh b√¨nh ph∆∞∆°ng: " +
      "$\\sqrt{\\frac{A}{B}} = \\sqrt{\\frac{AB}{B^2}} = \\frac{\\sqrt{AB}}{|B|}$."
  },
  {
    id: 2,
    level: "Nh·∫≠n bi·∫øt",
   question:
      "Bi·ªÉu th·ª©c li√™n h·ª£p c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(\\sqrt{3} - 1\\)<br/>" +
      "d√πng ƒë·ªÉ tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u l√† g√¨?",
    options: [
      "$\\sqrt{3} - 1$",
      "$-\\sqrt{3} + 1$",
      "$\\sqrt{3} + 1$",
      "$\\sqrt{3}$"
    ],
    correct: 2,
    rationale:
      "ƒê·ªÉ t·∫°o ra h·∫±ng ƒë·∫≥ng th·ª©c hi·ªáu hai b√¨nh ph∆∞∆°ng $A^2 - B^2$, bi·ªÉu th·ª©c li√™n h·ª£p c·ªßa " +
      "$\\sqrt{A} - B$ l√† $\\sqrt{A} + B$. V·∫≠y li√™n h·ª£p c·ªßa $\\sqrt{3}-1$ l√† $\\sqrt{3}+1$."
  },
  {
    id: 3,
    level: "Nh·∫≠n bi·∫øt",
    question:
      "K·∫øt qu·∫£ c·ªßa ph√©p ƒë∆∞a th·ª´a s·ªë ra ngo√†i d·∫•u cƒÉn c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(\\sqrt{12}\\)<br/>" +
      "l√†:",
    options: [
      "$2\\sqrt{3}$",
      "$3\\sqrt{2}$",
      "$4\\sqrt{3}$",
      "$6\\sqrt{2}$"
    ],
    correct: 0,
    rationale:
      "Ta ph√¢n t√≠ch $12 = 4\\cdot3 = 2^2\\cdot3$. ƒê∆∞a th·ª´a s·ªë $2$ ra ngo√†i d·∫•u cƒÉn ta ƒë∆∞·ª£c $2\\sqrt{3}$."
  },
  {
    id: 4,
    level: "Nh·∫≠n bi·∫øt",
   question:
      "ƒê∆∞a th·ª´a s·ªë v√†o trong d·∫•u cƒÉn c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(3\\sqrt{2}\\)<br/>" +
      "ta ƒë∆∞·ª£c:",
    options: [
      "$\\sqrt{6}$",
      "$\\sqrt{12}$",
      "$\\sqrt{18}$",
      "$\\sqrt{36}$"
    ],
    correct: 2,
    rationale:
      "ƒê∆∞a th·ª´a s·ªë d∆∞∆°ng v√†o trong cƒÉn: $3\\sqrt{2} = \\sqrt{3^2\\cdot2} = \\sqrt{9\\cdot2} = \\sqrt{18}$."
  },
  {
    id: 5,
    level: "Nh·∫≠n bi·∫øt",
    question: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† SAI v·ªÅ ph√©p tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u?",
    options: [
      "$\\frac{2}{\\sqrt{3}} = \\frac{2\\sqrt{3}}{3}$",
      "$\\frac{1}{2+\\sqrt{3}} = 2-\\sqrt{3}$",
      "$\\frac{a}{\\sqrt{b}} = \\frac{a\\sqrt{b}}{b} (b>0)$",
      "$\\frac{1}{\\sqrt{5}} = \\frac{1}{5}$"
    ],
    correct: 3,
    rationale:
      "Kh·∫≥ng ƒë·ªãnh D sai. ƒê√∫ng ph·∫£i l√†: $\\frac{1}{\\sqrt{5}} = \\frac{\\sqrt{5}}{5}$."
  },
  {
    id: 6,
    level: "Nh·∫≠n bi·∫øt",
   question:
      "V·ªõi $x \\ge 0$, gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(\\sqrt{x}(\\sqrt{x} + 2)\\)<br/>" +
      "b·∫±ng:",
    options: [
      "$x + 2$",
      "$\\sqrt{x} + 2\\sqrt{x}$",
      "$2x$",
      "$x + 2\\sqrt{x}$"
    ],
    correct: 3,
    rationale:
      "$\\sqrt{x}(\\sqrt{x}+2) = (\\sqrt{x})^2 + 2\\sqrt{x} = x + 2\\sqrt{x}$."
  },

  // Th√¥ng hi·ªÉu
  {
    id: 7,
    level: "Th√¥ng hi·ªÉu",
    question:
      "R√∫t g·ªçn bi·ªÉu th·ª©c:<br/>" +
      "\\(M = 2\\sqrt{3} + \\sqrt{27} - \\sqrt{12}\\)<br/>" +
      "ta ƒë∆∞·ª£c:",
    options: [
      "$3\\sqrt{3}$",
      "$4\\sqrt{3}$",
      "$\\sqrt{3}$",
      "$5\\sqrt{3}$"
    ],
    correct: 0,
    rationale:
      "$M = 2\\sqrt{3} + \\sqrt{9\\cdot3} - \\sqrt{4\\cdot3} = 2\\sqrt{3} + 3\\sqrt{3} - 2\\sqrt{3} = 3\\sqrt{3}$."
  },
  {
    id: 8,
    level: "Th√¥ng hi·ªÉu",
    question:
      "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(\\frac{4}{\\sqrt{5}-1}\\)<br/>" +
      "ta ƒë∆∞·ª£c k·∫øt qu·∫£ l√†:",
    options: [
      "$4(\\sqrt{5}+1)$",
      "$\\sqrt{5}+1$",
      "$\\sqrt{5}-1$",
      "$2(\\sqrt{5}+1)$"
    ],
    correct: 1,
    rationale:
      "$\\frac{4}{\\sqrt{5}-1} = \\frac{4(\\sqrt{5}+1)}{5-1} = \\sqrt{5}+1$."
  },
  {
    id: 9,
    level: "Th√¥ng hi·ªÉu",
   question:
      "R√∫t g·ªçn bi·ªÉu th·ª©c:<br/>" +
      "\\(\\sqrt{18a^2}\\)<br/>" +
      "v·ªõi $a < 0$.",
    options: [
      "$3a\\sqrt{2}$",
      "$-3a\\sqrt{2}$",
      "$3\\sqrt{2a}$",
      "$-3\\sqrt{2a}$"
    ],
    correct: 1,
    rationale:
      "$\\sqrt{18a^2} = \\sqrt{9\\cdot2\\cdot a^2} = 3\\sqrt{2}|a|$. V√¨ $a<0$ n√™n $|a|=-a$, ƒë∆∞·ª£c $-3a\\sqrt{2}$."
  },
  {
    id: 10,
    level: "Th√¥ng hi·ªÉu",
   question:
      "Gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\((\\sqrt{3}-2)(\\sqrt{3}+2)\\)<br/>" +
      "l√†:",
    options: ["7", "1", "-1", "-7"],
    correct: 2,
    rationale:
      "$(\\sqrt{3}-2)(\\sqrt{3}+2) = (\\sqrt{3})^2 - 2^2 = 3-4 = -1$."
  },
  {
    id: 11,
    level: "Th√¥ng hi·ªÉu",
    question:
      "Kh·ª≠ m·∫´u c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(\\sqrt{\\frac{5a}{2}}\\)<br/>" +
      "v·ªõi $a > 0$ ta ƒë∆∞·ª£c:",
    options: [
      "$\\frac{5\\sqrt{a}}{2}$",
      "$\\frac{\\sqrt{5a}}{2}$",
      "$\\frac{\\sqrt{10a}}{4}$",
      "$\\frac{\\sqrt{10a}}{2}$"
    ],
    correct: 3,
    rationale:
      "$\\sqrt{\\frac{5a}{2}} = \\sqrt{\\frac{5a\\cdot2}{2\\cdot2}} = \\frac{\\sqrt{10a}}{\\sqrt{4}} = \\frac{\\sqrt{10a}}{2}$."
  },

  // V·∫≠n d·ª•ng
  {
    id: 12,
    level: "V·∫≠n d·ª•ng",
   question:
      "R√∫t g·ªçn bi·ªÉu th·ª©c:<br/>" +
      "\\(P = \\frac{a - \\sqrt{a}}{\\sqrt{a} - 1}\\)<br/>" +
      "v·ªõi $a \\ge 0, a \\ne 1$.",
    options: ["$\\sqrt{a}$", "$\\sqrt{a} + 1$", "$\\sqrt{a} - 1$", "$a$"],
    correct: 0,
    rationale:
      "$a-\\sqrt{a} = \\sqrt{a}(\\sqrt{a}-1)$ n√™n $P = \\sqrt{a}$."
  },
  {
    id: 13,
    level: "V·∫≠n d·ª•ng",
   question:
      "T√¨m $x$ bi·∫øt:<br/>" +
      "\\(\\sqrt{4x} + \\sqrt{x} = 6\\)<br/>" +
      "(v·ªõi $x \\ge 0$).",
    options: ["$x = 2$", "$x = 4$", "$x = 9$", "$x = 16$"],
    correct: 1,
    rationale:
      "$\\sqrt{4x}=2\\sqrt{x}$ n√™n $3\\sqrt{x}=6 \\Rightarrow \\sqrt{x}=2 \\Rightarrow x=4$."
  },
  {
    id: 14,
    level: "V·∫≠n d·ª•ng (Th·ª±c t·∫ø)",
    question:
      "M·ªôt m·∫£nh v∆∞·ªùn h√¨nh ch·ªØ nh·∫≠t c√≥:<br/>" +
      "Chi·ªÅu d√†i $\\sqrt{32}$ m, chi·ªÅu r·ªông $\\sqrt{8}$ m.<br/>" +
      "Di·ªán t√≠ch c·ªßa m·∫£nh v∆∞·ªùn l√†:",
    options: ["$8 m^2$", "$12 m^2$", "$16 m^2$", "$32 m^2$"],
    correct: 2,
    rationale:
      "Di·ªán t√≠ch $=\\sqrt{32}\\cdot\\sqrt{8}=\\sqrt{256}=16\\,m^2$."
  },

  // V·∫≠n d·ª•ng cao
  {
    id: 15,
    level: "V·∫≠n d·ª•ng cao",
  question:
      "T√≠nh gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c:<br/>" +
      "\\(A = \\frac{1}{\\sqrt{2}+1} + \\frac{1}{\\sqrt{3}+\\sqrt{2}} + \\frac{1}{\\sqrt{4}+\\sqrt{3}}\\)",
    options: ["1", "2", "3", "$\\sqrt{2}$"],
    correct: 0,
    rationale:
      "Tr·ª•c cƒÉn: $A=(\\sqrt{2}-1)+ (\\sqrt{3}-\\sqrt{2}) + (\\sqrt{4}-\\sqrt{3}) = -1+2 = 1$."
  }
];

  // =========================
  // ‚úÖ CHU·∫®N B·ªä: random A/B/C/D + c√¢n t∆∞∆°ng ƒë·ªëi ƒë√°p √°n ƒë√∫ng
  // =========================
  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function shuffleKeepCorrect(q, desiredPos, maxTries = 40) {
    // t·∫°o c√°c ho√°n v·ªã v√† ch·ªçn c√°i ƒë∆∞a ƒë√°p √°n ƒë√∫ng v√†o v·ªã tr√≠ mong mu·ªën (n·∫øu ƒë∆∞·ª£c)
    const n = q.options.length;
    for (let t = 0; t < maxTries; t++) {
      const idx = shuffleArray([...Array(n).keys()]);
      const newOptions = idx.map(i => q.options[i]);
      const newCorrect = idx.indexOf(q.correct);
      if (newCorrect === desiredPos) {
        return { ...q, options: newOptions, correct: newCorrect };
      }
    }
    // n·∫øu kh√¥ng kh·ªõp th√¨ random th∆∞·ªùng
    const idx = shuffleArray([...Array(n).keys()]);
    const newOptions = idx.map(i => q.options[i]);
    const newCorrect = idx.indexOf(q.correct);
    return { ...q, options: newOptions, correct: newCorrect };
  }

  function prepareQuestionsBalanced(raw) {
    const n = raw.length;
    const target = [0,0,0,0].map(() => Math.floor(n / 4));
    for (let i = 0; i < (n % 4); i++) target[i]++; // chia d∆∞: A,B,C,... nh·∫≠n th√™m 1

    const count = [0,0,0,0];
    const prepared = [];

    raw.forEach(q => {
      // ch·ªçn v·ªã tr√≠ ƒëang thi·∫øu nhi·ªÅu nh·∫•t
      let desiredPos = 0;
      let bestNeed = -Infinity;
      for (let p = 0; p < 4; p++) {
        const need = target[p] - count[p];
        if (need > bestNeed) { bestNeed = need; desiredPos = p; }
      }

      const sq = shuffleKeepCorrect(q, desiredPos);
      count[sq.correct]++;
      prepared.push(sq);
    });

    return prepared;
  }

  const questions = prepareQuestionsBalanced(rawQuestions);

  // =========================
  // GAME STATE
  // =========================
  let currentQuestionIndex = 0;
  let score = 0;
  let isAnswering = true;

  // =========================
  // AUDIO (gi·ªØ nh·∫π)
  // =========================
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(type) {
    if (!audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'correct') {
      osc.type = 'sine';
      osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
      osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.45);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.45);
    } else if (type === 'wrong') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(150, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.22, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.28);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.28);
    } else if (type === 'end') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(440, audioCtx.currentTime);
      osc.frequency.setValueAtTime(554, audioCtx.currentTime + 0.2);
      osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.22, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.1);
      osc.start();
      osc.stop(audioCtx.currentTime + 1.1);
    }
  }

  // =========================
  // MATHJAX REFRESH
  // =========================
  function typesetMath() {
    if (window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetClear?.();
      window.MathJax.typesetPromise();
    }
  }

  // =========================
  // LOGIC
  // =========================
  function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    currentQuestionIndex = 0;
    score = 0;
    document.getElementById('score').innerText = score;
    loadQuestion();
  }

  function loadQuestion() {
    const q = questions[currentQuestionIndex];

    document.getElementById('q-current').innerText = currentQuestionIndex + 1;
    document.getElementById('level-badge').innerText = q.level;

    // ‚úÖ d√πng innerHTML ƒë·ªÉ MathJax ch·∫°y
    document.getElementById('question-text').innerHTML = q.question ?? q.text ?? "";

    // Progress
    const pct = (currentQuestionIndex / questions.length) * 100;
    document.getElementById('progress-fill').style.width = pct + "%";

    // Options
    const container = document.getElementById('options-container');
    container.innerHTML = '';

    q.options.forEach((opt, index) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.innerHTML = `<span style="font-weight:900;margin-right:10px;">${String.fromCharCode(65+index)}.</span> <span>${opt}</span>`;
      btn.onclick = () => checkAnswer(index, btn);
      container.appendChild(btn);
    });

    // Hide rationale
    document.getElementById('rationale-box').classList.add('hidden');
    isAnswering = true;

    // ‚úÖ render MathJax
    typesetMath();
  }

  function checkAnswer(selectedIndex, btnElement) {
    if (!isAnswering) return;
    isAnswering = false;

    const q = questions[currentQuestionIndex];
    const buttons = document.querySelectorAll('.option-btn');

    if (selectedIndex === q.correct) {
      btnElement.classList.add('correct');
      btnElement.innerHTML += " <span style='margin-left:8px;'>üòÉ</span>";
      score += 10;
      document.getElementById('score').innerText = score;
      playSound('correct');
      fireConfetti();
    } else {
      btnElement.classList.add('wrong');
      btnElement.innerHTML += " <span style='margin-left:8px;'>üò¢</span>";
      buttons[q.correct].classList.add('correct');
      playSound('wrong');
    }

    buttons.forEach(b => b.disabled = true);

    const rBox = document.getElementById('rationale-box');
    document.getElementById('rationale-content').innerHTML = q.rationale;
    rBox.classList.remove('hidden');

    // ‚úÖ render MathJax c·∫£ ph·∫ßn gi·∫£i th√≠ch
    typesetMath();
  }

  function nextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) loadQuestion();
    else endGame();
  }

  function endGame() {
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('end-screen').classList.remove('hidden');

    document.getElementById('final-score').innerText = score + "/" + (questions.length * 10);
    const msg = document.getElementById('end-message');

    playSound('end');
    fireConfetti();

    if (score >= (questions.length * 10) * 0.87) msg.innerText = "Xu·∫•t s·∫Øc! C√¥ Thu B√¨nh r·∫•t t·ª± h√†o v·ªÅ em!";
    else if (score >= (questions.length * 10) * 0.67) msg.innerText = "L√†m t·ªët l·∫Øm! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c.";
    else msg.innerText = "C·ªë g·∫Øng th√™m nh√©! H√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch.";
  }

  // =========================
  // CONFETTI
  // =========================
  function fireConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;

    const particles = [];
    const colors = ['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#00bcd4','#009688','#4CAF50','#FFEB3B','#FFC107','#FF9800'];

    for (let i = 0; i < 120; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        w: Math.random() * 10 + 5,
        h: Math.random() * 10 + 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        speed: Math.random() * 5 + 2,
        angle: Math.random() * 6.2
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let active = false;

      particles.forEach(p => {
        p.y += p.speed;
        p.angle += 0.1;
        ctx.fillStyle = p.color;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
        if (p.y < canvas.height) active = true;
      });

      if (active) requestAnimationFrame(draw);
    }
    draw();
  }
</script>

</body>
</html>
