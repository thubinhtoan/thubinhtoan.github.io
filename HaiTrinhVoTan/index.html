<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·∫£i Tr√¨nh V√¥ T·∫≠n - To√°n 9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pirata+One&family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #001e26;
            color: #e0f7fa;
            overflow: hidden;
            user-select: none;
        }

        .pirate-font {
            font-family: 'Pirata One', cursive;
            letter-spacing: 1px;
        }

        /* --- Dynamic Ocean Background --- */
        #ocean {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background: linear-gradient(to bottom, #4fc3f7 0%, #0288d1 40%, #01579b 100%);
            overflow: hidden;
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100px;
            background: url('https://raw.githubusercontent.com/yagoestevez/fcc-portfolio/master/src/Components/Landing/wave.svg') repeat-x; 
            background-size: 50% 100%;
            opacity: 0.8;
            animation: wave 10s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite;
            transform: translate3d(0, 0, 0);
        }

        .wave:nth-of-type(2) {
            bottom: 10px;
            animation: wave 7s cubic-bezier(0.36, 0.45, 0.63, 0.53) -.125s infinite, swell 7s ease -1.25s infinite;
            opacity: 0.6;
        }

        @keyframes wave {
            0% { margin-left: 0; }
            100% { margin-left: -100%; }
        }

        @keyframes swell {
            0%, 100% { transform: translate3d(0, -25px, 0); }
            50% { transform: translate3d(0, 5px, 0); }
        }

        /* --- Game Panel (Parchment) --- */
        .parchment {
            background: #fdf5e6; /* Old paper color */
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: #3e2723;
            border: 8px solid #8d6e63;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 40px rgba(161, 136, 127, 0.6);
            position: relative;
        }

        .parchment::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 2px dashed #5d4037;
            margin: 6px;
            pointer-events: none;
        }

        /* --- Buttons --- */
        .btn-pirate {
            background: #5d4037;
            color: #fff8e1;
            border: 2px solid #3e2723;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            font-family: 'Pirata One', cursive;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }

        .btn-pirate:hover {
            background: #795548;
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            cursor: pointer;
        }

        .btn-pirate.correct {
            background: #2e7d32 !important;
            border-color: #1b5e20 !important;
            box-shadow: 0 0 15px #4caf50;
        }

        .btn-pirate.wrong {
            background: #c62828 !important;
            border-color: #b71c1c !important;
            animation: shake 0.4s;
        }

        /* --- Explanation Box (Captain's Log) --- */
        #log-box {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 2px solid #ffd700;
            border-radius: 8px;
            transition: all 0.5s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding: 0 1rem;
        }

        #log-box.show {
            max-height: 300px;
            opacity: 1;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* --- Math Display --- */
        .system-eq {
            display: inline-flex;
            flex-direction: column;
            text-align: left;
            border-left: 3px solid currentColor;
            padding-left: 8px;
            border-radius: 4px 0 0 4px;
            vertical-align: middle;
            line-height: 1.4;
        }

        /* --- Animations --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #ship {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 5rem;
            animation: float-ship 3s ease-in-out infinite;
            z-index: -1;
            filter: drop-shadow(0 10px 5px rgba(0,0,0,0.3));
        }

        @keyframes float-ship {
            0%, 100% { transform: translateX(-50%) rotate(2deg) translateY(0); }
            50% { transform: translateX(-50%) rotate(-2deg) translateY(-10px); }
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Ocean Background -->
    <div id="ocean">
        <div class="wave"></div>
        <div class="wave"></div>
    </div>
    <div id="ship">üè¥‚Äç‚ò†Ô∏è</div>

    <!-- Start Screen -->
    <div id="start-screen" class="parchment p-10 text-center max-w-2xl w-full z-10">
        <h1 class="pirate-font text-6xl text-amber-900 mb-2 drop-shadow-sm">H·∫¢I TR√åNH V√î T·∫¨N</h1>
        <h2 class="text-xl text-amber-800 mb-6 font-bold uppercase tracking-widest">Kho B√°u ƒê·∫°i D∆∞∆°ng</h2>
        
        <p class="text-lg text-brown-900 mb-8 leading-relaxed font-serif italic">
            "H·ª°i ng∆∞·ªùi th·ªßy th·ªß can tr∆∞·ªùng! B·∫£n ƒë·ªì kho b√°u ƒë∆∞·ª£c m√£ h√≥a b·∫±ng c√°c <b>H·ªá Ph∆∞∆°ng Tr√¨nh</b>. 
            H√£y gi·∫£i m√£ 15 c√¢u ƒë·ªë ƒë·ªÉ t√¨m ra h√≤n ƒë·∫£o v√†ng!"
        </p>

        <div class="grid grid-cols-2 gap-4 text-left bg-orange-100/50 p-4 rounded mb-8 border border-amber-300">
            <div class="text-green-800 font-bold">‚öì 6 C√¢u Nh·∫≠n Bi·∫øt</div>
            <div class="text-blue-800 font-bold">üß≠ 5 C√¢u Th√¥ng Hi·ªÉu</div>
            <div class="text-purple-800 font-bold">üí£ 3 C√¢u V·∫≠n D·ª•ng</div>
            <div class="text-red-800 font-bold">üëë 1 C√¢u V·∫≠n D·ª•ng Cao</div>
        </div>

        <button onclick="startGame()" class="btn-pirate px-10 py-4 rounded text-2xl shadow-lg w-full md:w-auto">
            NH·ªî NEO RA KH∆†I! üåä
        </button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden w-full max-w-4xl z-10 flex-col h-full justify-center">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 px-2">
            <div class="parchment px-4 py-2 rounded shadow-md">
                <div class="text-xs text-amber-800 uppercase font-bold">Th·ª≠ th√°ch</div>
                <div class="text-xl font-bold text-amber-900 pirate-font">C√¢u <span id="q-number">1</span>/15</div>
            </div>
            <div class="parchment px-4 py-2 rounded shadow-md">
                <div class="text-xs text-amber-800 uppercase font-bold">Kho b√°u</div>
                <div class="text-xl font-bold text-yellow-600" id="score">0</div>
            </div>
        </div>

        <!-- Question Panel -->
        <div class="parchment p-8 mb-4 relative min-h-[160px] flex flex-col justify-center items-center text-center">
            <div id="level-badge" class="absolute -top-3 bg-amber-800 text-white px-3 py-1 text-xs rounded shadow uppercase font-bold">Nh·∫≠n Bi·∫øt</div>
            <div id="question-text" class="text-2xl font-bold text-amber-900 leading-relaxed">
                Loading map data...
            </div>
        </div>

        <!-- Explanation (Log) -->
        <div id="log-box">
            <div class="text-yellow-400 font-bold mb-1 border-b border-yellow-600 pb-1 pirate-font tracking-wide">üìñ NH·∫¨T K√ù THUY·ªÄN TR∆Ø·ªûNG:</div>
            <div id="log-content" class="text-gray-200 font-light leading-relaxed"></div>
        </div>

        <!-- Options -->
        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Buttons injected here -->
        </div>

        <!-- Next Button -->
        <div id="next-btn-container" class="hidden text-center pb-4">
            <button onclick="nextQuestion()" class="btn-pirate px-12 py-3 rounded text-xl animate-bounce bg-blue-700 border-blue-900">
                TI·∫æP T·ª§C H√ÄNH TR√åNH ‚ûú
            </button>
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/80">
        <div class="parchment p-10 text-center max-w-2xl w-full mx-4">
            <div class="text-7xl mb-4">üèùÔ∏è</div>
            <h2 class="pirate-font text-5xl text-amber-800 mb-4">T√åM TH·∫§Y ƒê·∫¢O GI·∫§U V√ÄNG!</h2>
            <p class="text-xl text-amber-900 mb-6 font-serif italic">"Ch√∫c m·ª´ng thuy·ªÅn tr∆∞·ªüng! Ng∆∞∆°i ƒë√£ chinh ph·ª•c ƒê·∫°i d∆∞∆°ng To√°n h·ªçc."</p>
            
            <div class="bg-orange-100 p-4 rounded border border-amber-300 inline-block mb-8 w-full">
                <div class="text-sm text-amber-700 uppercase mb-1">T·ªïng S·ªë V√†ng Thu ƒê∆∞·ª£c</div>
                <div class="text-6xl font-bold text-yellow-600 pirate-font" id="final-score">0</div>
            </div>

            <div>
                <button onclick="location.reload()" class="btn-pirate px-8 py-3 rounded text-xl w-full">
                    CH∆†I L·∫†I T·ª™ ƒê·∫¶U
                </button>
            </div>
        </div>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" class="fixed top-0 left-0 pointer-events-none z-50 w-full h-full"></canvas>

    <script>
        // --- DATA ---
        // 15 Questions: Linear Equations & Systems (To√°n 9 - Ch∆∞∆°ng 1 - B√†i 2)
        // ƒê√°p √°n ƒë√£ ƒë∆∞·ª£c ph√¢n b·ªë ƒë·ªÅu A/B/C/D.

        const questions = [
            // LEVEL 1: NH·∫¨N BI·∫æT (6 c√¢u)
            {
                q: "Ph∆∞∆°ng tr√¨nh n√†o sau ƒë√¢y l√† ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n?",
                a: [
                    "2x + y = 3",          // ƒê√öNG (gi·ªØ ·ªü A)
                    "0x + 0y = 5",
                    "x<sup>2</sup> + y = 1",
                    "3x - 1 = 0"
                ],
                correct: 0,
                rationale: "Ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n c√≥ d·∫°ng ax + by = c v·ªõi a, b kh√¥ng ƒë·ªìng th·ªùi b·∫±ng 0.<br>2x + y = 3 th·ªèa m√£n (a=2, b=1).",
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "C·∫∑p s·ªë (1; -2) l√† nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh n√†o sau ƒë√¢y?",
                a: [
                    "x - y = 1",
                    "2x + y = 0",         // ƒê√öNG (ƒë·∫∑t ·ªü B)
                    "x + y = 3",
                    "3x - y = 1"
                ],
                correct: 1,
                rationale: "Thay x=1, y=-2 v√†o 2x + y = 0:<br>2(1) + (-2) = 2 - 2 = 0 (ƒê√∫ng).",
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "H·ªá ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n c√≥ d·∫°ng t·ªïng qu√°t l√†:",
                a: [
                    "ax + by = c",  // ch·ªâ 1 ph∆∞∆°ng tr√¨nh
                    "<div class='system-eq'><span>ax<sup>2</sup> + by = c</span><span>a'x + b'y = c'</span></div>",
                    "<div class='system-eq'><span>ax + by = c</span><span>a'x + b'y = c'</span></div>",  // ƒê√öNG (C)
                    "<div class='system-eq'><span>ax + by = c</span><span>a'x + b'y<sup>2</sup> = c'</span></div>"
                ],
                correct: 2,
                rationale: "H·ªá hai ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n g·ªìm hai ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n ax+by=c v√† a'x+b'y=c'.",
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "Trong c√°c h·ªá ph∆∞∆°ng tr√¨nh sau, h·ªá n√†o l√† h·ªá ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n?",
                a: [
                    "<div class='system-eq'><span>x + y = 3</span><span>x<sup>2</sup> - y = 1</span></div>",
                    "<div class='system-eq'><span>x + y = 3</span><span>xy = 1</span></div>",
                    "<div class='system-eq'><span>1/x + y = 3</span><span>x - y = 1</span></div>",
                    "<div class='system-eq'><span>x + y = 3</span><span>2x - y = 1</span></div>"  // ƒê√öNG (D)
                ],
                correct: 3,
                rationale: "H·ªá D g·ªìm c√°c ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t (b·∫≠c 1) ƒë·ªëi v·ªõi x v√† y.",
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "Ph∆∞∆°ng tr√¨nh 3x - 2y = 6 c√≥ bao nhi√™u nghi·ªám?",
                a: [
                    "V√¥ s·ªë nghi·ªám",        // ƒê√öNG (A)
                    "1 nghi·ªám duy nh·∫•t",
                    "2 nghi·ªám",
                    "V√¥ nghi·ªám"
                ],
                correct: 0,
                rationale: "M·ªçi ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n ax + by = c (v·ªõi a, b kh√¥ng ƒë·ªìng th·ªùi b·∫±ng 0) ƒë·ªÅu c√≥ v√¥ s·ªë nghi·ªám.",
                level: "NH·∫¨N BI·∫æT"
            },
            {
                q: "Cho h·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>x = 2</span><span>y = 3</span></div>. Nghi·ªám c·ªßa h·ªá l√†:",
                a: [
                    "(3; 2)",
                    "(2; 3)",  // ƒê√öNG (B)
                    "x = 2",
                    "y = 3"
                ],
                correct: 1,
                rationale: "Nghi·ªám c·ªßa h·ªá ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng c·∫∑p s·ªë (x; y). V·∫≠y nghi·ªám l√† (2; 3).",
                level: "NH·∫¨N BI·∫æT"
            },

            // LEVEL 2: TH√îNG HI·ªÇU (5 c√¢u)
            {
                q: "Bi·ªÉu di·ªÖn y theo x t·ª´ ph∆∞∆°ng tr√¨nh 4x - 2y = 6, ta ƒë∆∞·ª£c:",
                a: [
                    "y = 4x - 6",
                    "y = 2x + 3",
                    "y = 2x - 3",  // ƒê√öNG (C)
                    "y = -2x + 3"
                ],
                correct: 2,
                rationale: "4x - 2y = 6 &rArr; -2y = -4x + 6 &rArr; y = 2x - 3.",
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "C·∫∑p s·ªë n√†o sau ƒë√¢y l√† nghi·ªám c·ªßa h·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>x + y = 5</span><span>x - y = 1</span></div>?",
                a: [
                    "(2; 3)",
                    "(4; 1)",
                    "(1; 4)",
                    "(3; 2)"  // ƒê√öNG (D)
                ],
                correct: 3,
                rationale: "Th·ª≠ (3; 2):<br>3 + 2 = 5 (ƒê√∫ng)<br>3 - 2 = 1 (ƒê√∫ng)<br>V·∫≠y (3; 2) l√† nghi·ªám.",
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "T√¨m gi√° tr·ªã c·ªßa m ƒë·ªÉ ph∆∞∆°ng tr√¨nh mx - y = 2 nh·∫≠n c·∫∑p s·ªë (1; -1) l√†m nghi·ªám.",
                a: [
                    "m = 1",   // ƒê√öNG (A)
                    "m = 3",
                    "m = -1",
                    "m = 2"
                ],
                correct: 0,
                rationale: "Thay x = 1, y = -1 v√†o ph∆∞∆°ng tr√¨nh:<br>m(1) - (-1) = 2 &rArr; m + 1 = 2 &rArr; m = 1.",
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "H·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>2x - y = 3</span><span>4x - 2y = 6</span></div> c√≥ bao nhi√™u nghi·ªám?",
                a: [
                    "V√¥ nghi·ªám",
                    "V√¥ s·ªë nghi·ªám",   // ƒê√öNG (B)
                    "1 nghi·ªám duy nh·∫•t",
                    "2 nghi·ªám"
                ],
                correct: 1,
                rationale: "Ta th·∫•y ph∆∞∆°ng tr√¨nh 2 l√† ph∆∞∆°ng tr√¨nh 1 nh√¢n v·ªõi 2 (4x - 2y = 6 &hArr; 2(2x - y) = 2(3)).<br>Hai ph∆∞∆°ng tr√¨nh t∆∞∆°ng ƒë∆∞∆°ng n√™n h·ªá c√≥ v√¥ s·ªë nghi·ªám.",
                level: "TH√îNG HI·ªÇU"
            },
            {
                q: "Tr√™n m·∫∑t ph·∫≥ng t·ªça ƒë·ªô, t·∫≠p nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh x - 2y = 0 ƒë∆∞·ª£c bi·ªÉu di·ªÖn b·ªüi ƒë∆∞·ªùng th·∫≥ng n√†o?",
                a: [
                    "Song song v·ªõi tr·ª•c ho√†nh",
                    "ƒêi qua ƒëi·ªÉm (0; 2)",
                    "ƒêi qua g·ªëc t·ªça ƒë·ªô O(0;0)",  // ƒê√öNG (C)
                    "Song song v·ªõi tr·ª•c tung"
                ],
                correct: 2,
                rationale: "Thay (0; 0) v√†o ph∆∞∆°ng tr√¨nh: 0 - 2(0) = 0 (ƒê√∫ng).<br>V·∫≠y ƒë∆∞·ªùng th·∫≥ng ƒëi qua g·ªëc t·ªça ƒë·ªô.",
                level: "TH√îNG HI·ªÇU"
            },

            // LEVEL 3: V·∫¨N D·ª§NG (3 c√¢u)
            {
                q: "(Th·ª±c t·∫ø) T·ªïng s·ªë tu·ªïi c·ªßa m·∫π v√† con l√† 36. Tu·ªïi m·∫π g·∫•p 5 l·∫ßn tu·ªïi con. G·ªçi x l√† tu·ªïi m·∫π, y l√† tu·ªïi con. H·ªá ph∆∞∆°ng tr√¨nh m√¥ t·∫£ b√†i to√°n l√†:",
                a: [
                    "<div class='system-eq'><span>x - y = 36</span><span>x = 5y</span></div>",
                    "<div class='system-eq'><span>x + y = 36</span><span>y = 5x</span></div>",
                    "<div class='system-eq'><span>xy = 36</span><span>x = 5y</span></div>",
                    "<div class='system-eq'><span>x + y = 36</span><span>x = 5y</span></div>"  // ƒê√öNG (D)
                ],
                correct: 3,
                rationale: "T·ªïng tu·ªïi: x + y = 36.<br>M·∫π g·∫•p 5 l·∫ßn con: x = 5y.",
                level: "V·∫¨N D·ª§NG"
            },
            {
                q: "T√¨m a v√† b ƒë·ªÉ ƒë∆∞·ªùng th·∫≥ng y = ax + b ƒëi qua hai ƒëi·ªÉm A(1; 3) v√† B(2; 5).",
                a: [
                    "a = 2, b = 1",   // ƒê√öNG (A)
                    "a = 1, b = 2",
                    "a = 2, b = -1",
                    "a = -2, b = 5"
                ],
                correct: 0,
                rationale: "Thay A(1;3): 3 = a + b (1)<br>Thay B(2;5): 5 = 2a + b (2)<br>L·∫•y (2) tr·ª´ (1): a = 2 &rArr; b = 1.",
                level: "V·∫¨N D·ª§NG"
            },
            {
                q: "Kh√¥ng c·∫ßn gi·∫£i h·ªá, h√£y x√°c ƒë·ªãnh s·ªë nghi·ªám c·ªßa h·ªá: <div class='system-eq'><span>x + y = 2</span><span>x + y = 5</span></div>",
                a: [
                    "1 nghi·ªám duy nh·∫•t",
                    "V√¥ nghi·ªám",       // ƒê√öNG (B)
                    "V√¥ s·ªë nghi·ªám",
                    "2 nghi·ªám"
                ],
                correct: 1,
                rationale: "V·∫ø tr√°i gi·ªëng nhau (x+y) nh∆∞ng v·∫ø ph·∫£i kh√°c nhau (2 &ne; 5).<br>ƒêi·ªÅu n√†y v√¥ l√Ω n√™n h·ªá v√¥ nghi·ªám (hai ƒë∆∞·ªùng th·∫≥ng song song).",
                level: "V·∫¨N D·ª§NG"
            },

            // LEVEL 4: V·∫¨N D·ª§NG CAO (1 c√¢u)
            {
                q: "Cho h·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>mx + y = 1</span><span>x + my = 1</span></div>. T√¨m m ƒë·ªÉ h·ªá c√≥ nghi·ªám duy nh·∫•t.",
                a: [
                    "m = 1",
                    "m &ne; 0",
                    "m &ne; &plusmn;1",  // ƒê√öNG (C)
                    "m = -1"
                ],
                correct: 2,
                rationale: "H·ªá c√≥ nghi·ªám duy nh·∫•t khi: a/a' &ne; b/b'<br>&rArr; m/1 &ne; 1/m &rArr; m<sup>2</sup> &ne; 1 &rArr; m &ne; 1 v√† m &ne; -1.",
                level: "V·∫¨N D·ª§NG CAO"
            }
        ];

        // --- GAME STATE ---
        let currentQIndex = 0;
        let score = 0;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'cannon') { // Boom
                osc.type = 'square';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'splash') { // Noise
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(50, now);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'correct') { // Ding
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'win') { // Victory
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                    setTimeout(() => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g);
                        g.connect(audioCtx.destination);
                        o.type = 'square';
                        o.frequency.value = f;
                        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                        o.start();
                        o.stop(audioCtx.currentTime + 0.3);
                    }, i * 200);
                });
            }
        }

        // --- GAME LOGIC ---
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            
            playSound('cannon');
            currentQIndex = 0;
            score = 0;
            updateUI();
            loadQuestion();
        }

        function loadQuestion() {
            const q = questions[currentQIndex];
            
            document.getElementById('q-number').innerText = currentQIndex + 1;
            document.getElementById('question-text').innerHTML = q.q;
            document.getElementById('level-badge').innerText = q.level;
            
            // Reset Log
            const logBox = document.getElementById('log-box');
            logBox.classList.remove('show');
            document.getElementById('next-btn-container').classList.add('hidden');

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            
            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "btn-pirate w-full p-4 rounded shadow-md min-h-[80px]";
                btn.innerHTML = opt;
                btn.onclick = () => handleAnswer(idx, q.correct, btn);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, btn) {
            const btns = document.querySelectorAll('.btn-pirate');
            btns.forEach(b => b.disabled = true);

            const q = questions[currentQIndex];
            const logBox = document.getElementById('log-box');
            const content = document.getElementById('log-content');
            
            content.innerHTML = q.rationale;
            logBox.classList.add('show');

            if (selected === correct) {
                btn.classList.add('correct');
                score += 100;
                playSound('correct');
                fireConfetti(30);
            } else {
                btn.classList.add('wrong');
                btns[correct].classList.add('correct');
                playSound('splash');
            }

            updateUI();
            document.getElementById('next-btn-container').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('score').innerText = score;
        }

        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex < questions.length) {
                loadQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            playSound('win');
            setInterval(() => fireConfetti(50), 1000);
        }

        // --- PARTICLES (Gold Coins) ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = [];

        function fireConfetti(amount) {
            for (let i = 0; i < amount; i++) {
                particles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20,
                    life: 100,
                    size: Math.random() * 6 + 3,
                    color: '#ffd700' // Gold
                });
            }
            if(particles.length <= amount) requestAnimationFrame(animateParticles);
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.3; // Gravity
                p.life--;
                
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Shine effect
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();

                if (p.life <= 0) {
                    particles.splice(i, 1);
                    i--;
                }
            }
            if (particles.length > 0) requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

    </script>
</body>
</html>
