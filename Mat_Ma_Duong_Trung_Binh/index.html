<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M·∫≠t M√£ Gen Z: Truy T√¨m ƒê∆∞·ªùng Trung B√¨nh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      background-color: #f0f9ff;
      background-image: radial-gradient(#bae6fd 20%, transparent 20%), radial-gradient(#bae6fd 20%, transparent 20%);
      background-position: 0 0, 10px 10px;
      background-size: 20px 20px;
      overflow-x: hidden;
    }
    .font-comic { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }

    .comic-box {
      background: white;
      border: 4px solid #000;
      box-shadow: 8px 8px 0px #000;
      border-radius: 12px;
      position: relative;
    }

    .btn-comic {
      border: 3px solid #000;
      box-shadow: 4px 4px 0px #000;
      transition: all 0.1s;
      text-transform: uppercase;
      font-weight: 900;
    }
    .btn-comic:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px #000; }
    .btn-comic:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px #000; }

    .option-btn { background-color: #fff; }
    .option-btn:hover { background-color: #fff9c4; }

    @keyframes pop {
      0% { transform: scale(0.8); opacity: 0; }
      80% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .pop-in { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    .confetti-piece {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -12px;
      opacity: 1; /* ch·ªânh l·∫°i ƒë·ªÉ nh√¨n ch·∫Øc ch·∫Øn */
      z-index: 100;
      pointer-events: none;
    }
    @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 1; } }

    .progress-striped {
      background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
      background-size: 1rem 1rem;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

  <!-- START SCREEN -->
  <div id="start-screen" class="comic-box p-8 max-w-2xl w-full text-center z-10 bg-yellow-300">
    <div class="absolute -top-6 -left-6 transform -rotate-12 bg-white border-4 border-black p-2 shadow-[4px_4px_0px_#000]">
      <i class="fas fa-star text-4xl text-yellow-500"></i>
    </div>

    <h1 class="font-comic text-6xl text-black mb-2 leading-none drop-shadow-sm">
      M·∫¨T M√É<br><span class="text-blue-600">ƒê∆Ø·ªúNG TRUNG B√åNH</span>
    </h1>
    <p class="text-xl font-bold text-black mb-8 border-b-4 border-black inline-block pb-1">Bi·ªát ƒê·ªôi Gen Z Gi·∫£i To√°n üìê</p>

    <div class="grid grid-cols-2 gap-4 mb-8 text-left">
      <div class="bg-white border-2 border-black p-3 shadow-[4px_4px_0px_#000] flex items-center">
        <span class="bg-green-500 text-white w-8 h-8 flex items-center justify-center border-2 border-black font-bold mr-2">6</span> Nh·∫≠n bi·∫øt
      </div>
      <div class="bg-white border-2 border-black p-3 shadow-[4px_4px_0px_#000] flex items-center">
        <span class="bg-blue-500 text-white w-8 h-8 flex items-center justify-center border-2 border-black font-bold mr-2">5</span> Th√¥ng hi·ªÉu
      </div>
      <div class="bg-white border-2 border-black p-3 shadow-[4px_4px_0px_#000] flex items-center">
        <span class="bg-orange-500 text-white w-8 h-8 flex items-center justify-center border-2 border-black font-bold mr-2">3</span> V·∫≠n d·ª•ng
      </div>
      <div class="bg-white border-2 border-black p-3 shadow-[4px_4px_0px_#000] flex items-center">
        <span class="bg-red-500 text-white w-8 h-8 flex items-center justify-center border-2 border-black font-bold mr-2">1</span> V·∫≠n d·ª•ng cao
      </div>
    </div>

    <button onclick="startGame()" class="btn-comic bg-pink-500 text-white text-3xl py-4 px-12 rounded-lg font-comic w-full md:w-auto">
      B·∫ÆT ƒê·∫¶U GAME! üöÄ
    </button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen" class="hidden w-full max-w-4xl flex flex-col h-[90vh]">
    <!-- HUD -->
    <div class="flex justify-between items-center mb-6 bg-white border-4 border-black p-3 rounded-lg shadow-[4px_4px_0px_#000]">
      <div class="flex items-center">
        <span class="font-comic text-2xl mr-2">C√ÇU:</span>
        <span id="q-curr" class="font-black text-2xl text-blue-600">1</span>
        <span class="font-bold text-gray-400 text-lg">/15</span>
      </div>

      <div class="flex-1 mx-4 h-6 bg-gray-200 border-2 border-black rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full bg-yellow-400 progress-striped transition-all duration-300 border-r-2 border-black" style="width: 0%"></div>
      </div>

      <div class="flex items-center">
        <i class="fas fa-bolt text-yellow-500 text-2xl mr-2 animate-pulse"></i>
        <span id="score" class="font-comic text-3xl">0</span>
      </div>
    </div>

    <!-- Question Area -->
    <div class="flex-1 comic-box p-6 md:p-10 flex flex-col overflow-hidden bg-white">
      <div id="level-tag" class="absolute top-0 right-0 bg-black text-white px-4 py-1 font-bold font-comic uppercase text-lg border-b-4 border-l-4 border-white">
        C·∫•p ƒë·ªô
      </div>

      <div class="flex-1 overflow-y-auto pr-2">
        <h2 id="question-text" class="font-bold text-2xl md:text-3xl text-black mb-8 leading-snug">
          Loading...
        </h2>

        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-24 md:pb-0"></div>
      </div>

      <!-- Feedback Overlay -->
      <div id="feedback-area" class="hidden absolute bottom-0 left-0 right-0 p-4 bg-black/80 backdrop-blur-sm h-full flex items-center justify-center z-20">
        <div class="bg-white border-4 border-black p-6 rounded-xl max-w-lg w-full shadow-[8px_8px_0px_#fff] pop-in relative">
          <div id="fb-badge" class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-yellow-400 border-4 border-black px-4 py-2 font-comic text-2xl rotate-3 shadow-[4px_4px_0px_#000]">
            <span id="fb-status">CH√çNH X√ÅC!</span>
          </div>

          <div class="mt-6 mb-6">
            <p id="fb-text" class="text-lg font-bold text-gray-800 leading-relaxed"></p>
          </div>

          <button onclick="nextQuestion()" class="btn-comic w-full bg-blue-500 text-white py-3 rounded text-xl">
            TI·∫æP THEO <i class="fas fa-forward"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULT SCREEN -->
  <div id="result-screen" class="hidden comic-box p-8 max-w-md w-full text-center z-20 bg-cyan-200">
    <div class="absolute -top-12 left-1/2 transform -translate-x-1/2">
      <i class="fas fa-trophy text-8xl text-yellow-400 drop-shadow-[4px_4px_0px_#000]"></i>
    </div>

    <h2 class="font-comic text-5xl text-black mt-12 mb-2">NHI·ªÜM V·ª§ HO√ÄN T·∫§T!</h2>
    <p class="font-bold text-gray-700 mb-6">ƒêi·ªÉm s·ªë c·ªßa b·∫°n:</p>

    <div class="bg-white border-4 border-black p-4 mb-8 shadow-[4px_4px_0px_#000] rotate-2">
      <span id="final-score" class="font-comic text-7xl text-black">0</span>
    </div>

    <p id="result-msg" class="text-xl font-bold text-black mb-8 uppercase"></p>

    <button onclick="restartGame()" class="btn-comic bg-green-500 text-white w-full py-4 rounded text-2xl">
      CH∆†I L·∫†I <i class="fas fa-undo"></i>
    </button>
  </div>

  <script>
    // --- SOUND ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const now = audioCtx.currentTime;

      if (type === 'correct') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        osc.start(); osc.stop(now + 0.5);
      } else if (type === 'wrong') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(100, now + 0.15);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(); osc.stop(now + 0.3);
      } else if (type === 'win') {
        const notes = [440, 554, 659, 880];
        notes.forEach((freq, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.type = 'triangle';
          o.frequency.value = freq;
          g.gain.setValueAtTime(0.2, now + i * 0.1);
          g.gain.linearRampToValueAtTime(0, now + i * 0.1 + 0.3);
          o.start(now + i * 0.1);
          o.stop(now + i * 0.1 + 0.3);
        });
      }
    }

    // --- QUESTIONS (ƒë√£ s·ª≠a c√¢u MN = 5) ---
    const questions = [
      // NB (6)
      {
        level: "Nh·∫≠n bi·∫øt",
        text: "ƒê∆∞·ªùng trung b√¨nh c·ªßa tam gi√°c l√† ƒëo·∫°n th·∫≥ng n·ªëi:",
        options: ["Hai ƒë·ªânh c·ªßa tam gi√°c", "Trung ƒëi·ªÉm hai c·∫°nh c·ªßa tam gi√°c", "M·ªôt ƒë·ªânh v√† trung ƒëi·ªÉm c·∫°nh ƒë·ªëi di·ªán", "Hai ƒëi·ªÉm b·∫•t k√¨ tr√™n hai c·∫°nh"],
        correct: 1,
        rationale: "ƒê·ªãnh nghƒ©a: ƒê∆∞·ªùng trung b√¨nh c·ªßa tam gi√°c l√† ƒëo·∫°n th·∫≥ng n·ªëi trung ƒëi·ªÉm hai c·∫°nh c·ªßa tam gi√°c ƒë√≥."
      },
      {
        level: "Nh·∫≠n bi·∫øt",
        text: "Trong m·ªôt tam gi√°c, ƒë∆∞·ªùng trung b√¨nh c√≥ t√≠nh ch·∫•t g√¨ v·ªõi c·∫°nh th·ª© ba?",
        options: ["Vu√¥ng g√≥c", "C·∫Øt nhau", "Song song v√† b·∫±ng m·ªôt n·ª≠a", "B·∫±ng nhau"],
        correct: 2,
        rationale: "ƒê·ªãnh l√≠: ƒê∆∞·ªùng trung b√¨nh c·ªßa tam gi√°c song song v·ªõi c·∫°nh th·ª© ba v√† b·∫±ng n·ª≠a c·∫°nh ·∫•y."
      },
      {
        level: "Nh·∫≠n bi·∫øt",
        text: "Cho tam gi√°c ABC c√≥ M, N l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB v√† AC. MN l√† g√¨?",
        options: ["ƒê∆∞·ªùng cao", "ƒê∆∞·ªùng trung tuy·∫øn", "ƒê∆∞·ªùng ph√¢n gi√°c", "ƒê∆∞·ªùng trung b√¨nh"],
        correct: 3,
        rationale: "V√¨ n·ªëi 2 trung ƒëi·ªÉm M, N n√™n MN l√† ƒë∆∞·ªùng trung b√¨nh c·ªßa tam gi√°c ABC."
      },
      {
        level: "Nh·∫≠n bi·∫øt",
        text: "Tam gi√°c ABC c√≥ BC = 12cm. MN l√† ƒë∆∞·ªùng trung b√¨nh ·ª©ng v·ªõi c·∫°nh BC. ƒê·ªô d√†i MN l√† bao nhi√™u?",
        options: ["6cm", "12cm", "24cm", "4cm"],
        correct: 0,
        rationale: "MN = 1/2 * BC = 1/2 * 12 = 6cm."
      },
      {
        level: "Nh·∫≠n bi·∫øt",
        text: "N·∫øu MN l√† ƒë∆∞·ªùng trung b√¨nh c·ªßa tam gi√°c ABC (MN // BC) v√† MN = 5cm th√¨ ƒë·ªô d√†i BC l√†:",
        options: ["2.5cm", "5cm", "10cm", "15cm"],
        correct: 2,
        rationale: "BC = 2 * MN = 2 * 5 = 10cm."
      },
      {
        level: "Nh·∫≠n bi·∫øt",
        text: "M·ªôt tam gi√°c c√≥ t·ªëi ƒëa bao nhi√™u ƒë∆∞·ªùng trung b√¨nh?",
        options: ["1", "2", "3", "V√¥ s·ªë"],
        correct: 2,
        rationale: "Tam gi√°c c√≥ 3 ƒë∆∞·ªùng trung b√¨nh."
      },

      // TH (5)
      {
        level: "Th√¥ng hi·ªÉu",
        text: "Tam gi√°c ABC c√≥ chu vi l√† 20cm. G·ªçi M, N, P l√† trung ƒëi·ªÉm 3 c·∫°nh. Chu vi tam gi√°c MNP l√† bao nhi√™u?",
        options: ["10cm", "20cm", "40cm", "5cm"],
        correct: 0,
        rationale: "Chu vi tam gi√°c trung b√¨nh b·∫±ng m·ªôt n·ª≠a chu vi tam gi√°c ban ƒë·∫ßu: 20/2 = 10cm."
      },
      {
        level: "Th√¥ng hi·ªÉu",
        text: "Cho tam gi√°c ABC, ƒë∆∞·ªùng th·∫≥ng ƒëi qua trung ƒëi·ªÉm M c·ªßa c·∫°nh AB v√† song song v·ªõi c·∫°nh BC s·∫Ω ƒëi qua ƒë√¢u?",
        options: ["ƒê·ªânh C", "Trung ƒëi·ªÉm c·∫°nh AC", "ƒêi·ªÉm b·∫•t k√¨ tr√™n AC", "Tr·ªçng t√¢m tam gi√°c"],
        correct: 1,
        rationale: "ƒê·ªãnh l√≠ ƒë·∫£o: Qua trung ƒëi·ªÉm 1 c·∫°nh, song song c·∫°nh th·ª© hai th√¨ ƒëi qua trung ƒëi·ªÉm c·∫°nh th·ª© ba."
      },
      {
        level: "Th√¥ng hi·ªÉu",
        text: "Tam gi√°c ƒë·ªÅu ABC c·∫°nh a. ƒê·ªô d√†i ƒë∆∞·ªùng trung b√¨nh c·ªßa tam gi√°c n√†y b·∫±ng:",
        options: ["a", "2a", "a/2", "a‚àö3/2"],
        correct: 2,
        rationale: "ƒê∆∞·ªùng trung b√¨nh lu√¥n b·∫±ng m·ªôt n·ª≠a c·∫°nh ƒë√°y t∆∞∆°ng ·ª©ng ‚áí a/2."
      },
      {
        level: "Th√¥ng hi·ªÉu",
        text: "Cho tam gi√°c ABC vu√¥ng t·∫°i A, AB=6, AC=8. ƒê·ªô d√†i ƒë∆∞·ªùng trung b√¨nh MN (M thu·ªôc AB, N thu·ªôc AC) l√†:",
        options: ["5", "10", "3", "4"],
        correct: 0,
        rationale: "MN n·ªëi trung ƒëi·ªÉm AB v√† AC n√™n MN // BC v√† MN = BC/2. BC = ‚àö(6¬≤+8¬≤)=10 ‚áí MN=5."
      },
      {
        level: "Th√¥ng hi·ªÉu",
        text: "Cho tam gi√°c ABC c√≥ g√≥c B = 70¬∞. MN l√† ƒë∆∞·ªùng trung b√¨nh (MN // BC). S·ªë ƒëo g√≥c AMN l√†:",
        options: ["70¬∞", "110¬∞", "35¬∞", "140¬∞"],
        correct: 0,
        rationale: "MN // BC n√™n ‚à†AMN = ‚à†ABC = 70¬∞."
      },

      // VD (3)
      {
        level: "V·∫≠n d·ª•ng (Th·ª±c t·∫ø)",
        text: "ƒê·ªÉ ƒëo kho·∫£ng c√°ch gi·ªØa hai ƒëi·ªÉm A v√† B b·ªã ngƒÉn c√°ch b·ªüi h·ªì n∆∞·ªõc, ng∆∞·ªùi ta ch·ªçn ƒëi·ªÉm C, l·∫•y trung ƒëi·ªÉm M c·ªßa CA v√† N c·ªßa CB. ƒêo ƒë∆∞·ª£c MN = 45m. Kho·∫£ng c√°ch AB l√†:",
        options: ["45m", "90m", "22.5m", "100m"],
        correct: 1,
        rationale: "Trong tam gi√°c CAB, MN l√† ƒë∆∞·ªùng trung b√¨nh ‚áí AB = 2MN = 90m."
      },
      {
        level: "V·∫≠n d·ª•ng",
        text: "Cho tam gi√°c ABC vu√¥ng t·∫°i A. G·ªçi M, N, P l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB, BC, AC. T·ª© gi√°c AMNP l√† h√¨nh g√¨?",
        options: ["H√¨nh thoi", "H√¨nh b√¨nh h√†nh", "H√¨nh ch·ªØ nh·∫≠t", "H√¨nh vu√¥ng"],
        correct: 2,
        rationale: "AMNP l√† h√¨nh b√¨nh h√†nh v√† c√≥ g√≥c A = 90¬∞ ‚áí AMNP l√† h√¨nh ch·ªØ nh·∫≠t."
      },
      {
        level: "V·∫≠n d·ª•ng",
        text: "Tam gi√°c ABC, trung tuy·∫øn AM. G·ªçi I l√† trung ƒëi·ªÉm AM. ƒê∆∞·ªùng th·∫≥ng CI c·∫Øt AB t·∫°i K. T√≠nh t·ªâ s·ªë AK/AB.",
        options: ["1/2", "1/3", "1/4", "2/3"],
        correct: 1,
        rationale: "K l√† ƒëi·ªÉm chia AB theo t·ªâ s·ªë AK = 1/3 AB ‚áí AK/AB = 1/3."
      },

      // VDC (1)
      {
        level: "V·∫≠n d·ª•ng cao",
        text: "Cho t·ª© gi√°c ABCD. G·ªçi M, N, P, Q l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB, BC, CD, DA. T·ª© gi√°c MNPQ l√† h√¨nh g√¨?",
        options: ["H√¨nh thang", "H√¨nh ch·ªØ nh·∫≠t", "H√¨nh b√¨nh h√†nh", "H√¨nh vu√¥ng"],
        correct: 2,
        rationale: "ƒê·ªãnh l√≠ Varignon: N·ªëi trung ƒëi·ªÉm 4 c·∫°nh c·ªßa t·ª© gi√°c ƒë∆∞·ª£c h√¨nh b√¨nh h√†nh."
      }
    ];

    // ====== RANDOM + R·∫¢I ƒê·ªÄU A/B/C/D ======
    const targetCorrectSlots = [0,1,2,3, 0,1,2,3, 0,1,2,3, 0,1,2];
    let prepared = [];

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function prepareQuestions() {
      prepared = questions.map((q, qi) => {
        const correctText = q.options[q.correct];
        const wrongs = q.options.filter((_, idx) => idx !== q.correct);
        const shuffledWrongs = shuffleArray(wrongs);

        const target = targetCorrectSlots[qi] ?? Math.floor(Math.random() * 4);

        const newOptions = [];
        let w = 0;
        for (let i = 0; i < 4; i++) {
          if (i === target) newOptions.push(correctText);
          else newOptions.push(shuffledWrongs[w++]);
        }

        return { ...q, options: newOptions, correct: target };
      });
    }

    // --- GAME STATE ---
    let currentIdx = 0;
    let score = 0;
    let isLocked = false;

    function startGame() {
      prepareQuestions(); // m·ªói l∆∞·ª£t ch∆°i s·∫Ω random kh√°c

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      document.getElementById('game-screen').classList.add('flex');
      loadQuestion();
    }

    function loadQuestion() {
      isLocked = false;
      const q = prepared[currentIdx];

      document.getElementById('q-curr').innerText = currentIdx + 1;
      document.getElementById('score').innerText = score;

      const pct = (currentIdx / prepared.length) * 100;
      document.getElementById('progress-bar').style.width = pct + '%';

      const tag = document.getElementById('level-tag');
      tag.innerText = q.level;

      if (q.level.includes("Nh·∫≠n bi·∫øt")) tag.className = "absolute top-0 right-0 bg-green-500 text-white px-4 py-1 font-bold font-comic uppercase text-lg border-b-4 border-l-4 border-black";
      else if (q.level.includes("Th√¥ng hi·ªÉu")) tag.className = "absolute top-0 right-0 bg-blue-500 text-white px-4 py-1 font-bold font-comic uppercase text-lg border-b-4 border-l-4 border-black";
      else if (q.level.includes("V·∫≠n d·ª•ng cao")) tag.className = "absolute top-0 right-0 bg-red-500 text-white px-4 py-1 font-bold font-comic uppercase text-lg border-b-4 border-l-4 border-black";
      else tag.className = "absolute top-0 right-0 bg-orange-500 text-white px-4 py-1 font-bold font-comic uppercase text-lg border-b-4 border-l-4 border-black";

      document.getElementById('question-text').innerText = q.text;
      document.getElementById('feedback-area').classList.add('hidden');

      const container = document.getElementById('options-container');
      container.innerHTML = '';

      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = `btn-comic option-btn w-full p-4 text-left rounded-lg border-2 border-black flex items-center text-lg`;
        btn.innerHTML = `<span class="bg-black text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 font-bold">${String.fromCharCode(65 + idx)}</span> ${opt}`;
        btn.onclick = () => checkAnswer(idx, btn);
        container.appendChild(btn);
      });
    }

    function lockButtons() {
      const allBtns = document.getElementById('options-container').children;
      Array.from(allBtns).forEach(b => b.disabled = true);
    }

    function checkAnswer(idx, btn) {
      if (isLocked) return;
      isLocked = true;

      const q = prepared[currentIdx];
      const isCorrect = idx === q.correct;

      if (isCorrect) {
        score++;
        document.getElementById('score').innerText = score;
        playSound('correct');
        fireConfetti();
        btn.style.backgroundColor = '#86efac';
        showFeedback(true, q.rationale);
      } else {
        playSound('wrong');
        btn.style.backgroundColor = '#fca5a5';

        const allBtns = document.getElementById('options-container').children;
        allBtns[q.correct].style.backgroundColor = '#86efac';

        showFeedback(false, q.rationale);
      }

      lockButtons();
    }

    function showFeedback(isCorrect, text) {
      const area = document.getElementById('feedback-area');
      area.classList.remove('hidden');

      const status = document.getElementById('fb-status');
      const badge = document.getElementById('fb-badge');

      if (isCorrect) {
        status.innerText = "CHU·∫®N KH√îNG C·∫¶N CH·ªàNH!";
        badge.className = "absolute -top-10 left-1/2 transform -translate-x-1/2 bg-green-400 border-4 border-black px-4 py-2 font-comic text-2xl rotate-3 shadow-[4px_4px_0px_#000]";
      } else {
        status.innerText = "TI·∫æC QU√Å ƒêI M·∫§T!";
        badge.className = "absolute -top-10 left-1/2 transform -translate-x-1/2 bg-red-400 border-4 border-black px-4 py-2 font-comic text-2xl -rotate-3 shadow-[4px_4px_0px_#000]";
      }

      document.getElementById('fb-text').innerHTML = `<strong class="text-black">Gi·∫£i th√≠ch:</strong> ${text}`;
    }

    function nextQuestion() {
      currentIdx++;
      if (currentIdx < prepared.length) loadQuestion();
      else showResult();
    }

    function showResult() {
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
      document.getElementById('final-score').innerText = score;

      const msg = document.getElementById('result-msg');
      playSound('win');

      if (score === 15) msg.innerText = "ƒê·ªàNH C·ª¶A CH√ìP! B·∫†N L√Ä THI√äN T√ÄI H√åNH H·ªåC! üèÜ";
      else if (score >= 12) msg.innerText = "QU√Å XU·∫§T S·∫ÆC! KI·∫æN TH·ª®C V·ªÆNG NH∆Ø B√ÄN TH·∫†CH! üî•";
      else if (score >= 8) msg.innerText = "L√ÄM T·ªêT L·∫ÆM! C·ªê G·∫ÆNG TH√äM CH√öT N·ªÆA NH√â! üí™";
      else msg.innerText = "ƒê·ª™NG LO! H√ÉY √îN T·∫¨P L·∫†I V√Ä TH·ª¨ L·∫†I NH√â! üìö";
    }

    function restartGame() {
      currentIdx = 0;
      score = 0;
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    }

    // --- CONFETTI ---
    function fireConfetti() {
      const colors = ['#ff1744', '#00c853', '#2979ff', '#ffea00', '#d500f9'];
      for (let i = 0; i < 50; i++) {
        const el = document.createElement('div');
        el.className = 'confetti-piece';
        el.style.left = Math.random() * 100 + 'vw';
        el.style.background = colors[Math.floor(Math.random() * colors.length)];
        el.style.transform = `rotate(${Math.random() * 360}deg)`;
        el.style.animation = `fall ${Math.random() * 2 + 1}s linear`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3000);
      }
    }
  </script>
</body>
</html>
