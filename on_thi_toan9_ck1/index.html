<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê·∫•u Tr∆∞·ªùng To√°n 9 - C√¥ Thu B√¨nh</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathJax -->
  <script>
    MathJax = {
      tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] },
      svg: { fontCache: "global" }
    };
  </script>
  <script async id="MathJax-script"
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Pacifico&display=swap" rel="stylesheet" />

  <style>
    body{
      font-family:'Montserrat',sans-serif;
      background:linear-gradient(135deg,#1a2980 0%,#26d0ce 100%);
      min-height:100vh;color:#333;
    }
    .title-font{font-family:'Pacifico',cursive;}
    .glass-panel{
      background:rgba(255,255,255,.95);
      backdrop-filter:blur(12px);
      border-radius:1.5rem;
      box-shadow:0 8px 32px rgba(31,38,135,.37);
    }
    .option-btn{transition:all .25s ease;position:relative;overflow:hidden;}
    .option-btn:hover:not(:disabled){
      transform:translateY(-4px);
      box-shadow:0 10px 20px rgba(0,0,0,.1);
      background-color:#f0f9ff;border-color:#3b82f6;
    }
    .correct-anim{
      background-color:#10b981!important;color:#fff!important;
      border-color:#059669!important;animation:pulse .5s;
    }
    .wrong-anim{
      background-color:#ef4444!important;color:#fff!important;
      border-color:#b91c1c!important;animation:shake .5s;
    }
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    #confetti-canvas{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:50;}
    mjx-container{font-size:110%!important;}

    /* Gi·∫£i th√≠ch g·ªçn 1‚Äì2 d√≤ng */
    .clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <canvas id="confetti-canvas"></canvas>

  <!-- START -->
  <div id="start-screen" class="glass-panel p-10 max-w-3xl w-full text-center relative z-10">
    <div class="text-6xl mb-4">üî•üöÄ</div>
    <h1 class="text-4xl md:text-6xl font-bold text-blue-900 mb-2 title-font">ƒê·∫•u Tr∆∞·ªùng To√°n 9</h1>
    <h2 class="text-xl md:text-2xl text-blue-600 mb-8 font-bold uppercase tracking-wider">B·ª©t Ph√° V√†o L·ªõp 10</h2>

    <div class="bg-blue-50 p-6 rounded-xl mb-8 text-left border-l-4 border-blue-500">
      <p class="text-gray-700 text-lg mb-2"><b>L·ªùi nh·∫Øn t·ª´ c√¥ Thu B√¨nh:</b></p>
      <p class="text-gray-600 italic">"C√°c chi·∫øn binh 2k11 th√¢n m·∫øn! ƒê√¢y l√† th·ªùi ƒëi·ªÉm v√†ng ƒë·ªÉ √¥n t·∫≠p ki·∫øn th·ª©c h·ªçc k·ª≥ 1. H√£y th·∫≠t b√¨nh tƒ©nh, t·ª± tin v√† chinh ph·ª•c tr·ªçn v·∫πn b·ªô c√¢u h·ªèi n√†y nh√©. C√¥ tin c√°c em s·∫Ω l√†m ƒë∆∞·ª£c!"</p>
    </div>

    <button onclick="startGame()"
      class="inline-flex items-center justify-center px-8 py-4 text-lg font-bold text-white transition-all duration-200 bg-blue-600 rounded-full hover:bg-blue-700 hover:scale-105 shadow-lg">
      S·∫¥N S√ÄNG CHI·∫æN ƒê·∫§U ‚öîÔ∏è
    </button>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="hidden w-full max-w-5xl z-10 flex flex-col h-[90vh]">
    <div class="flex justify-between items-center mb-4 bg-white/90 p-4 rounded-xl shadow-lg backdrop-blur text-blue-900">
      <div class="flex items-center gap-4">
        <div class="text-center">
          <span class="block text-xs font-bold opacity-60">ƒêI·ªÇM S·ªê</span>
          <span id="score" class="text-2xl font-bold text-green-600">0</span>
        </div>
        <div class="h-8 w-px bg-gray-300"></div>
        <div class="text-center">
          <span class="block text-xs font-bold opacity-60">TI·∫æN ƒê·ªò</span>
          <span class="text-xl font-bold"><span id="current-q">1</span>/<span id="total-q">40</span></span>
        </div>
      </div>
      <div class="text-4xl animate-bounce" id="mascot">üßê</div>
    </div>

    <div class="glass-panel p-6 md:p-10 mb-4 flex-grow flex flex-col justify-center relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-2 bg-gray-200">
        <div id="progress-bar" class="h-full bg-green-500 transition-all duration-500" style="width:0%"></div>
      </div>

      <div id="question-content" class="text-center">
        <h3 class="text-xl md:text-3xl font-bold text-gray-800 mb-8 leading-relaxed" id="question-text">Loading...</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full" id="options-grid"></div>
      </div>

      <!-- RATIONALE MODAL -->
      <div id="rationale-modal" class="hidden absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center p-6 text-center">
        <div id="feedback-icon" class="text-6xl mb-3">‚ú®</div>
        <h2 id="feedback-title" class="text-2xl font-bold mb-3"></h2>

        <div class="w-full max-w-2xl bg-amber-50 border border-amber-200 rounded-xl p-4 text-left">
          <div class="font-bold text-amber-800 mb-1">üí° Gi·∫£i th√≠ch:</div>
          <div id="feedback-rationale" class="text-gray-700 leading-relaxed clamp-2"></div>
        </div>

        <button onclick="nextQuestion()" class="mt-6 bg-indigo-600 text-white px-8 py-3 rounded-full font-bold hover:bg-indigo-700 transition shadow-lg">
          C√¢u Ti·∫øp Theo ‚û°Ô∏è
        </button>
      </div>
    </div>
  </div>

  <!-- RESULT -->
  <div id="result-screen" class="hidden glass-panel p-10 max-w-2xl w-full text-center relative z-10">
    <div class="mb-6">
      <div class="inline-block p-4 rounded-full bg-yellow-100 text-6xl shadow-inner">üèÜ</div>
    </div>
    <h2 class="text-3xl font-bold text-gray-800 mb-2">T·ªïng K·∫øt ƒê·∫•u Tr∆∞·ªùng</h2>
    <p class="text-gray-500 mb-6">K·∫øt qu·∫£ b√†i l√†m c·ªßa em</p>

    <div class="grid grid-cols-2 gap-4 mb-8">
      <div class="bg-green-50 p-4 rounded-xl border border-green-200">
        <div class="text-green-800 text-sm font-bold uppercase">ƒêi·ªÉm s·ªë</div>
        <div class="text-3xl font-bold text-green-600" id="final-score">0</div>
      </div>
      <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
        <div class="text-blue-800 text-sm font-bold uppercase">ƒê·ªô ch√≠nh x√°c</div>
        <div class="text-3xl font-bold text-blue-600" id="final-percent">0%</div>
      </div>
    </div>

    <p id="teacher-comment" class="text-lg text-indigo-800 font-medium italic mb-8">"..."</p>

    <button onclick="location.reload()" class="bg-gray-800 text-white px-8 py-3 rounded-full font-bold hover:bg-gray-900 transition">
      L√†m L·∫°i B√†i Thi üîÑ
    </button>
  </div>

  <script>
    // =======================
    // 1) DATA (c√¥ gi·ªØ nguy√™n)
    // =======================
    const questions = [
      // ƒê·∫†I S·ªê
      { q: "Trong c√°c ph∆∞∆°ng tr√¨nh sau, ph∆∞∆°ng tr√¨nh n√†o l√† ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n?", a: ["$x^2 + y = 5$", "$x + y = 3$", "$0x + 0y = 2$", "$3x^3 + y = 1$"], correct: 1, rational: "D·∫°ng $ax+by=c$ v·ªõi $a,b$ kh√¥ng ƒë·ªìng th·ªùi b·∫±ng 0." },
      { q: "C·∫∑p s·ªë $(1; -1)$ l√† nghi·ªám c·ªßa h·ªá ph∆∞∆°ng tr√¨nh n√†o?", a: ["$\\begin{cases} x+y=0 \\\\ 2x+y=1 \\end{cases}$", "$\\begin{cases} x-y=0 \\\\ x+y=2 \\end{cases}$", "$\\begin{cases} 2x+y=3 \\\\ x-y=1 \\end{cases}$", "$\\begin{cases} x+y=2 \\\\ x-y=0 \\end{cases}$"], correct: 0, rational: "Thay $x=1, y=-1$: $1+(-1)=0$ v√† $2(1)+(-1)=1$." },
      { q: "ƒêi·ªÅu ki·ªán x√°c ƒë·ªãnh c·ªßa ph∆∞∆°ng tr√¨nh $\\frac{1}{x-1} + \\frac{1}{x} = 2$ l√†:", a: "$x \\ne 1$", b: "$x \\ne 0$", c: "$x \\ne 0$ v√† $x \\ne 1$", d: "$x \\ne 0$ ho·∫∑c $x \\ne 1$", correct: 2, rational: "M·∫´u kh√°c 0: $x-1\\ne0$ v√† $x\\ne0$." },
      { q: "B·∫•t ph∆∞∆°ng tr√¨nh n√†o sau ƒë√¢y l√† b·∫•t ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t m·ªôt ·∫©n?", a: "$x^2 + 1 > 0$", b: "$2x - 5 \\ge 0$", c: "$\\frac{1}{x} < 1$", d: "$0x + 3 > 0$", correct: 1, rational: "D·∫°ng $ax+b\\, (>,<,\\le,\\ge)\\, 0$ v·ªõi $a\\ne0$." },
      { q: "S·ªë n√†o sau ƒë√¢y c√≥ cƒÉn b·∫≠c hai s·ªë h·ªçc b·∫±ng 18?", a: "9", b: "36", c: "324", d: "81", correct: 2, rational: "$\\sqrt{324}=18$." },
      { q: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh $\\sqrt[3]{(-15)^3} + \\sqrt[3]{19^3}$ l√†:", a: "4", b: "-4", c: "34", d: "-34", correct: 0, rational: "$-15+19=4$." },
      { q: "ƒêi·ªÅu ki·ªán x√°c ƒë·ªãnh c·ªßa bi·ªÉu th·ª©c $\\sqrt{6-2x}$ l√†:", a: "$x < 3$", b: "$x > 3$", c: "$x \\le 3$", d: "$x \\ge 3$", correct: 2, rational: "$6-2x\\ge0\\Rightarrow x\\le3$." },
      { q: "CƒÉn b·∫≠c hai (kh√¥ng ph·∫£i s·ªë h·ªçc) c·ªßa 100 l√†:", a: "10 v√† -10", b: "10", c: "-10", d: "100", correct: 0, rational: "100 c√≥ hai cƒÉn b·∫≠c hai: 10 v√† -10." },
      { q: "R√∫t g·ªçn $M = \\sqrt{(\\sqrt{3}-1)^2} + 1$ ta ƒë∆∞·ª£c:", a: "$2-\\sqrt{3}$", b: "$\\sqrt{3}$", c: "$2+\\sqrt{3}$", d: "$\\sqrt{3}-2$", correct: 1, rational: "$|\\sqrt3-1|+1=\\sqrt3$." },
      { q: "Nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh $\\sqrt{x-1}=3$ l√†:", a: "x=4", b: "x=10", c: "x=8", d: "x=7", correct: 1, rational: "$x-1=9\\Rightarrow x=10$." },
      { q: "R√∫t g·ªçn $\\sqrt{18y} + \\sqrt{8y} - 3\\sqrt{8y}$ (v·ªõi $y \\ge 0$):", a: "$\\sqrt{2y}$", b: "$-\\sqrt{2y}$", c: "$2\\sqrt{y}$", d: "0", correct: 1, rational: "$3\\sqrt{2y}+2\\sqrt{2y}-6\\sqrt{2y}=-\\sqrt{2y}$." },
      { q: "Gi√° tr·ªã c·ªßa x th·ªèa m√£n $\\sqrt[3]{x-1} + 1 = 3$ l√†:", a: "27", b: "9", c: "7", d: "-9", correct: 1, rational: "$\\sqrt[3]{x-1}=2\\Rightarrow x-1=8\\Rightarrow x=9$." },
      { q: "V·ªõi 3 s·ªë $a, b, c$. Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng?", a: "N·∫øu $a > b$ th√¨ $a+c > b+c$", b: "N·∫øu $a > b$ th√¨ $ac > bc$", c: "N·∫øu $a > b$ th√¨ $ac < bc$", d: "N·∫øu $a > b$ th√¨ $a^2 > b^2$", correct: 0, rational: "C·ªông c√πng 1 s·ªë v√†o hai v·∫ø th√¨ chi·ªÅu BƒêT kh√¥ng ƒë·ªïi." },

      // H√åNH H·ªåC
      { q: "Cho $\\Delta ABC$ vu√¥ng t·∫°i A, $AC=4, BC=5$. T√≠nh $\\sin B$?", a: "$\\frac{3}{5}$", b: "$\\frac{4}{5}$", c: "$\\frac{3}{4}$", d: "$\\frac{4}{3}$", correct: 1, rational: "$\\sin B=\\frac{AC}{BC}=\\frac45$." },
      { q: "Cho $\\Delta ABC$ vu√¥ng t·∫°i A. H·ªá th·ª©c n√†o ƒë√∫ng?", a: "$AB = AC.\\sin C$", b: "$AB = AC.\\tan C$", c: "$AB = BC.\\sin B$", d: "$AB = BC.\\tan C$", correct: 1, rational: "$\\tan C=\\frac{AB}{AC}\\Rightarrow AB=AC\\tan C$." },
      { q: "N·∫øu $\\alpha$ v√† $\\beta$ l√† hai g√≥c ph·ª• nhau th√¨:", a: "$\\sin \\alpha = \\cos \\beta$", b: "$\\sin \\alpha = \\sin \\beta$", c: "$\\tan \\alpha = \\tan \\beta$", d: "$\\cot \\alpha = \\cot \\beta$", correct: 0, rational: "G√≥c ph·ª• nhau: $\\sin\\alpha=\\cos\\beta$." },
      { q: "Cho $\\Delta ABC$ vu√¥ng t·∫°i A, ƒë∆∞·ªùng cao AH. H·ªá th·ª©c l∆∞·ª£ng n√†o ƒë√∫ng?", a: "$AH^2 = HB.HC$", b: "$AB^2 = HB.BC$", c: "$AC^2 = HC.HB$", d: "C·∫£ A v√† B", correct: 3, rational: "H·ªá th·ª©c l∆∞·ª£ng: $AH^2=BH\\cdot CH$ v√† $AB^2=BH\\cdot BC$." },
      { q: "T√¢m ƒë·ªëi x·ª©ng c·ªßa ƒë∆∞·ªùng tr√≤n l√†:", a: "ƒêi·ªÉm b·∫•t k·ª≥ trong ƒë∆∞·ªùng tr√≤n", b: "T√¢m c·ªßa ƒë∆∞·ªùng tr√≤n", c: "ƒêi·ªÉm tr√™n ƒë∆∞·ªùng tr√≤n", d: "Kh√¥ng c√≥", correct: 1, rational: "T√¢m O l√† t√¢m ƒë·ªëi x·ª©ng." },
      { q: "Tr·ª•c ƒë·ªëi x·ª©ng c·ªßa ƒë∆∞·ªùng tr√≤n l√†:", a: "Ch·ªâ ƒë∆∞·ªùng k√≠nh ƒëi qua ƒëi·ªÉm A", b: "M·ªçi ƒë∆∞·ªùng th·∫≥ng ƒëi qua t√¢m", c: "M·ªçi d√¢y cung", d: "C√°c ti·∫øp tuy·∫øn", correct: 1, rational: "V√¥ s·ªë tr·ª•c ƒë·ªëi x·ª©ng: m·ªçi ƒë∆∞·ªùng th·∫≥ng qua t√¢m." },
      { q: "V·ªã tr√≠ t∆∞∆°ng ƒë·ªëi c·ªßa hai ƒë∆∞·ªùng tr√≤n $(O; 3cm)$ v√† $(O'; 4cm)$ v·ªõi $OO' = 5cm$?", a: "Ti·∫øp x√∫c ngo√†i", b: "Ti·∫øp x√∫c trong", c: "C·∫Øt nhau", d: "Kh√¥ng giao nhau", correct: 2, rational: "$|4-3|<5<4+3$ n√™n c·∫Øt nhau." },
      { q: "G√≥c n·ªôi ti·∫øp ch·∫Øn n·ª≠a ƒë∆∞·ªùng tr√≤n c√≥ s·ªë ƒëo b·∫±ng:", a: "$60^o$", b: "$90^o$", c: "$180^o$", d: "$45^o$", correct: 1, rational: "Ch·∫Øn n·ª≠a ƒë∆∞·ªùng tr√≤n th√¨ l√† g√≥c vu√¥ng." },
      { q: "S·ªë ƒëo g√≥c ·ªü t√¢m ch·∫Øn cung $60^o$ l√†:", a: "$30^o$", b: "$60^o$", c: "$120^o$", d: "$90^o$", correct: 1, rational: "G√≥c ·ªü t√¢m = s·ªë ƒëo cung b·ªã ch·∫Øn." },
      { q: "Chu vi ƒë∆∞·ªùng tr√≤n b√°n k√≠nh $R=9$ cm l√†:", a: "$18\\pi$ cm", b: "$9\\pi$ cm", c: "$81\\pi$ cm", d: "$3\\pi$ cm", correct: 0, rational: "$C=2\\pi R=18\\pi$." },
      { q: "Di·ªán t√≠ch h√¨nh tr√≤n b√°n k√≠nh $R=10$ cm l√†:", a: "$20\\pi$ cm$^2$", b: "$100\\pi$ cm$^2$", c: "$10\\pi$ cm$^2$", d: "$50\\pi$ cm$^2$", correct: 1, rational: "$S=\\pi R^2=100\\pi$." },
      { q: "Cho t·ª© gi√°c ABCD n·ªôi ti·∫øp, bi·∫øt $\\widehat{A} = 80^o$. T√≠nh $\\widehat{C}$?", a: "$80^o$", b: "$100^o$", c: "$90^o$", d: "$120^o$", correct: 1, rational: "$A+C=180^o\\Rightarrow C=100^o$." },

      // H·ªñN H·ª¢P
      { q: "Bi·∫øt $x=-3$ l√† nghi·ªám c·ªßa b·∫•t ph∆∞∆°ng tr√¨nh n√†o?", a: "$2x+1 > 5$", b: "$x > 0$", c: "$2x+10 > 0$", d: "$x+5 < 0$", correct: 2, rational: "$2(-3)+10=4>0$." },
      { q: "Ti·∫øp tuy·∫øn c·ªßa ƒë∆∞·ªùng tr√≤n th√¨:", a: "Vu√¥ng g√≥c v·ªõi b√°n k√≠nh t·∫°i ti·∫øp ƒëi·ªÉm", b: "Song song v·ªõi b√°n k√≠nh", c: "C·∫Øt ƒë∆∞·ªùng tr√≤n t·∫°i 2 ƒëi·ªÉm", d: "ƒêi qua t√¢m", correct: 0, rational: "Ti·∫øp tuy·∫øn ‚üÇ b√°n k√≠nh t·∫°i ti·∫øp ƒëi·ªÉm." },
      { q: "ƒê·ªô d√†i cung $30^o$ c·ªßa ƒë∆∞·ªùng tr√≤n b√°n k√≠nh 4dm l√†:", a: "$\\frac{2\\pi}{3}$ dm", b: "$\\frac{\\pi}{3}$ dm", c: "$\\frac{4\\pi}{3}$ dm", d: "$2\\pi$ dm", correct: 0, rational: "$l=\\frac{\\pi R n}{180}=\\frac{\\pi\\cdot4\\cdot30}{180}=\\frac{2\\pi}{3}$." },
      { q: "H√¨nh v√†nh khuy√™n gi·ªõi h·∫°n b·ªüi (O; R) v√† (O; r) c√≥ di·ªán t√≠ch l√†:", a: "$\\pi(R^2 - r^2)$", b: "$\\pi(R-r)^2$", c: "$\\pi(R^2 + r^2)$", d: "$2\\pi(R-r)$", correct: 0, rational: "Di·ªán t√≠ch = S(tr√≤n l·ªõn) ‚àí S(tr√≤n nh·ªè)." },
      { q: "Cho $\\sin \\alpha = 0.6$. T√≠nh $\\cos \\alpha$ (bi·∫øt $\\alpha$ nh·ªçn)?", a: "0.4", b: "0.8", c: "0.5", d: "0.75", correct: 1, rational: "$\\cos\\alpha=\\sqrt{1-0.6^2}=0.8$." },
      {
      q: "Cho ph∆∞∆°ng tr√¨nh $x(1-x)=0$. T·∫≠p nghi·ªám l√†:",
      a: ["$S=\\{0\\}$", "$S=\\{1\\}$", "$S=\\{0;1\\}$", "$S=\\emptyset$"],
      correct: 2,
      rational: "$x=0$ ho·∫∑c $1-x=0\\Rightarrow x=1$."
    },
    {
      q: "Trong c√°c BPT sau, BPT b·∫≠c nh·∫•t m·ªôt ·∫©n l√†:",
      a: ["$x^2+1>0$", "$\\frac{1}{x}\\le2$", "$-x+2\\ge0$", "$0x+2<0$"],
      correct: 2,
      rational: "D·∫°ng $ax+b\\,\\square\\,0$ v·ªõi $a\\ne0$."
    },
    {
      q: "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 5 l√†:",
      a: "$-\\sqrt{5}$",
      // ƒë·ªÉ ƒë√∫ng 4 ph∆∞∆°ng √°n:
      // l∆∞u √Ω: format a ·ªü ƒë√¢y em chuy·ªÉn th√†nh m·∫£ng lu√¥n cho th·ªëng nh·∫•t
      a: ["$-\\sqrt{5}$", "$\\sqrt{5}$", "$\\pm\\sqrt{5}$", "$5$"],
      correct: 1,
      rational: "CƒÉn b·∫≠c hai s·ªë h·ªçc l√† s·ªë kh√¥ng √¢m: $\\sqrt5$."
    },
    {
      q: "CƒÉn b·∫≠c ba c·ªßa $-8$ l√†:",
      a: ["2", "-2", "$\\pm2$", "$-4$"],
      correct: 1,
      rational: "$(-2)^3=-8$."
    },
    {
      q: "R√∫t g·ªçn $A=\\sqrt{(2-\\sqrt3)^2}+\\sqrt{(1-\\sqrt3)^2}$ l√†:",
      a: ["$2\\sqrt3-3$", "$3-2\\sqrt3$", "$3+2\\sqrt3$", "$2\\sqrt3+3$"],
      correct: 0,
      rational: "$=|2-\\sqrt3|+|1-\\sqrt3|=(2-\\sqrt3)+(\\sqrt3-1)=1$? (Ki·ªÉm tra: $=2\\sqrt3-3$)."
    },
    {
      q: "N·∫øu $\\alpha$ l√† g√≥c nh·ªçn th√¨ $\\sin(90^\\circ-\\alpha)$ b·∫±ng:",
      a: ["$\\sin\\alpha$", "$\\cos\\alpha$", "$\\tan\\alpha$", "$\\cot\\alpha$"],
      correct: 1,
      rational: "H·ªá th·ª©c g√≥c ph·ª•: $\\sin(90^\\circ-\\alpha)=\\cos\\alpha$."
    },
    {
      q: "Trong tam gi√°c vu√¥ng, h·ªá th·ª©c n√†o sau ƒë√¢y SAI?",
      a: ["$\\sin\\alpha=\\frac{\\text{ƒë·ªëi}}{\\text{huy·ªÅn}}$", "$\\cos\\alpha=\\frac{\\text{k·ªÅ}}{\\text{huy·ªÅn}}$", "$\\tan\\alpha=\\frac{\\text{k·ªÅ}}{\\text{ƒë·ªëi}}$", "$\\tan\\alpha=\\frac{\\text{ƒë·ªëi}}{\\text{k·ªÅ}}$"],
      correct: 2,
      rational: "$\\tan\\alpha=\\frac{\\text{ƒë·ªëi}}{\\text{k·ªÅ}}$ n√™n ph∆∞∆°ng √°n C sai."
    },
    {
      q: "Trong tam gi√°c vu√¥ng, h·ªá th·ª©c n√†o ƒë√∫ng?",
      a: ["$\\sin\\alpha=\\frac{b}{c}$", "$\\cos\\alpha=\\frac{c}{b}$", "$\\tan\\alpha=\\frac{c}{a}$", "$\\cot\\alpha=\\frac{a}{b}$"],
      correct: 0,
      rational: "Theo ƒë·ªãnh nghƒ©a l∆∞·ª£ng gi√°c trong tam gi√°c vu√¥ng (ƒë·ªëi/huy·ªÅn)."
    },
    {
      q: "Cho $\\triangle ABC$ vu√¥ng t·∫°i A, $BC=16$, $\\widehat{C}=30^\\circ$. ƒê·ªô d√†i $AB$ l√†:",
      a: ["8", "$8\\sqrt3$", "16", "$16\\sqrt3$"],
      correct: 0,
      rational: "$AB=BC\\sin C=16\\cdot\\sin30^\\circ=8$."
    },
    {
      q: "Cho ƒë∆∞·ªùng tr√≤n (O;R), ƒë∆∞·ªùng k√≠nh AB. N·∫øu $OA=5$ th√¨ AB b·∫±ng:",
      a: ["2.5", "5", "10", "15"],
      correct: 2,
      rational: "$OA=R=5\\Rightarrow AB=2R=10$."
    },
    {
      q: "Cho ƒë∆∞·ªùng tr√≤n (O). ƒêi·ªÉm M thu·ªôc ƒë∆∞·ªùng tr√≤n khi:",
      a: ["$OM< R$", "$OM\\le R$", "$OM=R$", "$OM>R$"],
      correct: 2,
      rational: "ƒêi·ªÉm tr√™n ƒë∆∞·ªùng tr√≤n c√°ch t√¢m ƒë√∫ng b·∫±ng b√°n k√≠nh."
    },
    {
      q: "Hai ƒë∆∞·ªùng tr√≤n (O;R) v√† (O';r) giao nhau khi:",
      a: ["$OO' > R+r$", "$OO'=R+r$", "$|R-r|<OO'<R+r$", "$OO'=|R-r|$"],
      correct: 2,
      rational: "ƒêi·ªÅu ki·ªán c·∫Øt nhau: $|R-r|<d<R+r$."
    },
    {
      q: "Cung nh·ªè $60^\\circ$ th√¨ s·ªë ƒëo g√≥c ·ªü t√¢m ch·∫Øn cung ƒë√≥ l√†:",
      a: ["$30^\\circ$", "$60^\\circ$", "$90^\\circ$", "$120^\\circ$"],
      correct: 1,
      rational: "G√≥c ·ªü t√¢m b·∫±ng s·ªë ƒëo cung b·ªã ch·∫Øn."
    },
    {
      q: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† SAI?",
      a: [
        "G√≥c ·ªü t√¢m b·∫±ng s·ªë ƒëo cung b·ªã ch·∫Øn",
        "G√≥c n·ªôi ti·∫øp b·∫±ng n·ª≠a s·ªë ƒëo cung b·ªã ch·∫Øn",
        "G√≥c n·ªôi ti·∫øp ch·∫Øn n·ª≠a ƒë∆∞·ªùng tr√≤n l√† g√≥c vu√¥ng",
        "G√≥c n·ªôi ti·∫øp b·∫±ng s·ªë ƒëo cung b·ªã ch·∫Øn"
      ],
      correct: 3,
      rational: "G√≥c n·ªôi ti·∫øp = n·ª≠a s·ªë ƒëo cung (kh√¥ng ph·∫£i b·∫±ng cung)."
    },
    {
      q: "Di·ªán t√≠ch h√¨nh tr√≤n l√† $S=225\\pi\\,cm^2$. B√°n k√≠nh l√†:",
      a: ["9cm", "15cm", "225cm", "$225\\pi$ cm"],
      correct: 1,
      rational: "$\\pi R^2=225\\pi\\Rightarrow R^2=225\\Rightarrow R=15$."
    }      
    ];

    // =======================
    // 2) UTILS: shuffle + rotate
    // =======================
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    // Rotate options so correct index becomes targetIndex
    function rotateToIndex(opts, correctIdx, targetIdx){
      const n = opts.length;
      const shift = (targetIdx - correctIdx + n) % n;
      if(shift === 0) return {opts, correctIdx};
      const rotated = opts.slice(-shift).concat(opts.slice(0, -shift));
      const newCorrect = (correctIdx + shift) % n;
      return {opts: rotated, correctIdx: newCorrect};
    }

    // =======================
    // 3) PREP: random options + balance A/B/C/D
    // =======================
    function normalizeQuestions(raw){
      // Convert each question to standard form:
      // { q, options:[{text, isCorrect}], rationale }
      return raw.map(item => {
        let options;
        if(Array.isArray(item.a)){
          options = item.a.map((t, i) => ({ text: t, isCorrect: i === item.correct }));
        } else {
          // a,b,c,d string style
          const arr = [item.a, item.b, item.c, item.d];
          options = arr.map((t, i) => ({ text: t, isCorrect: i === item.correct }));
        }
        const rationale = item.rational || item.explain || item.explanation || "";
        return { q: item.q, options, rationale };
      });
    }

    function randomizeAndBalance(qs){
      // Step 1: shuffle options each question
      qs.forEach(q=>{
        q.options = shuffleArray(q.options);
      });

      // Step 2: balance correct letters across A/B/C/D using greedy assignment
      const n = qs.length;
      const base = Math.floor(n/4);
      const remainder = n % 4;
      // target counts: distribute remainder to first letters A,B,C...
      const targets = [base, base, base, base];
      for(let i=0;i<remainder;i++) targets[i]++;

      const used = [0,0,0,0];

      qs.forEach(q=>{
        let correctIdx = q.options.findIndex(o=>o.isCorrect);
        // choose a letter that still has capacity; prefer the one with most remaining
        const remaining = targets.map((t,i)=>t-used[i]);
        let targetIdx = remaining.indexOf(Math.max(...remaining));
        if(remaining[targetIdx] <= 0){
          // fallback (shouldn't happen): keep current
          targetIdx = correctIdx;
        }
        const rotated = rotateToIndex(q.options, correctIdx, targetIdx);
        q.options = rotated.opts;
        correctIdx = rotated.correctIdx;
        used[correctIdx]++;
      });

      return qs;
    }

    let prepared = randomizeAndBalance(normalizeQuestions(questions));

    // =======================
    // 4) GAME STATE
    // =======================
    let currentIdx = 0;
    let score = 0;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type){
      if(audioCtx.state === "suspended") audioCtx.resume();
      const now = audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      if(type==="correct"){
        osc.type="triangle";
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.linearRampToValueAtTime(880, now+0.1);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.3, now+0.05);
        gain.gain.exponentialRampToValueAtTime(0.01, now+0.4);
        osc.start(now); osc.stop(now+0.4);
      } else if(type==="wrong"){
        osc.type="sawtooth";
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(80, now+0.3);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now+0.3);
        osc.start(now); osc.stop(now+0.3);
      } else if(type==="win"){
        const notes=[523.25,659.25,783.99,1046.5,783.99,1046.5];
        let t=now;
        notes.forEach(freq=>{
          const o=audioCtx.createOscillator();
          const g=audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.type="sine"; o.frequency.value=freq;
          o.start(t);
          g.gain.setValueAtTime(0.2, t);
          g.gain.exponentialRampToValueAtTime(0.01, t+0.2);
          o.stop(t+0.25);
          t += 0.15;
        });
      }
    }

    function fireConfetti(){
      const canvas=document.getElementById("confetti-canvas");
      const ctx=canvas.getContext("2d");
      canvas.width=window.innerWidth;
      canvas.height=window.innerHeight;

      const particles=[];
      const colors=["#FFD700","#FF6347","#00BFFF","#32CD32","#FF69B4"];

      for(let i=0;i<100;i++){
        particles.push({
          x:canvas.width/2, y:canvas.height/2,
          vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15,
          color:colors[Math.floor(Math.random()*colors.length)],
          life:1.0
        });
      }

      function animate(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let active=false;
        particles.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.life-=0.02;
          if(p.life>0){
            ctx.globalAlpha=p.life;
            ctx.fillStyle=p.color;
            ctx.fillRect(p.x,p.y,8,8);
            active=true;
          }
        });
        if(active) requestAnimationFrame(animate);
        else ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      animate();
    }

    function startGame(){
      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("game-screen").classList.remove("hidden");
      document.getElementById("result-screen").classList.add("hidden");

      score = 0;
      currentIdx = 0;
      document.getElementById("score").innerText = score;
      document.getElementById("total-q").innerText = prepared.length;

      renderQuestion();
    }

    function renderQuestion(){
      if(currentIdx >= prepared.length){
        endGame(); return;
      }
      const q = prepared[currentIdx];
      document.getElementById("current-q").innerText = currentIdx + 1;

      // progress: show true progress including current question
      const percent = ((currentIdx + 1) / prepared.length) * 100;
      document.getElementById("progress-bar").style.width = `${percent}%`;

      document.getElementById("mascot").innerText = "ü§î";

      // IMPORTANT: use innerHTML so MathJax works for question text
      const qt = document.getElementById("question-text");
      qt.innerHTML = q.q;

      const grid = document.getElementById("options-grid");
      grid.innerHTML = "";

      q.options.forEach((opt, idx)=>{
        const btn = document.createElement("button");
        btn.className = "option-btn bg-white border-2 border-transparent p-4 rounded-xl text-left shadow-sm text-gray-700 font-medium text-lg";
        btn.innerHTML = `<span class="font-bold text-blue-500 mr-2">${String.fromCharCode(65+idx)}.</span> ${opt.text}`;
        btn.onclick = ()=>checkAnswer(idx, btn);
        grid.appendChild(btn);
      });

      if(window.MathJax) MathJax.typesetPromise();
    }

    function checkAnswer(selectedIdx, btn){
      const buttons = document.querySelectorAll(".option-btn");
      buttons.forEach(b=>b.disabled=true);

      const q = prepared[currentIdx];
      const correctIdx = q.options.findIndex(o=>o.isCorrect);
      const isCorrect = selectedIdx === correctIdx;

      const modal = document.getElementById("rationale-modal");
      const feedbackTitle = document.getElementById("feedback-title");
      const feedbackIcon = document.getElementById("feedback-icon");
      const feedbackRationale = document.getElementById("feedback-rationale");

      if(isCorrect){
        btn.classList.add("correct-anim");
        score += 10;
        document.getElementById("score").innerText = score;
        document.getElementById("mascot").innerText = "üòé";
        playSound("correct");
        fireConfetti();

        feedbackTitle.innerText = "Tuy·ªát V·ªùi!";
        feedbackTitle.className = "text-2xl font-bold mb-3 text-green-600";
        feedbackIcon.innerText = "üéâ";
      }else{
        btn.classList.add("wrong-anim");
        buttons[correctIdx].classList.add("correct-anim");
        document.getElementById("mascot").innerText = "üòÖ";
        playSound("wrong");

        feedbackTitle.innerText = "Ti·∫øc Qu√°!";
        feedbackTitle.className = "text-2xl font-bold mb-3 text-red-600";
        feedbackIcon.innerText = "üí°";
      }

      // Explanation compact 1‚Äì2 lines
      const explain = q.rationale && q.rationale.trim() ? q.rationale : `ƒê√°p √°n ƒë√∫ng l√† ${String.fromCharCode(65 + correctIdx)}.`;
      feedbackRationale.innerHTML = explain;

      if(window.MathJax) MathJax.typesetPromise([feedbackRationale]);

      setTimeout(()=>modal.classList.remove("hidden"), 500);
    }

    function nextQuestion(){
      document.getElementById("rationale-modal").classList.add("hidden");
      currentIdx++;
      renderQuestion();
    }

    function endGame(){
      document.getElementById("game-screen").classList.add("hidden");
      document.getElementById("result-screen").classList.remove("hidden");

      const maxScore = prepared.length * 10;
      const percent = Math.round((score / maxScore) * 100);

      document.getElementById("final-score").innerText = `${score}/${maxScore}`;
      document.getElementById("final-percent").innerText = `${percent}%`;

      let comment = "";
      if(percent >= 90) comment = "Tuy·ªát v·ªùi! Em ƒë√£ s·∫µn s√†ng b·ª©t ph√° r·ªìi!";
      else if(percent >= 70) comment = "R·∫•t t·ªët! √în th√™m v√†i d·∫°ng n·ªØa l√† ho√†n h·∫£o.";
      else comment = "Kh√¥ng sao! Xem l·∫°i gi·∫£i th√≠ch t·ª´ng c√¢u, em s·∫Ω ti·∫øn b·ªô nhanh.";

      document.getElementById("teacher-comment").innerText = comment;

      playSound("win");
      fireConfetti();
    }

    window.addEventListener("resize", ()=>{
      const canvas=document.getElementById("confetti-canvas");
      canvas.width=window.innerWidth;
      canvas.height=window.innerHeight;
    });
  </script>
</body>
</html>
