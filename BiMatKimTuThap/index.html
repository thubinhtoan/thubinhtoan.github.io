<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√≠ M·∫≠t Kim T·ª± Th√°p - To√°n 9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Marcellus&display=swap');

        body {
            font-family: 'Marcellus', serif;
            background-color: #0f0a05;
            color: #f0e6d2;
            overflow: hidden;
            margin: 0;
            user-select: none;
        }

        .egypt-font {
            font-family: 'Cinzel', serif;
        }

        /* --- Background --- */
        #desert-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background: radial-gradient(circle at center bottom, #cca466 0%, #5d4037 60%, #1a120b 100%);
        }

        .sand-dust {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.4;
            animation: drift 120s linear infinite;
        }

        @keyframes drift {
            from { background-position: 0 0; }
            to { background-position: 1000px 0; }
        }

        /* --- Game Container --- */
        .tablet-panel {
            background: linear-gradient(135deg, #e6cba5, #d4b483);
            border: 8px solid #8d6e63;
            border-image: linear-gradient(to bottom, #d7ccc8, #8d6e63, #3e2723) 1;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 0 60px rgba(62, 39, 35, 0.5);
            color: #3e2723;
            position: relative;
        }

        .tablet-panel::before {
            content: "ìÇÄ";
            position: absolute;
            top: 10px; left: 50%; transform: translateX(-50%);
            font-size: 3rem;
            opacity: 0.2;
            color: #3e2723;
        }

        .hieroglyphs {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/wall-4-light.png');
            opacity: 0.6;
            pointer-events: none;
        }

        /* --- Buttons --- */
        .btn-stone {
            background: linear-gradient(to bottom, #d7ccc8, #a1887f);
            border: 2px solid #5d4037;
            color: #3e2723;
            font-weight: bold;
            font-size: 1.15rem;
            transition: all 0.2s;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-stone:hover {
            transform: translateY(-3px);
            background: linear-gradient(to bottom, #efebe9, #bcaaa4);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            cursor: pointer;
        }

        .btn-stone:active { transform: translateY(1px); }

        .btn-stone.correct {
            background: linear-gradient(to bottom, #66bb6a, #2e7d32) !important;
            border-color: #1b5e20 !important;
            color: white !important;
            text-shadow: none;
            box-shadow: 0 0 20px #4caf50;
        }

        .btn-stone.wrong {
            background: linear-gradient(to bottom, #ef5350, #c62828) !important;
            border-color: #b71c1c !important;
            color: white !important;
            text-shadow: none;
            animation: shake 0.4s;
        }

        /* --- Scroll (Explanation) --- */
        #papyrus-scroll {
            background: #fff3e0;
            background-image: url('https://www.transparenttextures.com/patterns/old-map.png');
            color: #4e342e;
            border-top: 4px double #8d6e63;
            border-bottom: 4px double #8d6e63;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transform-origin: top;
            transform: scaleY(0);
            padding: 0 1.5rem;
        }

        #papyrus-scroll.show {
            max-height: 500px;
            opacity: 1;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transform: scaleY(1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* --- Math Display --- */
        .system-eq {
            display: inline-flex;
            flex-direction: column;
            text-align: left;
            border-left: 3px solid currentColor;
            padding-left: 8px;
            border-radius: 4px 0 0 4px;
            vertical-align: middle;
            line-height: 1.5;
            font-style: italic;
        }
        
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
            font-size: 0.9em;
        }
        .fraction > span { display: block; padding: 0.1em; }
        .fraction span.numerator { border-bottom: 1px solid currentColor; }
        .fraction span.denominator { border-top: 1px solid transparent; }

        /* --- Animations --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes shine {
            0% { background-position: -100px; }
            100% { background-position: 500px; }
        }

        /* --- Gem Progress --- */
        .gem-container {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 10px;
        }
        .gem {
            width: 12px; height: 20px;
            background: #3e2723;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: all 0.5s;
        }
        .gem.active {
            background: #00e676;
            box-shadow: 0 0 10px #00e676;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="desert-bg"></div>
    <div class="sand-dust"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="tablet-panel p-12 text-center max-w-2xl w-full z-10 rounded-lg">
        <div class="hieroglyphs"></div>
        <div class="relative z-10">
            <h1 class="egypt-font text-5xl md:text-7xl text-brown-900 mb-2 drop-shadow-sm" style="color: #3e2723;">B√ç M·∫¨T<br>KIM T·ª∞ TH√ÅP</h1>
            <h2 class="text-xl text-brown-800 mb-8 font-bold tracking-widest uppercase border-b-2 border-brown-500 inline-block pb-1">√în T·∫≠p Ch∆∞∆°ng 1</h2>
            
            <p class="text-lg text-brown-900 mb-8 leading-relaxed font-semibold">
                "H·ª°i k·∫ª l·ªØ h√†nh t√¨m ki·∫øm tri th·ª©c. ƒê·ªÉ m·ªü c√°nh c·ª≠a v√†o Ph√≤ng Ch√¢u B√°u, ng∆∞∆°i ph·∫£i gi·∫£i m√£ 15 phi·∫øn ƒë√° c·ªï ƒë·∫°i kh·∫Øc ghi nh·ªØng b√≠ ·∫©n v·ªÅ <b>Ph∆∞∆°ng Tr√¨nh & H·ªá Ph∆∞∆°ng Tr√¨nh</b>."
            </p>

            <div class="grid grid-cols-2 gap-4 text-left bg-white/30 p-4 rounded mb-8 border border-brown-400 text-brown-900">
                <div>üëÅÔ∏è 6 C√¢u Nh·∫≠n Bi·∫øt</div>
                <div>üß† 5 C√¢u Th√¥ng Hi·ªÉu</div>
                <div>‚öñÔ∏è 3 C√¢u V·∫≠n D·ª•ng</div>
                <div>üëë 1 C√¢u V·∫≠n D·ª•ng Cao</div>
            </div>

            <button onclick="startGame()" class="btn-stone px-12 py-4 rounded text-2xl shadow-lg w-full md:w-auto egypt-font">
                KH√ÅM PH√Å NGAY ‚ñ≤
            </button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden w-full max-w-4xl z-10 flex-col h-full justify-center">
        <!-- Header -->
        <div class="flex justify-between items-end mb-4 px-2 text-orange-100">
            <div>
                <div class="text-xs uppercase tracking-widest opacity-80">Phi·∫øn ƒë√°</div>
                <div class="text-2xl font-bold egypt-font">#<span id="q-number">1</span></div>
            </div>
            
            <div class="flex-grow mx-8 hidden md:block">
                <div class="gem-container" id="gem-bar">
                    <!-- Gems injected here -->
                </div>
            </div>

            <div class="text-right">
                <div class="text-xs uppercase tracking-widest opacity-80">ƒêi·ªÉm s·ªë</div>
                <div class="text-2xl font-bold text-yellow-400 egypt-font" id="score">0</div>
            </div>
        </div>

        <!-- Question Panel -->
        <div class="tablet-panel p-8 mb-4 relative min-h-[180px] flex flex-col justify-center items-center text-center rounded-lg">
            <div class="hieroglyphs"></div>
            
            <div id="level-badge" class="absolute top-0 right-0 bg-brown-800 text-white px-3 py-1 text-xs shadow font-bold z-10 rounded-bl-lg" style="background: #3e2723;">NH·∫¨N BI·∫æT</div>
            
            <div id="question-text" class="text-2xl md:text-3xl font-bold text-brown-900 leading-relaxed relative z-10 egypt-font">
                ƒêang gi·∫£i m√£ k√Ω t·ª± c·ªï...
            </div>
        </div>

        <!-- Explanation (Papyrus) -->
        <div id="papyrus-scroll" class="rounded-sm shadow-xl relative">
            <div class="text-brown-800 font-bold mb-2 border-b border-brown-400 pb-1 egypt-font tracking-wide mt-2">üìú L·ªúI GI·∫¢I C·ªî ƒê·∫†I:</div>
            <div id="log-content" class="text-brown-900 font-medium leading-relaxed text-lg"></div>
        </div>

        <!-- Options -->
        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Buttons injected here -->
        </div>

        <!-- Next Button -->
        <div id="next-btn-container" class="hidden text-center pb-4">
            <button onclick="nextQuestion()" class="px-10 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded shadow-lg border-2 border-yellow-300 transition transform hover:scale-105">
                PHI·∫æN ƒê√Å TI·∫æP THEO &rarr;
            </button>
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/90">
        <div class="tablet-panel p-12 text-center max-w-2xl w-full mx-4 rounded-lg">
            <div class="hieroglyphs"></div>
            <div class="relative z-10">
                <div class="text-7xl mb-4 text-yellow-600">üè∫</div>
                <h2 class="egypt-font text-5xl text-brown-900 mb-4">KHO B√ÅU ƒê√É M·ªû!</h2>
                <p class="text-xl text-brown-800 mb-8 font-bold">"Tr√≠ tu·ªá c·ªßa ng∆∞∆°i s√°ng h∆°n c·∫£ v√†ng r√≤ng c·ªßa Pharaoh."</p>
                
                <div class="bg-white/40 p-6 rounded border border-brown-300 inline-block mb-8 w-full shadow-inner">
                    <div class="text-sm text-brown-700 uppercase mb-2 tracking-widest">T·ªïng ƒêi·ªÉm Kh·∫£o C·ªï</div>
                    <div class="text-6xl font-bold text-brown-900 egypt-font" id="final-score">0</div>
                </div>

                <div>
                    <button onclick="location.reload()" class="btn-stone px-10 py-4 rounded text-xl w-full">
                        KH√ÅM PH√Å L·∫†I
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sound Effects (Invisible) -->
    <div id="sfx"></div>

    <script>
        // --- DATA ---
        // 15 Questions: End of Chapter 1 Review (Math 9)
       const questions = [
    // LEVEL 1: NH·∫¨N BI·∫æT (6 c√¢u)
    {
        q: "Ph∆∞∆°ng tr√¨nh n√†o sau ƒë√¢y l√† ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n?",
        a: ["2x - 3y = 5", "x<sup>2</sup> + y = 1", "0x + 0y = 2", "x + 1 = 0"],
        correct: 0,
        rationale: "Ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t hai ·∫©n c√≥ d·∫°ng ax + by = c (a, b kh√¥ng ƒë·ªìng th·ªùi b·∫±ng 0).<br>2x - 3y = 5 th·ªèa m√£n.",
        level: "NH·∫¨N BI·∫æT"
    },
    {
        q: "C·∫∑p s·ªë (2; 1) l√† nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh n√†o?",
        a: ["x - y = 0", "x + y = 3", "2x + y = 4", "x + 2y = 5"],
        correct: 1,
        rationale: "Thay x=2, y=1 v√†o x + y = 3 &rArr; 2 + 1 = 3 (ƒê√∫ng).",
        level: "NH·∫¨N BI·∫æT"
    },
    {
        q: "H·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>x = 3</span><span>2x - y = 1</span></div> c√≥ nghi·ªám l√†:",
        a: ["(2; 3)", "(3; 1)", "(3; 5)", "(1; 3)"],
        correct: 2,
        rationale: "Thay x=3 v√†o pt 2: 2(3) - y = 1 &rArr; 6 - y = 1 &rArr; y = 5. V·∫≠y nghi·ªám l√† (3; 5).",
        level: "NH·∫¨N BI·∫æT"
    },
    {
        q: "C√¥ng th·ª©c nghi·ªám t·ªïng qu√°t c·ªßa ph∆∞∆°ng tr√¨nh 2x - y = 1 bi·ªÉu di·ªÖn theo x l√†:",
        a: ["y = 1 - 2x", "y = 2x + 1", "x = (y+1)/2", "y = 2x - 1"],
        correct: 3,
        rationale: "2x - y = 1 &rArr; y = 2x - 1.",
        level: "NH·∫¨N BI·∫æT"
    },
    {
        q: "Trong ph∆∞∆°ng ph√°p th·∫ø, ƒë·ªÉ gi·∫£i h·ªá <div class='system-eq'><span>x + 2y = 4</span><span>3x - y = 5</span></div>, ta n√™n r√∫t ·∫©n n√†o?",
        a: ["R√∫t x t·ª´ ph∆∞∆°ng tr√¨nh 1", "R√∫t y t·ª´ ph∆∞∆°ng tr√¨nh 1", "R√∫t x t·ª´ ph∆∞∆°ng tr√¨nh 2", "R√∫t y t·ª´ ph∆∞∆°ng tr√¨nh 2"],
        correct: 0,
        rationale: "·∫®n x ·ªü pt 1 c√≥ h·ªá s·ªë l√† 1, r√∫t x = 4 - 2y l√† ƒë∆°n gi·∫£n nh·∫•t.",
        level: "NH·∫¨N BI·∫æT"
    },
    {
        q: "Ph∆∞∆°ng tr√¨nh (x - 2)(y + 1) = 0 t∆∞∆°ng ƒë∆∞∆°ng v·ªõi:",
        a: ["x = 2 v√† y = -1", "x = 2 ho·∫∑c y = -1", "x = -2 ho·∫∑c y = 1", "x = 0 ho·∫∑c y = 0"],
        correct: 1,
        rationale: "Ph∆∞∆°ng tr√¨nh t√≠ch A.B=0 &hArr; A=0 ho·∫∑c B=0.<br>x - 2 = 0 &rArr; x=2; y + 1 = 0 &rArr; y=-1.",
        level: "NH·∫¨N BI·∫æT"
    },

    // LEVEL 2: TH√îNG HI·ªÇU (5 c√¢u)
    {
        q: "Gi·∫£i h·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>x + y = 5</span><span>x - y = 1</span></div>.",
        a: ["(2; 3)", "(3; 2)", "(4; 1)", "(1; 4)"],
        correct: 1,
        rationale: "C·ªông 2 v·∫ø: 2x = 6 &rArr; x = 3.<br>Thay x=3 v√†o x+y=5 &rArr; 3+y=5 &rArr; y=2.",
        level: "TH√îNG HI·ªÇU"
    },
    {
        q: "T√¨m ƒêKXƒê c·ªßa ph∆∞∆°ng tr√¨nh <div class='fraction'><span class='numerator'>3</span><span class='denominator'>x + 2</span></div> = <div class='fraction'><span class='numerator'>x</span><span class='denominator'>x - 1</span></div>.",
        a: ["x &ne; -2 ho·∫∑c x &ne; 1", "x &ne; 2 v√† x &ne; -1", "x &ne; -2 v√† x &ne; 1", "x &ne; 0"],
        correct: 2,
        rationale: "M·∫´u th·ª©c kh√°c 0: x + 2 &ne; 0 &rArr; x &ne; -2; x - 1 &ne; 0 &rArr; x &ne; 1.",
        level: "TH√îNG HI·ªÇU"
    },
    {
        q: "T√¨m a, b bi·∫øt h·ªá <div class='system-eq'><span>ax + y = 3</span><span>x + by = 3</span></div> c√≥ nghi·ªám (1; 1).",
        a: ["a = 2, b = 2", "a = 1, b = 1", "a = 2, b = 1", "a = 3, b = 3"],
        correct: 0,
        rationale: "Thay x=1, y=1 v√†o h·ªá:<br>a + 1 = 3 &rArr; a = 2.<br>1 + b = 3 &rArr; b = 2.",
        level: "TH√îNG HI·ªÇU"
    },
    {
        q: "S·ªë nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh x<sup>2</sup> - 3x + 2 = 0 l√†:",
        a: ["1 nghi·ªám", "2 nghi·ªám", "V√¥ nghi·ªám", "3 nghi·ªám"],
        correct: 1,
        rationale: "Ph√¢n t√≠ch th√†nh nh√¢n t·ª≠: (x - 1)(x - 2) = 0.<br>Suy ra x = 1 ho·∫∑c x = 2.",
        level: "TH√îNG HI·ªÇU"
    },
    {
        q: "V·ªõi gi√° tr·ªã n√†o c·ªßa k th√¨ ƒë∆∞·ªùng th·∫≥ng y = (k-1)x + 2 song song v·ªõi ƒë∆∞·ªùng th·∫≥ng y = 2x - 1?",
        a: ["k = 1", "k = 2", "k = 3", "k = -1"],
        correct: 2,
        rationale: "Hai ƒë∆∞·ªùng th·∫≥ng song song khi h·ªá s·ªë g√≥c b·∫±ng nhau: k - 1 = 2 &rArr; k = 3.",
        level: "TH√îNG HI·ªÇU"
    },

    // LEVEL 3: V·∫¨N D·ª§NG (3 c√¢u)
    {
        q: "(Th·ª±c t·∫ø) M·ªôt m·∫£nh v∆∞·ªùn h√¨nh ch·ªØ nh·∫≠t c√≥ chu vi 34m. N·∫øu tƒÉng chi·ªÅu d√†i 2m v√† gi·∫£m chi·ªÅu r·ªông 1m th√¨ di·ªán t√≠ch kh√¥ng ƒë·ªïi. T√≠nh chi·ªÅu d√†i v√† chi·ªÅu r·ªông.",
        a: ["9m v√† 8m", "10m v√† 7m", "11m v√† 6m", "12m v√† 5m"],
        correct: 3,
        rationale: "G·ªçi x, y l√† d√†i, r·ªông. H·ªá:<br>2(x+y)=34 &rArr; x+y=17.<br>(x+2)(y-1)=xy &rArr; -x+2y=2.<br>Gi·∫£i h·ªá ƒë∆∞·ª£c x=12, y=5.",
        level: "V·∫¨N D·ª§NG"
    },
    {
        q: "T√¨m m ƒë·ªÉ h·ªá <div class='system-eq'><span>x + my = 1</span><span>mx - y = -m</span></div> c√≥ nghi·ªám duy nh·∫•t.",
        a: ["M·ªçi m", "m &ne; 0", "m &ne; 1", "m = 0"],
        correct: 0,
        rationale: "Ta x√©t t·ª∑ s·ªë a/a' v√† b/b': 1/m v√† m/-1. T√≠ch ch√©o: -1 &ne; m<sup>2</sup>.<br>V√¨ m<sup>2</sup> &ge; 0 n√™n m<sup>2</sup> &ne; -1 lu√¥n ƒë√∫ng v·ªõi m·ªçi m.",
        level: "V·∫¨N D·ª§NG"
    },
    {
        q: "Hai v√≤i n∆∞·ªõc c√πng ch·∫£y v√†o b·ªÉ th√¨ sau 4 gi·ªù 48 ph√∫t ƒë·∫ßy b·ªÉ. N·∫øu m·ªü v√≤i 1 trong 3h, v√≤i 2 trong 4h th√¨ ƒë∆∞·ª£c 3/4 b·ªÉ. H·ªèi v√≤i 1 ch·∫£y m·ªôt m√¨nh bao l√¢u ƒë·∫ßy b·ªÉ?",
        a: ["12 gi·ªù", "8 gi·ªù", "6 gi·ªù", "10 gi·ªù"],
        correct: 1,
        rationale: "4h48' = 24/5 h. G·ªçi x, y l√† th·ªùi gian m·ªói v√≤i. H·ªá:<br>1/x + 1/y = 5/24<br>3/x + 4/y = 3/4<br>ƒê·∫∑t u=1/x, v=1/y. Gi·∫£i h·ªá u, v r·ªìi suy ra x = 8.",
        level: "V·∫¨N D·ª§NG"
    },

    // LEVEL 4: V·∫¨N D·ª§NG CAO (1 c√¢u)
    {
        q: "Cho h·ªá ph∆∞∆°ng tr√¨nh <div class='system-eq'><span>x + y = 3m - 2</span><span>x - 2y = 3 - 3m</span></div>. T√¨m m nguy√™n ƒë·ªÉ h·ªá c√≥ nghi·ªám (x; y) sao cho x<sup>2</sup> + y<sup>2</sup> ƒë·∫°t gi√° tr·ªã nh·ªè nh·∫•t.",
        a: ["m = 2", "m = 0", "m = 1", "m = -1"],
        correct: 2,
        rationale: "Gi·∫£i h·ªá:<br>T·ª´ x + y = 3m - 2 v√† x - 2y = 3 - 3m &rArr; tr·ª´ hai ph∆∞∆°ng tr√¨nh: 3y = 6m - 5 &rArr; y = 2m - 5/3.<br>Thay l·∫°i v√†o x + y = 3m - 2 &rArr; x = m - 1/3.<br>ƒê·∫∑t P = x<sup>2</sup> + y<sup>2</sup> = 5m<sup>2</sup> - \\dfrac{22}{3}m + \\dfrac{26}{9}.<br>P l√† tam th·ª©c b·∫≠c hai c√≥ ƒë·ªânh t·∫°i m = 11/15 &approx; 0,73. V·ªõi m nguy√™n, P nh·ªè nh·∫•t t·∫°i m = 1.",
        level: "V·∫¨N D·ª§NG CAO"
    }
];

        // --- GAME LOGIC ---
        let currentQIndex = 0;
        let score = 0;
        
        // Audio Setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'stone') { // Deep thud
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(80, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
                gain.gain.setValueAtTime(0.6, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'correct') { // Magical chord
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, now); 
                osc.frequency.linearRampToValueAtTime(880, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'wrong') { // Crumble
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.4);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'win') { // Fanfare
                [392.00, 523.25, 659.25, 783.99].forEach((f, i) => {
                    setTimeout(() => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g);
                        g.connect(audioCtx.destination);
                        o.type = 'square';
                        o.frequency.value = f;
                        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                        o.start();
                        o.stop(audioCtx.currentTime + 0.5);
                    }, i * 150);
                });
            }
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            
            initGems();
            playSound('stone');
            currentQIndex = 0;
            score = 0;
            updateUI();
            loadQuestion();
        }

        function initGems() {
            const container = document.getElementById('gem-bar');
            container.innerHTML = '';
            for(let i=0; i<questions.length; i++) {
                const gem = document.createElement('div');
                gem.className = 'gem';
                gem.id = `gem-${i}`;
                container.appendChild(gem);
            }
        }

        function loadQuestion() {
            const q = questions[currentQIndex];
            
            document.getElementById('q-number').innerText = currentQIndex + 1;
            document.getElementById('question-text').innerHTML = q.q;
            document.getElementById('level-badge').innerText = q.level;
            
            // Reset UI
            const scroll = document.getElementById('papyrus-scroll');
            scroll.classList.remove('show');
            document.getElementById('next-btn-container').classList.add('hidden');

            // Difficulty Colors
            const badge = document.getElementById('level-badge');
            if (q.level === "NH·∫¨N BI·∫æT") badge.style.backgroundColor = "#2e7d32";
            else if (q.level === "TH√îNG HI·ªÇU") badge.style.backgroundColor = "#1565c0";
            else if (q.level === "V·∫¨N D·ª§NG CAO") badge.style.backgroundColor = "#c62828";
            else badge.style.backgroundColor = "#f9a825"; // Van Dung

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            
            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "btn-stone w-full p-4 rounded min-h-[80px]";
                btn.innerHTML = opt;
                btn.onclick = () => handleAnswer(idx, q.correct, btn);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(selected, correct, btn) {
            const btns = document.querySelectorAll('.btn-stone');
            btns.forEach(b => b.disabled = true);

            const q = questions[currentQIndex];
            const scroll = document.getElementById('papyrus-scroll');
            const content = document.getElementById('log-content');
            
            content.innerHTML = q.rationale;
            scroll.classList.add('show');

            if (selected === correct) {
                btn.classList.add('correct');
                score += 100;
                playSound('correct');
                
                // Light up gem
                document.getElementById(`gem-${currentQIndex}`).classList.add('active');
            } else {
                btn.classList.add('wrong');
                btns[correct].classList.add('correct');
                playSound('wrong');
            }

            updateUI();
            document.getElementById('next-btn-container').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('score').innerText = score;
        }

        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex < questions.length) {
                playSound('stone');
                loadQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            playSound('win');
        }

    </script>
</body>
</html>
