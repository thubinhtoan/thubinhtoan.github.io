<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V∆∞∆°ng Qu·ªëc K·∫πo Ng·ªçt: ƒê∆∞·ªùng Ph√¢n Gi√°c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Varela Round', sans-serif;
            background-color: #fdf2f8;
            background-image:
                radial-gradient(#fbcfe8 15%, transparent 16%),
                radial-gradient(#fbcfe8 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            overflow-x: hidden;
        }

        .font-candy { font-family: 'Fredoka One', cursive; }

        .candy-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 30px;
            border: 6px solid #fff;
            box-shadow:
                0 10px 0 #f472b6,
                0 20px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .btn-sweet {
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 20px;
            border-bottom: 6px solid rgba(0,0,0,0.15);
        }
        .btn-sweet:active { transform: translateY(4px); border-bottom-width: 2px; }
        .btn-sweet:hover { transform: translateY(-2px); filter: brightness(1.1); }

        .btn-option {
            background: #fff;
            border: 3px solid #fce7f3;
            color: #831843;
        }
        .btn-option:hover { background: #fdf2f8; border-color: #f472b6; }

        .candy-stripe {
            background: repeating-linear-gradient(
                45deg,
                #f472b6,
                #f472b6 10px,
                #ec4899 10px,
                #ec4899 20px
            );
            animation: moveStripe 1s linear infinite;
        }
        @keyframes moveStripe {
            0% { background-position: 0 0; }
            100% { background-position: 28px 0; }
        }

        .sweet-float {
            position: absolute;
            animation: float 3s ease-in-out infinite;
            z-index: -1;
            font-size: 3rem;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(10deg); }
        }

        @keyframes popUp {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-anim { animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .confetti-piece {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            top: 0;
            opacity: 0;
            z-index: 100;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 1;}
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Decor -->
    <div class="sweet-float top-10 left-10">üç¨</div>
    <div class="sweet-float bottom-20 right-10" style="animation-delay: 1s">üç©</div>
    <div class="sweet-float top-20 right-20" style="animation-delay: 0.5s">üç≠</div>
    <div class="sweet-float bottom-10 left-20" style="animation-delay: 1.5s">üßÅ</div>

    <!-- START SCREEN -->
    <div id="start-screen" class="candy-card p-8 max-w-2xl w-full text-center z-10">
        <div class="mb-4 text-7xl animate-bounce">üè∞</div>
        <h1 class="font-candy text-5xl md:text-6xl text-pink-500 mb-2 drop-shadow-sm">
            V∆∞∆°ng Qu·ªëc<br><span class="text-cyan-500">K·∫πo Ng·ªçt</span>
        </h1>
        <p class="text-xl text-gray-500 font-bold mb-8">Th·ª≠ th√°ch ƒë∆∞·ªùng ph√¢n gi√°c üç∞</p>

        <div class="grid grid-cols-2 gap-3 text-left mb-8">
            <div class="bg-green-100 p-4 rounded-2xl text-green-700 font-bold border-2 border-green-200">üå± 6 Nh·∫≠n bi·∫øt</div>
            <div class="bg-blue-100 p-4 rounded-2xl text-blue-700 font-bold border-2 border-blue-200">üíß 5 Th√¥ng hi·ªÉu</div>
            <div class="bg-yellow-100 p-4 rounded-2xl text-yellow-700 font-bold border-2 border-yellow-200">‚≠ê 3 V·∫≠n d·ª•ng</div>
            <div class="bg-purple-100 p-4 rounded-2xl text-purple-700 font-bold border-2 border-purple-200">üëë 1 V·∫≠n d·ª•ng cao</div>
        </div>

        <button onclick="startGame()" class="btn-sweet w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white text-3xl py-4 rounded-2xl font-candy shadow-lg">
            V√†o C·ªïng Ngay! üç´
        </button>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden w-full max-w-3xl flex flex-col h-[90vh]">
        <!-- Header -->
        <div class="candy-card p-4 mb-4 flex justify-between items-center bg-white/80">
            <div class="flex items-center space-x-2">
                <div class="bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-bold text-sm uppercase">C√¢u h·ªèi</div>
                <div class="text-2xl font-candy text-gray-700">
                    <span id="q-curr" class="text-pink-500 text-3xl">1</span>/15
                </div>
            </div>

            <div class="flex-1 mx-4 h-6 bg-gray-200 rounded-full overflow-hidden border-2 border-white box-content shadow-inner">
                <div id="progress-bar" class="h-full candy-stripe transition-all duration-500 rounded-full" style="width: 0%"></div>
            </div>

            <div class="bg-yellow-100 px-4 py-2 rounded-2xl border-2 border-yellow-200 flex items-center">
                <i class="fas fa-cookie-bite text-yellow-600 mr-2"></i>
                <span id="score" class="text-2xl font-candy text-yellow-700">0</span>
            </div>
        </div>

        <!-- Question Body -->
        <div class="flex-1 candy-card p-6 md:p-8 flex flex-col overflow-hidden relative">
            <div id="level-badge" class="absolute top-4 right-4 bg-gray-100 text-gray-500 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider">
                Kh·ªüi ƒë·ªông
            </div>

            <div class="flex-1 overflow-y-auto pr-2 flex flex-col justify-center">
                <h2 id="question-text" class="font-candy text-2xl md:text-3xl text-slate-700 mb-8 text-center leading-relaxed">
                    Loading...
                </h2>

                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-[40px] p-8 max-w-lg w-full text-center border-8 border-white shadow-2xl modal-anim relative overflow-hidden">
            <div id="modal-bg" class="absolute top-0 left-0 w-full h-32 bg-green-100 -z-10 rounded-t-[32px]"></div>

            <div id="fb-icon" class="text-8xl mb-4 transform -translate-y-8 drop-shadow-md">üéâ</div>
            <h3 id="fb-title" class="font-candy text-3xl text-green-600 mb-4 uppercase">Tuy·ªát V·ªùi!</h3>

            <div class="bg-gray-50 p-6 rounded-2xl mb-6 text-left border-2 border-gray-100">
                <p id="fb-text" class="text-gray-600 text-lg leading-relaxed"></p>
            </div>

            <button onclick="nextQuestion()" class="btn-sweet w-full bg-cyan-400 text-white py-4 rounded-2xl text-xl font-bold uppercase tracking-wide">
                ƒêi Ti·∫øp Th√¥i! üç≠
            </button>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="result-screen" class="hidden candy-card p-10 max-w-md w-full text-center z-20">
        <div class="mb-6">
            <i class="fas fa-crown text-8xl text-yellow-400 drop-shadow-lg animate-pulse"></i>
        </div>

        <h2 class="font-candy text-4xl text-pink-500 mb-2">B·ªØa Ti·ªác Ho√†n T·∫•t!</h2>
        <p class="text-gray-400 font-bold mb-6">S·ªë b√°nh k·∫πo b·∫°n thu th·∫≠p ƒë∆∞·ª£c</p>

        <div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-3xl p-8 mb-8 border-4 border-white shadow-inner">
            <span id="final-score" class="font-candy text-7xl text-orange-500">0</span>
        </div>

        <p id="result-msg" class="text-xl font-bold text-slate-600 mb-8"></p>

        <button onclick="restartGame()" class="btn-sweet w-full bg-green-500 text-white py-4 rounded-2xl text-xl font-bold">
            <i class="fas fa-redo-alt mr-2"></i> Ch∆°i L·∫°i
        </button>
    </div>

    <script>
        // --- SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                const notes = [523.25, 659.25, 783.99];
                notes.forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.type = 'sine';
                    o.frequency.value = freq;
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    g.gain.setValueAtTime(0.1, now + i*0.05);
                    g.gain.exponentialRampToValueAtTime(0.01, now + i*0.05 + 0.4);
                    o.start(now + i*0.05);
                    o.stop(now + i*0.05 + 0.4);
                });
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(150, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start();
                osc.stop(now + 0.3);
            } else if (type === 'win') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(523.25, now + 0.1);
                osc.frequency.setValueAtTime(659.25, now + 0.2);
                osc.frequency.setValueAtTime(783.99, now + 0.4);
                osc.frequency.setValueAtTime(1046.50, now + 0.6);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 1.2);
                osc.start();
                osc.stop(now + 1.2);
            }
        }

        // --- DATA ---
        const questions = [
            // NB (6)
            {
                level: "Nh·∫≠n bi·∫øt",
                text: "ƒê∆∞·ªùng ph√¢n gi√°c AD c·ªßa tam gi√°c ABC chia c·∫°nh ƒë·ªëi di·ªán BC th√†nh hai ƒëo·∫°n th·∫≥ng t·ªâ l·ªá v·ªõi:",
                options: ["Hai c·∫°nh k·ªÅ AB v√† AC", "Hai ƒë∆∞·ªùng cao", "Hai ƒë∆∞·ªùng trung tuy·∫øn", "Hai g√≥c ·ªü ƒë√°y"],
                correct: 0,
                rationale: "ƒê·ªãnh l√≠: DB/DC = AB/AC."
            },
            {
                level: "Nh·∫≠n bi·∫øt",
                text: "Cho tam gi√°c ABC, AD l√† ph√¢n gi√°c c·ªßa g√≥c A (D thu·ªôc BC). H·ªá th·ª©c n√†o sau ƒë√¢y ƒë√∫ng?",
                options: ["DB/DC = AB/AC", "DB/DC = AC/AB", "DB/AB = DC/BC", "AD/AB = AD/AC"],
                correct: 0,
                rationale: "Theo t√≠nh ch·∫•t ƒë∆∞·ªùng ph√¢n gi√°c: DB/DC = AB/AC."
            },
            {
                level: "Nh·∫≠n bi·∫øt",
                text: "N·∫øu tam gi√°c ABC c√¢n t·∫°i A, ƒë∆∞·ªùng ph√¢n gi√°c AD c√≥ t√≠nh ch·∫•t g√¨ ƒë·∫∑c bi·ªát?",
                options: ["V·ª´a l√† ƒë∆∞·ªùng cao, trung tuy·∫øn", "Ch·ªâ l√† ƒë∆∞·ªùng cao", "Ch·ªâ l√† trung tuy·∫øn", "Kh√¥ng c√≥ g√¨ ƒë·∫∑c bi·ªát"],
                correct: 0,
                rationale: "Trong tam gi√°c c√¢n, ph√¢n gi√°c t·ª´ ƒë·ªânh ƒë·ªìng th·ªùi l√† trung tuy·∫øn v√† ƒë∆∞·ªùng cao."
            },
            {
                level: "Nh·∫≠n bi·∫øt",
                text: "ƒêi·ªÅu ki·ªán ƒë·ªÉ √°p d·ª•ng ƒë·ªãnh l√≠ ƒë∆∞·ªùng ph√¢n gi√°c trong tam gi√°c ABC v·ªõi c√°t tuy·∫øn AD l√†:",
                options: ["AD vu√¥ng g√≥c BC", "AD chia ƒë√¥i g√≥c A", "D l√† trung ƒëi·ªÉm BC", "AD // BC"],
                correct: 1,
                rationale: "AD ph·∫£i l√† ph√¢n gi√°c t·ª©c l√† chia g√≥c A th√†nh 2 g√≥c b·∫±ng nhau."
            },
            {
                level: "Nh·∫≠n bi·∫øt",
                text: "Cho h√¨nh v·∫Ω, AD l√† ph√¢n gi√°c. N·∫øu DB/DC = 1 th√¨ tam gi√°c ABC l√† tam gi√°c g√¨?",
                options: ["Tam gi√°c c√¢n t·∫°i A", "Tam gi√°c vu√¥ng t·∫°i A", "Tam gi√°c th∆∞·ªùng", "Tam gi√°c t√π"],
                correct: 0,
                rationale: "DB=DC ‚áí D l√† trung ƒëi·ªÉm; ph√¢n gi√°c ƒë·ªìng th·ªùi l√† trung tuy·∫øn ‚áí tam gi√°c c√¢n t·∫°i A."
            },
            {
                level: "Nh·∫≠n bi·∫øt",
                text: "T√≠nh ch·∫•t ƒë∆∞·ªùng ph√¢n gi√°c c≈©ng ƒë√∫ng cho tr∆∞·ªùng h·ª£p n√†o?",
                options: ["ƒê∆∞·ªùng ph√¢n gi√°c g√≥c ngo√†i", "ƒê∆∞·ªùng cao", "ƒê∆∞·ªùng trung tr·ª±c", "Tr·ªçng t√¢m"],
                correct: 0,
                rationale: "ƒê·ªãnh l√≠ m·ªü r·ªông ƒë√∫ng cho ph√¢n gi√°c g√≥c ngo√†i (x√©t ƒëo·∫°n th·∫≥ng theo h∆∞·ªõng ph√π h·ª£p)."
            },

            // TH (5)
            {
                level: "Th√¥ng hi·ªÉu",
                text: "Tam gi√°c ABC c√≥ AB=4, AC=6, ph√¢n gi√°c AD. T·ªâ s·ªë DB/DC b·∫±ng bao nhi√™u?",
                options: ["2/3", "3/2", "1/2", "4/10"],
                correct: 0,
                rationale: "DB/DC = AB/AC = 4/6 = 2/3."
            },
            {
                level: "Th√¥ng hi·ªÉu",
                text: "Cho tam gi√°c ABC, ph√¢n gi√°c AD. Bi·∫øt DB=2, DC=3. T·ªâ s·ªë AC/AB b·∫±ng bao nhi√™u?",
                options: ["3/2", "2/3", "5/2", "1"],
                correct: 0,
                rationale: "DB/DC = AB/AC ‚áí 2/3 = AB/AC ‚áí AC/AB = 3/2."
            },
            {
                level: "Th√¥ng hi·ªÉu",
                text: "Tam gi√°c ABC c√≥ AB=12, AC=20, BC=28. Ph√¢n gi√°c AD. ƒê·ªô d√†i ƒëo·∫°n DB l√†:",
                options: ["10.5", "17.5", "12", "14"],
                correct: 0,
                rationale: "DB/(28-DB)=12/20=3/5 ‚áí DB=10.5."
            },
            {
                level: "Th√¥ng hi·ªÉu",
                text: "Cho tam gi√°c ABC vu√¥ng t·∫°i A, AB=3, AC=4. Ph√¢n gi√°c AD. T√≠nh t·ªâ s·ªë DB/DC.",
                options: ["3/4", "4/3", "3/5", "4/5"],
                correct: 0,
                rationale: "DB/DC = AB/AC = 3/4."
            },
            {
                level: "Th√¥ng hi·ªÉu",
                text: "Tam gi√°c MNP c√≥ ph√¢n gi√°c MI. Bi·∫øt MN=5, MP=8, NI=3. ƒê·ªô d√†i IP l√†:",
                options: ["4.8", "5", "6", "3.5"],
                correct: 0,
                rationale: "NI/IP = MN/MP ‚áí 3/IP = 5/8 ‚áí IP = 24/5 = 4.8."
            },

            // VD (3)
            {
                level: "V·∫≠n d·ª•ng",
                text: "Cho tam gi√°c ABC c√≥ chu vi l√† 45cm. Ph√¢n gi√°c AD chia BC th√†nh DB=6cm, DC=9cm. T√≠nh ƒë·ªô d√†i c·∫°nh AB, AC.",
                options: ["AB=12, AC=18", "AB=10, AC=15", "AB=15, AC=22.5", "AB=8, AC=12"],
                correct: 0,
                rationale: "BC=15 ‚áí AB+AC=30; AB/AC=2/3 ‚áí AB=12, AC=18."
            },
            {
                level: "V·∫≠n d·ª•ng (Th·ª±c t·∫ø)",
                text: "M·ªôt m·∫£nh ƒë·∫•t h√¨nh tam gi√°c ABC c√≥ AB=30m, AC=50m. D·ª±ng h√†ng r√†o AD chia ƒë√¥i g√≥c A. T·ªâ l·ªá di·ªán t√≠ch ABD so v·ªõi ACD l√†?",
                options: ["3/5", "5/3", "9/25", "1/1"],
                correct: 0,
                rationale: "S_ABD/S_ACD = DB/DC = AB/AC = 30/50 = 3/5."
            },
            {
                level: "V·∫≠n d·ª•ng",
                text: "Cho tam gi√°c ABC, trung tuy·∫øn AM. Ph√¢n gi√°c g√≥c AMB c·∫Øt AB t·∫°i D, ph√¢n gi√°c g√≥c AMC c·∫Øt AC t·∫°i E. Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng?",
                options: ["DE // BC", "DE vu√¥ng g√≥c AM", "D l√† trung ƒëi·ªÉm AB", "E l√† trung ƒëi·ªÉm AC"],
                correct: 0,
                rationale: "T·ª´ t·ªâ s·ªë do ph√¢n gi√°c v√† MB=MC suy ra DA/DB = EA/EC ‚áí DE // BC."
            },

            // VDC (1)
            {
                level: "V·∫≠n d·ª•ng cao",
                text: "Tam gi√°c ABC c√≥ AB=4, AC=5, BC=6. Hai ƒë∆∞·ªùng ph√¢n gi√°c AD v√† BE c·∫Øt nhau t·∫°i I. T√≠nh t·ªâ s·ªë AI/ID.",
                options: ["3/2", "2/3", "4/5", "9/4"],
                correct: 0,
                rationale: "BD/DC=AB/AC=4/5 ‚áí BD=6¬∑4/9=8/3. Trong ŒîABD, BI l√† ph√¢n gi√°c t·∫°i B (v√¨ D n·∫±m tr√™n BC) ‚áí AI/ID = AB/BD = 4/(8/3)=3/2."
            }
        ];

        let currentIdx = 0;
        let score = 0;
        let isLocked = false;

        // Shuffle helper (Fisher‚ÄìYates)
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');

            // reset UI score immediately
            document.getElementById('score').innerText = score;

            loadQuestion();
        }

        function loadQuestion() {
            isLocked = false;
            const q = questions[currentIdx];

            // UI Updates
            document.getElementById('q-curr').innerText = currentIdx + 1;
            document.getElementById('score').innerText = score;

            const pct = (currentIdx / questions.length) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';

            // Level badge style
            const badge = document.getElementById('level-badge');
            badge.innerText = q.level;
            if (q.level.includes("Nh·∫≠n bi·∫øt")) badge.className = "absolute top-4 right-4 bg-green-100 text-green-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-green-200";
            else if (q.level.includes("Th√¥ng hi·ªÉu")) badge.className = "absolute top-4 right-4 bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-blue-200";
            else if (q.level.includes("V·∫≠n d·ª•ng cao")) badge.className = "absolute top-4 right-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-purple-200";
            else badge.className = "absolute top-4 right-4 bg-yellow-100 text-yellow-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-yellow-200";

            document.getElementById('question-text').innerText = q.text;

            // Build options as objects to keep correct mapping when shuffled
            const optionObjects = q.options.map((text, idx) => ({
                text,
                isCorrect: idx === q.correct
            }));

            // RANDOMIZE options order
            shuffleArray(optionObjects);

            // Render options
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            optionObjects.forEach((optObj, idx) => {
                const btn = document.createElement('button');
                btn.className = `btn-sweet btn-option w-full p-6 text-left rounded-2xl flex items-center text-lg group`;
                btn.innerHTML = `
                    <span class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center mr-4 font-bold font-candy group-hover:bg-pink-500 group-hover:text-white transition-colors">
                        ${String.fromCharCode(65 + idx)}
                    </span>
                    <span class="font-bold text-gray-700">${optObj.text}</span>
                `;
                btn.onclick = () => checkAnswer(optObj.isCorrect, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(isCorrect, btn) {
            if (isLocked) return;
            isLocked = true;

            const q = questions[currentIdx];
            const allBtns = Array.from(document.getElementById('options-container').children);

            // Disable all buttons immediately
            allBtns.forEach(b => b.disabled = true);

            if (isCorrect) {
                score++;
                document.getElementById('score').innerText = score;
                playSound('correct');
                fireConfetti(false);

                btn.style.backgroundColor = '#d1fae5';
                btn.style.borderColor = '#34d399';
                const bubble = btn.querySelector('span:first-child');
                bubble.className = "w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center mr-4 font-bold font-candy";

                showFeedback(true, q.rationale);
            } else {
                playSound('wrong');
                btn.style.backgroundColor = '#ffe4e6';
                btn.style.borderColor = '#fb7185';

                // Highlight the correct one among shuffled options
                const correctBtn = allBtns.find(b => {
                    const text = b.querySelector('span:nth-child(2)')?.innerText;
                    return text === q.options[q.correct];
                });
                if (correctBtn) {
                    correctBtn.style.backgroundColor = '#d1fae5';
                    correctBtn.style.borderColor = '#34d399';
                    const bubble = correctBtn.querySelector('span:first-child');
                    if (bubble) bubble.className = "w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center mr-4 font-bold font-candy";
                }

                showFeedback(false, q.rationale);
            }
        }

        function showFeedback(isCorrect, text) {
            const modal = document.getElementById('feedback-modal');
            const bg = document.getElementById('modal-bg');
            const icon = document.getElementById('fb-icon');
            const title = document.getElementById('fb-title');

            modal.classList.remove('hidden');

            if (isCorrect) {
                bg.className = "absolute top-0 left-0 w-full h-32 bg-green-100 -z-10 rounded-t-[32px]";
                icon.innerText = "üç¨";
                title.innerText = "Chu·∫©n Kh√¥ng C·∫ßn Ch·ªânh!";
                title.className = "font-candy text-3xl text-green-600 mb-4 uppercase";
            } else {
                bg.className = "absolute top-0 left-0 w-full h-32 bg-red-100 -z-10 rounded-t-[32px]";
                icon.innerText = "üç©";
                title.innerText = "Ti·∫øc Qu√° ƒêi M·∫•t!";
                title.className = "font-candy text-3xl text-red-500 mb-4 uppercase";
            }

            document.getElementById('fb-text').innerHTML = `<strong class="text-pink-500">Gi·∫£i th√≠ch:</strong> ${text}`;
        }

        function nextQuestion() {
            document.getElementById('feedback-modal').classList.add('hidden');
            currentIdx++;
            if (currentIdx < questions.length) {
                loadQuestion();
            } else {
                showResult();
            }
        }

        function showResult() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            const scoreEl = document.getElementById('final-score');
            let s = 0;
            const interval = setInterval(() => {
                if (s >= score) {
                    clearInterval(interval);
                    playSound('win');
                    fireConfetti(true);
                } else {
                    s++;
                    scoreEl.innerText = s;
                }
            }, 50);

            const msg = document.getElementById('result-msg');
            if (score >= 12) msg.innerText = "TUY·ªÜT V·ªúI! B·∫°n l√† Vua K·∫πo Ng·ªçt! üëëüç≠";
            else if (score >= 8) msg.innerText = "L√ÄM T·ªêT L·∫ÆM! B√°nh k·∫πo ƒë·∫ßy t√∫i r·ªìi! üç¨";
            else msg.innerText = "C·ªê G·∫ÆNG H∆†N NH√â! L·∫ßn sau s·∫Ω ƒë∆∞·ª£c nhi·ªÅu k·∫πo h∆°n! üí™";
        }

        function restartGame() {
            currentIdx = 0;
            score = 0;

            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

        // --- CONFETTI ---
        function fireConfetti(isBig = false) {
            const colors = ['#f472b6', '#34d399', '#facc15', '#60a5fa'];
            const count = isBig ? 100 : 30;
            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-piece';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.background = colors[Math.floor(Math.random() * colors.length)];
                el.style.animation = `fall ${Math.random() * 2 + 1}s linear`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            }
        }
    </script>
</body>
</html>
