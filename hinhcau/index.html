<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√≠ M·∫≠t H√†nh Tinh Tr√≤n - C√¥ Thu B√¨nh To√°n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle at center, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .option-card {
            background: rgba(255, 255, 255, 0.9);
            color: #1a2a6c;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid transparent;
        }

        .option-card:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background: #fff;
        }

        .option-card.correct {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .option-card.incorrect {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .planet {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe);
            box-shadow: 0 0 60px rgba(79, 172, 254, 0.6);
            margin: 0 auto;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 999px;
            height: 8px;
            width: 100%;
        }
        .progress-fill {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            height: 100%;
            border-radius: 999px;
            transition: width 0.5s ease;
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
    </style>
</head>

<body class="flex items-center justify-center p-4">
<canvas id="confetti-canvas"></canvas>

<!-- START SCREEN -->
<div id="start-screen" class="glass-panel max-w-2xl w-full p-10 text-center fade-in-up">
    <div class="planet mb-8"></div>
    <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-white">
        B√≠ M·∫≠t H√†nh Tinh Tr√≤n
    </h1>
    <p class="text-blue-100 text-lg mb-6">Chinh ph·ª•c ki·∫øn th·ª©c H√¨nh C·∫ßu - To√°n 9</p>

    <!-- SETTINGS -->
    <div class="max-w-xl mx-auto bg-black/20 p-5 rounded-2xl border border-white/10 mb-8 text-left">
        <div class="font-bold mb-3 flex items-center gap-2">
            <i class="fa-solid fa-sliders text-blue-200"></i>
            Tu·ª≥ ch·ªçn khi l√†m b√†i
        </div>
        <label class="flex items-center gap-3 cursor-pointer select-none mb-3">
            <input id="toggle-shuffle-options" type="checkbox" class="w-5 h-5" checked>
            <span class="text-blue-100">Random th·ª© t·ª± ƒë√°p √°n (A/B/C/D)</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer select-none">
            <input id="toggle-shuffle-questions" type="checkbox" class="w-5 h-5">
            <span class="text-blue-100">Random th·ª© t·ª± c√¢u h·ªèi</span>
        </label>
        <p class="mt-3 text-xs text-blue-200/70">
            (Khi <b>t·∫Øt</b> random ƒë√°p √°n, b·ªô c√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c em ch·ªânh ƒë·ªÉ ƒë√°p √°n ƒë√∫ng chia ƒë·ªÅu <b>5‚Äì5‚Äì5‚Äì5</b>.)
        </p>
    </div>

    <button onclick="game.start()" class="group relative px-8 py-4 bg-white text-blue-900 font-bold rounded-full text-xl shadow-[0_0_20px_rgba(255,255,255,0.5)] transition hover:scale-105 hover:shadow-[0_0_30px_rgba(255,255,255,0.8)]">
        <span class="relative z-10">KH√ÅM PH√Å NGAY <i class="fa-solid fa-rocket ml-2 group-hover:translate-x-1 transition"></i></span>
    </button>
    <div class="mt-6 text-xs text-blue-200 opacity-60">Bi√™n so·∫°n b·ªüi C√¥ Thu B√¨nh To√°n</div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="hidden w-full max-w-4xl">
    <!-- HUD -->
    <div class="flex justify-between items-end mb-4 px-2">
        <div>
            <span class="text-xs uppercase tracking-wider text-blue-200">C√¢u h·ªèi</span>
            <div class="text-3xl font-bold"><span id="q-current">1</span><span class="text-lg text-blue-300">/20</span></div>
        </div>
        <div class="text-right">
            <span class="text-xs uppercase tracking-wider text-blue-200">ƒêi·ªÉm s·ªë</span>
            <div class="text-3xl font-bold text-yellow-300" id="score">0</div>
        </div>
    </div>

    <!-- Progress -->
    <div class="progress-container mb-8">
        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
    </div>

    <!-- Main Card -->
    <div class="glass-panel p-6 md:p-10 min-h-[400px] flex flex-col justify-center relative fade-in-up">
        <span id="level-badge" class="absolute top-6 right-6 px-3 py-1 bg-white/20 rounded-lg text-xs font-bold uppercase tracking-wider">Nh·∫≠n bi·∫øt</span>

        <h2 id="q-text" class="text-xl md:text-2xl font-bold mb-8 leading-relaxed mt-4"></h2>

        <!-- Options -->
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

        <!-- Rationale -->
        <div id="rationale" class="hidden mt-8 p-6 bg-black/20 rounded-xl border border-white/10 fade-in-up">
            <div class="flex items-start gap-4">
                <div id="rat-icon" class="text-3xl mt-1"></div>
                <div>
                    <h3 id="rat-title" class="font-bold text-lg mb-2"></h3>
                    <div id="rat-content" class="text-gray-100 leading-relaxed text-sm md:text-base"></div>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button onclick="game.next()" class="bg-white/20 hover:bg-white/30 text-white px-6 py-2 rounded-lg font-semibold transition">
                    Ti·∫øp t·ª•c <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- END SCREEN -->
<div id="end-screen" class="hidden glass-panel max-w-lg w-full p-8 text-center fade-in-up">
    <div class="inline-block p-6 rounded-full bg-white/10 mb-6">
        <i class="fa-solid fa-crown text-6xl text-yellow-400"></i>
    </div>
    <h2 class="text-3xl font-bold mb-2">Ho√†n Th√†nh S·ª© M·ªánh!</h2>
    <p class="text-blue-200 mb-8">Em ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc chuy·∫øn du h√†nh.</p>

    <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-black/20 p-4 rounded-xl">
            <div class="text-xs text-gray-400 uppercase">T·ªïng ƒëi·ªÉm</div>
            <div class="text-3xl font-bold text-yellow-300" id="final-score">0</div>
        </div>
        <div class="bg-black/20 p-4 rounded-xl">
            <div class="text-xs text-gray-400 uppercase">Ch√≠nh x√°c</div>
            <div class="text-3xl font-bold text-green-300" id="final-correct">0/20</div>
        </div>
    </div>

    <div id="final-message" class="mb-8 font-semibold italic text-lg text-white/90"></div>

    <button onclick="location.reload()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition">
        <i class="fa-solid fa-rotate-right mr-2"></i> Ch∆°i L·∫°i
    </button>
</div>

<script>
    // =========================
    // QUESTIONS (ƒê√É CH·ªàNH: ƒë√°p √°n ƒë√∫ng chia ƒë·ªÅu 5‚Äì5‚Äì5‚Äì5 khi T·∫ÆT random)
    // =========================
    const questions = [
        // NH·∫¨N BI·∫æT (7)
        {
            text: "H√¨nh c·∫ßu ƒë∆∞·ª£c t·∫°o th√†nh khi quay m·ªôt n·ª≠a h√¨nh tr√≤n m·ªôt v√≤ng quanh:",
            options: ["ƒê∆∞·ªùng k√≠nh c·ªßa n√≥", "D√¢y cung b·∫•t k·ª≥", "Ti·∫øp tuy·∫øn", "ƒê∆∞·ªùng trung tr·ª±c"],
            correct: 0, // A
            level: "NH·∫¨N BI·∫æT",
            rationale: "H√¨nh c·∫ßu ƒë∆∞·ª£c t·∫°o th√†nh khi quay n·ª≠a h√¨nh tr√≤n b√°n k√≠nh R quanh ƒë∆∞·ªùng k√≠nh c·ªßa n√≥."
        },
        {
            text: "C√¥ng th·ª©c t√≠nh di·ªán t√≠ch m·∫∑t c·∫ßu \\(S\\) c√≥ b√°n k√≠nh \\(R\\) l√†:",
            options: ["\\(S = \\pi R^2\\)", "\\(S = 4\\pi R^2\\)", "\\(S = \\frac{4}{3}\\pi R^2\\)", "\\(S = 2\\pi R^2\\)"],
            correct: 1, // B
            level: "NH·∫¨N BI·∫æT",
            rationale: "Di·ªán t√≠ch m·∫∑t c·∫ßu: \\(S = 4\\pi R^2\\)."
        },
        {
            text: "C√¥ng th·ª©c t√≠nh th·ªÉ t√≠ch \\(V\\) c·ªßa h√¨nh c·∫ßu c√≥ b√°n k√≠nh \\(R\\) l√†:",
            options: ["\\(V = 4\\pi R^3\\)", "\\(V = \\frac{1}{3}\\pi R^3\\)", "\\(V = \\frac{4}{3}\\pi R^3\\)", "\\(V = \\pi R^3\\)"],
            correct: 2, // C
            level: "NH·∫¨N BI·∫æT",
            rationale: "Th·ªÉ t√≠ch h√¨nh c·∫ßu: \\(V = \\frac{4}{3}\\pi R^3\\)."
        },
        {
            text: "C·∫Øt m·∫∑t c·∫ßu b·ªüi m·ªôt m·∫∑t ph·∫≥ng, thi·∫øt di·ªán thu ƒë∆∞·ª£c lu√¥n l√† h√¨nh g√¨?",
            options: ["H√¨nh elip", "H√¨nh vu√¥ng", "H√¨nh ch·ªØ nh·∫≠t", "H√¨nh tr√≤n"],
            correct: 3, // D
            level: "NH·∫¨N BI·∫æT",
            rationale: "M·ªçi thi·∫øt di·ªán c·ªßa m·∫∑t c·∫ßu b·ªüi m·ªôt m·∫∑t ph·∫≥ng ƒë·ªÅu l√† h√¨nh tr√≤n."
        },
        {
            text: "N·∫øu b√°n k√≠nh m·∫∑t c·∫ßu l√† \\(R\\) th√¨ ƒë∆∞·ªùng k√≠nh \\(d\\) c·ªßa m·∫∑t c·∫ßu l√†:",
            options: ["\\(d = 2R\\)", "\\(d = R^2\\)", "\\(d = \\frac{R}{2}\\)", "\\(d = 4R\\)"],
            correct: 0, // A
            level: "NH·∫¨N BI·∫æT",
            rationale: "ƒê∆∞·ªùng k√≠nh g·∫•p ƒë√¥i b√°n k√≠nh: \\(d=2R\\)."
        },
        {
            text: "Trong c√°c h√¨nh sau, h√¨nh n√†o c√≥ t√¢m ƒë·ªëi x·ª©ng?",
            options: ["H√¨nh n√≥n", "H√¨nh c·∫ßu", "H√¨nh ch√≥p tam gi√°c", "H√¨nh lƒÉng tr·ª• tam gi√°c"],
            correct: 1, // B
            level: "NH·∫¨N BI·∫æT",
            rationale: "H√¨nh c·∫ßu c√≥ t√¢m ƒë·ªëi x·ª©ng ch√≠nh l√† t√¢m c·ªßa n√≥."
        },
        {
            text: "M·ªôt ƒëi·ªÉm M n·∫±m tr√™n m·∫∑t c·∫ßu t√¢m O b√°n k√≠nh R th√¨ kho·∫£ng c√°ch OM b·∫±ng:",
            options: ["\\(2R\\)", "\\(\\frac{R}{2}\\)", "\\(R\\)", "\\(0\\)"],
            correct: 2, // C
            level: "NH·∫¨N BI·∫æT",
            rationale: "ƒêi·ªÉm tr√™n m·∫∑t c·∫ßu lu√¥n c√°ch t√¢m m·ªôt kho·∫£ng b·∫±ng b√°n k√≠nh R."
        },

        // TH√îNG HI·ªÇU (8)
        {
            text: "Di·ªán t√≠ch c·ªßa m·∫∑t c·∫ßu c√≥ b√°n k√≠nh \\(R = 5\\) cm l√†:",
            options: ["\\(25\\pi\\) cm¬≤", "\\(50\\pi\\) cm¬≤", "\\(20\\pi\\) cm¬≤", "\\(100\\pi\\) cm¬≤"],
            correct: 3, // D
            level: "TH√îNG HI·ªÇU",
            rationale: "\\(S=4\\pi R^2=4\\pi\\cdot25=100\\pi\\) cm¬≤."
        },
        {
            text: "Th·ªÉ t√≠ch c·ªßa h√¨nh c·∫ßu c√≥ ƒë∆∞·ªùng k√≠nh \\(d = 6\\) cm l√†:",
            options: ["\\(36\\pi\\) cm¬≥", "\\(288\\pi\\) cm¬≥", "\\(108\\pi\\) cm¬≥", "\\(12\\pi\\) cm¬≥"],
            correct: 0, // A
            level: "TH√îNG HI·ªÇU",
            rationale: "R=3. \\(V=\\frac{4}{3}\\pi\\cdot27=36\\pi\\) cm¬≥."
        },
        {
            text: "M·ªôt m·∫∑t c·∫ßu c√≥ di·ªán t√≠ch l√† \\(36\\pi\\) cm¬≤. B√°n k√≠nh c·ªßa m·∫∑t c·∫ßu ƒë√≥ l√†:",
            options: ["3 cm", "6 cm", "9 cm", "4.5 cm"],
            correct: 0, // A
            level: "TH√îNG HI·ªÇU",
            rationale: "\\(36\\pi=4\\pi R^2\\Rightarrow R^2=9\\Rightarrow R=3\\) cm."
        },
        {
            text: "N·∫øu b√°n k√≠nh h√¨nh c·∫ßu tƒÉng l√™n 3 l·∫ßn th√¨ di·ªán t√≠ch m·∫∑t c·∫ßu tƒÉng l√™n bao nhi√™u l·∫ßn?",
            options: ["9 l·∫ßn", "3 l·∫ßn", "6 l·∫ßn", "27 l·∫ßn"],
            correct: 0, // A
            level: "TH√îNG HI·ªÇU",
            rationale: "S t·ªâ l·ªá R^2 ‚áí tƒÉng 3 l·∫ßn th√¨ tƒÉng 9 l·∫ßn."
        },
        {
            text: "N·∫øu b√°n k√≠nh h√¨nh c·∫ßu tƒÉng l√™n 2 l·∫ßn th√¨ th·ªÉ t√≠ch h√¨nh c·∫ßu tƒÉng l√™n bao nhi√™u l·∫ßn?",
            options: ["4 l·∫ßn", "2 l·∫ßn", "8 l·∫ßn", "6 l·∫ßn"],
            correct: 2, // C
            level: "TH√îNG HI·ªÇU",
            rationale: "V t·ªâ l·ªá R^3 ‚áí tƒÉng 2 l·∫ßn th√¨ tƒÉng 8 l·∫ßn."
        },
        {
            text: "M·ªôt h√¨nh c·∫ßu c√≥ th·ªÉ t√≠ch \\(V = 288\\pi\\) cm¬≥. Di·ªán t√≠ch m·∫∑t c·∫ßu ƒë√≥ l√†:",
            options: ["\\(144\\pi\\) cm¬≤", "\\(36\\pi\\) cm¬≤", "\\(72\\pi\\) cm¬≤", "\\(288\\pi\\) cm¬≤"],
            correct: 0, // A
            level: "TH√îNG HI·ªÇU",
            rationale: "R^3=216 ‚áí R=6. \\(S=4\\pi\\cdot36=144\\pi\\)."
        },
        {
            text: "Cho m·∫∑t c·∫ßu t√¢m O b√°n k√≠nh 10 cm. M·ªôt m·∫∑t ph·∫≥ng c·∫Øt m·∫∑t c·∫ßu t·∫°i ƒë∆∞·ªùng tr√≤n c√≥ b√°n k√≠nh 8 cm. Kho·∫£ng c√°ch t·ª´ t√¢m O ƒë·∫øn m·∫∑t ph·∫≥ng ƒë√≥ l√†:",
            options: ["2 cm", "\\(\\sqrt{164}\\) cm", "10 cm", "6 cm"],
            correct: 3, // D
            level: "TH√îNG HI·ªÇU",
            rationale: "\\(d^2=R^2-r^2=100-64=36\\Rightarrow d=6\\) cm."
        },
        {
            text: "T·ªâ s·ªë gi·ªØa th·ªÉ t√≠ch h√¨nh c·∫ßu v√† di·ªán t√≠ch m·∫∑t c·∫ßu t∆∞∆°ng ·ª©ng (c√πng b√°n k√≠nh R) l√†:",
            options: ["\\(\\frac{R}{4}\\)", "\\(\\frac{R}{3}\\)", "\\(3R\\)", "\\(\\frac{3}{R}\\)"],
            correct: 1, // B
            level: "TH√îNG HI·ªÇU",
            rationale: "\\(\\frac{V}{S}=\\frac{\\frac{4}{3}\\pi R^3}{4\\pi R^2}=\\frac{R}{3}\\)."
        },

        // V·∫¨N D·ª§NG (3)
        {
            text: "M·ªôt qu·∫£ b√≥ng da c√≥ chu vi ƒë∆∞·ªùng tr√≤n l·ªõn kho·∫£ng 69 cm. T√≠nh di·ªán t√≠ch da c·∫ßn d√πng ƒë·ªÉ may qu·∫£ b√≥ng (l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã).",
            options: ["1515 cm¬≤", "379 cm¬≤", "4752 cm¬≤", "6060 cm¬≤"],
            correct: 0, // A
            level: "V·∫¨N D·ª§NG",
            rationale: "C=2œÄR=69 ‚áí R=69/(2œÄ). S=4œÄR¬≤=69¬≤/œÄ ‚âà 1515 cm¬≤."
        },
        {
            text: "M·ªôt b·ªìn n∆∞·ªõc inox h√¨nh c·∫ßu c√≥ ƒë∆∞·ªùng k√≠nh 2m. B·ªìn ch·ª©a ƒë∆∞·ª£c t·ªëi ƒëa bao nhi√™u l√≠t n∆∞·ªõc? (L·∫•y \\(\\pi \\approx 3,14\\), l√†m tr√≤n ƒë·∫øn l√≠t)",
            options: ["33500 l√≠t", "12560 l√≠t", "3140 l√≠t", "4187 l√≠t"],
            correct: 3, // D
            level: "V·∫¨N D·ª§NG",
            rationale: "R=1m. V‚âà4,1866 m¬≥ = 4186,6 l√≠t ‚áí 4187 l√≠t."
        },
        {
            text: "Tr√°i ƒê·∫•t ƒë∆∞·ª£c xem l√† m·ªôt h√¨nh c·∫ßu b√°n k√≠nh kho·∫£ng 6371 km. Di·ªán t√≠ch b·ªÅ m·∫∑t Tr√°i ƒê·∫•t x·∫•p x·ªâ l√†:",
            options: ["128 tri·ªáu km¬≤", "85 tri·ªáu km¬≤", "510 tri·ªáu km¬≤", "380 tri·ªáu km¬≤"],
            correct: 2, // C
            level: "V·∫¨N D·ª§NG",
            rationale: "S=4œÄR¬≤‚âà4¬∑3,14¬∑6371¬≤‚âà510 tri·ªáu km¬≤."
        },

        // V·∫¨N D·ª§NG CAO (2)
        {
            text: "M·ªôt h√¨nh tr·ª• c√≥ chi·ªÅu cao b·∫±ng ƒë∆∞·ªùng k√≠nh ƒë√°y v√† n·ªôi ti·∫øp trong m·ªôt m·∫∑t c·∫ßu b√°n k√≠nh \\(R\\). G·ªçi \\(V_1\\) l√† th·ªÉ t√≠ch h√¨nh c·∫ßu, \\(V_2\\) l√† th·ªÉ t√≠ch h√¨nh tr·ª•. T·ªâ s·ªë \\(\\frac{V_1}{V_2}\\) l√†:",
            options: ["\\(\\frac{4\\sqrt{2}}{3}\\)", "\\(\\frac{2}{3}\\)", "\\(\\sqrt{2}\\)", "\\(2\\)"],
            correct: 0, // A
            level: "V·∫¨N D·ª§NG CAO",
            rationale: "Suy ra r¬≤=R¬≤/2, h=R‚àö2. Vtr·ª•=œÄ¬∑(R¬≤/2)¬∑R‚àö2=œÄR¬≥‚àö2/2. Vc·∫ßu=4/3œÄR¬≥ ‚áí t·ªâ s·ªë = 4‚àö2/3."
        },
        {
            text: "Th·∫£ m·ªôt qu·∫£ c·∫ßu ƒë·∫∑c v√†o b√¨nh tr·ª•, n∆∞·ªõc d√¢ng th√™m 2 cm. B√°n k√≠nh ƒë√°y b√¨nh tr·ª• l√† 6 cm. B√°n k√≠nh qu·∫£ c·∫ßu l√†:",
            options: ["3 cm", "6 cm", "4 cm", "\\(3\\sqrt[3]{2}\\) cm"],
            correct: 3, // D
            level: "V·∫¨N D·ª§NG CAO",
            rationale: "Vd√¢ng=œÄ¬∑6¬≤¬∑2=72œÄ. 4/3œÄR¬≥=72œÄ ‚áí R¬≥=54 ‚áí R=3‚àõ2 cm."
        }
    ];

    // =========================
    // CHECK DISTRIBUTION (optional debug)
    // =========================
    // Khi t·∫Øt random, ƒë√°p √°n ƒë√∫ng ƒë√£ chia ƒë·ªÅu: A,B,C,D = 5,5,5,5

    // =========================
    // SHUFFLE HELPERS (ƒë·ªÉ random ƒë√°p √°n/c√¢u h·ªèi m√† v·∫´n ch·∫•m ƒë√∫ng)
    // =========================
    function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function buildQuestionForPlay(q, shuffleOptions) {
        if (!shuffleOptions) return { ...q };

        const idxs = [0, 1, 2, 3];
        shuffleInPlace(idxs);

        const newOptions = idxs.map(i => q.options[i]);
        const newCorrect = idxs.indexOf(q.correct);

        return { ...q, options: newOptions, correct: newCorrect };
    }

    function typesetSafe(targets) {
        if (!window.MathJax || !MathJax.typesetPromise) return;
        MathJax.typesetPromise(targets ? targets : undefined).catch(() => {});
    }

    // =========================
    // GAME LOGIC
    // =========================
    const game = {
        order: [],
        index: 0,
        score: 0,
        audioCtx: null,
        currentQ: null,
        settings: { shuffleOptions: true, shuffleQuestions: false },

        initSound: function() {
            if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        },

        playTone: function(type) {
            if (!this.audioCtx) return;
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);

            if (type === 'win') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, this.audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, this.audioCtx.currentTime + 0.1);
                osc.frequency.exponentialRampToValueAtTime(1760, this.audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(this.audioCtx.currentTime + 0.5);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, this.audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, this.audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(this.audioCtx.currentTime + 0.3);
            }
        },

        start: function() {
            this.initSound();

            // Read settings
            this.settings.shuffleOptions = document.getElementById('toggle-shuffle-options').checked;
            this.settings.shuffleQuestions = document.getElementById('toggle-shuffle-questions').checked;

            // Build order
            this.order = Array.from({ length: questions.length }, (_, i) => i);
            if (this.settings.shuffleQuestions) shuffleInPlace(this.order);

            // Reset
            this.index = 0;
            this.score = 0;
            document.getElementById('score').innerText = "0";

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').classList.remove('hidden');
            this.loadQuestion();
        },

        loadQuestion: function() {
            const realIdx = this.order[this.index];
            const baseQ = questions[realIdx];
            const q = buildQuestionForPlay(baseQ, this.settings.shuffleOptions);
            this.currentQ = q;

            document.getElementById('q-current').innerText = this.index + 1;
            document.getElementById('q-text').innerHTML = q.text;
            document.getElementById('level-badge').innerText = q.level;

            // FIX progress: l√™n ƒë√∫ng 100%
            document.getElementById('progress-fill').style.width = `${((this.index + 1) / questions.length) * 100}%`;

            // Render Options
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            document.getElementById('rationale').classList.add('hidden');

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-card w-full p-6 rounded-xl font-semibold text-lg text-left shadow-sm";
                btn.innerHTML = `<span class="font-extrabold mr-2">${String.fromCharCode(65+i)}.</span> ${opt}`;
                btn.onclick = () => this.check(i, btn);
                container.appendChild(btn);
            });

            typesetSafe();
        },

        check: function(choice, btn) {
            const q = this.currentQ;
            const btns = document.querySelectorAll('.option-card');
            btns.forEach(b => b.disabled = true);

            if (choice === q.correct) {
                btn.classList.add('correct');
                this.score += 10;
                this.playTone('win');
                this.showRationale(true, q.rationale);
                fireConfetti();
            } else {
                btn.classList.add('incorrect');
                btns[q.correct].classList.add('correct');
                this.playTone('lose');
                this.showRationale(false, q.rationale);
            }
            document.getElementById('score').innerText = this.score;
        },

        showRationale: function(isCorrect, text) {
            const div = document.getElementById('rationale');
            div.classList.remove('hidden');

            if (isCorrect) {
                document.getElementById('rat-icon').innerHTML = 'üåü';
                document.getElementById('rat-title').innerText = "Ch√≠nh x√°c! Tuy·ªát v·ªùi!";
                document.getElementById('rat-title').className = "font-bold text-lg mb-2 text-green-300";
            } else {
                document.getElementById('rat-icon').innerHTML = 'üí°';
                document.getElementById('rat-title').innerText = "Ch∆∞a ƒë√∫ng r·ªìi, xem gi·∫£i th√≠ch nh√©:";
                document.getElementById('rat-title').className = "font-bold text-lg mb-2 text-red-300";
            }
            document.getElementById('rat-content').innerHTML = text;
            typesetSafe([div]);
        },

        next: function() {
            if (this.index < questions.length - 1) {
                this.index++;
                this.loadQuestion();
            } else {
                this.endGame();
            }
        },

        endGame: function() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');

            document.getElementById('final-score').innerText = this.score;
            document.getElementById('final-correct').innerText = (this.score / 10) + "/20";

            let msg = "";
            if (this.score >= 180) msg = "ƒê·∫≥ng c·∫•p v≈© tr·ª•! Em l√† nh√† to√°n h·ªçc thi√™n t√†i!";
            else if (this.score >= 140) msg = "R·∫•t t·ªët! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c.";
            else msg = "C·ªë g·∫Øng th√™m nh√©, th√†nh c√¥ng ƒëang ch·ªù em!";
            document.getElementById('final-message').innerText = msg;

            if (this.score >= 150) fireConfetti();
        }
    };

    // =========================
    // CONFETTI (loop an to√†n)
    // =========================
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animating = false;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function fireConfetti() {
        for (let i = 0; i < 100; i++) {
            particles.push({
                x: canvas.width / 2,
                y: canvas.height / 2,
                vx: (Math.random() - 0.5) * 15,
                vy: (Math.random() - 0.5) * 15,
                color: `hsl(${Math.random() * 360}, 100%, 70%)`,
                life: 100,
                size: Math.random() * 5 + 2
            });
        }
        if (!animating) update();
    }

    function update() {
        animating = true;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life--;
            p.vy += 0.2;

            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();

            if (p.life <= 0) particles.splice(i, 1);
        }

        if (particles.length > 0) requestAnimationFrame(update);
        else { animating = false; ctx.clearRect(0,0,canvas.width,canvas.height); }
    }
</script>
</body>
</html>
