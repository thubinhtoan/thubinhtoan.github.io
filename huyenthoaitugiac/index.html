<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Huyền Thoại Tứ Giác - Cô Thu Bình Toán</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nunito+Sans:wght@400;600;700&display=swap');

    body {
      font-family: 'Nunito Sans', sans-serif;
      background: linear-gradient(135deg, #2b1055 0%, #7597de 100%);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
    }

    .title-font { font-family: 'Cinzel', serif; }

    .crystal-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255, 255, 255, 0.5);
      border-left: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      border-radius: 20px;
    }

    .btn-gem {
      background: rgba(255, 255, 255, 0.9);
      color: #2b1055;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      border: none;
    }

    .btn-gem:hover:not(:disabled) {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
      background: #fff;
    }

    .btn-gem.correct {
      background: linear-gradient(90deg, #00b09b, #96c93d) !important;
      color: white !important;
      box-shadow: 0 0 20px #96c93d;
    }

    .btn-gem.incorrect {
      background: linear-gradient(90deg, #ff416c, #ff4b2b) !important;
      color: white !important;
      opacity: 0.9;
    }

    .gem-icon {
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* blob animation (Tailwind CDN không có sẵn animate-blob) */
    .animate-blob { animation: blob 8s infinite; }
    .animation-delay-2000 { animation-delay: 2s; }
    @keyframes blob {
      0% { transform: translate(0px, 0px) scale(1); }
      33% { transform: translate(30px, -20px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.95); }
      100% { transform: translate(0px, 0px) scale(1); }
    }

    .progress-container {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 999px;
      height: 6px;
      width: 100%;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      height: 100%;
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    #confetti-canvas {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 50;
    }

    .fade-enter { animation: fadeEnter 0.5s ease-out forwards; }
    @keyframes fadeEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <canvas id="confetti-canvas"></canvas>

  <!-- START SCREEN -->
  <div id="start-screen" class="crystal-card max-w-2xl w-full p-10 text-center fade-enter relative overflow-hidden">
    <div class="absolute -top-10 -left-10 w-40 h-40 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
    <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>

    <div class="relative z-10">
      <div class="mb-6 gem-icon text-6xl text-cyan-300">
        <i class="fa-regular fa-gem"></i>
      </div>

      <h1 class="text-4xl md:text-5xl font-bold mb-2 title-font text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-white">
        Huyền Thoại Tứ Giác
      </h1>
      <p class="text-cyan-100 mb-6 font-light text-lg">Mảnh Ghép Cuối Cùng - Toán 9</p>

      <div class="grid grid-cols-2 gap-4 mb-6 text-left max-w-md mx-auto">
        <div class="bg-white/10 p-4 rounded-xl border border-white/20">
          <div class="text-xs text-cyan-300 uppercase tracking-widest mb-1">Chủ đề</div>
          <div class="font-bold">Tứ Giác Nội Tiếp</div>
        </div>
        <div class="bg-white/10 p-4 rounded-xl border border-white/20">
          <div class="text-xs text-purple-300 uppercase tracking-widest mb-1">Thử thách</div>
          <div class="font-bold">20 Câu hỏi</div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="bg-white/10 p-5 rounded-xl border border-white/20 text-left max-w-md mx-auto mb-8">
        <div class="font-bold text-white mb-3 flex items-center">
          <i class="fa-solid fa-sliders mr-2 text-white/70"></i> Tuỳ chọn
        </div>

        <label class="flex items-center gap-3 cursor-pointer select-none mb-3">
          <input id="toggle-shuffle-options" type="checkbox" class="w-5 h-5" checked>
          <span class="text-white/90">Random thứ tự đáp án (A/B/C/D)</span>
        </label>

        <label class="flex items-center gap-3 cursor-pointer select-none">
          <input id="toggle-shuffle-questions" type="checkbox" class="w-5 h-5">
          <span class="text-white/90">Random thứ tự câu hỏi</span>
        </label>

        <p class="text-xs text-white/60 mt-3">
          (Nếu <b>tắt</b> random đáp án, bộ đề đã được chia đều đúng 5–5–5–5 cho A/B/C/D.)
        </p>
      </div>

      <button onclick="game.start()" class="group relative px-8 py-4 bg-white text-purple-900 font-bold rounded-full text-lg shadow-[0_0_20px_rgba(255,255,255,0.4)] transition hover:scale-105 hover:shadow-[0_0_40px_rgba(255,255,255,0.6)]">
        <span class="relative z-10">KÍCH HOẠT TRẬN ĐẤU <i class="fa-solid fa-bolt ml-2 text-yellow-500"></i></span>
      </button>
      <div class="mt-6 text-xs text-white/50">Biên soạn bởi Cô Thu Bình Toán</div>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen" class="hidden w-full max-w-4xl">
    <!-- Stats -->
    <div class="flex justify-between items-end mb-4 px-2">
      <div>
        <span class="text-xs uppercase tracking-wider text-cyan-200">Tiến độ</span>
        <div class="text-2xl font-bold title-font"><span id="q-curr">1</span><span class="text-base text-white/50">/20</span></div>
      </div>
      <div class="text-right">
        <span class="text-xs uppercase tracking-wider text-purple-200">Điểm năng lượng</span>
        <div id="score" class="text-2xl font-bold text-yellow-300 title-font">0</div>
      </div>
    </div>

    <div class="progress-container mb-8">
      <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
    </div>

    <!-- Main Card -->
    <div class="crystal-card p-6 md:p-10 fade-enter relative">
      <div class="absolute top-0 right-0 mt-4 mr-4">
        <span id="level-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-white/20 text-white backdrop-blur-sm border border-white/20">Nhận biết</span>
      </div>

      <h2 id="q-text" class="text-xl md:text-2xl font-bold mb-8 leading-relaxed mt-4"></h2>

      <!-- Options -->
      <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <!-- Feedback -->
      <div id="feedback-panel" class="hidden mt-8 p-6 bg-black/20 rounded-xl border border-white/10 fade-enter">
        <div class="flex items-start gap-4">
          <div id="fb-icon" class="text-3xl mt-1"></div>
          <div>
            <h3 id="fb-title" class="font-bold text-lg mb-2 title-font"></h3>
            <div id="fb-content" class="text-cyan-50 leading-relaxed text-sm md:text-base"></div>
          </div>
        </div>
        <div class="mt-6 text-right">
          <button onclick="game.next()" class="bg-white/20 hover:bg-white/30 text-white px-8 py-2 rounded-lg font-bold transition border border-white/30">
            Tiếp tục <i class="fa-solid fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="end-screen" class="hidden crystal-card max-w-lg w-full p-8 text-center fade-enter">
    <div class="w-32 h-32 mx-auto bg-gradient-to-tr from-yellow-300 to-yellow-600 rounded-full flex items-center justify-center mb-6 shadow-lg border-4 border-yellow-200">
      <i class="fa-solid fa-crown text-5xl text-white"></i>
    </div>
    <h2 class="text-3xl font-bold mb-2 title-font">Hoàn Thành Sứ Mệnh!</h2>
    <p class="text-cyan-100 mb-8">Em đã mở khóa được bí mật của Tứ Giác.</p>

    <div class="grid grid-cols-2 gap-4 mb-8">
      <div class="bg-black/20 p-4 rounded-xl border border-white/10">
        <div class="text-xs text-white/60 uppercase">Tổng điểm</div>
        <div id="final-score" class="text-3xl font-bold text-yellow-300 title-font">0</div>
      </div>
      <div class="bg-black/20 p-4 rounded-xl border border-white/10">
        <div class="text-xs text-white/60 uppercase">Chính xác</div>
        <div id="final-acc" class="text-3xl font-bold text-cyan-300 title-font">0%</div>
      </div>
    </div>

    <div id="final-msg" class="mb-8 font-medium text-white/90 italic"></div>

    <button onclick="location.reload()" class="w-full bg-white text-purple-900 hover:bg-cyan-50 font-bold py-4 rounded-xl shadow-lg transition">
      <i class="fa-solid fa-rotate-right mr-2"></i> Chơi Lại Từ Đầu
    </button>
  </div>

  <script>
    // =========================
    // HELPERS
    // =========================
    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function safeTypeset(targets) {
      if (!window.MathJax || !MathJax.typesetPromise) return;
      MathJax.typesetPromise(targets ? targets : undefined).catch(() => {});
    }

    function buildQuestionForPlay(q, shuffleOptions) {
      if (!shuffleOptions) return { ...q };

      const idxs = [0,1,2,3];
      shuffleInPlace(idxs);

      const newOptions = idxs.map(i => q.options[i]);
      const newCorrect = idxs.indexOf(q.correct);

      return { ...q, options: newOptions, correct: newCorrect };
    }

    // =========================
    // QUESTION DATA (20)
    // ✅ Chia đều 5–5–5–5 khi TẮT random đáp án
    // =========================
    const questions = [
      // 1–5: đúng A
      {
        text: "Tứ giác nội tiếp là tứ giác có bốn đỉnh nằm trên:",
        options: ["Một đường tròn", "Một đường thẳng", "Một hình vuông", "Một tam giác"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Định nghĩa: Tứ giác nội tiếp là tứ giác có 4 đỉnh cùng nằm trên một đường tròn."
      },
      {
        text: "Trong một tứ giác nội tiếp, tổng số đo hai góc đối diện bằng:",
        options: ["\\(180^\\circ\\)", "\\(90^\\circ\\)", "\\(360^\\circ\\)", "\\(100^\\circ\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Tính chất cơ bản: Trong tứ giác nội tiếp, tổng hai góc đối bằng \\(180^\\circ\\)."
      },
      {
        text: "Tứ giác nào sau đây LUÔN nội tiếp được đường tròn?",
        options: ["Hình chữ nhật", "Hình bình hành", "Hình thoi", "Hình thang vuông"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Hình chữ nhật có tổng hai góc đối là \\(90^\\circ + 90^\\circ = 180^\\circ\\) nên luôn nội tiếp."
      },
      {
        text: "Tứ giác ABCD nội tiếp đường tròn. Nếu \\(\\angle A = 80^\\circ\\) thì số đo góc C là:",
        options: ["\\(100^\\circ\\)", "\\(80^\\circ\\)", "\\(10^\\circ\\)", "\\(180^\\circ\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "\\(\\angle A + \\angle C = 180^\\circ\\Rightarrow \\angle C = 100^\\circ\\)."
      },
      {
        text: "Hình nào sau đây KHÔNG nội tiếp được đường tròn?",
        options: ["Hình bình hành (không phải là HCN)", "Hình vuông", "Hình thang cân", "Hình chữ nhật"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Hình bình hành chỉ nội tiếp khi nó là hình chữ nhật."
      },

      // 6–10: đúng B
      {
        text: "Dấu hiệu nhận biết: Tứ giác có góc ngoài tại một đỉnh bằng góc trong của đỉnh đối diện là:",
        options: ["Hình thang", "Tứ giác nội tiếp", "Hình bình hành", "Không kết luận được"],
        correct: 1,
        level: "NHẬN BIẾT",
        rationale: "Đây là một dấu hiệu nhận biết quan trọng của tứ giác nội tiếp."
      },
      {
        text: "Tâm của đường tròn ngoại tiếp hình vuông là:",
        options: ["Giao điểm hai cạnh bên", "Giao điểm hai đường chéo", "Một đỉnh của hình vuông", "Trung điểm một cạnh"],
        correct: 1,
        level: "NHẬN BIẾT",
        rationale: "Hình vuông nội tiếp đường tròn có tâm là giao điểm hai đường chéo."
      },
      {
        text: "Cho tứ giác ABCD nội tiếp đường tròn tâm O. Biết \\(\\angle BOD = 120^\\circ\\). Số đo góc \\(\\angle BAD\\) là:",
        options: ["\\(90^\\circ\\)", "\\(60^\\circ\\) hoặc \\(120^\\circ\\)", "\\(120^\\circ\\)", "\\(60^\\circ\\)"],
        correct: 1,
        level: "THÔNG HIỂU",
        rationale: "Góc nội tiếp chắn cùng cung bằng nửa góc ở tâm; tuỳ cung chắn nên có thể ra \\(60^\\circ\\) hoặc \\(120^\\circ\\)."
      },
      {
        text: "Tứ giác ABCD có \\(\\angle A = 85^\\circ\\), \\(\\angle B = 75^\\circ\\), \\(\\angle C = 95^\\circ\\). Góc D là bao nhiêu và tứ giác có nội tiếp không?",
        options: ["\\(105^\\circ\\), không nội tiếp", "\\(105^\\circ\\), có nội tiếp", "\\(95^\\circ\\), có nội tiếp", "\\(85^\\circ\\), không nội tiếp"],
        correct: 1,
        level: "THÔNG HIỂU",
        rationale: "\\(D=360-(85+75+95)=105^\\circ\\). \\(A+C=180\\), \\(B+D=180\\) ⇒ nội tiếp."
      },
      {
        text: "Hai đỉnh kề nhau của một tứ giác cùng nhìn cạnh chứa hai đỉnh còn lại dưới một góc \\(\\alpha\\). Tứ giác đó là:",
        options: ["Hình thoi", "Tứ giác nội tiếp", "Hình bình hành", "Hình thang"],
        correct: 1,
        level: "THÔNG HIỂU",
        rationale: "Dấu hiệu quỹ tích cung chứa góc: cùng nhìn đoạn thẳng dưới một góc không đổi ⇒ nội tiếp."
      },

      // 11–15: đúng C
      {
        text: "Tam giác ABC nhọn có hai đường cao BD và CE cắt nhau tại H. Mệnh đề nào đúng?",
        options: ["Chỉ ADHE nội tiếp", "Chỉ BDEC nội tiếp", "Cả ADHE và BDEC đều nội tiếp", "Không tứ giác nào nội tiếp"],
        correct: 2,
        level: "THÔNG HIỂU",
        rationale: "ADHE nội tiếp (hai góc đối 90+90). BDEC nội tiếp vì \\(\\angle BEC = \\angle BDC = 90^\\circ\\)."
      },
      {
        text: "Hình thang cân ABCD (AB // CD) có nội tiếp đường tròn không? Vì sao?",
        options: ["Không, vì các cạnh không bằng nhau", "Có, vì hai đường chéo bằng nhau", "Có, vì tổng hai góc đối bằng \\(180^\\circ\\)", "Không, vì tổng hai góc kề bằng \\(180^\\circ\\)"],
        correct: 2,
        level: "THÔNG HIỂU",
        rationale: "Hình thang cân ⇒ hai góc kề một đáy bằng nhau ⇒ suy ra hai góc đối bù nhau ⇒ nội tiếp."
      },
      {
        text: "Tứ giác ABCD nội tiếp đường tròn đường kính AC. Khi đó góc ABC bằng:",
        options: ["\\(60^\\circ\\)", "\\(45^\\circ\\)", "\\(90^\\circ\\)", "\\(180^\\circ\\)"],
        correct: 2,
        level: "THÔNG HIỂU",
        rationale: "Góc nội tiếp chắn nửa đường tròn là góc vuông."
      },
      {
        text: "Biết tứ giác ABCD nội tiếp. Số đo \\(\\angle A = 2x\\) và \\(\\angle C = 3x\\). Giá trị của \\(x\\) là:",
        options: ["\\(30^\\circ\\)", "\\(45^\\circ\\)", "\\(36^\\circ\\)", "\\(60^\\circ\\)"],
        correct: 2,
        level: "THÔNG HIỂU",
        rationale: "\\(2x+3x=180\\Rightarrow x=36^\\circ\\)."
      },
      {
        text: "Khung thành bóng đá (đoạn thẳng) khi nhìn từ những vị trí khác nhau mà có cùng góc nhìn sẽ nằm trên:",
        options: ["Một đường thẳng song song", "Một đường parabol", "Một đường tròn (cung chứa góc)", "Một đường elip"],
        correct: 2,
        level: "VẬN DỤNG",
        rationale: "Tập hợp điểm nhìn một đoạn thẳng dưới góc không đổi là cung chứa góc (liên quan tứ giác nội tiếp)."
      },

      // 16–20: đúng D
      {
        text: "Một chiếc bàn hình tròn có 4 chân A,B,C,D trên mép bàn tạo thành hình chữ nhật. Biết AB=60cm, BC=80cm. Đường kính bàn là:",
        options: ["140 cm", "70 cm", "120 cm", "100 cm"],
        correct: 3,
        level: "VẬN DỤNG",
        rationale: "Hình chữ nhật nội tiếp: đường chéo là đường kính. \\(d=\\sqrt{60^2+80^2}=100\\) cm."
      },
      {
        text: "Bốn ngôi làng A,B,C,D. Muốn xây trạm phát sóng cách đều 4 làng. Điều này chỉ làm được khi:",
        options: ["Tứ giác là hình thoi", "Tứ giác là hình bình hành", "Không bao giờ làm được", "Tứ giác ABCD nội tiếp đường tròn"],
        correct: 3,
        level: "VẬN DỤNG",
        rationale: "Điểm cách đều 4 đỉnh là tâm đường tròn ngoại tiếp ⇒ tứ giác phải nội tiếp."
      },
      {
        text: "Cho tam giác ABC nhọn, các đường cao AD,BE,CF cắt nhau tại H. Có bao nhiêu tứ giác nội tiếp tạo được từ các điểm A,B,C,D,E,F,H?",
        options: ["3 tứ giác", "4 tứ giác", "5 tứ giác", "6 tứ giác"],
        correct: 3,
        level: "VẬN DỤNG CAO",
        rationale: "Các tứ giác nội tiếp thường gặp: AEHF, BFHD, CDHE, BDEC, CDF A, AEDB… (đếm được 6)."
      },
      {
        text: "Trong tứ giác nội tiếp ABCD, nếu \\(\\angle A + \\angle C = 180^\\circ\\) thì kết luận đúng là:",
        options: ["ABCD là hình bình hành", "ABCD là hình thang", "ABCD không nội tiếp", "ABCD nội tiếp một đường tròn"],
        correct: 3,
        level: "NHẬN BIẾT",
        rationale: "Dấu hiệu: Nếu tổng hai góc đối bằng \\(180^\\circ\\) ⇒ tứ giác nội tiếp."
      },
      {
        text: "Cho tứ giác ABCD nội tiếp có hai đường chéo AC và BD vuông góc tại I. Gọi M là trung điểm CD. Đường thẳng IM sẽ:",
        options: ["Song song với AB", "Trùng với AB", "Đi qua trung điểm AB", "Vuông góc với AB"],
        correct: 3,
        level: "VẬN DỤNG CAO",
        rationale: "Định lý Brahmagupta: Trong tứ giác nội tiếp có hai đường chéo vuông góc, đường qua giao điểm hai đường chéo và trung điểm một cạnh sẽ vuông góc với cạnh đối diện."
      }
    ];

    // =========================
    // GAME
    // =========================
    const game = {
      index: 0,
      score: 0,
      audioCtx: null,
      order: [],
      settings: { shuffleOptions: true, shuffleQuestions: false },
      currentQ: null,

      initAudio: function() {
        if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      },

      playSound: function(type) {
        if (!this.audioCtx) return;
        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();
        osc.connect(gain);
        gain.connect(this.audioCtx.destination);

        const now = this.audioCtx.currentTime;
        if (type === 'correct') {
          osc.type = 'sine';
          osc.frequency.setValueAtTime(440, now);
          osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
          osc.frequency.exponentialRampToValueAtTime(1760, now + 0.3);
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
          osc.start(now);
          osc.stop(now + 0.8);
        } else {
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(100, now);
          osc.frequency.linearRampToValueAtTime(50, now + 0.3);
          gain.gain.setValueAtTime(0.2, now);
          gain.gain.linearRampToValueAtTime(0.001, now + 0.3);
          osc.start(now);
          osc.stop(now + 0.3);
        }
      },

      start: function() {
        this.initAudio();

        this.settings.shuffleOptions = document.getElementById('toggle-shuffle-options').checked;
        this.settings.shuffleQuestions = document.getElementById('toggle-shuffle-questions').checked;

        this.index = 0;
        this.score = 0;

        this.order = Array.from({ length: questions.length }, (_, i) => i);
        if (this.settings.shuffleQuestions) shuffleInPlace(this.order);

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        this.loadQ();
      },

      loadQ: function() {
        const qIndex = this.order[this.index];
        const baseQ = questions[qIndex];
        const q = buildQuestionForPlay(baseQ, this.settings.shuffleOptions);
        this.currentQ = q;

        document.getElementById('q-curr').innerText = this.index + 1;
        document.getElementById('q-text').innerHTML = q.text;
        document.getElementById('score').innerText = this.score;
        document.getElementById('level-badge').innerText = q.level;

        // Progress (✅ FIX đúng 100%)
        const pct = ((this.index + 1) / questions.length) * 100;
        document.getElementById('progress-fill').style.width = `${pct}%`;

        // Options
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        document.getElementById('feedback-panel').classList.add('hidden');

        q.options.forEach((opt, i) => {
          const btn = document.createElement('button');
          btn.className = "btn-gem w-full p-5 rounded-xl text-left font-bold text-lg flex items-start shadow-sm gap-3";
          btn.innerHTML = `
            <span class="w-8 h-8 rounded-full border border-purple-200 text-purple-600 bg-purple-50 flex items-center justify-center text-sm shrink-0">
              ${String.fromCharCode(65+i)}
            </span>
            <span class="leading-snug break-words">${opt}</span>
          `;
          btn.onclick = () => this.check(i, btn);
          grid.appendChild(btn);
        });

        safeTypeset();
      },

      check: function(choice, btn) {
        const q = this.currentQ;
        const btns = document.querySelectorAll('.btn-gem');
        btns.forEach(b => b.disabled = true);

        if (choice === q.correct) {
          btn.classList.add('correct');
          this.score += 10;
          this.playSound('correct');
          this.showFB(true, q.rationale);
          fireConfetti();
        } else {
          btn.classList.add('incorrect');
          btns[q.correct].classList.add('correct');
          this.playSound('incorrect');
          this.showFB(false, q.rationale);
        }
        document.getElementById('score').innerText = this.score;
      },

      showFB: function(isCorrect, text) {
        const panel = document.getElementById('feedback-panel');
        panel.classList.remove('hidden');

        if (isCorrect) {
          document.getElementById('fb-icon').innerHTML = '<i class="fa-solid fa-check-circle text-green-400"></i>';
          document.getElementById('fb-title').innerHTML = '<span class="text-green-400">Chính xác!</span>';
        } else {
          document.getElementById('fb-icon').innerHTML = '<i class="fa-solid fa-circle-xmark text-red-400"></i>';
          document.getElementById('fb-title').innerHTML = '<span class="text-red-400">Chưa đúng!</span>';
        }
        document.getElementById('fb-content').innerHTML = text;
        safeTypeset([panel]);
      },

      next: function() {
        if (this.index < questions.length - 1) {
          this.index++;
          this.loadQ();
        } else {
          this.end();
        }
      },

      end: function() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');

        const score = this.score;
        const acc = Math.round((score / (questions.length * 10)) * 100);

        document.getElementById('final-score').innerText = score;
        document.getElementById('final-acc').innerText = acc + "%";

        let msg = "";
        if (acc >= 90) msg = "Xuất sắc! Em là bậc thầy về hình học!";
        else if (acc >= 70) msg = "Rất tốt! Em đã nắm chắc kiến thức cơ bản.";
        else msg = "Cần cố gắng thêm nhé. Đừng bỏ cuộc!";
        document.getElementById('final-msg').innerText = msg;

        if (acc >= 50) fireConfetti();
      }
    };

    // =========================
    // CONFETTI
    // =========================
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animating = false;

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function fireConfetti() {
      for (let i = 0; i < 100; i++) {
        particles.push({
          x: canvas.width / 2, y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 20,
          vy: (Math.random() - 0.5) * 20,
          life: 100,
          color: `hsl(${Math.random() * 360}, 100%, 70%)`,
          size: Math.random() * 5 + 3
        });
      }
      if (!animating) updateConfetti();
    }

    function updateConfetti() {
      if (particles.length === 0) {
        animating = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }
      animating = true;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < particles.length; i++) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life--;

        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();

        if (p.life <= 0) { particles.splice(i, 1); i--; }
      }
      requestAnimationFrame(updateConfetti);
    }
  </script>
</body>
</html>
