<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê·∫•u Tr∆∞·ªùng To√°n 7 - C√¥ Thu B√¨nh</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathJax ƒë·ªÉ hi·ªÉn th·ªã c√¥ng th·ª©c to√°n -->
  <script>
    MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .hand-font { font-family: 'Patrick Hand', cursive; }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    .option-btn {
      transition: all 0.2s;
      border: 3px solid transparent;
    }

    .option-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-color: #764ba2;
    }

    .option-btn:active:not(:disabled) { transform: translateY(1px); }

    .correct-anim {
      animation: bounce 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) infinite alternate;
      background-color: #48bb78 !important;
      color: white !important;
      border-color: #2f855a !important;
    }

    .wrong-anim {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      background-color: #f56565 !important;
      color: white !important;
      border-color: #c53030 !important;
    }

    @keyframes bounce { 0% { transform: translateY(0);} 100% { transform: translateY(-10px);} }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    #confetti-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .mascot { font-size: 3rem; animation: float 3s ease-in-out infinite; }
    @keyframes float {
      0% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(5deg); }
      100% { transform: translateY(0px) rotate(0deg); }
    }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <canvas id="confetti-canvas"></canvas>

  <!-- Welcome Screen -->
  <div id="start-screen" class="card p-8 max-w-2xl w-full text-center relative z-10">
    <div class="mascot mb-4">üë©‚Äçüè´ ‚ú®</div>
    <h1 class="text-4xl md:text-5xl font-bold text-indigo-700 mb-4 hand-font">ƒê·∫•u Tr∆∞·ªùng To√°n 7</h1>
    <h2 class="text-xl text-gray-600 mb-6">Chinh Ph·ª•c ƒê·ªânh Cao C√πng C√¥ Thu B√¨nh</h2>
    <p class="text-gray-600 mb-8 text-lg">
      Ch√†o m·ª´ng c√°c em ƒë·∫øn v·ªõi b√†i √¥n t·∫≠p cu·ªëi k·ª≥ 1! <br>
      H√£y h√≠t th·ªü s√¢u, th·∫≠t b√¨nh tƒ©nh v√† chinh ph·ª•c c√¢u h·ªèi nh√©. <br>
      C√¥ tin c√°c em s·∫Ω l√†m r·∫•t t·ªët! ‚ù§Ô∏è
    </p>
    <button onclick="startGame()"
      class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transition transform hover:scale-105">
      B·∫ÆT ƒê·∫¶U NGAY üöÄ
    </button>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="hidden w-full max-w-4xl relative z-10">
    <!-- Header Info -->
    <div class="flex justify-between items-center mb-6 bg-white/20 p-4 rounded-xl backdrop-blur-sm text-white">
      <div class="flex items-center">
        <span class="text-2xl mr-2">üèÜ</span>
        <div>
          <div class="text-xs opacity-80">ƒêI·ªÇM S·ªê</div>
          <div class="text-2xl font-bold" id="score">0</div>
        </div>
      </div>
      <div class="text-center">
        <div class="mascot" id="mascot-reaction">ü§î</div>
      </div>
      <div class="text-right">
        <div class="text-xs opacity-80">C√ÇU H·ªéI</div>
        <div class="text-2xl font-bold"><span id="current-q">1</span>/<span id="total-q">0</span></div>
      </div>
    </div>

    <!-- Question Card -->
    <div class="card p-6 md:p-10 mb-6 min-h-[200px] flex flex-col justify-center items-center text-center">
      <h3 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 leading-relaxed" id="question-text">
        ƒêang t·∫£i c√¢u h·ªèi...
      </h3>
    </div>

    <!-- Options Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-container"></div>

    <!-- Feedback Modal -->
    <div id="feedback-modal"
      class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50 backdrop-blur-sm">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center shadow-2xl animate-[bounce_0.5s]">
        <div id="feedback-icon" class="text-6xl mb-4">üéâ</div>
        <h3 id="feedback-title" class="text-3xl font-bold mb-2">Ch√≠nh X√°c!</h3>
        <p id="feedback-msg" class="text-gray-600 mb-6">B·∫°n qu√° xu·∫•t s·∫Øc!</p>
        <button onclick="nextQuestion()"
          class="bg-indigo-600 text-white py-3 px-8 rounded-full font-bold hover:bg-indigo-700 transition">
          C√¢u Ti·∫øp Theo ‚û°Ô∏è
        </button>
      </div>
    </div>
  </div>

  <!-- Result Screen -->
  <div id="result-screen" class="hidden card p-8 max-w-2xl w-full text-center relative z-10">
    <div class="text-6xl mb-4">üéì</div>
    <h2 class="text-4xl font-bold text-indigo-800 mb-4">T·ªïng K·∫øt</h2>
    <p class="text-xl text-gray-600 mb-6">Ch√∫c m·ª´ng em ƒë√£ ho√†n th√†nh b√†i thi!</p>

    <div class="bg-indigo-50 rounded-xl p-6 mb-8">
      <div class="text-5xl font-bold text-indigo-600 mb-2" id="final-score">0/0</div>
      <div class="text-gray-500" id="final-percent">0%</div>
    </div>

    <p id="teacher-msg" class="text-lg italic text-gray-700 mb-8">
      "L·ªùi nh·∫≠n x√©t t·ª´ c√¥ Thu B√¨nh..."
    </p>

    <div class="text-xs text-gray-500 mb-4" id="answer-balance"></div>

    <button onclick="location.reload()"
      class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition">
      L√†m L·∫°i B√†i üîÑ
    </button>
  </div>

  <script>
    // =========================
    // 1) D·ªÆ LI·ªÜU C√ÇU H·ªéI (RAW)
    // =========================
    const questionsRaw = [
      { q: "Gi√° tr·ªã tuy·ªát ƒë·ªëi c·ªßa 7,82 l√†:", a: ["8,27", "7,82", "-7,82", "7,8"], correct: 1 },
      { q: "K·∫øt qu·∫£ so s√°nh hai s·ªë th·∫≠p ph√¢n 65,312 v√† 65,314 l√†:", a: ["$65,312 < 65,314$", "$65,312 > 65,314$", "$65,312 = 65,314$", "$65,312 \\le 65,314$"], correct: 0 },
      { q: "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 81 l√†:", a: ["9", "8", "15", "-18"], correct: 0 },
      { q: "S·ªë ƒë·ªëi c·ªßa s·ªë $\\frac{15}{18}$ l√†:", a: ["$1\\frac{15}{8}$", "$-\\frac{15}{18}$", "$-\\sqrt{25}$", "$9^2$"], correct: 1 },
      { q: "Gi√° tr·ªã tuy·ªát ƒë·ªëi c·ªßa $-\\sqrt{25}$ l√†:", a: ["5", "$\\sqrt{25}$", "-9", "-5"], correct: 0 },
      { q: "S·ªë n√†o trong c√°c s·ªë d∆∞·ªõi ƒë√¢y vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng s·ªë th·∫≠p ph√¢n h·ªØu h·∫°n:", a: ["$\\frac{-6}{75}$", "$\\frac{-6}{76}$", "$\\frac{7}{30}$", "$\\frac{-7}{30}$"], correct: 0 },
      { q: "T·∫≠p h·ª£p c√°c s·ªë v√¥ t·ªâ k√≠ hi·ªáu l√†:", a: ["N", "Q", "R", "I"], correct: 3 },
      { q: "Ch·ª©ng minh ƒë·ªãnh l√≠ l√†:", a: ["D√πng h√¨nh v·∫Ω suy ra k·∫øt lu·∫≠n", "D√πng l·∫≠p lu·∫≠n t·ª´ gi·∫£ thi·∫øt suy ra k·∫øt lu·∫≠n", "D√πng ƒëo ƒë·∫°c th·ª±c t·∫ø", "D√πng tr·ª±c gi√°c"], correct: 1 },
      { q: "Ph√°t bi·ªÉu n√†o sau ƒë√¢y l√† sai?", a: ["M·ªçi s·ªë v√¥ t·ªâ ƒë·ªÅu l√† s·ªë th·ª±c", "M·ªçi s·ªë th·ª±c ƒë·ªÅu l√† s·ªë v√¥ t·ªâ", "S·ªë 0 l√† s·ªë h·ªØu t·ªâ", "$\\sqrt{7}$ l√† s·ªë v√¥ t·ªâ"], correct: 1 },
      { q: "H√£y b·ªï sung K·∫øt Lu·∫≠n cho ƒë·ªãnh l√≠: ‚ÄúN·∫øu hai ƒë∆∞·ªùng th·∫≥ng a v√† b c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba c th√¨...‚Äù", a: ["a song song v·ªõi b", "a v√† b c·∫Øt nhau", "b song song v·ªõi c", "a v√† b tr√πng nhau"], correct: 0 },
      { q: "X√°c ƒë·ªãnh gi·∫£ thi·∫øt c·ªßa ƒë·ªãnh l√≠: ¬´ N·∫øu hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba th√¨ ch√∫ng song song v·ªõi nhau ¬ª.", a: ["Hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát", "Hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c", "Hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba", "Ch√∫ng song song v·ªõi nhau"], correct: 2 },
      { q: "Cho $\\widehat{xOy}=140^{0}$, g·ªçi Om l√† tia ph√¢n gi√°c c·ªßa $\\widehat{xOy}$. S·ªë ƒëo c·ªßa $\\widehat{xOm}$ l√†:", a: ["$150^{\\circ}$", "$70^{0}$", "$130^{0}$", "$180^{0}$"], correct: 1 },
      { q: "T·ªïng s·ªë ƒëo hai g√≥c k·ªÅ b√π b·∫±ng:", a: ["$180^{\\circ}$", "$120^{0}$", "$90^{0}$", "$60^{\\circ}$"], correct: 0 },
      { q: "Cho $\\Delta MNP$. Qua M v·∫Ω ƒë∆∞·ªùng th·∫≥ng a // NP, qua P v·∫Ω ƒë∆∞·ªùng th·∫≥ng b // MN. S·ªë ƒë∆∞·ªùng th·∫≥ng a, b v·∫Ω ƒë∆∞·ª£c l·∫ßn l∆∞·ª£t l√†:", a: ["1; 1", "2; 2", "3; 3", "V√¥ s·ªë"], correct: 0 },
      { q: "Qua m·ªôt ƒëi·ªÉm ·ªü ngo√†i m·ªôt ƒë∆∞·ªùng th·∫≥ng c√≥ bao nhi√™u ƒë∆∞·ªùng th·∫≥ng song song v·ªõi ƒë∆∞·ªùng th·∫≥ng ƒë√≥?", a: ["Ch·ªâ c√≥ m·ªôt", "C√≥ v√¥ s·ªë", "C√≥ √≠t nh·∫•t m·ªôt", "Kh√¥ng c√≥"], correct: 0 },
      { q: "G√≥c ƒë·ªëi ƒë·ªânh v·ªõi g√≥c $\\widehat{O_3}$ l√†:", a: ["$\\widehat{O_1}$", "$\\widehat{O_2}$", "$\\widehat{O_3}$", "$\\widehat{O_4}$"], correct: 0 },
      { q: "N·∫øu $\\widehat{M_1}=80^{\\circ}$ th√¨ s·ªë ƒëo c·ªßa g√≥c k·ªÅ b√π v·ªõi g√≥c $M_1$ l√† bao nhi√™u ƒë·ªô?", a: ["$60^{0}$", "$180^{0}$", "$80^{0}$", "$100^{0}$"], correct: 3 },
      { q: "T·∫≠p h·ª£p s·ªë th·ª±c ƒë∆∞·ª£c k√≠ hi·ªáu l√†:", a: ["Q", "N", "R", "I"], correct: 2 },
      { q: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒê√öNG?", a: ["$\\sqrt{2}; \\sqrt{3}; \\sqrt{5}$ l√† c√°c s·ªë th·ª±c", "S·ªë nguy√™n kh√¥ng l√† s·ªë th·ª±c", "S·ªë 0 v·ª´a l√† s·ªë h·ªØu t·ªâ v·ª´a l√† s·ªë v√¥ t·ªâ", "1/3 l√† s·ªë v√¥ t·ªâ"], correct: 0 },
      { q: "Ph√¢n s·ªë n√†o vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng s·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n?", a: ["$\\frac{3}{8}$", "$\\frac{6}{9}$", "$\\frac{17}{25}$", "$\\frac{9}{6}$"], correct: 1 },
      { q: "S·ªë ƒë·ªëi c·ªßa s·ªë $\\frac{-2}{5}$ l√†:", a: ["$\\frac{2}{5}$", "$\\frac{-5}{2}$", "$\\frac{5}{2}$", "0"], correct: 0 },
      { q: "Th·ªÉ t√≠ch h√¨nh l·∫≠p ph∆∞∆°ng c√≥ c·∫°nh 0,05m l√†:", a: ["$25m^{3}$", "$0,0125m^{3}$", "$0,000125m^{3}$", "$0,125dm^{3}$"], correct: 2 },
      { q: "H√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c, h=10cm, $S_{xq}=90cm^2$. Chu vi ƒë√°y l√†:", a: ["10 cm", "$9cm^{2}$", "100 cm", "9 cm"], correct: 3 },
      {
        q: "M√¥ t·∫£ quy t·∫Øc chuy·ªÉn v·∫ø qua ƒë·∫≥ng th·ª©c $-x+\\frac{1}{2}=\\frac{-5}{6}$ ta ƒë∆∞·ª£c:",
        options: ["$-x=\\frac{-5}{6}+\\frac{1}{2}$", "$-x=\\frac{-5}{6}-\\frac{1}{2}$", "$x=\\frac{-5}{6}+\\frac{1}{2}$", "$x=\\frac{-5}{6}-\\frac{1}{2}$"],
        correct: 1
      },
      { q: "Gi√° tr·ªã g·∫ßn ƒë√∫ng khi l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn ngh√¨n c·ªßa $\\sqrt{17}$ l√†:", a: ["4,123", "4,12", "4,1231", "4,124"], correct: 0 },
      { q: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh $-\\sqrt{64}+3\\sqrt{49}$ l√†:", a: ["29", "15", "13", "-13"], correct: 2 },
      {
        q: "S·ªë $x^{12}$ KH√îNG ph·∫£i k·∫øt qu·∫£ c·ªßa ph√©p t√≠nh n√†o sau ƒë√¢y:",
        options: ["$x^{13}:x (x\\ne0)$", "$x^5 \\cdot x^7$", "$x^4 \\cdot x^3$", "$(x^4)^3$"],
        correct: 2
      },
      { q: "T√≠nh $|\\frac{-2}{43}|$ b·∫±ng:", a: ["$\\frac{-2}{43}$", "$\\frac{2}{43}$", "$\\frac{43}{2}$", "$-|\\frac{-2}{43}|$"], correct: 1 },
      { q: "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 81 l√†:", a: ["9", "+9", "-9", "81"], correct: 0 },
      { q: "Cho ph√©p t√≠nh $(-38+21)-(21-38)$. Khi b·ªè d·∫•u ngo·∫∑c, ta ƒë∆∞·ª£c:", a: ["$-38+21-21+38$", "$38+21+21-38$", "$38-21-21+38$", "$-38+21+21+38$"], correct: 0 },
      { q: "Trong c√°c s·ªë sau, s·ªë v√¥ t·ªâ l√†:", a: ["$\\frac{3}{2}$", "$\\sqrt{2}$", "0", "3,(3)"], correct: 1 },
      { q: "H√£y ch·ªçn tr·∫£ l·ªùi ƒë√∫ng:", a: ["$-2\\in N$", "$3,2\\in Z$", "$\\sqrt{3}\\in Q$", "$2\\in R$"], correct: 3 },
      { q: "S·ªë 50,91 ƒë∆∞·ª£c l√†m tr√≤n v·ªõi ƒë·ªô ch√≠nh x√°c l√† $d=0,01$ (h√†ng ph·∫ßn trƒÉm) => l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn ch·ª•c:", a: ["50", "50,9", "50,5", "51,5"], correct: 1 },
      { q: "T√≠nh $1,(5) -2\\frac{1}{3}+3,(4)$ v·ªõi ƒë·ªô ch√≠nh x√°c $d=0,005$ (l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn trƒÉm) l√†:", a: ["2,7", "2,67", "2,667", "2,66"], correct: 1 },
      { q: "Cho $|x|=11,2$ th√¨ gi√° tr·ªã c·ªßa x l√†:", a: ["$x=11,2$", "$x=-11,2$", "$x=11,2$ ho·∫∑c $x=-11,2$", "$x=112$"], correct: 2 },
      { q: "Bi·∫øt $x^2=2$ th√¨ x b·∫±ng:", a: ["$x=\\sqrt{2}$ ho·∫∑c $x=\\sqrt{-2}$", "$x=\\pm\\sqrt{4}$", "$x=4$", "$x=\\sqrt{2}$ ho·∫∑c $x=-\\sqrt{2}$"], correct: 3 },
      { q: "N·∫øu $\\sqrt{x+1}=8$ th√¨ $x=$ ?", a: ["7", "8", "16", "63"], correct: 3 },
      { q: "V·ªõi m·ªçi s·ªë th·ª±c x. Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒë√∫ng?", a: ["$|x|\\ge0$", "$|x|=-x$", "$|x|=x$", "$|x|=0$"], correct: 0 },
      { q: "Ch·ªçn kh·∫≥ng ƒë·ªãnh SAI:", a: ["$|-2,5|=2,5$", "$|0|=0$", "$|3,5|=\\pm3,5$", "$|-\\sqrt{7}|>0$"], correct: 2 },
      { q: "B√°nh ng·ªçt lƒÉng tr·ª• ƒë·ª©ng tam gi√°c vu√¥ng, 2 c·∫°nh g√≥c vu√¥ng 6cm, 8cm, chi·ªÅu cao 3cm. Th·ªÉ t√≠ch l√†:", a: ["$72cm^{3}$", "$48cm^{3}$", "$120cm^{3}$", "$144cm^{3}$"], correct: 0 }
    ];

    // =========================
    // 2) TI·ªÜN √çCH: SHUFFLE & HO√ÅN V·ªä
    // =========================
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Tr·∫£ v·ªÅ 24 ho√°n v·ªã c·ªßa [0,1,2,3] (c·ªë ƒë·ªãnh, nh·∫π)
    function allPermutations4() {
      const base = [0,1,2,3];
      const res = [];
      function permute(a, l) {
        if (l === a.length - 1) { res.push(a.slice()); return; }
        for (let i = l; i < a.length; i++) {
          [a[l], a[i]] = [a[i], a[l]];
          permute(a, l + 1);
          [a[l], a[i]] = [a[i], a[l]];
        }
      }
      permute(base, 0);
      return res;
    }
    const PERMS4 = allPermutations4();

    // =========================
    // 3) CHU·∫®N HO√Å + RANDOM C√ÇU + RANDOM ƒê√ÅP √ÅN + C√ÇN B·∫∞NG ABCD
    // =========================
    function normalizeQuestions(raw) {
      const normalized = raw.map((qq, idx) => {
        const opts = Array.isArray(qq.options) ? qq.options
                  : Array.isArray(qq.a) ? qq.a
                  : null;

        if (!opts || opts.length !== 4) {
          console.warn("C√¢u b·ªã l·ªói d·ªØ li·ªáu (kh√¥ng ƒë·ªß 4 ƒë√°p √°n):", idx + 1, qq);
        }

        return {
          q: qq.q,
          options: opts || ["(Thi·∫øu ƒë√°p √°n A)", "(Thi·∫øu ƒë√°p √°n B)", "(Thi·∫øu ƒë√°p √°n C)", "(Thi·∫øu ƒë√°p √°n D)"],
          correct: typeof qq.correct === "number" ? qq.correct : 0
        };
      });

      return normalized;
    }

    // C√¢n b·∫±ng ch·ªØ c√°i ƒë√°p √°n ƒë√∫ng: ∆∞u ti√™n ƒë·∫∑t ƒë√°p √°n ƒë√∫ng v√†o letter √≠t xu·∫•t hi·ªán nh·∫•t
    function prepareQuiz(rawQuestions) {
      const base = normalizeQuestions(rawQuestions);

      // 1) random th·ª© t·ª± c√¢u h·ªèi
      shuffleInPlace(base);

      // 2) random ƒë√°p √°n nh∆∞ng c√≥ c√¢n b·∫±ng ABCD
      const correctCounts = [0,0,0,0]; // A,B,C,D
      const prepared = base.map((q) => {
        const correctOld = q.correct;
        const opts = q.options.slice();

        // Ch·ªçn ch·ªØ c√°i m·ª•c ti√™u (√≠t xu·∫•t hi·ªán nh·∫•t)
        const minCount = Math.min(...correctCounts);
        const targetLetters = [0,1,2,3].filter(i => correctCounts[i] === minCount);
        const target = targetLetters[Math.floor(Math.random() * targetLetters.length)];

        // Duy·ªát c√°c ho√°n v·ªã: ch·ªçn ho√°n v·ªã sao cho ƒë√°p √°n ƒë√∫ng r∆°i v√†o target n·∫øu c√≥ th·ªÉ
        // ƒë·ªìng th·ªùi v·∫´n c√≥ ng·∫´u nhi√™n (l·ªçc nh√≥m ph√π h·ª£p r·ªìi pick random)
        const goodPerms = PERMS4.filter(p => p.indexOf(correctOld) === target);
        const candidatePerms = goodPerms.length ? goodPerms : PERMS4;

        const chosenPerm = candidatePerms[Math.floor(Math.random() * candidatePerms.length)];

        const newOptions = chosenPerm.map(i => opts[i]);
        const newCorrect = chosenPerm.indexOf(correctOld);

        correctCounts[newCorrect]++;

        return {
          q: q.q,
          options: newOptions,
          correct: newCorrect
        };
      });

      return { prepared, correctCounts };
    }

    // =========================
    // 4) GAME STATE
    // =========================
    let quiz = [];
    let correctCountsFinal = [0,0,0,0];
    let currentIdx = 0;
    let score = 0;

    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- √ÇM THANH (Synth) ---
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      if (type === 'correct') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
      } else if (type === 'wrong') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
      } else if (type === 'fanfare') {
        const now = audioCtx.currentTime;
        [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g);
          g.connect(audioCtx.destination);
          o.frequency.value = freq;
          o.start(now + i * 0.1);
          g.gain.setValueAtTime(0.2, now + i * 0.1);
          g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.5);
          o.stop(now + i * 0.1 + 0.5);
        });
      }
    }

    // --- HI·ªÜU ·ª®NG CONFETTI ---
    function fireConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const pieces = [];
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];

      for (let i = 0; i < 150; i++) {
        pieces.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          w: Math.random() * 10 + 5,
          h: Math.random() * 10 + 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 5 + 2,
          vx: Math.random() * 4 - 2
        });
      }

      let animationId;
      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;
        pieces.forEach(p => {
          p.y += p.vy;
          p.x += p.vx;
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, p.w, p.h);
          if (p.y < canvas.height) active = true;
        });

        if (active) animationId = requestAnimationFrame(loop);
        else cancelAnimationFrame(animationId);
      }
      loop();
    }

    // --- LOGIC GAME ---
    function startGame() {
      // Prepare quiz each run (random c√¢u + random ƒë√°p √°n + c√¢n b·∫±ng ABCD)
      const preparedPack = prepareQuiz(questionsRaw);
      quiz = preparedPack.prepared;
      correctCountsFinal = preparedPack.correctCounts;

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      document.getElementById('result-screen').classList.add('hidden');

      score = 0;
      currentIdx = 0;

      document.getElementById('total-q').innerText = quiz.length;

      renderQuestion();
    }

    function renderQuestion() {
      if (currentIdx >= quiz.length) {
        endGame();
        return;
      }

      const qData = quiz[currentIdx];

      document.getElementById('current-q').innerText = currentIdx + 1;
      document.getElementById('score').innerText = score;

      // IMPORTANT: innerHTML ƒë·ªÉ MathJax render t·ªët cho c·∫£ $...$
      document.getElementById('question-text').innerHTML = qData.q;
      document.getElementById('mascot-reaction').innerText = "ü§î";

      const optsDiv = document.getElementById('options-container');
      optsDiv.innerHTML = '';

      qData.options.forEach((optText, idx) => {
        const btn = document.createElement('button');
        btn.className = "option-btn bg-white p-6 rounded-xl shadow-md text-lg font-semibold text-gray-700 hover:bg-indigo-50 w-full";
        btn.innerHTML = `<span class="font-bold text-indigo-500 mr-2">${String.fromCharCode(65 + idx)}.</span> ${optText}`;
        btn.onclick = () => checkAnswer(idx, btn);
        optsDiv.appendChild(btn);
      });

      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    }

    function checkAnswer(selectedIndex, btnElement) {
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(b => b.disabled = true);

      const correctIndex = quiz[currentIdx].correct;
      const isCorrect = selectedIndex === correctIndex;

      if (isCorrect) {
        btnElement.classList.add('correct-anim');
        score += 10;
        document.getElementById('score').innerText = score;
        document.getElementById('mascot-reaction').innerText = "üòç";
        playSound('correct');
        fireConfetti();
        showFeedback(true);
      } else {
        btnElement.classList.add('wrong-anim');
        buttons[correctIndex].classList.add('correct-anim');
        document.getElementById('mascot-reaction').innerText = "üòÖ";
        playSound('wrong');
        showFeedback(false);
      }
    }

    function showFeedback(isCorrect) {
      const modal = document.getElementById('feedback-modal');
      const title = document.getElementById('feedback-title');
      const msg = document.getElementById('feedback-msg');
      const icon = document.getElementById('feedback-icon');

      modal.classList.remove('hidden');

      if (isCorrect) {
        title.innerText = "Tuy·ªát V·ªùi!";
        title.className = "text-3xl font-bold mb-2 text-green-600";
        msg.innerText = randomPraise();
        icon.innerText = "üéâ";
      } else {
        title.innerText = "Ti·∫øc Qu√°!";
        title.className = "text-3xl font-bold mb-2 text-red-600";
        msg.innerText = "ƒê√°p √°n ƒë√∫ng l√† " + String.fromCharCode(65 + quiz[currentIdx].correct);
        icon.innerText = "üí™";
      }
    }

    function randomPraise() {
      const praises = ["Em l√†m t·ªët l·∫Øm!", "Chu·∫©n kh√¥ng c·∫ßn ch·ªânh!", "10 ƒëi·ªÉm v·ªÅ ch·ªó!", "C√¥ Thu B√¨nh r·∫•t t·ª± h√†o!", "Ti·∫øp t·ª•c ph√°t huy nh√©!"];
      return praises[Math.floor(Math.random() * praises.length)];
    }

    function nextQuestion() {
      document.getElementById('feedback-modal').classList.add('hidden');
      currentIdx++;
      renderQuestion();
    }

    function endGame() {
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');

      const maxScore = quiz.length * 10;
      const percentage = Math.round((score / maxScore) * 100);

      document.getElementById('final-score').innerText = `${score}/${maxScore}`;
      document.getElementById('final-percent').innerText = `${percentage}%`;

      playSound('fanfare');
      fireConfetti();

      let msg = "";
      if (percentage >= 90) msg = "Xu·∫•t s·∫Øc! C√¥ tin em s·∫Ω ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa trong k·ª≥ thi t·ªõi! üåü";
      else if (percentage >= 70) msg = "L√†m t·ªët l·∫Øm! Ch·ªâ c·∫ßn c·∫©n th·∫≠n h∆°n m·ªôt ch√∫t n·ªØa th√¥i. üí™";
      else msg = "C·ªë g·∫Øng l√™n nh√©! H√£y √¥n l·∫°i c√°c c√¢u sai, c√¥ tin em s·∫Ω ti·∫øn b·ªô. ‚ù§Ô∏è";

      document.getElementById('teacher-msg').innerText = msg;

      // Hi·ªÉn th·ªã ph√¢n b·ªë ƒë√°p √°n ƒë√∫ng ABCD ƒë·ªÉ c√¥ ki·ªÉm tra nhanh
      const [a,b,c,d] = correctCountsFinal;
      document.getElementById('answer-balance').innerText =
        `Ph√¢n b·ªë ƒë√°p √°n ƒë√∫ng (t·ª± c√¢n b·∫±ng): A=${a}, B=${b}, C=${c}, D=${d}`;
    }

    // Resize confetti canvas
    window.addEventListener('resize', () => {
      const canvas = document.getElementById('confetti-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
