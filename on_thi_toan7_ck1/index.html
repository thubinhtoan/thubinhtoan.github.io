<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ƒê·∫•u Tr∆∞·ªùng To√°n 7 - C√¥ Thu B√¨nh</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .hand-font { font-family: 'Patrick Hand', cursive; }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .option-btn {
      transition: all 0.2s;
      border: 3px solid transparent;
    }
    .option-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-color: #764ba2;
    }
    .option-btn:active:not(:disabled) { transform: translateY(1px); }

    .correct-anim {
      animation: bounce 0.45s cubic-bezier(0.36, 0, 0.66, -0.56) infinite alternate;
      background-color: #48bb78 !important;
      color: white !important;
      border-color: #2f855a !important;
    }
    .wrong-anim {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      background-color: #f56565 !important;
      color: white !important;
      border-color: #c53030 !important;
    }
    @keyframes bounce { 0%{transform:translateY(0)} 100%{transform:translateY(-10px)} }
    @keyframes shake {
      10%,90%{transform:translate3d(-1px,0,0)}
      20%,80%{transform:translate3d(2px,0,0)}
      30%,50%,70%{transform:translate3d(-4px,0,0)}
      40%,60%{transform:translate3d(4px,0,0)}
    }

    #confetti-canvas{
      position:fixed;top:0;left:0;width:100%;height:100%;
      pointer-events:none;z-index:9999;
    }

    .mascot { font-size: 3rem; animation: float 3s ease-in-out infinite; }
    @keyframes float {
      0%{transform:translateY(0) rotate(0)}
      50%{transform:translateY(-10px) rotate(5deg)}
      100%{transform:translateY(0) rotate(0)}
    }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <canvas id="confetti-canvas"></canvas>

  <!-- Start -->
  <div id="start-screen" class="card p-8 max-w-2xl w-full text-center relative z-10">
    <div class="mascot mb-4">üë©‚Äçüè´ ‚ú®</div>
    <h1 class="text-4xl md:text-5xl font-bold text-indigo-700 mb-4 hand-font">ƒê·∫•u Tr∆∞·ªùng To√°n 7</h1>
    <h2 class="text-xl text-gray-600 mb-6">√în t·∫≠p ‚Äì Ki·ªÉm tra (c√≥ gi·∫£i th√≠ch)</h2>
    <p class="text-gray-600 mb-8 text-lg">
      Ch√†o m·ª´ng c√°c em ƒë·∫øn v·ªõi b√†i √¥n t·∫≠p!<br/>
      L√†m t·ª´ng c√¢u th·∫≠t b√¨nh tƒ©nh, xem gi·∫£i th√≠ch ƒë·ªÉ nh·ªõ l√¢u nh√©.
    </p>
    <button onclick="startGame()"
      class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transition transform hover:scale-105">
      B·∫ÆT ƒê·∫¶U NGAY üöÄ
    </button>
  </div>

  <!-- Game -->
  <div id="game-screen" class="hidden w-full max-w-4xl relative z-10">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6 bg-white/20 p-4 rounded-xl backdrop-blur-sm text-white">
      <div class="flex items-center">
        <span class="text-2xl mr-2">üèÜ</span>
        <div>
          <div class="text-xs opacity-80">ƒêI·ªÇM S·ªê</div>
          <div class="text-2xl font-bold" id="score">0</div>
        </div>
      </div>
      <div class="text-center">
        <div class="mascot" id="mascot-reaction">ü§î</div>
      </div>
      <div class="text-right">
        <div class="text-xs opacity-80">C√ÇU H·ªéI</div>
        <div class="text-2xl font-bold"><span id="current-q">1</span>/<span id="total-q">0</span></div>
      </div>
    </div>

    <!-- Question -->
    <div class="card p-6 md:p-10 mb-4 min-h-[180px] flex flex-col justify-center items-center text-center">
      <h3 class="text-2xl md:text-3xl font-bold text-gray-800 leading-relaxed" id="question-text">
        ...
      </h3>
    </div>

    <!-- Options -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-container"></div>

    <!-- Explain Panel -->
    <div id="explain-panel" class="hidden mt-4 card p-6 md:p-8">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-lg md:text-xl font-bold text-amber-700">üí° Gi·∫£i th√≠ch</div>
        <div id="level-pill" class="text-xs font-semibold px-3 py-1 rounded-full bg-amber-100 text-amber-800">
          NH·∫¨N BI·∫æT
        </div>
      </div>
      <div id="explain-text" class="mt-3 text-gray-700 text-base leading-relaxed"></div>

      <div class="mt-5 flex items-center justify-end">
        <button id="next-btn" onclick="nextQuestion()"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition">
          Ti·∫øp t·ª•c ‚û°Ô∏è
        </button>
      </div>
    </div>
  </div>

  <!-- Result -->
  <div id="result-screen" class="hidden card p-8 max-w-2xl w-full text-center relative z-10">
    <div class="text-6xl mb-4">üéì</div>
    <h2 class="text-4xl font-bold text-indigo-800 mb-4">T·ªïng K·∫øt</h2>
    <p class="text-xl text-gray-600 mb-6">Ch√∫c m·ª´ng em ƒë√£ ho√†n th√†nh b√†i!</p>

    <div class="bg-indigo-50 rounded-xl p-6 mb-8">
      <div class="text-5xl font-bold text-indigo-600 mb-2" id="final-score">0/0</div>
      <div class="text-gray-500" id="final-percent">0%</div>
    </div>

    <p id="teacher-msg" class="text-lg italic text-gray-700 mb-8">
      ...
    </p>

    <button onclick="location.reload()"
      class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition">
      L√†m L·∫°i B√†i üîÑ
    </button>
  </div>

  <script>
    // ================== UTIL ==================
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function typesetMath() {
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise().catch(() => {});
      }
    }

    // ================== QUESTIONS ==================
    // M·ªói c√¢u: q, options (4 ƒë√°p √°n), correct (0..3), explain
    const baseQuestions = [
      { q: "Gi√° tr·ªã tuy·ªát ƒë·ªëi c·ªßa 7,82 l√†:", options: ["8,27","7,82","-7,82","7,8"], correct: 1,
        explain: "V√¨ $7{,}82 \\ge 0$ n√™n $|7{,}82| = 7{,}82$." },

      { q: "K·∫øt qu·∫£ so s√°nh hai s·ªë th·∫≠p ph√¢n 65,312 v√† 65,314 l√†:", options: ["$65,312 < 65,314$","$65,312 > 65,314$","$65,312 = 65,314$","$65,312 \\le 65,314$"], correct: 0,
        explain: "So s√°nh ƒë·∫øn h√†ng ph·∫ßn ngh√¨n: $312 < 314$ n√™n $65{,}312 < 65{,}314$." },

      { q: "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 81 l√†:", options: ["9","8","15","-18"], correct: 0,
        explain: "CƒÉn b·∫≠c hai s·ªë h·ªçc l√† s·ªë kh√¥ng √¢m: $\\sqrt{81}=9$." },

      { q: "S·ªë ƒë·ªëi c·ªßa s·ªë $\\frac{15}{18}$ l√†:", options: ["$1\\frac{15}{8}$","$-\\frac{15}{18}$","$-\\sqrt{25}$","$9^2$"], correct: 1,
        explain: "S·ªë ƒë·ªëi c·ªßa $a$ l√† $-a$. V·∫≠y s·ªë ƒë·ªëi c·ªßa $\\frac{15}{18}$ l√† $-\\frac{15}{18}$." },

      { q: "Gi√° tr·ªã tuy·ªát ƒë·ªëi c·ªßa $-\\sqrt{25}$ l√†:", options: ["5","$\\sqrt{25}$","-9","-5"], correct: 0,
        explain: "$\\sqrt{25}=5$ n√™n $-\\sqrt{25}=-5$ v√† $|-5|=5$." },

      { q: "S·ªë n√†o vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng s·ªë th·∫≠p ph√¢n h·ªØu h·∫°n:", options: ["$\\frac{-6}{75}$","$\\frac{-6}{76}$","$\\frac{7}{30}$","$\\frac{-7}{30}$"], correct: 0,
        explain: "$\\frac{-6}{75}=-\\frac{2}{25}$ v·ªõi m·∫´u $25=5^2$ n√™n l√† th·∫≠p ph√¢n h·ªØu h·∫°n." },

      { q: "T·∫≠p h·ª£p c√°c s·ªë v√¥ t·ªâ k√≠ hi·ªáu l√†:", options: ["N","Q","R","I"], correct: 3,
        explain: "T·∫≠p s·ªë v√¥ t·ªâ k√≠ hi·ªáu l√† $I$." },

      { q: "Ch·ª©ng minh ƒë·ªãnh l√≠ l√†:", options: ["D√πng h√¨nh v·∫Ω suy ra k·∫øt lu·∫≠n","D√πng l·∫≠p lu·∫≠n t·ª´ gi·∫£ thi·∫øt suy ra k·∫øt lu·∫≠n","D√πng ƒëo ƒë·∫°c th·ª±c t·∫ø","D√πng tr·ª±c gi√°c"], correct: 1,
        explain: "Ch·ª©ng minh l√† suy lu·∫≠n logic t·ª´ gi·∫£ thi·∫øt ƒë·∫øn k·∫øt lu·∫≠n." },

      { q: "Ph√°t bi·ªÉu n√†o sau ƒë√¢y l√† sai?", options: ["M·ªçi s·ªë v√¥ t·ªâ ƒë·ªÅu l√† s·ªë th·ª±c","M·ªçi s·ªë th·ª±c ƒë·ªÅu l√† s·ªë v√¥ t·ªâ","S·ªë 0 l√† s·ªë h·ªØu t·ªâ","$\\sqrt{7}$ l√† s·ªë v√¥ t·ªâ"], correct: 1,
        explain: "S·ªë th·ª±c g·ªìm c·∫£ h·ªØu t·ªâ v√† v√¥ t·ªâ; kh√¥ng ph·∫£i m·ªçi s·ªë th·ª±c ƒë·ªÅu v√¥ t·ªâ." },

      { q: "K·∫øt lu·∫≠n ƒë√∫ng: ‚ÄúN·∫øu hai ƒë∆∞·ªùng th·∫≥ng a v√† b c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba c th√¨...‚Äù", options: ["a song song v·ªõi b","a v√† b c·∫Øt nhau","b song song v·ªõi c","a v√† b tr√πng nhau"], correct: 0,
        explain: "Hai ƒë∆∞·ªùng th·∫≥ng c√πng vu√¥ng g√≥c v·ªõi ƒë∆∞·ªùng th·∫≥ng th·ª© ba th√¨ song song v·ªõi nhau (n·∫øu ph√¢n bi·ªát)." },

      { q: "Gi·∫£ thi·∫øt c·ªßa ƒë·ªãnh l√≠: ¬´ N·∫øu hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba th√¨ ch√∫ng song song v·ªõi nhau ¬ª l√†:", options: ["Hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát","Hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c","Hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba","Ch√∫ng song song v·ªõi nhau"], correct: 2,
        explain: "Gi·∫£ thi·∫øt ch√≠nh l√† ph·∫ßn ‚ÄúN·∫øu ‚Ä¶‚Äù: hai ƒë∆∞·ªùng th·∫≥ng ph√¢n bi·ªát c√πng vu√¥ng g√≥c v·ªõi m·ªôt ƒë∆∞·ªùng th·∫≥ng th·ª© ba." },

      { q: "Cho $\\widehat{xOy}=140^{\\circ}$, Om l√† tia ph√¢n gi√°c. S·ªë ƒëo $\\widehat{xOm}$ l√†:", options: ["$150^{\\circ}$","$70^{\\circ}$","$130^{\\circ}$","$180^{\\circ}$"], correct: 1,
        explain: "Tia ph√¢n gi√°c chia ƒë√¥i g√≥c: $140^{\\circ}:2=70^{\\circ}$." },

      { q: "T·ªïng s·ªë ƒëo hai g√≥c k·ªÅ b√π b·∫±ng:", options: ["$180^{\\circ}$","$120^{\\circ}$","$90^{\\circ}$","$60^{\\circ}$"], correct: 0,
        explain: "Hai g√≥c k·ªÅ b√π lu√¥n c√≥ t·ªïng $180^{\\circ}$." },

      { q: "Cho $\\Delta MNP$. Qua M k·∫ª a // NP, qua P k·∫ª b // MN. S·ªë ƒë∆∞·ªùng th·∫≥ng a, b v·∫Ω ƒë∆∞·ª£c l·∫ßn l∆∞·ª£t l√†:", options: ["1; 1","2; 2","3; 3","V√¥ s·ªë"], correct: 0,
        explain: "Qua 1 ƒëi·ªÉm ngo√†i 1 ƒë∆∞·ªùng th·∫≥ng ch·ªâ k·∫ª ƒë∆∞·ª£c duy nh·∫•t 1 ƒë∆∞·ªùng th·∫≥ng song song." },

      { q: "Qua m·ªôt ƒëi·ªÉm ·ªü ngo√†i m·ªôt ƒë∆∞·ªùng th·∫≥ng c√≥ bao nhi√™u ƒë∆∞·ªùng th·∫≥ng song song v·ªõi ƒë∆∞·ªùng th·∫≥ng ƒë√≥?", options: ["Ch·ªâ c√≥ m·ªôt","C√≥ v√¥ s·ªë","C√≥ √≠t nh·∫•t m·ªôt","Kh√¥ng c√≥"], correct: 0,
        explain: "Ti√™n ƒë·ªÅ Euclid: qua m·ªôt ƒëi·ªÉm ngo√†i m·ªôt ƒë∆∞·ªùng th·∫≥ng ch·ªâ c√≥ m·ªôt ƒë∆∞·ªùng th·∫≥ng song song." },

      { q: "N·∫øu $\\widehat{M_1}=80^{\\circ}$ th√¨ g√≥c k·ªÅ b√π v·ªõi $M_1$ l√†:", options: ["$60^{\\circ}$","$180^{\\circ}$","$80^{\\circ}$","$100^{\\circ}$"], correct: 3,
        explain: "G√≥c k·ªÅ b√π t·ªïng $180^{\\circ}$ n√™n $180^{\\circ}-80^{\\circ}=100^{\\circ}$." },

      { q: "T·∫≠p h·ª£p s·ªë th·ª±c ƒë∆∞·ª£c k√≠ hi·ªáu l√†:", options: ["Q","N","R","I"], correct: 2,
        explain: "T·∫≠p s·ªë th·ª±c k√≠ hi·ªáu l√† $\\mathbb{R}$." },

      { q: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒê√öNG?", options: ["$\\sqrt{2};\\sqrt{3};\\sqrt{5}$ l√† c√°c s·ªë th·ª±c","S·ªë nguy√™n kh√¥ng l√† s·ªë th·ª±c","S·ªë 0 v·ª´a h·ªØu t·ªâ v·ª´a v√¥ t·ªâ","$\\frac{1}{3}$ l√† s·ªë v√¥ t·ªâ"], correct: 0,
        explain: "C√°c cƒÉn b·∫≠c hai kh√¥ng ho√†n ch·ªânh l√† s·ªë v√¥ t·ªâ nh∆∞ng v·∫´n thu·ªôc t·∫≠p s·ªë th·ª±c." },

      { q: "Ph√¢n s·ªë n√†o l√† s·ªë th·∫≠p ph√¢n v√¥ h·∫°n tu·∫ßn ho√†n?", options: ["$\\frac{3}{8}$","$\\frac{6}{9}$","$\\frac{17}{25}$","$\\frac{9}{6}$"], correct: 1,
        explain: "$\\frac{6}{9}=\\frac{2}{3}=0,(6)$ l√† v√¥ h·∫°n tu·∫ßn ho√†n." },

      { q: "S·ªë ƒë·ªëi c·ªßa s·ªë $\\frac{-2}{5}$ l√†:", options: ["$\\frac{2}{5}$","$\\frac{-5}{2}$","$\\frac{5}{2}$","0"], correct: 0,
        explain: "S·ªë ƒë·ªëi c·ªßa $-\\frac{2}{5}$ l√† $\\frac{2}{5}$." },

      { q: "Th·ªÉ t√≠ch h√¨nh l·∫≠p ph∆∞∆°ng c·∫°nh 0,05m l√†:", options: ["$25m^{3}$","$0,0125m^{3}$","$0,000125m^{3}$","$0,125dm^{3}$"], correct: 2,
        explain: "$V=a^3=(0{,}05)^3=0{,}000125\\,m^3$." },

      { q: "LƒÉng tr·ª• ƒë·ª©ng tam gi√°c, h=10cm, $S_{xq}=90cm^2$. Chu vi ƒë√°y l√†:", options: ["10 cm","$9cm^{2}$","100 cm","9 cm"], correct: 3,
        explain: "$S_{xq}=C_{ƒë√°y}\\cdot h$ n√™n $C_{ƒë√°y}=90:10=9\\,cm$." },

      { q: "T·ª´ ƒë·∫≥ng th·ª©c $-x+\\frac{1}{2}=\\frac{-5}{6}$ ta chuy·ªÉn v·∫ø ƒë√∫ng l√†:", options: ["$-x=\\frac{-5}{6}+\\frac{1}{2}$","$-x=\\frac{-5}{6}-\\frac{1}{2}$","$x=\\frac{-5}{6}+\\frac{1}{2}$","$x=\\frac{-5}{6}-\\frac{1}{2}$"], correct: 1,
        explain: "Chuy·ªÉn $+\\frac12$ sang v·∫ø ph·∫£i th√†nh $-\\frac12$: $-x= -\\frac56-\\frac12$." },

      { q: "Gi√° tr·ªã g·∫ßn ƒë√∫ng (l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn ngh√¨n) c·ªßa $\\sqrt{17}$ l√†:", options: ["4,123","4,12","4,1231","4,124"], correct: 0,
        explain: "$\\sqrt{17}\\approx 4{,}123105...$ l√†m tr√≤n ƒë·∫øn ph·∫ßn ngh√¨n ƒë∆∞·ª£c $4{,}123$." },

      { q: "K·∫øt qu·∫£ $-\\sqrt{64}+3\\sqrt{49}$ l√†:", options: ["29","15","13","-13"], correct: 2,
        explain: "$-\\sqrt{64}=-8$, $3\\sqrt{49}=3\\cdot 7=21$ n√™n t·ªïng $=13$." },

      { q: "Bi·ªÉu th·ª©c n√†o KH√îNG cho k·∫øt qu·∫£ $x^{12}$?", options: ["$x^{13}:x$","$x^5\\cdot x^7$","$x^4\\cdot x^3$","$(x^4)^3$"], correct: 2,
        explain: "$x^4\\cdot x^3=x^{7}$, kh√¥ng ph·∫£i $x^{12}$." },

      { q: "T√≠nh $\\left|\\frac{-2}{43}\\right|$ b·∫±ng:", options: ["$\\frac{-2}{43}$","$\\frac{2}{43}$","$\\frac{43}{2}$","$-\\left|\\frac{-2}{43}\\right|$"], correct: 1,
        explain: "Gi√° tr·ªã tuy·ªát ƒë·ªëi lu√¥n kh√¥ng √¢m: $\\left|\\frac{-2}{43}\\right|=\\frac{2}{43}$." },

      { q: "Cho ph√©p t√≠nh $(-38+21)-(21-38)$. B·ªè d·∫•u ngo·∫∑c ƒë∆∞·ª£c:", options: ["$-38+21-21+38$","$38+21+21-38$","$38-21-21+38$","$-38+21+21+38$"], correct: 0,
        explain: "Tr·ª´ ngo·∫∑c th·ª© hai ƒë·ªïi d·∫•u: $(-38+21)-(21-38)=-38+21-21+38$." },

      { q: "Trong c√°c s·ªë sau, s·ªë v√¥ t·ªâ l√†:", options: ["$\\frac{3}{2}$","$\\sqrt{2}$","0","3,(3)"], correct: 1,
        explain: "$\\sqrt{2}$ l√† s·ªë v√¥ t·ªâ." },

      { q: "Ch·ªçn tr·∫£ l·ªùi ƒë√∫ng:", options: ["$-2\\in \\mathbb{N}$","$3,2\\in \\mathbb{Z}$","$\\sqrt{3}\\in \\mathbb{Q}$","$2\\in \\mathbb{R}$"], correct: 3,
        explain: "$2$ l√† s·ªë th·ª±c n√™n $2\\in\\mathbb{R}$." },

      { q: "S·ªë 50,91 l√†m tr√≤n v·ªõi ƒë·ªô ch√≠nh x√°c $d=0,01$ l√†:", options: ["50","50,9","50,91","50,92"], correct: 2,
        explain: "ƒê·ªô ch√≠nh x√°c $0{,}01$ l√† l√†m tr√≤n ƒë·∫øn h√†ng ph·∫ßn trƒÉm: $50{,}91$ ƒë√£ ·ªü h√†ng ph·∫ßn trƒÉm." },

      { q: "Cho $|x|=11,2$ th√¨ x l√†:", options: ["$x=11,2$","$x=-11,2$","$x=11,2$ ho·∫∑c $x=-11,2$","$x=112$"], correct: 2,
        explain: "$|x|=a>0$ th√¨ $x=a$ ho·∫∑c $x=-a$." },

      { q: "Bi·∫øt $x^2=2$ th√¨ x b·∫±ng:", options: ["$x=\\sqrt{2}$ ho·∫∑c $x=\\sqrt{-2}$","$x=\\pm\\sqrt{4}$","$x=4$","$x=\\sqrt{2}$ ho·∫∑c $x=-\\sqrt{2}$"], correct: 3,
        explain: "Nghi·ªám c·ªßa $x^2=2$ l√† $x=\\pm\\sqrt{2}$." },

      { q: "N·∫øu $\\sqrt{x+1}=8$ th√¨ $x=$ ?", options: ["7","8","16","63"], correct: 3,
        explain: "B√¨nh ph∆∞∆°ng: $x+1=64$ n√™n $x=63$." },

      { q: "V·ªõi m·ªçi s·ªë th·ª±c x, kh·∫≥ng ƒë·ªãnh ƒë√∫ng l√†:", options: ["$|x|\\ge0$","$|x|=-x$","$|x|=x$","$|x|=0$"], correct: 0,
        explain: "Gi√° tr·ªã tuy·ªát ƒë·ªëi lu√¥n kh√¥ng √¢m: $|x|\\ge 0$." },

      { q: "Ch·ªçn kh·∫≥ng ƒë·ªãnh SAI:", options: ["$|-2,5|=2,5$","$|0|=0$","$|3,5|=\\pm3,5$","$|-\\sqrt{7}|>0$"], correct: 2,
        explain: "Gi√° tr·ªã tuy·ªát ƒë·ªëi ch·ªâ cho m·ªôt gi√° tr·ªã kh√¥ng √¢m, kh√¥ng th·ªÉ l√† $\\pm$." },

      { q: "LƒÉng tr·ª• ƒë·ª©ng tam gi√°c vu√¥ng: 2 c·∫°nh g√≥c vu√¥ng 6cm, 8cm, chi·ªÅu cao 3cm. Th·ªÉ t√≠ch l√†:", options: ["$72cm^{3}$","$48cm^{3}$","$120cm^{3}$","$144cm^{3}$"], correct: 0,
        explain: "Di·ªán t√≠ch ƒë√°y $S=\\frac12\\cdot6\\cdot8=24$. Th·ªÉ t√≠ch $V=S\\cdot h=24\\cdot3=72\\,cm^3$." }
    ];

    // ================== GAME STATE ==================
    let questions = [];
    let currentIdx = 0;
    let score = 0;
    let locked = false;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // ================== SOUND ==================
    function playSound(type) {
      if (audioCtx.state === 'suspended') audioCtx.resume();

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      if (type === 'correct') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.45);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.45);
      } else if (type === 'wrong') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(160, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(95, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.22, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
      } else if (type === 'fanfare') {
        const now = audioCtx.currentTime;
        [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.frequency.value = freq;
          o.start(now + i * 0.1);
          g.gain.setValueAtTime(0.18, now + i * 0.1);
          g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.5);
          o.stop(now + i * 0.1 + 0.5);
        });
      }
    }

    // ================== CONFETTI ==================
    function fireConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const pieces = [];
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];

      for (let i = 0; i < 150; i++) {
        pieces.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          w: Math.random() * 10 + 5,
          h: Math.random() * 10 + 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 5 + 2,
          vx: Math.random() * 4 - 2
        });
      }

      let animationId;
      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;
        pieces.forEach(p => {
          p.y += p.vy; p.x += p.vx;
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, p.w, p.h);
          if (p.y < canvas.height) active = true;
        });
        if (active) animationId = requestAnimationFrame(loop);
        else cancelAnimationFrame(animationId);
      }
      loop();
    }

    // ================== BUILD QUESTIONS (shuffle + balance A/B/C/D) ==================
    function buildQuestions() {
      const qCopy = baseQuestions.map(q => ({
        q: q.q,
        explain: q.explain || "C√¢u n√†y c√¥ s·∫Ω b·ªï sung gi·∫£i th√≠ch sau nh√©.",
        // chuy·ªÉn options th√†nh object ƒë·ªÉ shuffle m√† v·∫´n bi·∫øt ƒë√°p √°n ƒë√∫ng
        opts: q.options.map((t, idx) => ({ text: t, isCorrect: idx === q.correct }))
      }));

      // Random th·ª© t·ª± c√¢u h·ªèi (c√¥ c√≥ th·ªÉ t·∫Øt b·∫±ng c√°ch comment d√≤ng d∆∞·ªõi)
      shuffleArray(qCopy);

      // C√¢n b·∫±ng v·ªã tr√≠ ƒë√°p √°n ƒë√∫ng A/B/C/D
      // M·ª•c ti√™u: c√¢u 1 ƒë√∫ng A, c√¢u 2 ƒë√∫ng B, c√¢u 3 ƒë√∫ng C, c√¢u 4 ƒë√∫ng D, l·∫∑p l·∫°i...
      qCopy.forEach((qq, i) => {
        shuffleArray(qq.opts);

        const desired = i % 4;
        const correctIdx = qq.opts.findIndex(o => o.isCorrect);

        if (correctIdx !== desired) {
          [qq.opts[correctIdx], qq.opts[desired]] = [qq.opts[desired], qq.opts[correctIdx]];
        }
      });

      return qCopy;
    }

    // ================== UI / LOGIC ==================
    function startGame() {
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      document.getElementById('result-screen').classList.add('hidden');

      score = 0;
      currentIdx = 0;
      locked = false;

      questions = buildQuestions();
      document.getElementById('total-q').innerText = questions.length;

      renderQuestion();
    }

    function renderQuestion() {
      if (currentIdx >= questions.length) { endGame(); return; }

      locked = false;
      document.getElementById('explain-panel').classList.add('hidden');

      const qData = questions[currentIdx];
      document.getElementById('current-q').innerText = currentIdx + 1;
      document.getElementById('score').innerText = score;
      document.getElementById('mascot-reaction').innerText = "ü§î";

      // d√πng innerHTML ƒë·ªÉ MathJax render
      document.getElementById('question-text').innerHTML = qData.q;

      const optsDiv = document.getElementById('options-container');
      optsDiv.innerHTML = '';

      qData.opts.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "option-btn bg-white p-6 rounded-xl shadow-md text-lg font-semibold text-gray-700 hover:bg-indigo-50 w-full text-left";
        btn.innerHTML = `<span class="font-bold text-indigo-500 mr-2">${String.fromCharCode(65 + idx)}.</span> ${opt.text}`;
        btn.onclick = () => checkAnswer(idx, btn);
        optsDiv.appendChild(btn);
      });

      typesetMath();
    }

    function checkAnswer(selectedIndex, btnElement) {
      if (locked) return;
      locked = true;

      const qData = questions[currentIdx];
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(b => b.disabled = true);

      const correctIndex = qData.opts.findIndex(o => o.isCorrect);
      const isCorrect = selectedIndex === correctIndex;

      if (isCorrect) {
        btnElement.classList.add('correct-anim');
        score += 10;
        document.getElementById('score').innerText = score;
        document.getElementById('mascot-reaction').innerText = "üòç";
        playSound('correct');
        fireConfetti();
      } else {
        btnElement.classList.add('wrong-anim');
        buttons[correctIndex].classList.add('correct-anim');
        document.getElementById('mascot-reaction').innerText = "üòÖ";
        playSound('wrong');
      }

      showExplain(isCorrect, correctIndex);
    }

    function showExplain(isCorrect, correctIndex) {
      const panel = document.getElementById('explain-panel');
      const explainText = document.getElementById('explain-text');

      const qData = questions[currentIdx];
      const correctLetter = String.fromCharCode(65 + correctIndex);

      const headline = isCorrect
        ? `<div class="text-green-700 font-bold text-lg mb-1">Tuy·ªát v·ªùi! ƒê√∫ng r·ªìi.</div>`
        : `<div class="text-red-700 font-bold text-lg mb-1">Ti·∫øc qu√°! ƒê√°p √°n ƒë√∫ng l√† <span class="underline">${correctLetter}</span>.</div>`;

      explainText.innerHTML = `
        ${headline}
        <div class="mt-2 text-gray-700">${qData.explain}</div>
      `;

      panel.classList.remove('hidden');
      typesetMath();
    }

    function nextQuestion() {
      currentIdx++;
      renderQuestion();
    }

    function endGame() {
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');

      const maxScore = questions.length * 10;
      const percentage = Math.round((score / maxScore) * 100);

      document.getElementById('final-score').innerText = `${score}/${maxScore}`;
      document.getElementById('final-percent').innerText = `${percentage}%`;

      playSound('fanfare');
      fireConfetti();

      let msg = "";
      if (percentage >= 90) msg = "Xu·∫•t s·∫Øc! C√¥ tin em s·∫Ω ƒë·∫°t ƒëi·ªÉm r·∫•t cao trong k·ª≥ thi t·ªõi!";
      else if (percentage >= 70) msg = "L√†m t·ªët l·∫Øm! C·∫©n th·∫≠n th√™m m·ªôt ch√∫t n·ªØa l√† tuy·ªát v·ªùi.";
      else msg = "C·ªë g·∫Øng l√™n nh√©! Xem l·∫°i gi·∫£i th√≠ch c√°c c√¢u sai, em s·∫Ω ti·∫øn b·ªô nhanh.";
      document.getElementById('teacher-msg').innerText = msg;
    }

    window.addEventListener('resize', () => {
      const canvas = document.getElementById('confetti-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
