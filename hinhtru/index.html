<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chinh Ph·ª•c H√¨nh Tr·ª• - C√¥ Thu B√¨nh To√°n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #E0F2FE 0%, #F0F9FF 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .btn-option { transition: all 0.2s; border: 2px solid #E5E7EB; }
    .btn-option:hover:not(:disabled) { transform: translateY(-2px); border-color: #3B82F6; background-color: #EFF6FF; }
    .btn-option.correct { border-color: #22C55E; background-color: #F0FDF4; color: #15803D; }
    .btn-option.incorrect { border-color: #EF4444; background-color: #FEF2F2; color: #B91C1C; }

    .fade-in { animation: fadeIn 0.5s ease-in; }
    .slide-up { animation: slideUp 0.5s ease-out; }
    .bounce { animation: bounce 0.5s cubic-bezier(0.36, 0, 0.66, -0.56); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

    #confetti-canvas {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 50;
    }
    .progress-bar { transition: width 0.5s ease-in-out; }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <canvas id="confetti-canvas"></canvas>

  <!-- Start Screen -->
  <div id="start-screen" class="card max-w-2xl w-full p-8 text-center slide-up">
    <div class="mb-6">
      <i class="fa-solid fa-shapes text-6xl text-blue-500 mb-4 bounce"></i>
      <h1 class="text-4xl font-extrabold text-slate-800 mb-2">Chinh Ph·ª•c H√¨nh Tr·ª•</h1>
      <p class="text-slate-500 text-lg">M√¥n To√°n L·ªõp 9 - Ch∆∞∆°ng 10</p>
    </div>

    <div class="bg-blue-50 rounded-xl p-6 mb-6 text-left">
      <h3 class="font-bold text-blue-800 mb-3 flex items-center">
        <i class="fa-solid fa-circle-info mr-2"></i> Th√¥ng tin b√†i thi:
      </h3>
      <ul class="space-y-2 text-slate-700">
        <li><i class="fa-solid fa-check text-green-500 mr-2"></i> <b>20 C√¢u h·ªèi</b> tr·∫Øc nghi·ªám</li>
        <li><i class="fa-solid fa-layer-group text-purple-500 mr-2"></i> 4 M·ª©c ƒë·ªô: Nh·∫≠n bi·∫øt, Th√¥ng hi·ªÉu, V·∫≠n d·ª•ng</li>
        <li><i class="fa-solid fa-brain text-orange-500 mr-2"></i> C√≥ gi·∫£i th√≠ch chi ti·∫øt sau m·ªói c√¢u</li>
      </ul>
    </div>

    <!-- Settings -->
    <div class="bg-white rounded-xl p-5 mb-6 text-left shadow-sm border border-slate-100">
      <div class="font-bold text-slate-800 mb-3 flex items-center">
        <i class="fa-solid fa-sliders mr-2 text-slate-500"></i> Tu·ª≥ ch·ªçn khi l√†m b√†i
      </div>
      <label class="flex items-center gap-3 mb-3 cursor-pointer select-none">
        <input id="toggle-shuffle-options" type="checkbox" class="w-5 h-5" checked />
        <span class="text-slate-700">Random th·ª© t·ª± ƒë√°p √°n (A/B/C/D)</span>
      </label>
      <label class="flex items-center gap-3 cursor-pointer select-none">
        <input id="toggle-shuffle-questions" type="checkbox" class="w-5 h-5" />
        <span class="text-slate-700">Random th·ª© t·ª± c√¢u h·ªèi</span>
      </label>
      <p class="text-xs text-slate-400 mt-2">
        (Em ƒë√£ ch·ªânh b·ªô d·ªØ li·ªáu ƒë·ªÉ ƒë√°p √°n A/B/C/D chia ƒë·ªÅu 5-5-5-5 khi <b>t·∫Øt</b> random ƒë√°p √°n.)
      </p>
    </div>

    <button onclick="game.start()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg transform transition hover:scale-105 w-full md:w-auto text-xl">
      <i class="fa-solid fa-play mr-2"></i> B·∫Øt ƒê·∫ßu Ngay
    </button>
    <p class="mt-4 text-sm text-slate-400">Thi·∫øt k·∫ø b·ªüi C√¥ Thu B√¨nh To√°n</p>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="hidden w-full max-w-3xl">
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center bg-white px-4 py-2 rounded-lg shadow-sm">
        <span class="text-slate-500 mr-2">C√¢u:</span>
        <span id="q-current" class="font-bold text-blue-600 text-xl">1</span>
        <span class="text-slate-400 mx-1">/</span>
        <span id="q-total" class="text-slate-500">20</span>
      </div>
      <div class="flex items-center bg-white px-4 py-2 rounded-lg shadow-sm">
        <span class="text-slate-500 mr-2">ƒêi·ªÉm:</span>
        <span id="score" class="font-bold text-green-600 text-xl">0</span>
      </div>
    </div>

    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
      <div id="progress" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
    </div>

    <div class="card p-6 md:p-8 relative overflow-hidden">
      <div class="mb-2">
        <span id="q-level" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-600 mb-2">NH·∫¨N BI·∫æT</span>
      </div>
      <h2 id="q-text" class="text-xl md:text-2xl font-bold text-slate-800 mb-6 leading-relaxed"></h2>

      <div id="options-container" class="grid grid-cols-1 gap-4"></div>

      <div id="feedback-area" class="hidden mt-6 p-4 rounded-xl border-l-4">
        <div class="flex items-start">
          <div id="feedback-icon" class="text-2xl mr-3 mt-1"></div>
          <div>
            <h4 id="feedback-title" class="font-bold text-lg mb-1"></h4>
            <p id="feedback-text" class="text-slate-700"></p>
          </div>
        </div>
        <button onclick="game.nextQuestion()" id="btn-next" class="mt-4 bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700 transition float-right">
          C√¢u ti·∫øp theo <i class="fa-solid fa-arrow-right ml-2"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- End Screen -->
  <div id="end-screen" class="hidden card max-w-xl w-full p-8 text-center slide-up">
    <div class="mb-6">
      <div id="final-emoji" class="text-6xl mb-4">üèÜ</div>
      <h2 class="text-3xl font-bold text-slate-800 mb-2">Ho√†n Th√†nh!</h2>
      <p class="text-slate-500">Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i ki·ªÉm tra.</p>
    </div>

    <div class="bg-gradient-to-r from-blue-500 to-cyan-400 rounded-2xl p-8 mb-8 text-white shadow-lg">
      <div class="text-sm opacity-90 uppercase tracking-wider mb-1">T·ªïng ƒëi·ªÉm c·ªßa b·∫°n</div>
      <div class="text-6xl font-black mb-2"><span id="final-score">0</span><span class="text-2xl font-normal opacity-70">/200</span></div>
      <div id="final-message" class="font-semibold text-lg bg-white/20 inline-block px-4 py-1 rounded-full">Xu·∫•t s·∫Øc!</div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-8">
      <div class="bg-gray-50 p-4 rounded-xl">
        <div class="text-gray-400 text-xs uppercase">Ch√≠nh x√°c</div>
        <div id="final-correct" class="text-2xl font-bold text-green-500">0</div>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl">
        <div class="text-gray-400 text-xs uppercase">T·ªâ l·ªá</div>
        <div id="final-percent" class="text-2xl font-bold text-blue-500">0%</div>
      </div>
    </div>

    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl w-full transition">
      <i class="fa-solid fa-rotate-right mr-2"></i> L√†m l·∫°i b√†i
    </button>
  </div>

  <script>
    // =========================
    // 1) QUESTIONS (ƒê√É CHIA ƒê·ªÄU A/B/C/D 5-5-5-5 khi KH√îNG random ƒë√°p √°n)
    // =========================
    const questions = [
      // NH·∫¨N BI·∫æT (7)
      {
        text: "H√¨nh tr·ª• ƒë∆∞·ª£c t·∫°o th√†nh khi quay h√¨nh n√†o sau ƒë√¢y m·ªôt v√≤ng quanh m·ªôt c·∫°nh c·ªë ƒë·ªãnh?",
        options: ["H√¨nh ch·ªØ nh·∫≠t", "H√¨nh tam gi√°c vu√¥ng", "H√¨nh b√°n nguy·ªát", "H√¨nh thang c√¢n"],
        correct: 0, // A
        level: "NH·∫¨N BI·∫æT",
        rationale: "Khi quay m·ªôt h√¨nh ch·ªØ nh·∫≠t m·ªôt v√≤ng quanh m·ªôt c·∫°nh c·ªë ƒë·ªãnh c·ªßa n√≥, ta ƒë∆∞·ª£c m·ªôt h√¨nh tr·ª•."
      },
      {
        text: "C√¥ng th·ª©c t√≠nh di·ªán t√≠ch xung quanh \\(S_{xq}\\) c·ªßa h√¨nh tr·ª• c√≥ b√°n k√≠nh ƒë√°y \\(r\\) v√† chi·ªÅu cao \\(h\\) l√†:",
        options: ["\\(S_{xq} = \\pi r h\\)", "\\(S_{xq} = 2\\pi r h\\)", "\\(S_{xq} = \\pi r^2 h\\)", "\\(S_{xq} = 4\\pi r h\\)"],
        correct: 1, // B
        level: "NH·∫¨N BI·∫æT",
        rationale: "Di·ªán t√≠ch xung quanh c·ªßa h√¨nh tr·ª• b·∫±ng chu vi ƒë√°y nh√¢n v·ªõi chi·ªÅu cao: \\(S_{xq} = 2\\pi r h\\)."
      },
      {
        text: "Trong h√¨nh tr·ª•, kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒë√∫ng v·ªÅ m·ªëi quan h·ªá gi·ªØa chi·ªÅu cao \\(h\\) v√† ƒë∆∞·ªùng sinh \\(l\\)?",
        options: ["\\(h > l\\)", "\\(h < l\\)", "\\(h = l\\)", "\\(h = 2l\\)"],
        correct: 2, // C
        level: "NH·∫¨N BI·∫æT",
        rationale: "Trong h√¨nh tr·ª•, ƒë∆∞·ªùng sinh vu√¥ng g√≥c v·ªõi ƒë√°y n√™n ƒë·ªô d√†i ƒë∆∞·ªùng sinh \\(l\\) b·∫±ng chi·ªÅu cao \\(h\\)."
      },
      {
        text: "C·∫Øt h√¨nh tr·ª• b·ªüi m·ªôt m·∫∑t ph·∫≥ng song song v·ªõi ƒë√°y, thi·∫øt di·ªán thu ƒë∆∞·ª£c l√† h√¨nh g√¨?",
        options: ["H√¨nh ch·ªØ nh·∫≠t", "H√¨nh elip", "H√¨nh tam gi√°c", "H√¨nh tr√≤n"],
        correct: 3, // D
        level: "NH·∫¨N BI·∫æT",
        rationale: "M·∫∑t ph·∫≥ng song song v·ªõi ƒë√°y s·∫Ω c·∫Øt c√°c m·∫∑t xung quanh t·∫°o th√†nh m·ªôt h√¨nh tr√≤n b·∫±ng v·ªõi h√¨nh tr√≤n ƒë√°y."
      },
      {
        text: "C√¥ng th·ª©c t√≠nh th·ªÉ t√≠ch \\(V\\) c·ªßa h√¨nh tr·ª• l√†:",
        options: ["\\(V = \\pi r^2 h\\)", "\\(V = 2\\pi r h\\)", "\\(V = \\frac{1}{3}\\pi r^2 h\\)", "\\(V = 2\\pi r^2\\)"],
        correct: 0, // A
        level: "NH·∫¨N BI·∫æT",
        rationale: "Th·ªÉ t√≠ch h√¨nh tr·ª• b·∫±ng di·ªán t√≠ch ƒë√°y nh√¢n v·ªõi chi·ªÅu cao: \\(V = \\pi r^2 h\\)."
      },
      {
        text: "H√¨nh tr·ª• c√≥ bao nhi√™u m·∫∑t ƒë√°y?",
        options: ["1 m·∫∑t", "2 m·∫∑t", "3 m·∫∑t", "Kh√¥ng c√≥ m·∫∑t ƒë√°y"],
        correct: 1, // B
        level: "NH·∫¨N BI·∫æT",
        rationale: "H√¨nh tr·ª• c√≥ 2 m·∫∑t ƒë√°y l√† hai h√¨nh tr√≤n b·∫±ng nhau v√† n·∫±m tr√™n hai m·∫∑t ph·∫≥ng song song."
      },
      {
        text: "N·∫øu c·∫Øt m·∫∑t xung quanh c·ªßa h√¨nh tr·ª• d·ªçc theo m·ªôt ƒë∆∞·ªùng sinh v√† tr·∫£i ph·∫≥ng ra, ta ƒë∆∞·ª£c h√¨nh g√¨?",
        options: ["H√¨nh tr√≤n", "H√¨nh thang", "H√¨nh ch·ªØ nh·∫≠t", "H√¨nh tam gi√°c"],
        correct: 2, // C
        level: "NH·∫¨N BI·∫æT",
        rationale: "Khai tri·ªÉn m·∫∑t xung quanh c·ªßa h√¨nh tr·ª• ta ƒë∆∞·ª£c h√¨nh ch·ªØ nh·∫≠t c√≥ m·ªôt c·∫°nh b·∫±ng chu vi ƒë√°y, c·∫°nh kia b·∫±ng chi·ªÅu cao."
      },

      // TH√îNG HI·ªÇU (8)
      {
        text: "M·ªôt h√¨nh tr·ª• c√≥ b√°n k√≠nh ƒë√°y \\(r = 3\\) cm v√† chi·ªÅu cao \\(h = 5\\) cm. Di·ªán t√≠ch xung quanh c·ªßa h√¨nh tr·ª• l√†:",
        options: ["\\(15\\pi\\) cm¬≤", "\\(45\\pi\\) cm¬≤", "\\(90\\pi\\) cm¬≤", "\\(30\\pi\\) cm¬≤"],
        correct: 3, // D
        level: "TH√îNG HI·ªÇU",
        rationale: "√Åp d·ª•ng \\(S_{xq} = 2\\pi r h = 2\\pi\\cdot3\\cdot5 = 30\\pi\\) cm¬≤."
      },
      {
        text: "T√≠nh th·ªÉ t√≠ch h√¨nh tr·ª• c√≥ ƒë∆∞·ªùng k√≠nh ƒë√°y \\(d = 8\\) cm v√† chi·ªÅu cao \\(h = 10\\) cm.",
        options: ["\\(160\\pi\\) cm¬≥", "\\(640\\pi\\) cm¬≥", "\\(80\\pi\\) cm¬≥", "\\(40\\pi\\) cm¬≥"],
        correct: 0, // A
        level: "TH√îNG HI·ªÇU",
        rationale: "B√°n k√≠nh \\(r=4\\). \\(V=\\pi r^2 h=\\pi\\cdot16\\cdot10=160\\pi\\) cm¬≥."
      },
      {
        text: "M·ªôt h√¨nh tr·ª• c√≥ th·ªÉ t√≠ch \\(V = 100\\pi\\) cm¬≥ v√† chi·ªÅu cao \\(h = 4\\) cm. B√°n k√≠nh ƒë√°y c·ªßa h√¨nh tr·ª• l√†:",
        options: ["25 cm", "5 cm", "10 cm", "2.5 cm"],
        correct: 1, // B
        level: "TH√îNG HI·ªÇU",
        rationale: "\\(100\\pi=\\pi r^2\\cdot4\\Rightarrow r^2=25\\Rightarrow r=5\\) cm."
      },
      {
        text: "Thi·∫øt di·ªán qua tr·ª•c c·ªßa m·ªôt h√¨nh tr·ª• l√† h√¨nh vu√¥ng c√≥ c·∫°nh b·∫±ng \\(6\\) cm. T√≠nh di·ªán t√≠ch xung quanh c·ªßa h√¨nh tr·ª• ƒë√≥.",
        options: ["\\(18\\pi\\) cm¬≤", "\\(72\\pi\\) cm¬≤", "\\(36\\pi\\) cm¬≤", "\\(9\\pi\\) cm¬≤"],
        correct: 2, // C
        level: "TH√îNG HI·ªÇU",
        rationale: "Thi·∫øt di·ªán qua tr·ª•c l√† h√¨nh vu√¥ng c·∫°nh 6 \\(\\Rightarrow h=6\\), \\(2r=6\\Rightarrow r=3\\). \\(S_{xq}=2\\pi r h=36\\pi\\)."
      },
      {
        text: "N·∫øu gi·ªØ nguy√™n b√°n k√≠nh ƒë√°y v√† tƒÉng chi·ªÅu cao c·ªßa h√¨nh tr·ª• l√™n 2 l·∫ßn th√¨ th·ªÉ t√≠ch h√¨nh tr·ª• s·∫Ω:",
        options: ["TƒÉng 4 l·∫ßn", "Gi·ªØ nguy√™n", "Gi·∫£m 2 l·∫ßn", "TƒÉng 2 l·∫ßn"],
        correct: 3, // D
        level: "TH√îNG HI·ªÇU",
        rationale: "\\(V=\\pi r^2 h\\) t·ªâ l·ªá thu·∫≠n v·ªõi \\(h\\). \\(h\\) tƒÉng 2 l·∫ßn ‚áí \\(V\\) tƒÉng 2 l·∫ßn."
      },
      {
        text: "N·∫øu gi·ªØ nguy√™n chi·ªÅu cao v√† tƒÉng b√°n k√≠nh ƒë√°y c·ªßa h√¨nh tr·ª• l√™n 2 l·∫ßn th√¨ th·ªÉ t√≠ch h√¨nh tr·ª• s·∫Ω:",
        options: ["TƒÉng 4 l·∫ßn", "TƒÉng 2 l·∫ßn", "TƒÉng 8 l·∫ßn", "Kh√¥ng ƒë·ªïi"],
        correct: 0, // A
        level: "TH√îNG HI·ªÇU",
        rationale: "\\(V=\\pi r^2 h\\). N·∫øu \\(r\\) tƒÉng 2 l·∫ßn ‚áí \\(r^2\\) tƒÉng 4 l·∫ßn ‚áí \\(V\\) tƒÉng 4 l·∫ßn."
      },
      {
        text: "M·ªôt h√¨nh tr·ª• c√≥ chu vi ƒë√°y l√† \\(20\\pi\\) cm v√† di·ªán t√≠ch xung quanh l√† \\(400\\pi\\) cm¬≤. Chi·ªÅu cao c·ªßa h√¨nh tr·ª• l√†:",
        options: ["10 cm", "20 cm", "40 cm", "5 cm"],
        correct: 1, // B
        level: "TH√îNG HI·ªÇU",
        rationale: "\\(S_{xq}=C\\cdot h\\Rightarrow 400\\pi=20\\pi\\cdot h\\Rightarrow h=20\\) cm."
      },
      {
        text: "Di·ªán t√≠ch to√†n ph·∫ßn c·ªßa h√¨nh tr·ª• c√≥ \\(r = 2\\) cm v√† \\(h = 5\\) cm l√†:",
        options: ["\\(20\\pi\\) cm¬≤", "\\(24\\pi\\) cm¬≤", "\\(28\\pi\\) cm¬≤", "\\(40\\pi\\) cm¬≤"],
        correct: 2, // C
        level: "TH√îNG HI·ªÇU",
        rationale: "\\(S_{tp}=2\\pi r h+2\\pi r^2=20\\pi+8\\pi=28\\pi\\)."
      },

      // V·∫¨N D·ª§NG (3)
      {
        text: "M·ªôt th√πng n∆∞·ªõc h√¨nh tr·ª• c√≥ ƒë∆∞·ªùng k√≠nh ƒë√°y 1m, chi·ªÅu cao 1,5m. Th√πng n√†y ch·ª©a ƒë∆∞·ª£c t·ªëi ƒëa bao nhi√™u l√≠t n∆∞·ªõc? (L·∫•y \\(\\pi \\approx 3,14\\))",
        options: ["4710 l√≠t", "1500 l√≠t", "3532,5 l√≠t", "1177,5 l√≠t"],
        correct: 3, // D
        level: "V·∫¨N D·ª§NG",
        rationale: "\\(r=0,5\\)m. \\(V\\approx 3,14\\cdot(0,5)^2\\cdot1,5=1,1775\\) m¬≥ = 1177,5 l√≠t."
      },
      {
        text: "M·ªôt c√°i tr·ª•c lƒÉn s∆°n c√≥ d·∫°ng h√¨nh tr·ª• v·ªõi ƒë∆∞·ªùng k√≠nh 8cm v√† chi·ªÅu d√†i 25cm. Sau khi lƒÉn tr·ªçn v·∫πn 10 v√≤ng th√¨ di·ªán t√≠ch b·ªÅ m·∫∑t ƒë∆∞·ª£c s∆°n l√† bao nhi√™u? (L·∫•y \\(\\pi \\approx 3,14\\))",
        options: ["6280 cm¬≤", "3140 cm¬≤", "12560 cm¬≤", "5024 cm¬≤"],
        correct: 0, // A
        level: "V·∫¨N D·ª§NG",
        rationale: "Di·ªán t√≠ch 1 v√≤ng: \\(S=\\pi d h=3,14\\cdot8\\cdot25=628\\) cm¬≤. 10 v√≤ng: \\(6280\\) cm¬≤."
      },
      {
        text: "Ng∆∞·ªùi ta c·∫ßn l√†m m·ªôt lon s·ªØa b√≤ h√¨nh tr·ª• b·∫±ng kim lo·∫°i c√≥ th·ªÉ t√≠ch \\(314\\) ml (cm¬≥) v√† b√°n k√≠nh ƒë√°y \\(5\\) cm. Chi·ªÅu cao c·ªßa lon s·ªØa x·∫•p x·ªâ b·∫±ng: (L·∫•y \\(\\pi \\approx 3,14\\))",
        options: ["8 cm", "4 cm", "10 cm", "6 cm"],
        correct: 1, // B
        level: "V·∫¨N D·ª§NG",
        rationale: "\\(314=3,14\\cdot25\\cdot h\\Rightarrow 314=78,5h\\Rightarrow h=4\\) cm."
      },

      // V·∫¨N D·ª§NG CAO (2)
      {
        text: "Cho h√¨nh ch·ªØ nh·∫≠t ABCD c√≥ \\(AB = 3\\), \\(AD = 4\\). Quay h√¨nh ch·ªØ nh·∫≠t n√†y quanh c·∫°nh AD ta ƒë∆∞·ª£c h√¨nh tr·ª• (T1), quay quanh c·∫°nh AB ta ƒë∆∞·ª£c h√¨nh tr·ª• (T2). T·ªâ s·ªë th·ªÉ t√≠ch \\(\\frac{V_{T1}}{V_{T2}}\\) l√†:",
        options: ["\\(\\frac{4}{3}\\)", "\\(\\frac{9}{16}\\)", "\\(\\frac{3}{4}\\)", "\\(1\\)"],
        correct: 2, // C
        level: "V·∫¨N D·ª§NG CAO",
        rationale: "(T1): quay quanh AD ‚áí \\(h=4\\), \\(r_1=3\\) ‚áí \\(V_1=\\pi\\cdot3^2\\cdot4=36\\pi\\).<br>(T2): quay quanh AB ‚áí \\(h=3\\), \\(r_2=4\\) ‚áí \\(V_2=\\pi\\cdot4^2\\cdot3=48\\pi\\).<br>\\(\\frac{V_1}{V_2}=\\frac{36\\pi}{48\\pi}=\\frac{3}{4}\\)."
      },
      {
        text: "M·ªôt ·ªëng c·ªëng h√¨nh tr·ª• r·ªóng c√≥ chi·ªÅu d√†i 2m, ƒë∆∞·ªùng k√≠nh ngo√†i 1m, ƒë·ªô d√†y th√†nh ·ªëng l√† 10cm. T√≠nh th·ªÉ t√≠ch b√™ t√¥ng c·∫ßn d√πng ƒë·ªÉ ƒë√∫c ·ªëng c·ªëng ƒë√≥. (L·∫•y \\(\\pi \\approx 3,14\\))",
        options: ["1,5700 m¬≥", "0,2826 m¬≥", "0,4522 m¬≥", "0,5652 m¬≥"],
        correct: 3, // D
        level: "V·∫¨N D·ª§NG CAO",
        rationale: "B√°n k√≠nh ngo√†i \\(R=0,5\\)m. B√°n k√≠nh trong \\(r=0,4\\)m.<br>\\(V=\\pi h(R^2-r^2)\\approx 3,14\\cdot2\\cdot(0,25-0,16)=6,28\\cdot0,09=0,5652\\) m¬≥."
      }
    ];

    // =========================
    // 2) HELPERS
    // =========================
    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function safeTypeset(targets) {
      if (!window.MathJax || !MathJax.typesetPromise) return;
      MathJax.typesetPromise(targets ? targets : undefined).catch(() => {});
    }

    // T·∫°o phi√™n b·∫£n c√¢u h·ªèi c√≥ th·ªÉ shuffle ƒë√°p √°n m√† v·∫´n gi·ªØ ƒë√∫ng correct
    function buildQuestionForPlay(q, shuffleOptions) {
      if (!shuffleOptions) {
        return {
          ...q,
          _optionMap: q.options.map((_, idx) => idx), // map hi·ªÉn th·ªã -> g·ªëc
        };
      }

      const idxs = [0,1,2,3];
      shuffleInPlace(idxs);

      const newOptions = idxs.map(i => q.options[i]);
      const newCorrect = idxs.indexOf(q.correct);

      return {
        ...q,
        options: newOptions,
        correct: newCorrect,
        _optionMap: idxs
      };
    }

    // =========================
    // 3) GAME LOGIC
    // =========================
    const game = {
      currentQuestionIndex: 0,
      score: 0,
      isAnswering: false,
      audioContext: null,
      questionOrder: [],
      settings: {
        shuffleOptions: true,
        shuffleQuestions: false
      },
      currentQ: null,

      init: function() {
        document.body.addEventListener('click', () => {
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
        }, { once: true });

        document.getElementById('q-total').innerText = questions.length;
      },

      start: function() {
        // Read settings from toggles
        this.settings.shuffleOptions = document.getElementById('toggle-shuffle-options').checked;
        this.settings.shuffleQuestions = document.getElementById('toggle-shuffle-questions').checked;

        // Build order
        this.questionOrder = Array.from({ length: questions.length }, (_, i) => i);
        if (this.settings.shuffleQuestions) shuffleInPlace(this.questionOrder);

        // Reset state
        this.currentQuestionIndex = 0;
        this.score = 0;

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('game-screen').classList.add('slide-up');

        this.showQuestion();
      },

      playSound: function(type) {
        if (!this.audioContext) return;

        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);

        if (type === 'correct') {
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(1200, this.audioContext.currentTime + 0.1);
          gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
          oscillator.start();
          oscillator.stop(this.audioContext.currentTime + 0.5);
        } else {
          oscillator.type = 'sawtooth';
          oscillator.frequency.setValueAtTime(150, this.audioContext.currentTime);
          oscillator.frequency.linearRampToValueAtTime(100, this.audioContext.currentTime + 0.3);
          gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
          oscillator.start();
          oscillator.stop(this.audioContext.currentTime + 0.3);
        }
      },

      showQuestion: function() {
        this.isAnswering = true;

        const qIndex = this.questionOrder[this.currentQuestionIndex];
        const baseQ = questions[qIndex];
        const q = buildQuestionForPlay(baseQ, this.settings.shuffleOptions);
        this.currentQ = q;

        // UI: header + progress (S·ª¨A: l√™n ƒë√∫ng 100%)
        document.getElementById('q-current').innerText = this.currentQuestionIndex + 1;
        document.getElementById('score').innerText = this.score;

        const progressPercent = ((this.currentQuestionIndex + 1) / questions.length) * 100;
        document.getElementById('progress').style.width = `${progressPercent}%`;

        // Question content
        document.getElementById('q-level').innerText = q.level;
        const qText = document.getElementById('q-text');
        qText.innerHTML = q.text;

        // Reset feedback + options
        const fbArea = document.getElementById('feedback-area');
        fbArea.classList.add('hidden');

        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';

        // Render options
        q.options.forEach((opt, index) => {
          const btn = document.createElement('button');
          btn.className = 'btn-option w-full text-left p-4 rounded-xl text-lg font-medium text-slate-700 bg-white shadow-sm';
          btn.innerHTML = `<span class="inline-block w-8 h-8 rounded-full bg-slate-100 text-slate-500 text-center leading-8 mr-3 text-sm font-bold">${String.fromCharCode(65 + index)}</span> ${opt}`;
          btn.onclick = () => this.checkAnswer(index, btn);
          optionsContainer.appendChild(btn);
        });

        safeTypeset();
      },

      checkAnswer: function(selectedIndex, btnElement) {
        if (!this.isAnswering) return;
        this.isAnswering = false;

        const q = this.currentQ;
        const isCorrect = selectedIndex === q.correct;
        const options = document.getElementById('options-container').children;

        Array.from(options).forEach(btn => btn.disabled = true);

        if (isCorrect) {
          btnElement.classList.add('correct');
          this.score += 10;
          this.playSound('correct');
          fireConfetti();
        } else {
          btnElement.classList.add('incorrect');
          options[q.correct].classList.add('correct');
          this.playSound('wrong');
        }

        this.showFeedback(isCorrect, q.rationale);
        document.getElementById('score').innerText = this.score;
      },

      showFeedback: function(isCorrect, rationale) {
        const fbArea = document.getElementById('feedback-area');
        const fbIcon = document.getElementById('feedback-icon');
        const fbTitle = document.getElementById('feedback-title');
        const fbText = document.getElementById('feedback-text');
        const btnNext = document.getElementById('btn-next');

        fbArea.classList.remove('hidden', 'bg-green-50', 'border-green-500', 'bg-red-50', 'border-red-500');

        if (isCorrect) {
          fbArea.classList.add('bg-green-50', 'border-green-500');
          fbIcon.innerHTML = '<i class="fa-solid fa-face-laugh-beam text-green-500 bounce"></i>';
          fbTitle.innerText = "Ch√≠nh x√°c! L√†m t·ªët l·∫Øm!";
          fbTitle.className = "font-bold text-lg mb-1 text-green-700";
        } else {
          fbArea.classList.add('bg-red-50', 'border-red-500');
          fbIcon.innerHTML = '<i class="fa-solid fa-face-frown-open text-red-500"></i>';
          fbTitle.innerText = "Ti·∫øc qu√°, ch∆∞a ƒë√∫ng r·ªìi!";
          fbTitle.className = "font-bold text-lg mb-1 text-red-700";
        }

        fbText.innerHTML = rationale;
        fbArea.classList.add('fade-in');

        // Button label
        if (this.currentQuestionIndex === questions.length - 1) {
          btnNext.innerHTML = 'Xem k·∫øt qu·∫£ <i class="fa-solid fa-trophy ml-2"></i>';
        } else {
          btnNext.innerHTML = 'C√¢u ti·∫øp theo <i class="fa-solid fa-arrow-right ml-2"></i>';
        }

        safeTypeset([fbArea]);
      },

      nextQuestion: function() {
        if (this.currentQuestionIndex < questions.length - 1) {
          this.currentQuestionIndex++;
          this.showQuestion();
        } else {
          this.endGame();
        }
      },

      endGame: function() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');

        const finalScore = this.score;
        const totalScore = questions.length * 10;
        const percent = (finalScore / totalScore) * 100;

        document.getElementById('final-score').innerText = finalScore;
        document.getElementById('final-correct').innerText = (finalScore / 10) + "/" + questions.length;
        document.getElementById('final-percent').innerText = Math.round(percent) + "%";

        let message = "";
        let emoji = "";

        if (percent >= 90) {
          message = "Xu·∫•t s·∫Øc! C√¥ r·∫•t t·ª± h√†o v·ªÅ em!";
          emoji = "üëë";
          fireConfetti();
        } else if (percent >= 70) {
          message = "Gi·ªèi l·∫Øm! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©!";
          emoji = "üåü";
        } else if (percent >= 50) {
          message = "Kh√° t·ªët! Em ƒë√£ n·∫Øm ƒë∆∞·ª£c ki·∫øn th·ª©c c∆° b·∫£n.";
          emoji = "üëç";
        } else {
          message = "C·∫ßn √¥n t·∫≠p th√™m nh√©. ƒê·ª´ng n·∫£n ch√≠!";
          emoji = "üìö";
        }

        document.getElementById('final-message').innerText = message;
        document.getElementById('final-emoji').innerText = emoji;
      }
    };

    // =========================
    // 4) CONFETTI
    // =========================
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let confetti = [];
    let isAnimating = false;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function fireConfetti() {
      const colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6'];
      for (let i = 0; i < 100; i++) {
        confetti.push({
          x: Math.random() * canvas.width,
          y: -10,
          w: Math.random() * 10 + 5,
          h: Math.random() * 5 + 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 2 + 2,
          vx: Math.random() * 2 - 1,
          rot: Math.random() * 360,
          rotSpeed: Math.random() * 10 - 5
        });
      }
      if (!isAnimating) {
        isAnimating = true;
        animateConfetti();
      }
    }

    function animateConfetti() {
      if (confetti.length === 0) {
        isAnimating = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < confetti.length; i++) {
        const c = confetti[i];
        c.y += c.vy;
        c.x += c.vx;
        c.rot += c.rotSpeed;

        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate(c.rot * Math.PI / 180);
        ctx.fillStyle = c.color;
        ctx.fillRect(-c.w / 2, -c.h / 2, c.w, c.h);
        ctx.restore();

        if (c.y > canvas.height) {
          confetti.splice(i, 1);
          i--;
        }
      }
      requestAnimationFrame(animateConfetti);
    }

    // Initialize
    game.init();
  </script>
</body>
</html>
