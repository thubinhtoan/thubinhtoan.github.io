<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mật Mã Vi-ét: Truy Tìm Kho Báu - Cô Thu Bình Toán</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@400;700&display=swap');

    body {
      font-family: 'Lato', sans-serif;
      background-color: #2c241b;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233e3226' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      min-height: 100vh;
      color: #eaddcf;
      overflow-x: hidden;
    }

    .serif-font { font-family: 'Crimson Text', serif; }

    .parchment-card {
      background: #fdfbf7;
      background-image: linear-gradient(to bottom right, #fdfbf7 0%, #f4ecd8 100%);
      border: 8px solid #5d4037;
      border-radius: 8px;
      box-shadow:
        0 0 0 2px #3e2723,
        0 10px 20px rgba(0,0,0,0.5),
        inset 0 0 60px rgba(93, 64, 55, 0.1);
      color: #3e2723;
      position: relative;
    }

    .parchment-card::before {
      content: '';
      position: absolute;
      top: 4px; left: 4px; right: 4px; bottom: 4px;
      border: 2px solid #8d6e63;
      pointer-events: none;
    }

    .btn-choice {
      background: #fff;
      border: 2px solid #8d6e63;
      color: #3e2723;
      transition: all 0.2s ease;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-choice:hover:not(:disabled) {
      background: #efebe9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-color: #5d4037;
    }

    .btn-choice.correct {
      background: #dcedc8 !important;
      border-color: #33691e !important;
      color: #1b5e20 !important;
    }

    .btn-choice.incorrect {
      background: #ffcdd2 !important;
      border-color: #b71c1c !important;
      color: #b71c1c !important;
    }

    .wax-seal {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle at 30% 30%, #d32f2f, #b71c1c);
      border-radius: 50%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.8);
      font-size: 2rem;
      border: 4px double rgba(0,0,0,0.2);
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .progress-bar-container {
      background: #d7ccc8;
      border-radius: 10px;
      height: 10px;
      border: 1px solid #a1887f;
      overflow: hidden;
    }

    .progress-bar-fill {
      background: linear-gradient(90deg, #8d6e63, #5d4037);
      height: 100%;
      transition: width 0.5s ease;
    }

    #confetti-canvas {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <canvas id="confetti-canvas"></canvas>

  <!-- START SCREEN -->
  <div id="start-screen" class="parchment-card max-w-2xl w-full p-10 pt-16 text-center fade-in">
    <div class="wax-seal"><i class="fa-solid fa-key"></i></div>

    <h1 class="text-4xl md:text-5xl font-bold mb-2 serif-font text-[#3e2723]">Mật Mã Vi-ét</h1>
    <h2 class="text-xl text-[#5d4037] mb-6 italic serif-font">Truy Tìm Kho Báu Số Học</h2>

    <div class="mb-8 text-left bg-[#efebe9] p-6 rounded border border-[#d7ccc8]">
      <p class="mb-2"><i class="fa-solid fa-scroll text-[#795548] mr-2"></i> <strong>Nhiệm vụ:</strong> Giải mã 20 câu đố về Định lí Vi-ét.</p>
      <p class="mb-2"><i class="fa-solid fa-layer-group text-[#795548] mr-2"></i> <strong>Cấp độ:</strong> Từ Nhận biết đến Vận dụng cao.</p>
      <p><i class="fa-solid fa-lightbulb text-[#795548] mr-2"></i> <strong>Gợi ý:</strong> Sử dụng công thức tổng và tích nghiệm để tìm chìa khóa.</p>
    </div>

    <button onclick="game.start()" class="bg-[#5d4037] hover:bg-[#4e342e] text-[#fdfbf7] font-bold py-3 px-8 rounded shadow-lg transform transition hover:scale-105 uppercase tracking-widest border-2 border-[#3e2723]">
      <i class="fa-solid fa-compass mr-2"></i> Bắt Đầu Hành Trình
    </button>
    <div class="mt-4 text-xs text-[#8d6e63]">Thiết kế bởi Cô Thu Bình Toán</div>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen" class="hidden w-full max-w-4xl parchment-card p-8 pt-12 fade-in">
    <div class="flex justify-between items-end mb-4 border-b border-[#a1887f] pb-2">
      <div>
        <span class="text-xs uppercase font-bold text-[#8d6e63]">Câu hỏi</span>
        <div class="text-2xl font-bold serif-font"><span id="q-curr">1</span><span class="text-lg text-[#a1887f]">/20</span></div>
      </div>
      <div class="text-right">
        <span class="text-xs uppercase font-bold text-[#8d6e63]">Điểm số</span>
        <div id="score" class="text-2xl font-bold serif-font text-[#5d4037]">0</div>
      </div>
    </div>

    <div class="progress-bar-container mb-8">
      <div id="progress-bar" class="progress-bar-fill" style="width: 0%"></div>
    </div>

    <div class="relative">
      <span id="level-badge" class="absolute right-0 -top-16 bg-[#5d4037] text-[#fdfbf7] text-xs px-3 py-1 rounded shadow">NHẬN BIẾT</span>

      <h2 id="q-text" class="text-xl md:text-2xl font-medium text-[#3e2723] mb-8 leading-relaxed serif-font"></h2>

      <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

      <div id="rationale-box" class="hidden mt-6 bg-[#efebe9] p-5 rounded border-l-4 border-[#5d4037] fade-in">
        <div class="flex items-start gap-4">
          <div id="rat-icon" class="text-2xl mt-1 text-[#5d4037]"></div>
          <div>
            <h4 id="rat-title" class="font-bold text-lg mb-1 serif-font"></h4>
            <div id="rat-content" class="text-[#4e342e] leading-relaxed"></div>
          </div>
        </div>
        <div class="mt-4 text-right">
          <button onclick="game.next()" class="text-[#5d4037] font-bold hover:text-[#3e2723] transition flex items-center justify-end ml-auto">
            Tiếp tục <i class="fa-solid fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="end-screen" class="hidden parchment-card max-w-lg w-full p-10 text-center fade-in">
    <div class="text-6xl text-[#ffb300] mb-4 drop-shadow-md"><i class="fa-solid fa-trophy"></i></div>
    <h2 class="text-3xl font-bold text-[#3e2723] mb-2 serif-font">Hoàn Thành Nhiệm Vụ!</h2>
    <p class="text-[#5d4037] mb-8">Bạn đã giải mã thành công bí ẩn của Định lí Vi-ét.</p>

    <div class="bg-[#efebe9] p-4 rounded mb-8 border border-[#d7ccc8]">
      <div class="grid grid-cols-2 divide-x divide-[#d7ccc8]">
        <div>
          <div class="text-xs uppercase text-[#8d6e63] font-bold">Tổng Điểm</div>
          <div id="final-score" class="text-3xl font-bold text-[#3e2723] serif-font">0</div>
        </div>
        <div>
          <div class="text-xs uppercase text-[#8d6e63] font-bold">Chính Xác</div>
          <div id="final-acc" class="text-3xl font-bold text-[#3e2723] serif-font">0%</div>
        </div>
      </div>
    </div>

    <div id="final-msg" class="mb-8 font-serif italic text-[#4e342e] text-lg"></div>

    <button onclick="location.reload()" class="w-full bg-[#5d4037] hover:bg-[#4e342e] text-[#fdfbf7] font-bold py-3 rounded shadow-lg transition">
      <i class="fa-solid fa-rotate-left mr-2"></i> Chơi Lại
    </button>
  </div>

  <script>
    // ===== Helpers: shuffle + balanced correct letters =====
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function buildBalancedTargets(n) {
      // 20 câu => mỗi vị trí 0..3 (A..D) đúng 5 lần
      const base = [];
      const per = Math.floor(n / 4);
      for (let k = 0; k < 4; k++) for (let i = 0; i < per; i++) base.push(k);
      while (base.length < n) base.push(Math.floor(Math.random() * 4));
      return shuffleArray(base);
    }

    function buildSessionOrders(questions) {
      const targets = buildBalancedTargets(questions.length);
      return questions.map((q, idx) => {
        const correctText = q.options[q.correct];
        const wrongs = q.options.filter((_, i) => i !== q.correct);
        const wrongsShuffled = shuffleArray(wrongs);

        const targetPos = targets[idx];
        const finalOptions = new Array(4);
        finalOptions[targetPos] = correctText;

        let w = 0;
        for (let i = 0; i < 4; i++) {
          if (i === targetPos) continue;
          finalOptions[i] = wrongsShuffled[w++];
        }
        return { options: finalOptions, correct: targetPos };
      });
    }

    // ===== Questions Data (fixed 1 câu VDC để có đáp án duy nhất) =====
    const questions = [
      // NHẬN BIẾT (7)
      {
        text: "Cho phương trình bậc hai \\(ax^2 + bx + c = 0\\) (\\(a \\ne 0\\)) có hai nghiệm \\(x_1, x_2\\). Theo hệ thức Vi-ét, tổng hai nghiệm là:",
        options: ["\\(S = -\\frac{b}{a}\\)", "\\(S = \\frac{b}{a}\\)", "\\(S = -\\frac{c}{a}\\)", "\\(S = \\frac{c}{a}\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Tổng hai nghiệm \\(S = x_1 + x_2 = -\\frac{b}{a}\\)."
      },
      {
        text: "Theo hệ thức Vi-ét, tích hai nghiệm của phương trình \\(ax^2 + bx + c = 0\\) là:",
        options: ["\\(P = \\frac{c}{a}\\)", "\\(P = -\\frac{c}{a}\\)", "\\(P = \\frac{b}{a}\\)", "\\(P = -\\frac{b}{a}\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Tích hai nghiệm \\(P = x_1x_2 = \\frac{c}{a}\\)."
      },
      {
        text: "Không giải phương trình, tính tổng hai nghiệm của phương trình \\(x^2 - 5x + 4 = 0\\).",
        options: ["5", "-5", "4", "-4"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Với \\(a=1, b=-5\\): \\(S=-b/a=5\\)."
      },
      {
        text: "Không giải phương trình, tính tích hai nghiệm của phương trình \\(x^2 - 5x + 4 = 0\\).",
        options: ["4", "-4", "5", "-5"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Với \\(a=1, c=4\\): \\(P=c/a=4\\)."
      },
      {
        text: "Nếu phương trình \\(ax^2 + bx + c = 0\\) có \\(a + b + c = 0\\) thì phương trình có hai nghiệm là:",
        options: ["\\(x_1 = 1; x_2 = \\frac{c}{a}\\)", "\\(x_1 = -1; x_2 = -\\frac{c}{a}\\)", "\\(x_1 = 1; x_2 = -\\frac{c}{a}\\)", "\\(x_1 = -1; x_2 = \\frac{c}{a}\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Nếu \\(a+b+c=0\\) thì \\(x_1=1\\), \\(x_2=\\frac{c}{a}\\)."
      },
      {
        text: "Nếu phương trình \\(ax^2 + bx + c = 0\\) có \\(a - b + c = 0\\) thì phương trình có hai nghiệm là:",
        options: ["\\(x_1 = -1; x_2 = -\\frac{c}{a}\\)", "\\(x_1 = 1; x_2 = \\frac{c}{a}\\)", "\\(x_1 = -1; x_2 = \\frac{c}{a}\\)", "\\(x_1 = 1; x_2 = -\\frac{c}{a}\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Nếu \\(a-b+c=0\\) thì \\(x_1=-1\\), \\(x_2=-\\frac{c}{a}\\)."
      },
      {
        text: "Muốn tìm hai số \\(u\\) và \\(v\\) biết tổng \\(u+v=S\\) và tích \\(uv=P\\), ta giải phương trình nào?",
        options: ["\\(x^2 - Sx + P = 0\\)", "\\(x^2 + Sx + P = 0\\)", "\\(x^2 - Px + S = 0\\)", "\\(x^2 + Px + S = 0\\)"],
        correct: 0,
        level: "NHẬN BIẾT",
        rationale: "Hai số là nghiệm của \\(x^2 - Sx + P = 0\\)."
      },

      // THÔNG HIỂU (8)
      {
        text: "Tính tổng và tích hai nghiệm của phương trình \\(2x^2 - 7x - 3 = 0\\).",
        options: ["\\(S = \\frac{7}{2}; P = -\\frac{3}{2}\\)", "\\(S = -\\frac{7}{2}; P = -\\frac{3}{2}\\)", "\\(S = \\frac{7}{2}; P = \\frac{3}{2}\\)", "\\(S = 7; P = -3\\)"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "\\(S=-b/a=7/2\\), \\(P=c/a=-3/2\\)."
      },
      {
        text: "Cho phương trình \\(x^2 - 6x + 8 = 0\\) có hai nghiệm \\(x_1, x_2\\). Giá trị \\(x_1^2 + x_2^2\\) là:",
        options: ["20", "36", "52", "16"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "Với \\(S=6,P=8\\): \\(x_1^2+x_2^2=S^2-2P=36-16=20\\)."
      },
      {
        text: "Cho phương trình \\(x^2 - 4x + 1 = 0\\) có hai nghiệm \\(x_1, x_2\\). Giá trị \\(\\frac{1}{x_1} + \\frac{1}{x_2}\\) là:",
        options: ["4", "1", "-4", "1/4"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "\\(\\frac{1}{x_1}+\\frac{1}{x_2}=\\frac{x_1+x_2}{x_1x_2}=\\frac{S}{P}=4\\)."
      },
      {
        text: "Phương trình \\(x^2 + 5x + 3 = 0\\) có hai nghiệm phân biệt. Nhận xét đúng về dấu hai nghiệm?",
        options: ["Hai nghiệm cùng âm", "Hai nghiệm cùng dương", "Hai nghiệm trái dấu", "Có một nghiệm bằng 0"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "P=3>0 => cùng dấu. S=-5<0 => cùng âm."
      },
      {
        text: "Tìm \\(m\\) để \\(x^2 - 2(m-1)x + m^2 - 3 = 0\\) có hai nghiệm đối nhau (tổng bằng 0).",
        options: ["\\(m = 1\\)", "\\(m = 0\\)", "\\(m = 3\\)", "\\(m = -1\\)"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "Hai nghiệm đối nhau => S=0 => 2(m-1)=0 => m=1. Khi đó PT: \\(x^2-2=0\\) có 2 nghiệm."
      },
      {
        text: "Tìm \\(m\\) để \\(x^2 - 5x + m - 2 = 0\\) có một nghiệm bằng 0.",
        options: ["\\(m = 2\\)", "\\(m = 5\\)", "\\(m = 0\\)", "\\(m = -2\\)"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "Có nghiệm 0 => P=0 => m-2=0 => m=2."
      },
      {
        text: "Hai số có tổng 9 và tích 20 là nghiệm của phương trình:",
        options: ["\\(x^2 - 9x + 20 = 0\\)", "\\(x^2 + 9x + 20 = 0\\)", "\\(x^2 - 9x - 20 = 0\\)", "\\(x^2 - 20x + 9 = 0\\)"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "Dựng PT: \\(x^2 - Sx + P = 0\\) => \\(x^2-9x+20=0\\)."
      },
      {
        text: "Nhẩm nghiệm của \\(2023x^2 + x - 2024 = 0\\).",
        options: ["\\(x_1 = 1; x_2 = -\\frac{2024}{2023}\\)", "\\(x_1 = -1; x_2 = \\frac{2024}{2023}\\)", "\\(x_1 = 1; x_2 = \\frac{2024}{2023}\\)", "\\(x_1 = -1; x_2 = -\\frac{2024}{2023}\\)"],
        correct: 0,
        level: "THÔNG HIỂU",
        rationale: "Vì \\(a+b+c=2023+1-2024=0\\) nên nghiệm: 1 và \\(c/a=-2024/2023\\)."
      },

      // VẬN DỤNG (3)
      {
        text: "Một mảnh đất hình chữ nhật có chu vi 30m và diện tích 54m². Tìm chiều dài và chiều rộng.",
        options: ["9m và 6m", "10m và 5m", "18m và 3m", "27m và 2m"],
        correct: 0,
        level: "VẬN DỤNG",
        rationale: "S=15, P=54. PT: \\(x^2-15x+54=0\\) có nghiệm 6 và 9."
      },
      {
        text: "Tìm hai số biết tổng bằng 12 và tổng bình phương bằng 74.",
        options: ["5 và 7", "4 và 8", "6 và 6", "1 và 11"],
        correct: 0,
        level: "VẬN DỤNG",
        rationale: "S=12. \\(u^2+v^2=S^2-2P=74\\Rightarrow 144-2P=74\\Rightarrow P=35\\). PT: \\(x^2-12x+35=0\\) => 5 và 7."
      },
      {
        text: "Hai điện trở nối tiếp có tổng 10\\(\\Omega\\). Mắc song song có \\(R_{tđ}=2.4\\(\\Omega\\). Tìm \\(R_1,R_2\\).",
        options: ["6\\(\\Omega\\) và 4\\(\\Omega\\)", "5\\(\\Omega\\) và 5\\(\\Omega\\)", "8\\(\\Omega\\) và 2\\(\\Omega\\)", "7\\(\\Omega\\) và 3\\(\\Omega\\)"],
        correct: 0,
        level: "VẬN DỤNG",
        rationale: "S=10. \\(\\frac{P}{S}=2.4\\Rightarrow P=24\\). PT: \\(x^2-10x+24=0\\) => 4 và 6."
      },

      // VẬN DỤNG CAO (2) - FIX câu 19 để có đáp án duy nhất
      {
        text: "Cho \\(x^2 - 2(m+1)x + 2m = 0\\). Tìm \\(m\\) để hai nghiệm \\(x_1,x_2\\) thỏa mãn \\(x_1^2 + x_2^2 = 4\\).",
        options: ["\\(m=0\\) hoặc \\(m=-1\\)", "\\(m=0\\)", "\\(m=-1\\)", "\\(m=1\\)"],
        correct: 0,
        level: "VẬN DỤNG CAO",
        rationale: "S=2(m+1), P=2m. \\(x_1^2+x_2^2=S^2-2P=4(m+1)^2-4m=4m^2+4m+4\\). =4 => \\(m(m+1)=0\\) => \\(m=0\\) hoặc \\(m=-1\\)."
      },
      {
        text: "Cho \\(x^2 - 5x + m = 0\\). Tìm \\(m\\) để có hai nghiệm \\(x_1,x_2\\) thỏa \\(2x_1 + x_2 = 7\\).",
        options: ["\\(m = 6\\)", "\\(m = 4\\)", "\\(m = 5\\)", "\\(m = 2\\)"],
        correct: 0,
        level: "VẬN DỤNG CAO",
        rationale: "S=5. Hệ: \\(x_1+x_2=5\\), \\(2x_1+x_2=7\\) => \\(x_1=2\\), \\(x_2=3\\). P=6 => m=6."
      }
    ];

    // ===== Game Engine (random + balance) =====
    const game = {
      index: 0,
      score: 0,
      correctCount: 0,
      audioCtx: null,
      sessionOrders: null,

      initAudio() {
        if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      },

      playSound(type) {
        if (!this.audioCtx) return;
        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();
        osc.connect(gain);
        gain.connect(this.audioCtx.destination);

        const now = this.audioCtx.currentTime;

        if (type === 'correct') {
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(523.25, now);
          osc.frequency.linearRampToValueAtTime(659.25, now + 0.1);
          osc.frequency.linearRampToValueAtTime(783.99, now + 0.2);
          gain.gain.setValueAtTime(0.2, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
          osc.start(now);
          osc.stop(now + 0.6);
        } else {
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(150, now);
          osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
          gain.gain.setValueAtTime(0.2, now);
          gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
          osc.start(now);
          osc.stop(now + 0.3);
        }
      },

      start() {
        this.initAudio();
        this.index = 0;
        this.score = 0;
        this.correctCount = 0;

        // mỗi lần vào game => random lại + cân bằng ABCD
        this.sessionOrders = buildSessionOrders(questions);

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        this.loadQ();
      },

      loadQ() {
        const q = questions[this.index];
        const order = this.sessionOrders[this.index];

        document.getElementById('q-curr').innerText = this.index + 1;
        document.getElementById('score').innerText = this.score;
        document.getElementById('q-text').innerHTML = q.text;
        document.getElementById('level-badge').innerText = q.level;

        // progress đẹp hơn: (index/len)*100 khi đang ở câu index
        document.getElementById('progress-bar').style.width = `${Math.round((this.index / questions.length) * 100)}%`;

        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        document.getElementById('rationale-box').classList.add('hidden');

        order.options.forEach((opt, i) => {
          const btn = document.createElement('button');
          btn.className = "btn-choice w-full p-4 rounded text-left font-bold text-lg font-serif";
          btn.innerHTML = `<span class="inline-block w-8 h-8 rounded-full border border-[#5d4037] text-[#5d4037] text-center leading-7 mr-3 text-sm">${String.fromCharCode(65+i)}</span> ${opt}`;
          btn.onclick = () => this.check(i);
          grid.appendChild(btn);
        });

        if (window.MathJax) MathJax.typesetPromise();
      },

      check(choice) {
        const q = questions[this.index];
        const order = this.sessionOrders[this.index];

        const btns = document.querySelectorAll('.btn-choice');
        btns.forEach(b => b.disabled = true);

        if (choice === order.correct) {
          btns[choice].classList.add('correct');
          this.score += 10;
          this.correctCount += 1;
          this.playSound('correct');
          this.showRat(true, q.rationale);
          fireConfetti();
        } else {
          btns[choice].classList.add('incorrect');
          btns[order.correct].classList.add('correct');
          this.playSound('incorrect');
          this.showRat(false, q.rationale);
        }
        document.getElementById('score').innerText = this.score;
      },

      showRat(isCorrect, text) {
        const box = document.getElementById('rationale-box');
        box.classList.remove('hidden');

        const title = document.getElementById('rat-title');
        const icon = document.getElementById('rat-icon');

        if (isCorrect) {
          title.innerHTML = "<span class='text-[#33691e]'>Chính Xác!</span>";
          icon.innerHTML = '<i class="fa-solid fa-check-circle text-[#33691e]"></i>';
        } else {
          title.innerHTML = "<span class='text-[#b71c1c]'>Chưa đúng!</span>";
          icon.innerHTML = '<i class="fa-solid fa-circle-xmark text-[#b71c1c]"></i>';
        }

        document.getElementById('rat-content').innerHTML = `<strong>Giải mã:</strong> ${text}`;
        if (window.MathJax) MathJax.typesetPromise([box]);
      },

      next() {
        if (this.index < questions.length - 1) {
          this.index++;
          this.loadQ();
        } else {
          this.end();
        }
      },

      end() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');

        // full progress
        document.getElementById('progress-bar').style.width = `100%`;

        const finalScore = this.score;
        const acc = Math.round((this.correctCount / questions.length) * 100);

        document.getElementById('final-score').innerText = finalScore;
        document.getElementById('final-acc').innerText = acc + "%";

        let msg = "";
        if (acc >= 90) msg = "Tuyệt vời! Bạn là một thám tử đại tài!";
        else if (acc >= 70) msg = "Rất tốt! Bạn đã tìm ra hầu hết các manh mối.";
        else msg = "Hãy ôn tập lại và thử sức lần nữa nhé!";

        document.getElementById('final-msg').innerText = msg;
        if (acc >= 50) fireConfetti();
      }
    };

    // ===== Confetti =====
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animating = false;

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function fireConfetti() {
      for (let i = 0; i < 80; i++) {
        particles.push({
          x: canvas.width / 2, y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 15,
          vy: (Math.random() - 0.5) * 15,
          life: 100,
          color: `hsl(${Math.random() * 50 + 20}, 80%, 50%)`,
          size: Math.random() * 5 + 2
        });
      }
      if (!animating) updateConfetti();
    }

    function updateConfetti() {
      if (particles.length === 0) {
        animating = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }
      animating = true;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < particles.length; i++) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.5;
        p.life--;

        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);

        if (p.life <= 0) {
          particles.splice(i, 1);
          i--;
        }
      }
      requestAnimationFrame(updateConfetti);
    }
  </script>
</body>
</html>
