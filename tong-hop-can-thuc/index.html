<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V∆∞∆°ng Qu·ªëc CƒÉn Th·ª©c ‚Äì Th·ª≠ Th√°ch T·ªëi Th∆∞·ª£ng</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500;700&display=swap");

    body {
      font-family: "Roboto", sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
      user-select: none;
    }

    .sci-fi-font { font-family: "Orbitron", sans-serif; }

    /* --- Starfield Background --- */
    #starfield {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: star-anim linear infinite;
    }

    @keyframes star-anim {
      from { transform: translateY(-100vh); opacity: 0; }
      50% { opacity: 1; }
      to { transform: translateY(100vh); opacity: 0; }
    }

    /* --- Spaceship & Planets --- */
    #game-scene {
      position: relative;
      height: 300px;
      width: 100%;
      overflow: hidden;
      margin-bottom: 20px;
      border-bottom: 2px solid #4ade80;
      background: rgba(0, 0, 0, 0.3);
    }

    #spaceship {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 4rem;
      filter: drop-shadow(0 0 10px #4ade80);
      transition: all 0.5s ease;
      z-index: 10;
    }

    .warp-speed #spaceship {
      transform: translateX(-50%) scale(0.8) translateY(-50px);
      filter: drop-shadow(0 0 20px #60a5fa);
    }

    .planet {
      position: absolute;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 6rem;
      transition: top 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      opacity: 0.8;
    }

    .planet.arrived { top: 50px; }

    /* --- UI Elements --- */
    .glass-panel {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(56, 189, 248, 0.3);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
    }

    .btn-option {
      background: rgba(30, 41, 59, 0.9);
      border: 2px solid #475569;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .btn-option:hover {
      border-color: #38bdf8;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
      transform: translateY(-2px);
    }

    .btn-option.correct {
      background: #065f46;
      border-color: #34d399;
      box-shadow: 0 0 15px #34d399;
    }

    .btn-option.wrong {
      background: #7f1d1d;
      border-color: #f87171;
      animation: shake 0.4s;
    }

    .btn-option:disabled { cursor: default; opacity: 0.92; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Math styling */
    .math-expr {
      font-family: "Times New Roman", serif;
      font-style: italic;
      font-weight: bold;
    }

    .fraction {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      margin: 0 2px;
      font-size: 0.9em;
    }
    .fraction > span { display: block; padding: 0.1em; }
    .fraction span.numerator { border-bottom: 1px solid currentColor; }
    .fraction span.denominator { border-top: 1px solid transparent; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">
  <div id="starfield"></div>

  <!-- START SCREEN -->
  <div id="start-screen" class="glass-panel p-8 rounded-2xl text-center max-w-3xl w-full z-10">
    <h1 class="sci-fi-font text-5xl md:text-6xl text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-4 animate-pulse">
      DU H√ÄNH<br />GI·ªÆA C√ÅC V√å SAO
    </h1>

    <p class="text-xl text-gray-300 mb-6 leading-relaxed">
      ƒê·ªông c∆° <span class="text-cyan-400 font-bold">Warp</span> c·ªßa t√†u ƒë√£ suy y·∫øu. B·∫°n ph·∫£i v∆∞·ª£t qua
      <span class="text-yellow-300 font-bold">4 C·ªîNG TH·ª¨ TH√ÅCH</span>
      t∆∞∆°ng ·ª©ng v·ªõi 4 m·ª©c ƒë·ªô t∆∞ duy to√°n h·ªçc ƒë·ªÉ kh·ªüi ƒë·ªông l·∫°i h·ªá th·ªëng v√† m·ªü ƒë∆∞·ªùng ƒë·∫øn c√°c h√†nh tinh m·ªõi.
    </p>

    <div class="grid grid-cols-1 gap-3 text-left bg-slate-900/50 p-4 rounded-lg mb-8 text-sm">
      <div class="flex items-start gap-3">
        <div class="text-green-400 text-xl">üü¢</div>
        <div>
          <div class="font-bold text-green-300 text-lg">C·ªîNG 1 ‚Äì NH·∫¨N BI·∫æT</div>
          <div class="text-gray-300">10 c√¢u kh·ªüi ƒë·ªông: cƒÉn b·∫≠c hai s·ªë h·ªçc, ƒëi·ªÅu ki·ªán x√°c ƒë·ªãnh, ph√©p t√≠nh c∆° b·∫£n.</div>
        </div>
      </div>

      <div class="flex items-start gap-3">
        <div class="text-blue-400 text-xl">üîµ</div>
        <div>
          <div class="font-bold text-blue-300 text-lg">C·ªîNG 2 ‚Äì TH√îNG HI·ªÇU</div>
          <div class="text-gray-300">9 c√¢u c·ªßng c·ªë: r√∫t g·ªçn cƒÉn, tr·ª•c cƒÉn th·ª©c, ph√¢n t√≠ch ‚Äì so s√°nh ‚Äì chuy·ªÉn ƒë·ªïi.</div>
        </div>
      </div>

      <div class="flex items-start gap-3">
        <div class="text-purple-400 text-xl">üü£</div>
        <div>
          <div class="font-bold text-purple-300 text-lg">C·ªîNG 3 ‚Äì V·∫¨N D·ª§NG</div>
          <div class="text-gray-300">7 c√¢u tƒÉng t·ªëc: b√†i to√°n ch·ª©a cƒÉn, m√¥ h√¨nh th·ª±c t·∫ø, bi·∫øn ƒë·ªïi n√¢ng cao.</div>
        </div>
      </div>

      <div class="flex items-start gap-3">
        <div class="text-red-400 text-xl">üî¥</div>
        <div>
          <div class="font-bold text-red-300 text-lg">C·ªîNG 4 ‚Äì V·∫¨N D·ª§NG CAO</div>
          <div class="text-gray-300">4 c√¢u t·ªëi th∆∞·ª£ng: ph∆∞∆°ng tr√¨nh ch·ª©a cƒÉn ‚Äì b√†i to√°n t∆∞ duy s√¢u.</div>
        </div>
      </div>
    </div>

    <p class="text-lg text-cyan-300 mb-8">
      ‚ú¶ T·ªïng c·ªông <span class="font-bold text-yellow-300">30 c√¢u h·ªèi</span> ‚Äì chinh ph·ª•c ƒë·ªß 4 c·ªïng ƒë·ªÉ m·ªü l·ªëi ƒëi xuy√™n v≈© tr·ª•!
    </p>

    <button onclick="startGame()"
      class="px-10 py-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-full text-xl shadow-[0_0_20px_rgba(8,145,178,0.6)] transition transform hover:scale-110">
      KH·ªûI H√ÄNH üöÄ
    </button>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen" class="hidden w-full max-w-4xl flex-col z-10 space-y-3">
    <!-- Status Bar -->
    <div class="flex justify-between items-center px-4 py-2 glass-panel rounded-full">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üíé</span>
        <span id="score" class="text-2xl font-bold text-yellow-400">0</span>
      </div>
      <div class="text-cyan-300 sci-fi-font text-lg">
        H√†nh tinh <span id="q-current">1</span>/30
      </div>
      <div id="difficulty-badge" class="px-3 py-1 rounded bg-slate-700 text-xs font-bold">
        C·ªîNG 1 ‚Äì NH·∫¨N BI·∫æT
      </div>
    </div>

    <!-- Visual Scene -->
    <div id="game-scene" class="glass-panel rounded-xl relative">
      <div id="spaceship">üöÄ</div>
      <div id="target-planet" class="planet">ü™ê</div>
      <div id="warp-container" class="absolute inset-0 hidden"></div>
    </div>

    <!-- Question Area -->
    <div class="glass-panel p-6 rounded-xl min-h-[160px] flex items-center justify-center relative">
      <div id="question-text" class="text-2xl text-center font-medium leading-relaxed">
        Loading...
      </div>
    </div>

    <!-- Answer Grid -->
    <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <!-- ‚úÖ RATIONALE PANEL (m·ªõi) -->
    <div id="rationale-panel" class="hidden glass-panel p-5 rounded-xl border-l-4">
      <div class="flex items-start gap-3">
        <div id="rationale-icon" class="text-3xl">üí°</div>
        <div class="flex-1">
          <div id="rationale-title" class="font-bold text-lg mb-1"></div>
          <div id="rationale-text" class="text-gray-200 leading-relaxed"></div>
        </div>
      </div>

      <button id="next-btn"
        class="mt-4 w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-lg shadow-lg transition">
        C√ÇU TI·∫æP THEO ‚ûú
      </button>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="end-screen" class="hidden glass-panel p-10 rounded-2xl text-center max-w-2xl w-full z-20">
    <div class="text-7xl mb-4">üèÜ</div>
    <h2 class="sci-fi-font text-4xl text-yellow-400 mb-4">CHINH PH·ª§C V≈® TR·ª§!</h2>
    <p class="text-xl text-gray-300 mb-4">B·∫°n ƒë√£ ho√†n th√†nh chuy·∫øn du h√†nh xu·∫•t s·∫Øc.</p>

    <div id="final-score" class="text-5xl font-bold text-white mb-6">0</div>

    <div class="mb-6">
      <input id="player-name" type="text" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..."
        class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-center text-white text-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" />
    </div>

    <button onclick="saveScore()" class="px-8 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold shadow-lg mb-6">
      L∆∞u ƒêi·ªÉm üéâ
    </button>

    <div id="leaderboard" class="text-left bg-slate-900/60 p-6 rounded-xl max-h-[300px] overflow-auto hidden">
      <h3 class="text-2xl text-cyan-300 sci-fi-font mb-3">B·∫¢NG X·∫æP H·∫†NG</h3>
      <ul id="leaderboard-list" class="space-y-2"></ul>
    </div>

    <button onclick="location.reload()"
      class="mt-6 px-8 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-bold shadow-lg">
      Ch∆°i L·∫°i
    </button>
  </div>

  <!-- FEEDBACK + CONFETTI -->
  <div id="feedback-overlay"
    class="fixed inset-0 pointer-events-none flex items-center justify-center z-50 opacity-0 transition-opacity duration-300">
    <div id="feedback-content"
      class="text-9xl transform scale-0 transition-transform duration-300"></div>
  </div>

  <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-40"></canvas>

  <script>
    // ===============================
    //  D·ªÆ LI·ªÜU C√ÇU H·ªéI ‚Äì 30 C√ÇU / 4 C·ªîNG
    //  ‚úÖ C√≥ th·ªÉ th√™m r: "Gi·∫£i th√≠ch..." cho t·ª´ng c√¢u (t√πy c√¥)
    // ===============================
    const questions = [
      // NH·∫¨N BI·∫æT ‚Äì 10 c√¢u
      { q: "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa 81 l√†:", a: ["9", "-9", "¬±9", "81"], c: 0, l: "NH·∫¨N BI·∫æT" },
      { q: "ƒêi·ªÅu ki·ªán x√°c ƒë·ªãnh c·ªßa bi·ªÉu th·ª©c &radic;(x - 5) l√†:", a: ["x > 5", "x < 5", "x &ge; 5", "x &le; 5"], c: 2, l: "NH·∫¨N BI·∫æT" },
      { q: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh &radic;((-7)<sup>2</sup>) l√†:", a: ["-7", "7", "¬±7", "49"], c: 1, l: "NH·∫¨N BI·∫æT" },
      {
        q: "Trong c√°c kh·∫≥ng ƒë·ªãnh sau, kh·∫≥ng ƒë·ªãnh n√†o ƒê√öNG?",
        a: [
          "&radic;(AB) = &radic;A . &radic;B v·ªõi m·ªçi A, B",
          "&radic;(A/B) = &radic;A / &radic;B v·ªõi A &ge; 0, B > 0",
          "&radic;(A<sup>2</sup>) = A v·ªõi m·ªçi A",
          "&radic;A x√°c ƒë·ªãnh v·ªõi m·ªçi A",
        ],
        c: 1, l: "NH·∫¨N BI·∫æT"
      },
      { q: "CƒÉn b·∫≠c ba c·ªßa -64 l√†:", a: ["4", "-4", "8", "-8"], c: 1, l: "NH·∫¨N BI·∫æT" },
      { q: "So s√°nh 3 v√† &radic;8:", a: ["3 > &radic;8", "3 < &radic;8", "3 = &radic;8", "Kh√¥ng so s√°nh ƒë∆∞·ª£c"], c: 0, l: "NH·∫¨N BI·∫æT" },
      { q: "T√≠nh: &radic;25 + 3&radic;4", a: ["7", "9", "11", "13"], c: 2, l: "NH·∫¨N BI·∫æT" },
      { q: "Gi√° tr·ªã c·ªßa &radic;49 ‚àí &radic;9 l√†:", a: ["2", "3", "4", "5"], c: 2, l: "NH·∫¨N BI·∫æT" },
      { q: "Bi·ªÉu th·ª©c n√†o d∆∞·ªõi ƒë√¢y l√† cƒÉn b·∫≠c hai s·ªë h·ªçc (lu√¥n kh√¥ng √¢m) c·ªßa 16?", a: ["&radic;16", "‚àí&radic;16", "&radic;(-16)", "‚àí4"], c: 0, l: "NH·∫¨N BI·∫æT" },
      { q: "ƒêi·ªÅu ki·ªán x√°c ƒë·ªãnh c·ªßa bi·ªÉu th·ª©c A = &radic;(5x ‚àí 15) l√†:", a: ["x > 3", "x &ge; 3", "x &le; 3", "x < 3"], c: 1, l: "NH·∫¨N BI·∫æT" },

      // TH√îNG HI·ªÇU ‚Äì 9 c√¢u
      { q: "T√≠nh gi√° tr·ªã bi·ªÉu th·ª©c: M = &radic;16 + &radic;25", a: ["9", "41", "&radic;41", "1"], c: 0, l: "TH√îNG HI·ªÇU" },
      { q: "R√∫t g·ªçn bi·ªÉu th·ª©c P = &radic;18 - &radic;8", a: ["&radic;10", "2&radic;2", "&radic;2", "5&radic;2"], c: 2, l: "TH√îNG HI·ªÇU" },
      { q: "T√¨m x, bi·∫øt &radic;x = 6", a: ["x = 6", "x = 12", "x = 36", "x = -36"], c: 2, l: "TH√îNG HI·ªÇU" },
      { q: "K·∫øt qu·∫£ r√∫t g·ªçn c·ªßa &radic;((2 - &radic;5)<sup>2</sup>) l√†:", a: ["2 - &radic;5", "&radic;5 - 2", "2 + &radic;5", "-2 - &radic;5"], c: 1, l: "TH√îNG HI·ªÇU" },
      {
        q: "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u c·ªßa bi·ªÉu th·ª©c <div class='fraction'><span class='numerator'>2</span><span class='denominator'>&radic;3</span></div> ta ƒë∆∞·ª£c:",
        a: [
          "<div class='fraction'><span class='numerator'>2&radic;3</span><span class='denominator'>3</span></div>",
          "<div class='fraction'><span class='numerator'>&radic;6</span><span class='denominator'>3</span></div>",
          "2&radic;3",
          "<div class='fraction'><span class='numerator'>2</span><span class='denominator'>3</span></div>",
        ],
        c: 0, l: "TH√îNG HI·ªÇU"
      },
      { q: "R√∫t g·ªçn: &radic;20", a: ["2&radic;5", "4&radic;5", "&radic;5", "5&radic;2"], c: 0, l: "TH√îNG HI·ªÇU" },
      { q: "R√∫t g·ªçn: &radic;45 ‚àí &radic;5", a: ["4&radic;5", "2&radic;5", "&radic;5", "3&radic;5"], c: 1, l: "TH√îNG HI·ªÇU" },
      { q: "R√∫t g·ªçn t√≠ch: &radic;3 ¬∑ &radic;12", a: ["&radic;36", "6", "6&radic;3", "3&radic;12"], c: 1, l: "TH√îNG HI·ªÇU" },
      {
        q: "Tr·ª•c cƒÉn th·ª©c ·ªü m·∫´u c·ªßa bi·ªÉu th·ª©c 3 / &radic;5 ta ƒë∆∞·ª£c:",
        a: [
          "<div class='fraction'><span class='numerator'>3&radic;5</span><span class='denominator'>25</span></div>",
          "<div class='fraction'><span class='numerator'>3&radic;5</span><span class='denominator'>5</span></div>",
          "3&radic;5",
          "3 / 5",
        ],
        c: 1, l: "TH√îNG HI·ªÇU"
      },

      // V·∫¨N D·ª§NG ‚Äì 7 c√¢u
      { q: "R√∫t g·ªçn bi·ªÉu th·ª©c A = 3&radic;x - &radic;(16x) + 5 v·ªõi x &ge; 0", a: ["7&radic;x + 5", "&radic;x + 5", "5 - &radic;x", "19&radic;x"], c: 2, l: "V·∫¨N D·ª§NG" },
      { q: "Gi·∫£i ph∆∞∆°ng tr√¨nh &radic;(4x - 4) + &radic;(x - 1) = 6", a: ["x = 5", "x = 3", "x = 4", "x = 2"], c: 0, l: "V·∫¨N D·ª§NG" },
      { q: "(V·∫≠n d·ª•ng th·ª±c t·∫ø) M·ªôt m·∫£nh ƒë·∫•t h√¨nh vu√¥ng c√≥ di·ªán t√≠ch l√† 50 m<sup>2</sup>. ƒê·ªô d√†i c·∫°nh c·ªßa m·∫£nh ƒë·∫•t ƒë√≥ l√† bao nhi√™u?", a: ["25 m", "10 m", "5&radic;2 m", "2&radic;5 m"], c: 2, l: "V·∫¨N D·ª§NG" },
      { q: "R√∫t g·ªçn: &radic;27 + &radic;12", a: ["5&radic;3", "7&radic;3", "3&radic;3 + &radic;12", "3&radic;3 + 2&radic;12"], c: 0, l: "V·∫¨N D·ª§NG" },
      { q: "Cho A = &radic;(a<sup>2</sup>) v·ªõi a l√† s·ªë th·ª±c. K·∫øt lu·∫≠n ƒë√∫ng l√†:", a: ["A = a", "A = ‚àía", "A = |a|", "A = a<sup>2</sup>"], c: 2, l: "V·∫¨N D·ª§NG" },
      { q: "R√∫t g·ªçn: &radic;(18x<sup>2</sup>) v·ªõi x &ge; 0.", a: ["3x&radic;2", "6x", "3&radic;(2x<sup>2</sup>)", "x&radic;18"], c: 0, l: "V·∫¨N D·ª§NG" },
      {
        q: "Cho A = <div class='fraction'><span class='numerator'>&radic;5 - 1</span><span class='denominator'>&radic;5 + 1</span></div>. R√∫t g·ªçn A:",
        a: [
          "4/6",
          "2/3",
          "<div class='fraction'><span class='numerator'>&radic;5 - 1</span><span class='denominator'>4</span></div>",
          "<div class='fraction'><span class='numerator'>3 - &radic;5</span><span class='denominator'>2</span></div>",
        ],
        c: 3, l: "V·∫¨N D·ª§NG"
      },

      // V·∫¨N D·ª§NG CAO ‚Äì 4 c√¢u
      { q: "Gi·∫£i ph∆∞∆°ng tr√¨nh: &radic;x = 3", a: ["x = &plusmn;3", "x = 3", "x = 9", "x = -9"], c: 2, l: "V·∫¨N D·ª§NG CAO" },
      { q: "Gi·∫£i ph∆∞∆°ng tr√¨nh: &radic;(x + 5) = x ‚àí 1", a: ["x = 0", "x = 2", "x = 3", "x = 4"], c: 3, l: "V·∫¨N D·ª§NG CAO" },
      { q: "M·ªôt h√¨nh vu√¥ng c√≥ c·∫°nh a = &radic;8 cm. Di·ªán t√≠ch h√¨nh vu√¥ng l√†:", a: ["4 cm<sup>2</sup>", "8 cm<sup>2</sup>", "16 cm<sup>2</sup>", "8&radic;2 cm<sup>2</sup>"], c: 1, l: "V·∫¨N D·ª§NG CAO" },
      {
        q: "Cho bi·ªÉu th·ª©c P = <div class='fraction'><span class='numerator'>x - 1</span><span class='denominator'>&radic;x - 1</span></div> - &radic;x v·ªõi x &ge; 0, x &ne; 1. Gi√° tr·ªã c·ªßa P l√†:",
        a: ["&radic;x", "1", "-1", "2&radic;x"],
        c: 1, l: "V·∫¨N D·ª§NG CAO"
      },
    ];

    const gateMapping = {
      "NH·∫¨N BI·∫æT": { label: "C·ªîNG 1 ‚Äì NH·∫¨N BI·∫æT" },
      "TH√îNG HI·ªÇU": { label: "C·ªîNG 2 ‚Äì TH√îNG HI·ªÇU" },
      "V·∫¨N D·ª§NG": { label: "C·ªîNG 3 ‚Äì V·∫¨N D·ª§NG" },
      "V·∫¨N D·ª§NG CAO": { label: "C·ªîNG 4 ‚Äì V·∫¨N D·ª§NG CAO" },
    };

    // ===============================
    // GAME LOGIC
    // ===============================
    let currentIdx = 0;
    let score = 0;
    let answered = false;
    let lastWasCorrect = false;

    const starContainer = document.getElementById("starfield");

    // N·ªÅn sao
    for (let i = 0; i < 100; i++) {
      const star = document.createElement("div");
      star.className = "star";
      star.style.width = Math.random() * 3 + "px";
      star.style.height = star.style.width;
      star.style.left = Math.random() * 100 + "vw";
      star.style.animationDuration = Math.random() * 3 + 2 + "s";
      starContainer.appendChild(star);
    }

    // √Çm thanh
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playTone(freq, type, duration) {
      if (audioCtx.state === "suspended") audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    function playCorrectSound() {
      playTone(523.25, "sine", 0.1);
      setTimeout(() => playTone(659.25, "sine", 0.1), 100);
      setTimeout(() => playTone(783.99, "square", 0.3), 200);
    }

    function playWrongSound() {
      playTone(150, "sawtooth", 0.3);
      setTimeout(() => playTone(100, "sawtooth", 0.3), 150);
    }

    function playWinSound() {
      [523.25, 659.25, 783.99, 1046.5].forEach((f, i) => {
        setTimeout(() => playTone(f, "square", 0.2), i * 150);
      });
    }

    function startGame() {
      document.getElementById("start-screen").classList.add("hidden");
      const gs = document.getElementById("game-screen");
      gs.classList.remove("hidden");
      gs.classList.add("flex");

      currentIdx = 0;
      score = 0;
      answered = false;
      updateScore();
      hideRationale();

      loadQuestion();
      animatePlanetArrival();
    }

    function loadQuestion() {
      if (currentIdx >= questions.length) {
        endGame();
        return;
      }

      answered = false;
      hideRationale();

      const q = questions[currentIdx];

      document.getElementById("q-current").innerText = currentIdx + 1;
      document.getElementById("question-text").innerHTML = q.q;

      const badge = document.getElementById("difficulty-badge");
      const gateInfo = gateMapping[q.l] || { label: q.l };
      badge.innerText = gateInfo.label;

      if (q.l === "NH·∫¨N BI·∫æT")
        badge.className = "px-3 py-1 rounded bg-green-900 text-green-300 text-xs font-bold";
      else if (q.l === "TH√îNG HI·ªÇU")
        badge.className = "px-3 py-1 rounded bg-blue-900 text-blue-300 text-xs font-bold";
      else if (q.l === "V·∫¨N D·ª§NG")
        badge.className = "px-3 py-1 rounded bg-purple-900 text-purple-300 text-xs font-bold";
      else
        badge.className = "px-3 py-1 rounded bg-red-900 text-red-300 text-xs font-bold";

      const grid = document.getElementById("options-grid");
      grid.innerHTML = "";

      q.a.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "btn-option w-full p-4 rounded-xl text-lg font-medium text-slate-200 math-expr";
        btn.innerHTML = `<span class="inline-block w-8 font-bold opacity-60">${String.fromCharCode(65 + idx)}.</span> ${opt}`;
        btn.onclick = () => checkAnswer(idx);
        grid.appendChild(btn);
      });
    }

    // ‚úÖ T·∫°o gi·∫£i th√≠ch m·∫∑c ƒë·ªãnh n·∫øu c√¥ ch∆∞a nh·∫≠p r:
    function defaultRationale(qObj) {
      const correctIdx = qObj.c;
      const letter = String.fromCharCode(65 + correctIdx);
      const ans = qObj.a[correctIdx];
      return `ƒê√°p √°n ƒë√∫ng l√† <b>${letter}</b>: ${ans}`;
    }

    function showRationale(isCorrect, htmlText) {
      const panel = document.getElementById("rationale-panel");
      const icon = document.getElementById("rationale-icon");
      const title = document.getElementById("rationale-title");
      const text = document.getElementById("rationale-text");

      panel.classList.remove("hidden");

      if (isCorrect) {
        panel.classList.remove("border-red-500");
        panel.classList.add("border-green-500");
        icon.innerText = "üí°";
        title.innerText = "Ch√≠nh x√°c!";
        title.className = "font-bold text-lg mb-1 text-green-300";
      } else {
        panel.classList.remove("border-green-500");
        panel.classList.add("border-red-500");
        icon.innerText = "üß†";
        title.innerText = "Ch∆∞a ƒë√∫ng r·ªìi!";
        title.className = "font-bold text-lg mb-1 text-red-300";
      }

      text.innerHTML = htmlText;

      const nextBtn = document.getElementById("next-btn");
      nextBtn.innerText = (currentIdx < questions.length - 1) ? "C√ÇU TI·∫æP THEO ‚ûú" : "XEM K·∫æT QU·∫¢ üèÜ";
      nextBtn.onclick = goNextAfterRationale;
    }

    function hideRationale() {
      document.getElementById("rationale-panel").classList.add("hidden");
      document.getElementById("rationale-text").innerHTML = "";
    }

    function checkAnswer(selected) {
      if (answered) return;
      answered = true;

      const q = questions[currentIdx];
      const correct = q.c;
      const btns = document.querySelectorAll(".btn-option");
      btns.forEach((b) => (b.disabled = true));

      lastWasCorrect = (selected === correct);

      if (lastWasCorrect) {
        btns[selected].classList.add("correct");
        score += 10;
        updateScore();
        playCorrectSound();
        showFeedback("üòç");
        fireConfetti();
      } else {
        btns[selected].classList.add("wrong");
        btns[correct].classList.add("correct");
        playWrongSound();
        showFeedback("üëΩ");
      }

      // ‚úÖ Hi·ªán gi·∫£i th√≠ch gi·ªëng game tr∆∞·ªõc
      const rationaleHTML = (q.r && String(q.r).trim() !== "") ? q.r : defaultRationale(q);
      showRationale(lastWasCorrect, rationaleHTML);
    }

    // ‚úÖ Ch·ªâ qua c√¢u khi HS b·∫•m n√∫t "C√¢u ti·∫øp theo"
    function goNextAfterRationale() {
      if (!answered) return;

      // n·∫øu ƒë√∫ng: gi·ªØ hi·ªáu ·ª©ng bay/warp nh∆∞ c≈©
      if (lastWasCorrect) {
        document.body.classList.add("warp-speed");
        document.getElementById("spaceship").style.transform =
          "translateX(-50%) translateY(-100px) scale(0.5)";
        document.getElementById("target-planet").style.top = "150%";

        setTimeout(() => {
          document.body.classList.remove("warp-speed");
          currentIdx++;
          loadQuestion();
          animatePlanetArrival();
          document.getElementById("spaceship").style.transform =
            "translateX(-50%) translateY(0) scale(1)";
        }, 1200);
      } else {
        // n·∫øu sai: chuy·ªÉn c√¢u nhanh h∆°n
        setTimeout(() => {
          currentIdx++;
          loadQuestion();
          animatePlanetArrival();
        }, 300);
      }
    }

    function updateScore() {
      document.getElementById("score").innerText = score;
    }

    function animatePlanetArrival() {
      const planets = ["ü™ê","üåç","üåï","üåë","üåû","‚≠ê","‚òÑÔ∏è","üåå","üåë","ü™ê","üåç","üåï","üåë","üåû","üè∞"];
      const planetEl = document.getElementById("target-planet");
      planetEl.classList.remove("arrived");
      planetEl.innerText = planets[currentIdx % planets.length];
      planetEl.style.top = "-150px";
      setTimeout(() => planetEl.classList.add("arrived"), 100);
    }

    function showFeedback(emoji) {
      const overlay = document.getElementById("feedback-overlay");
      const content = document.getElementById("feedback-content");
      content.innerText = emoji;
      overlay.style.opacity = "1";
      content.style.transform = "scale(1)";
      setTimeout(() => {
        overlay.style.opacity = "0";
        content.style.transform = "scale(0)";
      }, 900);
    }

    function endGame() {
      const gs = document.getElementById("game-screen");
      gs.classList.remove("flex");
      gs.classList.add("hidden");
      document.getElementById("end-screen").classList.remove("hidden");
      document.getElementById("final-score").innerText = score;
      renderLeaderboard();
      playWinSound();
      fireConfetti();
      setInterval(fireConfetti, 1000);
    }

    // ===============================
    // LEADERBOARD SYSTEM
    // ===============================
    function getLeaderboard() {
      const data = localStorage.getItem("star_leaderboard");
      return data ? JSON.parse(data) : [];
    }

    function setLeaderboard(list) {
      localStorage.setItem("star_leaderboard", JSON.stringify(list));
    }

    function saveScore() {
      const name = document.getElementById("player-name").value.trim();
      if (name === "") {
        alert("Vui l√≤ng nh·∫≠p t√™n!");
        return;
      }
      const leaderboard = getLeaderboard();
      leaderboard.push({ name, score });
      leaderboard.sort((a, b) => b.score - a.score);
      setLeaderboard(leaderboard.slice(0, 10));
      renderLeaderboard();
    }

    function renderLeaderboard() {
      const leaderboard = getLeaderboard();
      const listEl = document.getElementById("leaderboard-list");
      const section = document.getElementById("leaderboard");
      listEl.innerHTML = "";
      leaderboard.forEach((item, index) => {
        const li = document.createElement("li");
        li.className =
          "flex justify-between bg-slate-800 p-3 rounded-lg text-gray-200 border border-slate-700";
        li.innerHTML = `<span class="font-bold">${index + 1}. ${item.name}</span><span class="text-yellow-300">${item.score} ƒëi·ªÉm</span>`;
        listEl.appendChild(li);
      });
      if (leaderboard.length > 0) section.classList.remove("hidden");
    }

    // ===============================
    // CONFETTI
    // ===============================
    const canvas = document.getElementById("confetti-canvas");
    const ctx = canvas.getContext("2d");
    let particles = [];

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function fireConfetti() {
      for (let i = 0; i < 50; i++) {
        particles.push({
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 20,
          vy: (Math.random() - 0.5) * 20,
          color: `hsl(${Math.random() * 360}, 100%, 50%)`,
          size: Math.random() * 10 + 5,
          life: 100,
        });
      }
      if (particles.length <= 50) requestAnimationFrame(updateConfetti);
    }

    function updateConfetti() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < particles.length; i++) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2;
        p.life--;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);
        if (p.life <= 0 || p.y > canvas.height) {
          particles.splice(i, 1);
          i--;
        }
      }
      if (particles.length > 0) requestAnimationFrame(updateConfetti);
    }
  </script>
</body>
</html>
