<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·∫øn Tr√∫c S∆∞ T√†i Ba: H√¨nh H·ªôp & H√¨nh L·∫≠p Ph∆∞∆°ng</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sora', sans-serif;
            background-color: #e0f2fe; /* Sky-100 */
            background-image: radial-gradient(#bae6fd 2px, transparent 2px);
            background-size: 24px 24px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 2px solid #fff;
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.15);
        }

        .btn-game {
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-game:active {
            transform: scale(0.95);
        }

        .option-card {
            transition: all 0.3s ease;
        }
        .option-card:hover:not(.disabled) {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1);
            border-color: #38bdf8;
        }
        .option-card.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d;
        }
        .option-card.wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c;
        }

        /* 3D Cube Animation for Decor */
        .scene {
            width: 80px;
            height: 80px;
            perspective: 400px;
        }
        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: rotate 10s infinite linear;
        }
        .cube__face {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid #0ea5e9;
            background: rgba(14, 165, 233, 0.2);
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0369a1;
            font-weight: bold;
        }
        .cube__face--front  { transform: rotateY(  0deg) translateZ(40px); }
        .cube__face--right  { transform: rotateY( 90deg) translateZ(40px); }
        .cube__face--back   { transform: rotateY(180deg) translateZ(40px); }
        .cube__face--left   { transform: rotateY(-90deg) translateZ(40px); }
        .cube__face--top    { transform: rotateX( 90deg) translateZ(40px); }
        .cube__face--bottom { transform: rotateX(-90deg) translateZ(40px); }

        @keyframes rotate {
            from { transform: rotateX(0deg) rotateY(0deg); }
            to { transform: rotateX(360deg) rotateY(360deg); }
        }

        @keyframes bounce-in {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- GAME CONTAINER -->
    <div class="w-full max-w-4xl glass-panel rounded-3xl overflow-hidden relative flex flex-col min-h-[650px] shadow-2xl">
        
        <!-- DECORATIVE CUBES -->
        <div class="absolute top-4 right-4 opacity-50 z-0 hidden md:block">
            <div class="scene">
                <div class="cube">
                    <div class="cube__face cube__face--front">1</div>
                    <div class="cube__face cube__face--back">2</div>
                    <div class="cube__face cube__face--right">3</div>
                    <div class="cube__face cube__face--left">4</div>
                    <div class="cube__face cube__face--top">5</div>
                    <div class="cube__face cube__face--bottom">6</div>
                </div>
            </div>
        </div>

        <!-- START SCREEN -->
        <div id="start-screen" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-white p-8 text-center">
            <div class="mb-6 bg-blue-100 p-6 rounded-full inline-block animate-pop">
                <i class="ph-fill ph-cube text-6xl text-blue-600"></i>
            </div>
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-2 tracking-tight">Ki·∫øn Tr√∫c S∆∞ T√†i Ba</h1>
            <h2 class="text-xl md:text-2xl text-blue-500 font-bold mb-8">Ch·ªß ƒë·ªÅ: H√¨nh H·ªôp Ch·ªØ Nh·∫≠t & H√¨nh L·∫≠p Ph∆∞∆°ng</h2>
            
            <div class="bg-slate-50 border border-slate-200 p-6 rounded-2xl mb-8 max-w-lg w-full">
                <ul class="space-y-3 text-left font-medium text-slate-600">
                    <li class="flex items-center"><i class="ph-bold ph-check-square text-green-500 mr-3 text-xl"></i> 15 C√¢u h·ªèi tr·∫Øc nghi·ªám</li>
                    <li class="flex items-center"><i class="ph-bold ph-brain text-purple-500 mr-3 text-xl"></i> Th·ª≠ th√°ch t∆∞ duy kh√¥ng gian</li>
                    <li class="flex items-center"><i class="ph-bold ph-trophy text-yellow-500 mr-3 text-xl"></i> X√¢y d·ª±ng th√†nh ph·ªë tri th·ª©c</li>
                </ul>
            </div>

            <button onclick="Game.start()" class="btn-game px-10 py-4 bg-blue-600 text-white font-bold rounded-2xl text-xl shadow-lg hover:bg-blue-700 hover:shadow-blue-500/30 flex items-center gap-2">
                <i class="ph-bold ph-play-circle text-2xl"></i> B·∫Øt ƒê·∫ßu Thi·∫øt K·∫ø
            </button>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden flex-col h-full bg-slate-50/50 relative z-10">
            <!-- Header -->
            <div class="bg-white p-4 flex justify-between items-center shadow-sm border-b border-slate-100">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center font-bold text-xl shadow-md">
                        <span id="ui-current">1</span>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">C√¢u h·ªèi</div>
                        <div class="font-bold text-slate-700 text-lg">/ <span id="ui-total">15</span></div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-100 px-4 py-2 rounded-xl border border-slate-200">
                    <i class="ph-fill ph-coin text-yellow-500 text-2xl"></i>
                    <span id="ui-score" class="font-bold text-2xl text-slate-700">0</span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-slate-200 h-1.5">
                <div id="ui-progress" class="h-full bg-blue-500 transition-all duration-500 ease-out shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: 0%"></div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 md:p-8 pb-40">
                <div class="max-w-3xl mx-auto">
                    <span id="ui-level" class="inline-block px-3 py-1 rounded-md bg-sky-100 text-sky-700 text-xs font-bold uppercase mb-6 tracking-wide border border-sky-200">
                        Nh·∫≠n bi·∫øt
                    </span>
                    
                    <h2 id="ui-question" class="text-2xl md:text-3xl font-bold text-slate-800 mb-8 leading-snug">
                        <!-- Question Text -->
                    </h2>

                    <!-- Image Container (Optional) -->
                    <div id="ui-image-container" class="hidden mb-6 rounded-xl overflow-hidden shadow-md border border-slate-200">
                        <!-- Image injected here if needed -->
                    </div>

                    <div id="ui-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Buttons injected here -->
                    </div>
                </div>
            </div>

            <!-- Feedback Sheet -->
            <div id="feedback-sheet" class="absolute bottom-0 inset-x-0 bg-white border-t-4 border-blue-500 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] p-6 md:p-8 transform translate-y-full transition-transform duration-300 z-30 rounded-t-3xl">
                <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-6 items-start">
                    <div id="fb-icon" class="text-5xl flex-shrink-0 animate-pop"></div>
                    <div class="flex-1">
                        <h3 id="fb-title" class="text-xl font-bold mb-2"></h3>
                        <div class="text-xs font-bold text-slate-400 uppercase mb-1">Gi·∫£i th√≠ch:</div>
                        <p id="fb-rationale" class="text-slate-700 text-lg leading-relaxed mb-3"></p>
                        <div id="fb-hint-box" class="hidden bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm border border-yellow-200">
                            <i class="ph-bold ph-lightbulb mr-1"></i> <span id="fb-hint"></span>
                        </div>
                    </div>
                    <button onclick="Game.next()" class="w-full md:w-auto px-8 py-3 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                        Ti·∫øp T·ª•c <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div id="end-screen" class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center bg-white/95 p-8 text-center">
            <div class="relative mb-8">
                <div class="absolute inset-0 bg-yellow-200 rounded-full animate-ping opacity-50"></div>
                <i class="ph-fill ph-crown text-8xl text-yellow-500 relative z-10 drop-shadow-xl"></i>
            </div>

            <h2 class="text-3xl font-black text-slate-800 mb-2">C√¥ng Tr√¨nh Ho√†n T·∫•t!</h2>
            <p id="end-msg" class="text-lg text-slate-600 mb-8 max-w-md mx-auto">Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc b·∫£n thi·∫øt k·∫ø tri th·ª©c.</p>

            <div class="grid grid-cols-2 gap-4 w-full max-w-sm mb-8">
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <div class="text-xs font-bold text-blue-400 uppercase">T·ªïng ƒêi·ªÉm</div>
                    <div class="text-3xl font-black text-blue-600" id="end-score">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                    <div class="text-xs font-bold text-green-400 uppercase">ƒê√∫ng</div>
                    <div class="text-3xl font-black text-green-600"><span id="end-correct">0</span>/15</div>
                </div>
            </div>

            <button onclick="location.reload()" class="btn-game px-8 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 flex items-center gap-2">
                <i class="ph-bold ph-arrow-counter-clockwise"></i> Ch∆°i L·∫°i
            </button>
        </div>

    </div>

<script>
/* =========================
   UTIL: SHUFFLE (random)
========================= */
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* =========================
   DATABASE (15 c√¢u)
========================= */
const QUESTIONS = [
  // --- NH·∫¨N BI·∫æT (6 c√¢u) ---
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ bao nhi√™u ƒë·ªânh?",
    options: [
      { text: "8 ƒë·ªânh", correct: true, rationale: "Ch√≠nh x√°c! H√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ 8 ƒë·ªânh (4 ƒë·ªânh ·ªü m·∫∑t tr√™n v√† 4 ƒë·ªânh ·ªü m·∫∑t d∆∞·ªõi)." },
      { text: "6 ƒë·ªânh", correct: false, rationale: "Sai. 6 l√† s·ªë m·∫∑t c·ªßa h√¨nh h·ªôp ch·ªØ nh·∫≠t." },
      { text: "12 ƒë·ªânh", correct: false, rationale: "Sai. 12 l√† s·ªë c·∫°nh." },
      { text: "4 ƒë·ªânh", correct: false, rationale: "Qu√° √≠t." }
    ],
    hint: "H√£y t∆∞·ªüng t∆∞·ª£ng m·ªôt vi√™n g·∫°ch ho·∫∑c h·ªôp ph·∫•n v√† ƒë·∫øm c√°c g√≥c nh·ªçn c·ªßa n√≥."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "C√°c m·∫∑t c·ªßa h√¨nh h·ªôp ch·ªØ nh·∫≠t l√† h√¨nh g√¨?",
    options: [
      { text: "H√¨nh ch·ªØ nh·∫≠t", correct: true, rationale: "ƒê√∫ng. Theo ƒë·ªãnh nghƒ©a, h√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ 6 m·∫∑t ƒë·ªÅu l√† h√¨nh ch·ªØ nh·∫≠t." },
      { text: "H√¨nh vu√¥ng", correct: false, rationale: "Ch·ªâ ƒë√∫ng v·ªõi h√¨nh l·∫≠p ph∆∞∆°ng. H√¨nh h·ªôp ch·ªØ nh·∫≠t t·ªïng qu√°t th√¨ l√† h√¨nh ch·ªØ nh·∫≠t." },
      { text: "H√¨nh b√¨nh h√†nh", correct: false, rationale: "Ch∆∞a ch√≠nh x√°c nh·∫•t. D√π h√¨nh ch·ªØ nh·∫≠t l√† h√¨nh b√¨nh h√†nh ƒë·∫∑c bi·ªát, nh∆∞ng t√™n g·ªçi ch√≠nh x√°c nh·∫•t ph·∫£i l√† h√¨nh ch·ªØ nh·∫≠t." },
      { text: "H√¨nh thoi", correct: false, rationale: "Sai." }
    ],
    hint: "T√™n g·ªçi c·ªßa h√¨nh ƒë√£ g·ª£i √Ω c√¢u tr·∫£ l·ªùi: H√¨nh h·ªôp CH·ªÆ NH·∫¨T."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh l·∫≠p ph∆∞∆°ng c√≥ bao nhi√™u c·∫°nh b·∫±ng nhau?",
    options: [
      { text: "12 c·∫°nh", correct: true, rationale: "Ch√≠nh x√°c! H√¨nh l·∫≠p ph∆∞∆°ng c√≥ 12 c·∫°nh v√† t·∫•t c·∫£ c√°c c·∫°nh ƒë·ªÅu c√≥ ƒë·ªô d√†i b·∫±ng nhau." },
      { text: "6 c·∫°nh", correct: false, rationale: "Sai. 6 l√† s·ªë m·∫∑t." },
      { text: "8 c·∫°nh", correct: false, rationale: "Sai." },
      { text: "4 c·∫°nh", correct: false, rationale: "Sai." }
    ],
    hint: "H√¨nh l·∫≠p ph∆∞∆°ng ƒë∆∞·ª£c t·∫°o b·ªüi 6 m·∫∑t l√† c√°c h√¨nh vu√¥ng b·∫±ng nhau."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh l·∫≠p ph∆∞∆°ng c√≥ bao nhi√™u ƒë∆∞·ªùng ch√©o (ƒë∆∞·ªùng ch√©o c·ªßa kh·ªëi)?",
    options: [
      { text: "4 ƒë∆∞·ªùng ch√©o", correct: true, rationale: "ƒê√∫ng. C√≥ 4 ƒë∆∞·ªùng ch√©o n·ªëi c√°c c·∫∑p ƒë·ªânh ƒë·ªëi di·ªán xuy√™n qua t√¢m c·ªßa h√¨nh." },
      { text: "2 ƒë∆∞·ªùng ch√©o", correct: false, rationale: "Sai." },
      { text: "6 ƒë∆∞·ªùng ch√©o", correct: false, rationale: "Sai." },
      { text: "8 ƒë∆∞·ªùng ch√©o", correct: false, rationale: "Sai." }
    ],
    hint: "ƒê∆∞·ªùng ch√©o c·ªßa kh·ªëi n·ªëi 2 ƒë·ªânh ƒë·ªëi di·ªán (kh√¥ng c√πng 1 m·∫∑t). C√≥ 4 c·∫∑p ƒë·ªânh nh∆∞ v·∫≠y."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† <b>ƒë√∫ng</b> v·ªÅ h√¨nh l·∫≠p ph∆∞∆°ng?",
    options: [
      { text: "C√≥ 6 m·∫∑t l√† c√°c h√¨nh vu√¥ng b·∫±ng nhau.", correct: true, rationale: "Ch√≠nh x√°c. ƒê√¢y l√† ƒë·∫∑c ƒëi·ªÉm nh·∫≠n d·∫°ng quan tr·ªçng nh·∫•t c·ªßa h√¨nh l·∫≠p ph∆∞∆°ng." },
      { text: "C√≥ 6 m·∫∑t l√† h√¨nh ch·ªØ nh·∫≠t.", correct: false, rationale: "ƒê√¢y l√† ƒë·∫∑c ƒëi·ªÉm c·ªßa h√¨nh h·ªôp ch·ªØ nh·∫≠t n√≥i chung." },
      { text: "C√≥ c√°c c·∫°nh kh√¥ng b·∫±ng nhau.", correct: false, rationale: "Sai. H√¨nh l·∫≠p ph∆∞∆°ng c√≥ t·∫•t c·∫£ c·∫°nh b·∫±ng nhau." },
      { text: "C√≥ 4 m·∫∑t b√™n l√† h√¨nh ch·ªØ nh·∫≠t, 2 m·∫∑t ƒë√°y l√† h√¨nh vu√¥ng.", correct: false, rationale: "Kh√¥ng ch·∫Øc. M√¥ t·∫£ n√†y c√≥ th·ªÉ l√† h·ªôp ch·ªØ nh·∫≠t c√≥ 2 ƒë√°y vu√¥ng, ch∆∞a ƒë·ªß ƒë·ªÉ k·∫øt lu·∫≠n l√† l·∫≠p ph∆∞∆°ng." }
    ],
    hint: "H√£y nghƒ© ƒë·∫øn con x√∫c x·∫Øc (x√≠ ng·∫ßu)."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "S·ªë m·∫∑t c·ªßa h√¨nh h·ªôp ch·ªØ nh·∫≠t l√†:",
    options: [
      { text: "6 m·∫∑t", correct: true, rationale: "ƒê√∫ng. G·ªìm 2 m·∫∑t ƒë√°y v√† 4 m·∫∑t b√™n." },
      { text: "4 m·∫∑t", correct: false, rationale: "Sai." },
      { text: "8 m·∫∑t", correct: false, rationale: "Sai." },
      { text: "12 m·∫∑t", correct: false, rationale: "Sai." }
    ],
    hint: "Gi·ªëng nh∆∞ con x√∫c x·∫Øc: c√≥ 6 m·∫∑t."
  },

  // --- TH√îNG HI·ªÇU (5 c√¢u) ---
  {
    level: "Th√¥ng hi·ªÉu",
    text: "M·ªôt h√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i 5cm, chi·ªÅu r·ªông 3cm, chi·ªÅu cao 4cm. T·ªïng ƒë·ªô d√†i t·∫•t c·∫£ c√°c c·∫°nh c·ªßa h√¨nh h·ªôp ƒë√≥ l√† bao nhi√™u?",
    options: [
      { text: "48 cm", correct: true, rationale: "Xu·∫•t s·∫Øc! T·ªïng c·∫°nh = 4 √ó (5 + 3 + 4) = 4 √ó 12 = 48 cm." },
      { text: "24 cm", correct: false, rationale: "Sai. B·∫°n c√≥ th·ªÉ ƒë√£ qu√™n nh√¢n 4." },
      { text: "12 cm", correct: false, rationale: "Sai. ƒê√¢y m·ªõi ch·ªâ l√† t·ªïng 3 k√≠ch th∆∞·ªõc." },
      { text: "60 cm", correct: false, rationale: "Sai." }
    ],
    hint: "H√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ 4 c·∫°nh theo m·ªói k√≠ch th∆∞·ªõc."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "N·∫øu m·ªôt h√¨nh l·∫≠p ph∆∞∆°ng c√≥ c·∫°nh b·∫±ng 5cm th√¨ di·ªán t√≠ch m·ªôt m·∫∑t c·ªßa n√≥ l√† bao nhi√™u?",
    options: [
      { text: "$25\\,cm^2$", correct: true, rationale: "ƒê√∫ng. Di·ªán t√≠ch m·∫∑t = $5^2 = 25$." },
      { text: "$20\\,cm^2$", correct: false, rationale: "Sai. $5\\times 4$ l√† chu vi, kh√¥ng ph·∫£i di·ªán t√≠ch." },
      { text: "$125\\,cm^2$", correct: false, rationale: "Sai." },
      { text: "$10\\,cm^2$", correct: false, rationale: "Sai." }
    ],
    hint: "Di·ªán t√≠ch h√¨nh vu√¥ng = c·∫°nh √ó c·∫°nh."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "Cho h√¨nh h·ªôp ch·ªØ nh·∫≠t ABCD.MNPQ. C·∫°nh n√†o song song v·ªõi c·∫°nh AB?",
    options: [
      { text: "C·∫°nh MN", correct: true, rationale: "Ch√≠nh x√°c! AB song song MN." },
      { text: "C·∫°nh AD", correct: false, rationale: "Sai. AB v√† AD c·∫Øt nhau t·∫°i A." },
      { text: "C·∫°nh AM", correct: false, rationale: "Sai. AB v√† AM c·∫Øt nhau t·∫°i A." },
      { text: "C·∫°nh BC", correct: false, rationale: "Sai. AB v√† BC c·∫Øt nhau t·∫°i B." }
    ],
    hint: "C·∫°nh song song l√† c·∫°nh ƒë·ªëi di·ªán v√† kh√¥ng c·∫Øt nhau."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "T·ªïng ƒë·ªô d√†i c√°c c·∫°nh c·ªßa m·ªôt h√¨nh l·∫≠p ph∆∞∆°ng l√† 36cm. ƒê·ªô d√†i m·ªôt c·∫°nh l√†:",
    options: [
      { text: "3 cm", correct: true, rationale: "ƒê√∫ng. C√≥ 12 c·∫°nh n√™n c·∫°nh = $36:12=3$ cm." },
      { text: "6 cm", correct: false, rationale: "Sai. 6 l√† s·ªë m·∫∑t." },
      { text: "4 cm", correct: false, rationale: "Sai." },
      { text: "9 cm", correct: false, rationale: "Sai." }
    ],
    hint: "H√¨nh l·∫≠p ph∆∞∆°ng c√≥ 12 c·∫°nh b·∫±ng nhau."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "Cho h√¨nh h·ªôp ch·ªØ nh·∫≠t ABCD.EFGH. ƒê∆∞·ªùng ch√©o c·ªßa h√¨nh h·ªôp n√†y l√† ƒëo·∫°n th·∫≥ng n√†o?",
    options: [
      { text: "AG", correct: true, rationale: "Ch√≠nh x√°c. AG l√† ƒë∆∞·ªùng ch√©o c·ªßa kh·ªëi (n·ªëi 2 ƒë·ªânh ƒë·ªëi di·ªán)." },
      { text: "AC", correct: false, rationale: "Sai. AC l√† ƒë∆∞·ªùng ch√©o c·ªßa m·∫∑t ƒë√°y." },
      { text: "AF", correct: false, rationale: "Sai. AF l√† ƒë∆∞·ªùng ch√©o c·ªßa m·ªôt m·∫∑t b√™n." },
      { text: "AH", correct: false, rationale: "Sai. AH l√† ƒë∆∞·ªùng ch√©o c·ªßa m·ªôt m·∫∑t b√™n." }
    ],
    hint: "ƒê∆∞·ªùng ch√©o c·ªßa kh·ªëi ƒëi xuy√™n qua trong l√≤ng kh·ªëi."
  },

  // --- V·∫¨N D·ª§NG (3 c√¢u) ---
  {
    level: "V·∫≠n d·ª•ng",
    text: "M·ªôt th√πng h√†ng h√¨nh l·∫≠p ph∆∞∆°ng c√≥ c·∫°nh 0,5m. Bu·ªôc d√¢y vi·ªÅn quanh t·∫•t c·∫£ c√°c c·∫°nh. C·∫ßn √≠t nh·∫•t bao nhi√™u m√©t d√¢y?",
    options: [
      { text: "6 m", correct: true, rationale: "ƒê√∫ng. C√≥ 12 c·∫°nh: $12\\times 0,5=6$ m." },
      { text: "3 m", correct: false, rationale: "Sai. 3m m·ªõi ch·ªâ t∆∞∆°ng ƒë∆∞∆°ng 6 c·∫°nh." },
      { text: "4 m", correct: false, rationale: "Sai." },
      { text: "2 m", correct: false, rationale: "Sai." }
    ],
    hint: "T√≠nh t·ªïng ƒë·ªô d√†i 12 c·∫°nh."
  },
  {
    level: "V·∫≠n d·ª•ng (Th·ª±c t·∫ø)",
    text: "D√°n gi·∫•y m√†u l√™n to√†n b·ªô m·∫∑t ngo√†i c·ªßa h·ªôp qu√† h√¨nh l·∫≠p ph∆∞∆°ng c·∫°nh 10cm. Di·ªán t√≠ch gi·∫•y c·∫ßn d√πng √≠t nh·∫•t l√†:",
    options: [
      { text: "$600\\,cm^2$", correct: true, rationale: "ƒê√∫ng. Di·ªán t√≠ch to√†n ph·∫ßn: $6\\times 10^2 = 600$." },
      { text: "$100\\,cm^2$", correct: false, rationale: "Sai. ƒê√¢y l√† di·ªán t√≠ch 1 m·∫∑t." },
      { text: "$400\\,cm^2$", correct: false, rationale: "Sai. ƒê√¢y l√† di·ªán t√≠ch xung quanh (4 m·∫∑t)." },
      { text: "$1000\\,cm^2$", correct: false, rationale: "Sai. ƒê√¢y kh√¥ng ph·∫£i th·ªÉ t√≠ch." }
    ],
    hint: "C√≥ 6 m·∫∑t b·∫±ng nhau."
  },
  {
    level: "V·∫≠n d·ª•ng",
    text: "M·ªôt cƒÉn ph√≤ng h√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i 6m, chi·ªÅu r·ªông 4m. Chu vi m·∫∑t ƒë√°y l√†:",
    options: [
      { text: "20 m", correct: true, rationale: "ƒê√∫ng. Chu vi ƒë√°y: $(6+4)\\times 2=20$ m." },
      { text: "10 m", correct: false, rationale: "Sai. ƒê√¢y m·ªõi l√† n·ª≠a chu vi." },
      { text: "24 m", correct: false, rationale: "Sai. 24 l√† di·ªán t√≠ch $6\\times 4$." },
      { text: "12 m", correct: false, rationale: "Sai." }
    ],
    hint: "Chu vi h√¨nh ch·ªØ nh·∫≠t: $2(a+b)$."
  },

  // --- V·∫¨N D·ª§NG CAO (1 c√¢u) ---
  {
    level: "V·∫≠n d·ª•ng cao",
    text: "H√¨nh l·∫≠p ph∆∞∆°ng l·ªõn t·∫°o b·ªüi 27 kh·ªëi l·∫≠p ph∆∞∆°ng nh·ªè c·∫°nh 1cm. S∆°n t·∫•t c·∫£ m·∫∑t ngo√†i. H·ªèi c√≥ bao nhi√™u kh·ªëi nh·ªè KH√îNG b·ªã s∆°n m·∫∑t n√†o?",
    options: [
      { text: "1 kh·ªëi", correct: true, rationale: "ƒê√∫ng. Kh·ªëi kh√¥ng b·ªã s∆°n l√† kh·ªëi ·ªü gi·ªØa. V√¨ $27=3^3$, l√µi trong l√† $(3-2)^3=1$ kh·ªëi." },
      { text: "0 kh·ªëi", correct: false, rationale: "Sai." },
      { text: "8 kh·ªëi", correct: false, rationale: "Sai. 8 l√† c√°c kh·ªëi ·ªü 8 g√≥c (b·ªã s∆°n 3 m·∫∑t)." },
      { text: "6 kh·ªëi", correct: false, rationale: "Sai. 6 l√† t√¢m c√°c m·∫∑t (b·ªã s∆°n 1 m·∫∑t)." }
    ],
    hint: "B√≥c l·ªõp v·ªè ngo√†i ƒëi: c√≤n l·∫°i l√µi b√™n trong."
  }
];

/* =========================
   PREP: RANDOM QUESTIONS + OPTIONS
========================= */
const GameData = {
  questions: [],
  prepare() {
    // random c√¢u h·ªèi
    this.questions = shuffleArray(QUESTIONS).map(q => {
      // random ƒë√°p √°n (gi·ªØ ƒë√∫ng/sai theo thu·ªôc t√≠nh correct)
      return { ...q, options: shuffleArray(q.options) };
    });
  }
};

// --- GAME LOGIC ---
const Game = {
  state: { index: 0, score: 0, answered: false },

  start() {
    GameData.prepare();
    this.state = { index: 0, score: 0, answered: false };

    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('end-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('game-screen').classList.add('flex');

    this.render();
  },

  render() {
    this.state.answered = false;
    document.getElementById('feedback-sheet').classList.add('translate-y-full');

    const q = GameData.questions[this.state.index];

    // UI
    document.getElementById('ui-current').innerText = this.state.index + 1;
    document.getElementById('ui-total').innerText = GameData.questions.length;
    document.getElementById('ui-score').innerText = this.state.score;
    document.getElementById('ui-level').innerText = "M·ª©c ƒë·ªô: " + q.level;

    // Progress
    const pct = (this.state.index / GameData.questions.length) * 100;
    document.getElementById('ui-progress').style.width = `${pct}%`;

    // Question
    document.getElementById('ui-question').innerHTML = q.text;

    // Options
    const container = document.getElementById('ui-options');
    container.innerHTML = '';

    q.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = `option-card w-full text-left p-6 rounded-2xl bg-white border-2 border-slate-100 font-medium text-slate-600 flex items-center shadow-sm relative overflow-hidden`;
      btn.innerHTML = `
        <div class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 font-bold flex items-center justify-center mr-4 border border-slate-200 shrink-0">
          ${String.fromCharCode(65 + i)}
        </div>
        <span class="text-lg">${opt.text}</span>
      `;
      btn.onclick = () => this.check(btn, opt, q);
      container.appendChild(btn);
    });

    if (window.MathJax) MathJax.typesetPromise();
  },

  check(btn, opt, q) {
    if (this.state.answered) return;
    this.state.answered = true;

    const allBtns = document.querySelectorAll('.option-card');
    allBtns.forEach(b => b.classList.add('disabled', 'cursor-default'));

    const fbIcon = document.getElementById('fb-icon');
    const fbTitle = document.getElementById('fb-title');
    const hintBox = document.getElementById('fb-hint-box');

    if (opt.correct) {
      this.state.score += 10;
      document.getElementById('ui-score').innerText = this.state.score;

      btn.classList.add('correct');

      fbIcon.innerText = "üéâ";
      fbTitle.innerText = "Tuy·ªát V·ªùi!";
      fbTitle.className = "text-xl font-bold mb-2 text-green-600";
      hintBox.classList.add('hidden');

      this.playSound('win');
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
    } else {
      btn.classList.add('wrong');

      // Highlight correct
      const correctIndex = q.options.findIndex(o => o.correct);
      allBtns[correctIndex].classList.add('correct', 'opacity-70');

      fbIcon.innerText = "ü§î";
      fbTitle.innerText = "Ti·∫øc Qu√°!";
      fbTitle.className = "text-xl font-bold mb-2 text-red-500";

      hintBox.classList.remove('hidden');
      document.getElementById('fb-hint').innerHTML = q.hint;

      this.playSound('lose');
    }

    // d√πng innerHTML ƒë·ªÉ MathJax ƒÉn c·∫£ n·ªôi dung $...$ n·∫øu c√≥
    document.getElementById('fb-rationale').innerHTML = opt.rationale;

    document.getElementById('feedback-sheet').classList.remove('translate-y-full');

    if (window.MathJax) MathJax.typesetPromise();
  },

  next() {
    this.state.index++;
    if (this.state.index < GameData.questions.length) {
      this.render();
    } else {
      this.end();
    }
  },

  end() {
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('end-screen').classList.add('flex');

    document.getElementById('end-score').innerText = this.state.score;
    document.getElementById('end-correct').innerText = Math.round(this.state.score / 10);

    this.playSound('finish');
  },

  playSound(type) {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    if (type === 'win') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(400, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
      osc.start();
      osc.stop(ctx.currentTime + 0.3);
    } else if (type === 'lose') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    } else if (type === 'finish') {
      [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
        setTimeout(() => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.value = freq;
          g.gain.setValueAtTime(0.1, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
          o.start();
          o.stop(ctx.currentTime + 0.5);
        }, i * 150);
      });
    }
  }
};
</script>
</body>
</html>
