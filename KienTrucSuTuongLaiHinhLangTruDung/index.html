<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·∫øn Tr√∫c S∆∞ T∆∞∆°ng Lai: H√¨nh LƒÉng Tr·ª• ƒê·ª©ng</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0fdf4;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2316a34a' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .hand-font {
            font-family: 'Patrick Hand', cursive;
        }

        .camp-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 3px solid #4ade80;
            box-shadow: 8px 8px 0px #15803d;
            border-radius: 24px;
        }

        .btn-option {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-option:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 8px 0 #cbd5e1;
        }
        
        .btn-option:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 0 0 #cbd5e1;
        }

        .btn-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #14532d;
            box-shadow: 0 4px 0 #15803d;
        }

        .btn-option.wrong {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #7f1d1d;
            box-shadow: 0 4px 0 #b91c1c;
        }

        /* Animations */
        @keyframes tent-sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }
        .tent-anim { animation: tent-sway 3s ease-in-out infinite; }

        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- GAME CONTAINER -->
    <div class="w-full max-w-4xl relative min-h-[650px] flex flex-col">
        
        <!-- DECORATIONS -->
        <div class="absolute -top-12 -left-8 text-8xl tent-anim z-0 opacity-80">‚õ∫</div>
        <div class="absolute -bottom-8 -right-8 text-8xl z-0 opacity-80">üå≤</div>

        <!-- MAIN CARD -->
        <div class="camp-card flex-1 flex flex-col overflow-hidden relative z-10 bg-white">
            
            <!-- START SCREEN -->
            <div id="start-screen" class="absolute inset-0 z-30 flex flex-col items-center justify-center p-8 text-center bg-white">
                <div class="mb-4">
                    <i class="ph-fill ph-compass-tool text-green-600 text-7xl"></i>
                </div>
                <h1 class="text-5xl md:text-6xl font-bold text-green-700 mb-2 hand-font">Ki·∫øn Tr√∫c S∆∞ T∆∞∆°ng Lai</h1>
                <h2 class="text-2xl text-gray-600 mb-8 font-medium">Ch·ªß ƒë·ªÅ: H√¨nh LƒÉng Tr·ª• ƒê·ª©ng</h2>
                
                <div class="bg-green-50 p-6 rounded-2xl border-2 border-green-200 max-w-md mb-8">
                    <p class="text-gray-700 text-lg mb-2">Ch√†o m·ª´ng c√°c ki·∫øn tr√∫c s∆∞ nh√≠!</p>
                    <p class="text-gray-600">H√£y tr·∫£ l·ªùi ƒë√∫ng 15 c√¢u h·ªèi ƒë·ªÉ thu th·∫≠p v·∫≠t li·ªáu x√¢y d·ª±ng khu c·∫Øm tr·∫°i trong m∆° nh√©!</p>
                </div>

                <button onclick="Game.start()" class="group relative px-10 py-4 bg-green-600 text-white font-bold rounded-xl text-xl shadow-[0_6px_0_#14532d] active:shadow-none active:translate-y-[6px] transition-all hover:bg-green-500">
                    <span class="flex items-center gap-2">
                        B·∫Øt ƒê·∫ßu Thi·∫øt K·∫ø <i class="ph-bold ph-pencil-simple-line"></i>
                    </span>
                </button>
            </div>

            <!-- GAME SCREEN -->
            <div id="game-screen" class="hidden flex-col h-full bg-stone-50">
                <!-- Header -->
                <div class="bg-green-600 p-4 flex justify-between items-center text-white shadow-md z-20">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center font-bold text-xl border-2 border-white/40">
                            <span id="ui-current">1</span>
                        </div>
                        <div class="leading-tight">
                            <div class="text-xs font-bold text-green-200 uppercase tracking-widest">C√¢u h·ªèi</div>
                            <div class="font-bold">/ <span id="ui-total">15</span></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 bg-black/20 px-4 py-2 rounded-xl">
                        <i class="ph-fill ph-trophy text-yellow-300 text-xl"></i>
                        <span id="ui-score" class="font-bold text-2xl">0</span>
                    </div>
                </div>

                <!-- Progress -->
                <div class="w-full bg-gray-200 h-3">
                    <div id="ui-progress" class="h-full bg-yellow-400 transition-all duration-500" style="width: 0%"></div>
                </div>

                <!-- Question Area -->
                <div class="flex-1 overflow-y-auto p-6 md:p-10 pb-40">
                    <div class="max-w-3xl mx-auto">
                        <span id="ui-level" class="inline-block px-3 py-1 rounded border border-blue-200 bg-blue-50 text-blue-600 text-xs font-bold uppercase tracking-widest mb-4">
                            Nh·∫≠n bi·∫øt
                        </span>
                        
                        <h2 id="ui-question" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 leading-snug font-sans">
                            <!-- Question Text -->
                        </h2>

                        <div id="ui-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Options injected -->
                        </div>
                    </div>
                </div>

                <!-- Feedback Panel -->
                <div id="feedback-panel" class="absolute bottom-0 inset-x-0 bg-white border-t-4 border-green-500 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] p-6 md:p-8 transform translate-y-full transition-transform duration-300 z-30">
                    <div class="max-w-4xl mx-auto flex gap-6 items-start">
                        <div id="fb-icon" class="text-5xl shrink-0 animate-pop"></div>
                        <div class="flex-1">
                            <h3 id="fb-title" class="text-xl font-bold mb-1"></h3>
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">GI·∫¢I TH√çCH</div>
                            <p id="fb-rationale" class="text-gray-700 text-lg leading-relaxed mb-3"></p>
                            <div id="fb-hint-container" class="hidden bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm border border-yellow-200 flex items-start">
                                <i class="ph-bold ph-lightbulb text-xl mr-2 mt-0.5"></i>
                                <span id="fb-hint"></span>
                            </div>
                        </div>
                        <button onclick="Game.next()" class="shrink-0 bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition-transform hover:scale-105 active:scale-95 flex items-center gap-2">
                            Ti·∫øp T·ª•c <i class="ph-bold ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- END SCREEN -->
            <div id="end-screen" class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center p-8 text-center bg-white">
                <div class="relative mb-6">
                    <div class="absolute inset-0 bg-yellow-200 rounded-full animate-ping opacity-75"></div>
                    <i class="ph-fill ph-house-line text-8xl text-green-600 relative z-10"></i>
                </div>

                <h2 class="text-3xl font-bold text-gray-800 mb-2 hand-font">C√¥ng Tr√¨nh Ho√†n Thi·ªán!</h2>
                <p id="end-msg" class="text-gray-500 mb-8 text-lg">B·∫°n ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c v·ªÅ h√¨nh lƒÉng tr·ª•.</p>

                <div class="grid grid-cols-2 gap-4 w-full max-w-sm mb-8">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <div class="text-xs font-bold text-green-500 uppercase">ƒêi·ªÉm s·ªë</div>
                        <div class="text-3xl font-black text-green-700" id="end-score">0</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <div class="text-xs font-bold text-blue-500 uppercase">ƒê√∫ng</div>
                        <div class="text-3xl font-black text-blue-700"><span id="end-correct">0</span>/15</div>
                    </div>
                </div>

                <button onclick="location.reload()" class="px-8 py-3 bg-gray-800 text-white font-bold rounded-full shadow-lg hover:bg-black transition-all flex items-center gap-2">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i> Ch∆°i L·∫°i
                </button>
            </div>
        </div>
    </div>

<script>
/* =========================
   UTIL: SHUFFLE (random)
========================= */
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* =========================
   PREP QUESTIONS:
   - Random th·ª© t·ª± c√¢u h·ªèi
   - Random ƒë√°p √°n
   - C√ÇN B·∫∞NG ƒë√°p √°n ƒë√∫ng A/B/C/D (g·∫ßn ƒë·ªÅu nh·∫•t)
========================= */
function prepareQuestions(rawQuestions) {
  // 1) random th·ª© t·ª± c√¢u h·ªèi
  const qs = shuffleArray(rawQuestions).map(q => ({ ...q }));

  // 2) c√¢n b·∫±ng v·ªã tr√≠ ƒë√°p √°n ƒë√∫ng A/B/C/D
  const counts = [0, 0, 0, 0]; // A,B,C,D

  return qs.map(q => {
    const correctOpt = q.options.find(o => o.correct);
    const wrongOpts = q.options.filter(o => !o.correct);

    // ƒë·∫£o ng·∫´u nhi√™n c√°c ƒë√°p √°n sai ƒë·ªÉ m·ªói l·∫ßn ch∆°i kh√°c nhau
    const wrongShuffled = shuffleArray(wrongOpts);

    // ch·ªçn v·ªã tr√≠ cho ƒë√°p √°n ƒë√∫ng: n∆°i ƒëang √≠t nh·∫•t (ƒë·ªÉ chia ƒë·ªÅu)
    const minCount = Math.min(...counts);
    const candidates = counts
      .map((c, idx) => ({ c, idx }))
      .filter(x => x.c === minCount)
      .map(x => x.idx);

    const correctPos = candidates[Math.floor(Math.random() * candidates.length)];
    counts[correctPos]++;

    // d·ª±ng l·∫°i m·∫£ng options 4 ph·∫ßn t·ª≠
    const newOptions = new Array(4);
    newOptions[correctPos] = { ...correctOpt, correct: true };

    let wi = 0;
    for (let i = 0; i < 4; i++) {
      if (!newOptions[i]) {
        newOptions[i] = { ...wrongShuffled[wi], correct: false };
        wi++;
      }
    }

    return { ...q, options: newOptions };
  });
}

/* =========================
   DATABASE (gi·ªØ nguy√™n n·ªôi dung c√¢u h·ªèi c·ªßa c√¥)
========================= */
const QUESTIONS_RAW = [
  // --- NH·∫¨N BI·∫æT (6 c√¢u) ---
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c c√≥ hai m·∫∑t ƒë√°y l√† h√¨nh g√¨?",
    options: [
      { text: "H√¨nh tam gi√°c", correct: true, rationale: "Ch√≠nh x√°c! T√™n g·ªçi 'lƒÉng tr·ª• ƒë·ª©ng tam gi√°c' xu·∫•t ph√°t t·ª´ vi·ªác ƒë√°y c·ªßa n√≥ l√† h√¨nh tam gi√°c." },
      { text: "H√¨nh ch·ªØ nh·∫≠t", correct: false, rationale: "Sai. H√¨nh ch·ªØ nh·∫≠t l√† h√¨nh d·∫°ng c·ªßa c√°c m·∫∑t b√™n." },
      { text: "H√¨nh vu√¥ng", correct: false, rationale: "Sai." },
      { text: "H√¨nh b√¨nh h√†nh", correct: false, rationale: "Sai." }
    ],
    hint: "H√£y nh√¨n v√†o t√™n g·ªçi c·ªßa h√¨nh: LƒÉng tr·ª• ƒë·ª©ng TAM GI√ÅC."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "C√°c m·∫∑t b√™n c·ªßa h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c v√† t·ª© gi√°c l√† h√¨nh g√¨?",
    options: [
      { text: "H√¨nh ch·ªØ nh·∫≠t", correct: true, rationale: "ƒê√∫ng. Trong h√¨nh lƒÉng tr·ª• ƒê·ª®NG, c√°c m·∫∑t b√™n lu√¥n l√† h√¨nh ch·ªØ nh·∫≠t vu√¥ng g√≥c v·ªõi ƒë√°y." },
      { text: "H√¨nh tam gi√°c", correct: false, rationale: "Sai. M·∫∑t b√™n l√† h√¨nh ch·ªØ nh·∫≠t, ch·ªâ c√≥ ƒë√°y m·ªõi c√≥ th·ªÉ l√† tam gi√°c." },
      { text: "H√¨nh b√¨nh h√†nh", correct: false, rationale: "Ch∆∞a ch√≠nh x√°c. V·ªõi lƒÉng tr·ª• xi√™n th√¨ l√† h√¨nh b√¨nh h√†nh, nh∆∞ng ƒë√¢y l√† lƒÉng tr·ª• ƒê·ª®NG." },
      { text: "H√¨nh thoi", correct: false, rationale: "Sai." }
    ],
    hint: "H√£y t∆∞·ªüng t∆∞·ª£ng c√°c b·ª©c t∆∞·ªùng th·∫≥ng ƒë·ª©ng c·ªßa m·ªôt ng√¥i nh√†."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh lƒÉng tr·ª• ƒë·ª©ng t·ª© gi√°c c√≥ bao nhi√™u ƒë·ªânh?",
    options: [
      { text: "8 ƒë·ªânh", correct: true, rationale: "Ch√≠nh x√°c! G·ªìm 4 ƒë·ªânh ·ªü ƒë√°y tr√™n v√† 4 ƒë·ªânh ·ªü ƒë√°y d∆∞·ªõi." },
      { text: "6 ƒë·ªânh", correct: false, rationale: "Sai. ƒê√¢y l√† s·ªë ƒë·ªânh c·ªßa lƒÉng tr·ª• tam gi√°c." },
      { text: "12 ƒë·ªânh", correct: false, rationale: "Sai. ƒê√¢y l√† s·ªë c·∫°nh." },
      { text: "10 ƒë·ªânh", correct: false, rationale: "Sai." }
    ],
    hint: "ƒê√°y l√† t·ª© gi√°c (4 ƒë·ªânh). C√≥ 2 ƒë√°y n√™n nh√¢n ƒë√¥i l√™n."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "Trong h√¨nh lƒÉng tr·ª• ƒë·ª©ng, ƒë·ªô d√†i c·∫°nh b√™n ƒë∆∞·ª£c g·ªçi l√†:",
    options: [
      { text: "Chi·ªÅu cao", correct: true, rationale: "ƒê√∫ng. V√¨ l√† lƒÉng tr·ª• ƒê·ª®NG n√™n c·∫°nh b√™n vu√¥ng g√≥c v·ªõi ƒë√°y, ƒë·ªô d√†i c·∫°nh b√™n ch√≠nh l√† chi·ªÅu cao." },
      { text: "Chu vi ƒë√°y", correct: false, rationale: "Sai." },
      { text: "ƒê∆∞·ªùng ch√©o", correct: false, rationale: "Sai." },
      { text: "Di·ªán t√≠ch ƒë√°y", correct: false, rationale: "Sai." }
    ],
    hint: "N√≥ th·ªÉ hi·ªán ƒë·ªô 'cao' c·ªßa h√¨nh lƒÉng tr·ª•."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c c√≥ bao nhi√™u m·∫∑t?",
    options: [
      { text: "5 m·∫∑t", correct: true, rationale: "Ch√≠nh x√°c! G·ªìm 2 m·∫∑t ƒë√°y v√† 3 m·∫∑t b√™n (t·ªïng c·ªông l√† 5)." },
      { text: "6 m·∫∑t", correct: false, rationale: "Sai. ƒê√¢y l√† s·ªë m·∫∑t c·ªßa lƒÉng tr·ª• t·ª© gi√°c." },
      { text: "4 m·∫∑t", correct: false, rationale: "Sai. ƒê√¢y l√† h√¨nh ch√≥p tam gi√°c (t·ª© di·ªán)." },
      { text: "3 m·∫∑t", correct: false, rationale: "Sai." }
    ],
    hint: "ƒê·∫øm: 2 ƒë√°y + 3 m·∫∑t b√™n."
  },
  {
    level: "Nh·∫≠n bi·∫øt",
    text: "H√¨nh h·ªôp ch·ªØ nh·∫≠t v√† h√¨nh l·∫≠p ph∆∞∆°ng c√≥ ph·∫£i l√† h√¨nh lƒÉng tr·ª• ƒë·ª©ng t·ª© gi√°c kh√¥ng?",
    options: [
      { text: "C√≥", correct: true, rationale: "ƒê√∫ng. Ch√∫ng l√† c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát c·ªßa h√¨nh lƒÉng tr·ª• ƒë·ª©ng t·ª© gi√°c (khi ƒë√°y l√† hcn ho·∫∑c h√¨nh vu√¥ng)." },
      { text: "Kh√¥ng", correct: false, rationale: "Sai. Ch√∫ng th·ªèa m√£n m·ªçi ƒë·ªãnh nghƒ©a c·ªßa lƒÉng tr·ª• ƒë·ª©ng t·ª© gi√°c." },
      { text: "Ch·ªâ h√¨nh l·∫≠p ph∆∞∆°ng ph·∫£i", correct: false, rationale: "Sai." },
      { text: "Ch·ªâ h√¨nh h·ªôp ch·ªØ nh·∫≠t ph·∫£i", correct: false, rationale: "Sai." }
    ],
    hint: "Xem l·∫°i ƒë·ªãnh nghƒ©a ƒë√°y v√† m·∫∑t b√™n c·ªßa ch√∫ng."
  },

  // --- TH√îNG HI·ªÇU (5 c√¢u) ---
  {
    level: "Th√¥ng hi·ªÉu",
    text: "Cho h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c ABC.DEF. C·∫°nh b√™n AD vu√¥ng g√≥c v·ªõi c·∫°nh n√†o sau ƒë√¢y?",
    options: [
      { text: "C·∫°nh AB", correct: true, rationale: "Tuy·ªát v·ªùi! Do l√† lƒÉng tr·ª• ƒë·ª©ng n√™n c·∫°nh b√™n AD vu√¥ng g√≥c v·ªõi m·ªçi c·∫°nh n·∫±m trong m·∫∑t ƒë√°y (nh∆∞ AB, AC)." },
      { text: "C·∫°nh BE", correct: false, rationale: "Sai. AD song song v·ªõi BE." },
      { text: "C·∫°nh CF", correct: false, rationale: "Sai. AD song song v·ªõi CF." },
      { text: "C·∫°nh EF", correct: false, rationale: "Sai." }
    ],
    hint: "C·∫°nh b√™n vu√¥ng g√≥c v·ªõi m·∫∑t ƒë√°y, n√™n n√≥ vu√¥ng g√≥c v·ªõi c√°c c·∫°nh c·ªßa ƒë√°y."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "M·ªôt h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c c√≥ chi·ªÅu cao $h = 10cm$, chu vi ƒë√°y $C = 12cm$. Di·ªán t√≠ch xung quanh c·ªßa n√≥ l√†:",
    options: [
      { text: "$120 \\, cm^2$", correct: true, rationale: "ƒê√∫ng. $S_{xq} = C_{ƒë√°y} \\cdot h = 12 \\cdot 10 = 120$." },
      { text: "$60 \\, cm^2$", correct: false, rationale: "Sai." },
      { text: "$1200 \\, cm^2$", correct: false, rationale: "Sai." },
      { text: "$22 \\, cm^2$", correct: false, rationale: "Sai." }
    ],
    hint: "C√¥ng th·ª©c: Di·ªán t√≠ch xung quanh = Chu vi ƒë√°y √ó Chi·ªÅu cao."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "Hai ƒë√°y c·ªßa h√¨nh lƒÉng tr·ª• ƒë·ª©ng l√† hai ƒëa gi√°c c√≥ ƒë·∫∑c ƒëi·ªÉm g√¨?",
    options: [
      { text: "B·∫±ng nhau v√† n·∫±m tr√™n hai m·∫∑t ph·∫≥ng song song", correct: true, rationale: "Ch√≠nh x√°c. ƒê√¢y l√† t√≠nh ch·∫•t c∆° b·∫£n c·ªßa ƒë√°y lƒÉng tr·ª•." },
      { text: "Kh√°c nhau v√† n·∫±m tr√™n hai m·∫∑t ph·∫≥ng song song", correct: false, rationale: "Sai." },
      { text: "B·∫±ng nhau v√† vu√¥ng g√≥c v·ªõi nhau", correct: false, rationale: "Sai." },
      { text: "Kh√°c nhau v√† c·∫Øt nhau", correct: false, rationale: "Sai." }
    ],
    hint: "Hai ƒë√°y gi·ªëng nh∆∞ s√†n nh√† v√† tr·∫ßn nh√†."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "H√¨nh lƒÉng tr·ª• ƒë·ª©ng t·ª© gi√°c c√≥ bao nhi√™u c·∫°nh?",
    options: [
      { text: "12 c·∫°nh", correct: true, rationale: "ƒê√∫ng. 4 c·∫°nh ƒë√°y tr√™n + 4 c·∫°nh ƒë√°y d∆∞·ªõi + 4 c·∫°nh b√™n = 12 c·∫°nh." },
      { text: "8 c·∫°nh", correct: false, rationale: "Sai. ƒê√¢y l√† s·ªë ƒë·ªânh." },
      { text: "10 c·∫°nh", correct: false, rationale: "Sai." },
      { text: "16 c·∫°nh", correct: false, rationale: "Sai." }
    ],
    hint: "ƒê·∫øm: (4+4) + 4."
  },
  {
    level: "Th√¥ng hi·ªÉu",
    text: "Khi tr·∫£i ph·∫≥ng m·ªôt h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c, ta s·∫Ω thu ƒë∆∞·ª£c:",
    options: [
      { text: "3 h√¨nh ch·ªØ nh·∫≠t v√† 2 h√¨nh tam gi√°c", correct: true, rationale: "Ch√≠nh x√°c. 3 h√¨nh ch·ªØ nh·∫≠t l√† 3 m·∫∑t b√™n, 2 tam gi√°c l√† 2 ƒë√°y." },
      { text: "3 h√¨nh tam gi√°c v√† 2 h√¨nh ch·ªØ nh·∫≠t", correct: false, rationale: "Sai." },
      { text: "5 h√¨nh ch·ªØ nh·∫≠t", correct: false, rationale: "Sai." },
      { text: "4 h√¨nh tam gi√°c", correct: false, rationale: "Sai." }
    ],
    hint: "3 m·∫∑t b√™n + 2 m·∫∑t ƒë√°y."
  },

  // --- V·∫¨N D·ª§NG (3 c√¢u) ---
  {
    level: "V·∫≠n d·ª•ng",
    text: "M·ªôt h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c c√≥ ƒë·ªô d√†i ba c·∫°nh ƒë√°y l√† 3cm, 4cm, 5cm v√† chi·ªÅu cao l√† 6cm. T·ªïng ƒë·ªô d√†i t·∫•t c·∫£ c√°c c·∫°nh c·ªßa h√¨nh lƒÉng tr·ª• ƒë√≥ l√†:",
    options: [
      { text: "42 cm", correct: true, rationale: "ƒê√∫ng! Chu vi 1 ƒë√°y = 12. Hai ƒë√°y = 24. Ba c·∫°nh b√™n = $3\\cdot 6=18$. T·ªïng = 42." },
      { text: "24 cm", correct: false, rationale: "Sai." },
      { text: "18 cm", correct: false, rationale: "Sai." },
      { text: "30 cm", correct: false, rationale: "Sai." }
    ],
    hint: "T·ªïng c·∫°nh = 2√ó(chu vi ƒë√°y) + 3√ó(chi·ªÅu cao)."
  },
  {
    level: "V·∫≠n d·ª•ng th·ª±c t·∫ø",
    text: "M·ªôt chi·∫øc l·ªÅu c·∫Øm tr·∫°i c√≥ d·∫°ng h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c. M·∫∑t s√†n l√† h√¨nh ch·ªØ nh·∫≠t hay h√¨nh tam gi√°c?",
    options: [
      { text: "H√¨nh ch·ªØ nh·∫≠t", correct: true, rationale: "ƒê√∫ng trong m√¥ h√¨nh l·ªÅu ph·ªï bi·∫øn: l·ªÅu th∆∞·ªùng ƒë·∫∑t n·∫±m ngang, m·∫∑t ti·∫øp x√∫c ƒë·∫•t l√† m·ªôt m·∫∑t b√™n (h√¨nh ch·ªØ nh·∫≠t)." },
      { text: "H√¨nh tam gi√°c", correct: false, rationale: "Sai (th∆∞·ªùng kh√¥ng d·ª±ng l·ªÅu ƒë·ª©ng tr√™n m·∫∑t tam gi√°c)." },
      { text: "H√¨nh tr√≤n", correct: false, rationale: "Sai." },
      { text: "H√¨nh vu√¥ng", correct: false, rationale: "Sai." }
    ],
    hint: "L·ªÅu th∆∞·ªùng ‚Äún·∫±m‚Äù tr√™n m·∫∑t ƒë·∫•t, n√™n s√†n l√† m·∫∑t b√™n."
  },
  {
    level: "V·∫≠n d·ª•ng",
    text: "M·ªôt cu·ªën l·ªãch ƒë·ªÉ b√†n d·∫°ng ch·ªØ A c√≥ h√¨nh lƒÉng tr·ª• ƒë·ª©ng tam gi√°c. Ph·∫ßn gi·∫•y b√¨a c·ª©ng l√†m khung l·ªãch t∆∞∆°ng ·ª©ng v·ªõi b·ªô ph·∫≠n n√†o c·ªßa lƒÉng tr·ª•?",
    options: [
      { text: "C√°c m·∫∑t b√™n", correct: true, rationale: "ƒê√∫ng. Khung l·ªãch t·∫°o b·ªüi c√°c m·∫∑t ch·ªØ nh·∫≠t (m·∫∑t b√™n) gh√©p l·∫°i." },
      { text: "Hai m·∫∑t ƒë√°y", correct: false, rationale: "Sai. Hai ƒë√°y l√† 2 tam gi√°c ·ªü hai ƒë·∫ßu." },
      { text: "C√°c c·∫°nh b√™n", correct: false, rationale: "Sai." },
      { text: "Chi·ªÅu cao", correct: false, rationale: "Sai." }
    ],
    hint: "B√¨a t·∫°o th√†nh c√°c ‚Äúm·∫∑t‚Äù ph·∫≥ng l·ªõn c·ªßa l·ªãch."
  },

  // --- V·∫¨N D·ª§NG CAO (1 c√¢u) ---
  {
    level: "V·∫≠n d·ª•ng cao",
    text: "M·ªôt h√¨nh lƒÉng tr·ª• ƒë·ª©ng c√≥ ƒë√°y l√† m·ªôt ƒëa gi√°c $n$ c·∫°nh ($n > 3$). S·ªë c·∫°nh c·ªßa h√¨nh lƒÉng tr·ª• n√†y l√† bao nhi√™u?",
    options: [
      { text: "$3n$", correct: true, rationale: "ƒê√∫ng. C·∫°nh = $n$ (ƒë√°y tr√™n) + $n$ (ƒë√°y d∆∞·ªõi) + $n$ (c·∫°nh b√™n) = $3n$." },
      { text: "$2n$", correct: false, rationale: "Sai. $2n$ l√† s·ªë ƒë·ªânh." },
      { text: "$n + 2$", correct: false, rationale: "Sai. ƒê√¢y l√† s·ªë m·∫∑t: $n$ m·∫∑t b√™n + 2 ƒë√°y." },
      { text: "$n^2$", correct: false, rationale: "Sai." }
    ],
    hint: "C·ªông c·∫°nh c·ªßa 2 ƒë√°y v√† c·∫°nh b√™n."
  }
];

// ‚úÖ danh s√°ch d√πng trong game: ƒë√£ random + c√¢n ABCD
const QUESTIONS = prepareQuestions(QUESTIONS_RAW);

/* =========================
   GAME LOGIC
========================= */
const Game = {
  state: { index: 0, score: 0, answered: false },

  start() {
    this.state = { index: 0, score: 0, answered: false };
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('end-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('game-screen').classList.add('flex');
    this.render();
  },

  render() {
    this.state.answered = false;
    document.getElementById('feedback-panel').classList.add('translate-y-full');

    const q = QUESTIONS[this.state.index];

    // Stats
    document.getElementById('ui-current').innerText = this.state.index + 1;
    document.getElementById('ui-total').innerText = QUESTIONS.length;
    document.getElementById('ui-score').innerText = this.state.score;
    document.getElementById('ui-level').innerText = "M·ª©c ƒë·ªô: " + q.level;

    // Progress
    const pct = (this.state.index / QUESTIONS.length) * 100;
    document.getElementById('ui-progress').style.width = `${pct}%`;

    // Question
    document.getElementById('ui-question').innerHTML = q.text;

    // Options
    const container = document.getElementById('ui-options');
    container.innerHTML = '';

    q.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      // ‚úÖ th√™m class group ƒë·ªÉ group-hover ho·∫°t ƒë·ªông
      btn.className = `btn-option group w-full p-6 text-left rounded-2xl bg-white border-2 border-stone-100 font-medium text-stone-600 flex items-center shadow-sm`;

      btn.innerHTML = `
        <div class="w-10 h-10 rounded-lg bg-green-50 text-green-600 font-bold flex items-center justify-center mr-4 border border-green-200 shrink-0 group-hover:bg-green-600 group-hover:text-white transition-colors">
          ${String.fromCharCode(65 + i)}
        </div>
        <span class="text-lg">${opt.text}</span>
      `;
      btn.onclick = () => this.check(btn, opt, q);
      container.appendChild(btn);
    });

    if (window.MathJax) MathJax.typesetPromise();
  },

  check(btn, opt, q) {
    if (this.state.answered) return;
    this.state.answered = true;

    const allBtns = document.querySelectorAll('.btn-option');
    // ‚úÖ disable th·∫≠t ƒë·ªÉ kh√¥ng hover/nh·∫•n n·ªØa
    allBtns.forEach(b => b.disabled = true);

    const fbIcon = document.getElementById('fb-icon');
    const fbTitle = document.getElementById('fb-title');
    const hintBox = document.getElementById('fb-hint-container');

    if (opt.correct) {
      this.state.score += 10;
      document.getElementById('ui-score').innerText = this.state.score;

      btn.classList.add('correct');

      fbIcon.innerText = "üéâ";
      fbTitle.innerText = "Ch√≠nh X√°c! C√¥ Khen!";
      fbTitle.className = "text-xl font-bold mb-1 text-green-600";
      hintBox.classList.add('hidden');

      this.playSound('win');
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
    } else {
      btn.classList.add('wrong');

      // Highlight correct
      const correctIndex = q.options.findIndex(o => o.correct);
      allBtns[correctIndex].classList.add('correct', 'opacity-75');

      fbIcon.innerText = "ü§î";
      fbTitle.innerText = "Ti·∫øc Qu√°!";
      fbTitle.className = "text-xl font-bold mb-1 text-red-500";

      hintBox.classList.remove('hidden');
      document.getElementById('fb-hint').innerText = q.hint;

      this.playSound('lose');
    }

    // ‚úÖ ƒë·ªïi innerText -> innerHTML ƒë·ªÉ LaTeX/HTML render t·ªët
    document.getElementById('fb-rationale').innerHTML = opt.rationale;

    document.getElementById('feedback-panel').classList.remove('translate-y-full');

    if (window.MathJax) MathJax.typesetPromise();
  },

  next() {
    this.state.index++;
    if (this.state.index < QUESTIONS.length) this.render();
    else this.end();
  },

  end() {
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('end-screen').classList.add('flex');

    document.getElementById('end-score').innerText = this.state.score;
    document.getElementById('end-correct').innerText = Math.round(this.state.score / 10);

    const msg = document.getElementById('end-msg');
    if (this.state.score >= 130) msg.innerText = "Ki·∫øn tr√∫c s∆∞ t√†i ba! B·∫£n thi·∫øt k·∫ø c·ªßa em r·∫•t ho√†n h·∫£o! üèóÔ∏è";
    else if (this.state.score >= 100) msg.innerText = "Em l√†m t·ªët l·∫Øm! Khu c·∫Øm tr·∫°i s·∫Øp ho√†n th√†nh r·ªìi! ‚õ∫";
    else msg.innerText = "C·ªë g·∫Øng √¥n l·∫°i c√°c ƒë·∫∑c ƒëi·ªÉm h√¨nh lƒÉng tr·ª• nh√©! üìê";

    this.playSound('finish');
  },

  playSound(type) {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    if (type === 'win') {
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(523, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
      osc.start();
      osc.stop(ctx.currentTime + 0.3);
    } else if (type === 'lose') {
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    } else if (type === 'finish') {
      [523, 659, 783, 1046].forEach((f, i) => {
        setTimeout(() => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.type = 'sine';
          o.frequency.value = f;
          g.gain.setValueAtTime(0.1, ctx.currentTime);
          g.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
          o.start();
          o.stop(ctx.currentTime + 0.3);
        }, i * 150);
      });
    }
  }
};
</script>
</body>
</html>
