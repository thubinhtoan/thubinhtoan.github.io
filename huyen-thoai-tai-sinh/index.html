import React, { useState, useEffect } from 'react';
import { Sparkles, Flame, Zap, Crown, Play, RotateCcw, Music, VolumeX } from 'lucide-react';

// --- D·ªÆ LI·ªÜU C√ÇU H·ªéI (15 C√¢u - To√°n 8 B√†i 4: H√¨nh B√¨nh H√†nh) ---
const questions = [
  // M·ª©c ƒë·ªô: Nh·∫≠n bi·∫øt (6 c√¢u)
  {
    id: 1,
    level: "Nh·∫≠n bi·∫øt",
    question: "H√¨nh b√¨nh h√†nh l√† t·ª© gi√°c c√≥:",
    options: [
      "Hai c·∫∑p c·∫°nh ƒë·ªëi song song",
      "Hai c·∫∑p c·∫°nh ƒë·ªëi c·∫Øt nhau",
      "B·ªën c·∫°nh b·∫±ng nhau",
      "B·ªën g√≥c b·∫±ng nhau"
    ],
    correct: 0 // A
  },
  {
    id: 2,
    level: "Nh·∫≠n bi·∫øt",
    question: "Trong h√¨nh b√¨nh h√†nh, kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng v·ªÅ c√°c c·∫°nh?",
    options: [
      "C√°c c·∫°nh k·ªÅ b·∫±ng nhau",
      "C√°c c·∫°nh ƒë·ªëi b·∫±ng nhau",
      "B·ªën c·∫°nh ƒë·ªÅu b·∫±ng nhau",
      "Ch·ªâ c√≥ m·ªôt c·∫∑p c·∫°nh ƒë·ªëi b·∫±ng nhau"
    ],
    correct: 1 // B
  },
  {
    id: 3,
    level: "Nh·∫≠n bi·∫øt",
    question: "Trong h√¨nh b√¨nh h√†nh ABCD, hai ƒë∆∞·ªùng ch√©o AC v√† BD c√≥ t√≠nh ch·∫•t g√¨?",
    options: [
      "B·∫±ng nhau",
      "Vu√¥ng g√≥c v·ªõi nhau",
      "C·∫Øt nhau t·∫°i trung ƒëi·ªÉm m·ªói ƒë∆∞·ªùng",
      "Kh√¥ng c·∫Øt nhau"
    ],
    correct: 2 // C
  },
  {
    id: 4,
    level: "Nh·∫≠n bi·∫øt",
    question: "Trong h√¨nh b√¨nh h√†nh, c√°c g√≥c ƒë·ªëi c√≥ t√≠nh ch·∫•t n√†o?",
    options: [
      "B√π nhau",
      "Ph·ª• nhau",
      "H∆°n k√©m nhau 90 ƒë·ªô",
      "B·∫±ng nhau"
    ],
    correct: 3 // D
  },
  {
    id: 5,
    level: "Nh·∫≠n bi·∫øt",
    question: "D·∫•u hi·ªáu nh·∫≠n bi·∫øt n√†o sau ƒë√¢y KH√îNG d√πng ƒë·ªÉ ch·ª©ng minh m·ªôt t·ª© gi√°c l√† h√¨nh b√¨nh h√†nh?",
    options: [
      "T·ª© gi√°c c√≥ hai ƒë∆∞·ªùng ch√©o vu√¥ng g√≥c",
      "T·ª© gi√°c c√≥ c√°c c·∫°nh ƒë·ªëi song song",
      "T·ª© gi√°c c√≥ c√°c c·∫°nh ƒë·ªëi b·∫±ng nhau",
      "T·ª© gi√°c c√≥ hai ƒë∆∞·ªùng ch√©o c·∫Øt nhau t·∫°i trung ƒëi·ªÉm m·ªói ƒë∆∞·ªùng"
    ],
    correct: 0 // A (kh√¥ng ph·∫£i d·∫•u hi·ªáu h√¨nh b√¨nh h√†nh)
  },
  {
    id: 6,
    level: "Nh·∫≠n bi·∫øt",
    question: "T·ª© gi√°c ABCD c√≥ AB = CD v√† AB // CD th√¨ ABCD l√† h√¨nh g√¨?",
    options: [
      "H√¨nh thang c√¢n",
      "H√¨nh b√¨nh h√†nh",
      "H√¨nh ch·ªØ nh·∫≠t",
      "H√¨nh thang vu√¥ng"
    ],
    correct: 1 // B (h√¨nh b√¨nh h√†nh)
  },

  // M·ª©c ƒë·ªô: Th√¥ng hi·ªÉu (5 c√¢u)
  {
    id: 7,
    level: "Th√¥ng hi·ªÉu",
    question: "Cho h√¨nh b√¨nh h√†nh ABCD c√≥ g√≥c A = 100 ƒë·ªô. S·ªë ƒëo g√≥c C l√†:",
    options: [
      "80 ƒë·ªô",
      "50 ƒë·ªô",
      "100 ƒë·ªô",
      "180 ƒë·ªô"
    ],
    correct: 2 // C
  },
  {
    id: 8,
    level: "Th√¥ng hi·ªÉu",
    question: "Cho h√¨nh b√¨nh h√†nh ABCD c√≥ g√≥c A = 60 ƒë·ªô. S·ªë ƒëo g√≥c B l√†:",
    options: [
      "60 ƒë·ªô",
      "30 ƒë·ªô",
      "90 ƒë·ªô",
      "120 ƒë·ªô"
    ],
    correct: 3 // D (g√≥c k·ªÅ b√π 180 - 60)
  },
  {
    id: 9,
    level: "Th√¥ng hi·ªÉu",
    question: "Cho h√¨nh b√¨nh h√†nh ABCD c√≥ chu vi l√† 20cm, c·∫°nh AB = 4cm. ƒê·ªô d√†i c·∫°nh BC l√†:",
    options: [
      "6 cm",
      "16 cm",
      "4 cm",
      "10 cm"
    ],
    correct: 0 // A (2(AB+BC)=20 ‚áí BC=6)
  },
  {
    id: 10,
    level: "Th√¥ng hi·ªÉu",
    question: "Cho h√¨nh b√¨nh h√†nh MNPQ. N·∫øu g√≥c M = 110 ƒë·ªô th√¨ s·ªë ƒëo g√≥c N l√†:",
    options: [
      "110 ƒë·ªô",
      "70 ƒë·ªô",
      "90 ƒë·ªô",
      "55 ƒë·ªô"
    ],
    correct: 1 // B (g√≥c k·ªÅ b√π: 180 - 110)
  },
  {
    id: 11,
    level: "Th√¥ng hi·ªÉu",
    question: "M·ªôt m·∫£nh v∆∞·ªùn h√¨nh b√¨nh h√†nh c√≥ ƒë·ªô d√†i m·ªôt c·∫°nh l√† 15m, c·∫°nh k·ªÅ v·ªõi n√≥ d√†i h∆°n n√≥ 5m. Chu vi m·∫£nh v∆∞·ªùn l√†:",
    options: [
      "35 m",
      "80 m",
      "70 m",
      "40 m"
    ],
    correct: 2 // C (c·∫°nh k·ªÅ 20m, P=2(15+20)=70)
  },

  // M·ª©c ƒë·ªô: V·∫≠n d·ª•ng (3 c√¢u)
  {
    id: 12,
    level: "V·∫≠n d·ª•ng",
    question: "Cho tam gi√°c ABC. G·ªçi M, N, P l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB, AC, BC. T·ª© gi√°c BMNP l√† h√¨nh g√¨?",
    options: [
      "H√¨nh thoi",
      "H√¨nh thang c√¢n",
      "H√¨nh ch·ªØ nh·∫≠t",
      "H√¨nh b√¨nh h√†nh"
    ],
    correct: 3 // D (t·ª© gi√°c trung ƒëi·ªÉm l√† h√¨nh b√¨nh h√†nh)
  },
  {
    id: 13,
    level: "V·∫≠n d·ª•ng (Th·ª±c t·∫ø)",
    question: "C·∫•u tr√∫c khung c·ªßa m·ªôt chi·∫øc c·ªïng x·∫øp t·ª± ƒë·ªông (c·ª≠a k√©o) th∆∞·ªùng ƒë∆∞·ª£c t·∫°o th√†nh t·ª´ c√°c thanh kim lo·∫°i x·∫øp ch√©o nhau. C√°c h√¨nh t·ª© gi√°c t·∫°o b·ªüi c√°c thanh n√†y khi c·ª≠a chuy·ªÉn ƒë·ªông l√† h√¨nh g√¨?",
    options: [
      "H√¨nh b√¨nh h√†nh",
      "H√¨nh vu√¥ng",
      "H√¨nh thang c√¢n",
      "H√¨nh tam gi√°c"
    ],
    correct: 0 // A
  },
  {
    id: 14,
    level: "V·∫≠n d·ª•ng",
    question: "Cho h√¨nh b√¨nh h√†nh ABCD. G·ªçi E l√† trung ƒëi·ªÉm c·ªßa AB, F l√† trung ƒëi·ªÉm c·ªßa CD. T·ª© gi√°c DEBF l√† h√¨nh g√¨?",
    options: [
      "H√¨nh ch·ªØ nh·∫≠t",
      "H√¨nh b√¨nh h√†nh",
      "H√¨nh thang",
      "H√¨nh thoi"
    ],
    correct: 1 // B (DEBF l√† h√¨nh b√¨nh h√†nh)
  },

  // M·ª©c ƒë·ªô: V·∫≠n d·ª•ng cao (1 c√¢u)
  {
    id: 15,
    level: "V·∫≠n d·ª•ng cao",
    question: "Cho h√¨nh b√¨nh h√†nh ABCD. C√°c tia ph√¢n gi√°c c·ªßa g√≥c A v√† g√≥c D c·∫Øt nhau t·∫°i M, c√°c tia ph√¢n gi√°c c·ªßa g√≥c B v√† g√≥c C c·∫Øt nhau t·∫°i N. Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng v·ªÅ MN v√† c√°c c·∫°nh c·ªßa h√¨nh b√¨nh h√†nh?",
    options: [
      "MN vu√¥ng g√≥c v·ªõi AB",
      "MN vu√¥ng g√≥c v·ªõi BC",
      "MN song song v·ªõi AB v√† CD",
      "MN tr√πng v·ªõi AD"
    ],
    correct: 2 // C (MN // AB, CD)
  }
];

// --- √ÇM THANH (Web Audio API) ---
const playSound = (type) => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;
  const ctx = new AudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const now = ctx.currentTime;

  if (type === 'correct') {
    // √Çm thanh huy·ªÅn b√≠, chi·∫øn th·∫Øng (Major chord arpeggio)
    osc.type = 'sine';
    osc.frequency.setValueAtTime(440, now); // A4
    osc.frequency.setValueAtTime(554.37, now + 0.1); // C#5
    osc.frequency.setValueAtTime(659.25, now + 0.2); // E5
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
    osc.start(now);
    osc.stop(now + 0.6);
  } else if (type === 'wrong') {
    // √Çm thanh v·ª° v·ª•n (Low dissonance)
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(100, now);
    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
    gain.gain.setValueAtTime(0.2, now);
    gain.gain.linearRampToValueAtTime(0, now + 0.3);
    osc.start(now);
    osc.stop(now + 0.3);
  } else if (type === 'evolve') {
    // √Çm thanh ti·∫øn h√≥a (Sweep up)
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(200, now);
    osc.frequency.exponentialRampToValueAtTime(800, now + 1);
    gain.gain.setValueAtTime(0.1, now);
    gain.gain.linearRampToValueAtTime(0, now + 1);
    osc.start(now);
    osc.stop(now + 1);
  }
};

// --- COMPONENT: PH∆Ø·ª¢NG HO√ÄNG (S·ª≠ d·ª•ng SVG Inline) ---
const PhoenixAvatar = ({ stage }) => {
  // Stage 0: Tr·ª©ng (Egg)
  if (stage === 0) return (
    <div className="relative animate-pulse">
      <svg width="120" height="120" viewBox="0 0 100 100">
        <ellipse cx="50" cy="50" rx="30" ry="40" fill="#fcd34d" stroke="#fbbf24" strokeWidth="3" />
        <path d="M35 40 Q50 60 65 40" stroke="#b45309" strokeWidth="2" fill="none" opacity="0.5" />
      </svg>
      <div className="absolute inset-0 bg-yellow-400 opacity-20 rounded-full blur-xl animate-ping"></div>
    </div>
  );

  // Stage 1: Chim non (Hatchling)
  if (stage === 1) return (
    <div className="relative animate-bounce">
      <svg width="150" height="150" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="30" fill="#f59e0b" />
        <circle cx="40" cy="45" r="5" fill="white" />
        <circle cx="60" cy="45" r="5" fill="white" />
        <circle cx="40" cy="45" r="2" fill="black" />
        <circle cx="60" cy="45" r="2" fill="black" />
        <path d="M45 55 L50 65 L55 55" fill="#b45309" />
        <path d="M20 50 Q10 30 30 40" stroke="#f59e0b" strokeWidth="4" fill="none" />
        <path d="M80 50 Q90 30 70 40" stroke="#f59e0b" strokeWidth="4" fill="none" />
      </svg>
    </div>
  );

  // Stage 2: Ph∆∞·ª£ng Ho√†ng Chi·∫øn Binh (Warrior)
  if (stage === 2) return (
    <div className="relative">
      <svg width="200" height="200" viewBox="0 0 200 200" className="drop-shadow-[0_0_15px_rgba(251,146,60,0.8)]">
        <path d="M100 40 Q60 80 20 60 Q50 100 100 160 Q150 100 180 60 Q140 80 100 40" fill="#ea580c" />
        <path d="M100 40 Q90 30 100 20 Q110 30 100 40" fill="#fbbf24" />
        <circle cx="90" cy="70" r="5" fill="white" />
        <circle cx="110" cy="70" r="5" fill="white" />
        {/* C√°nh l·ª≠a */}
        <path d="M20 60 Q0 20 40 40" fill="#c2410c" className="animate-pulse" />
        <path d="M180 60 Q200 20 160 40" fill="#c2410c" className="animate-pulse" />
      </svg>
    </div>
  );

  // Stage 3: Huy·ªÅn Tho·∫°i (Legend)
  return (
    <div className="relative">
      <div className="absolute inset-0 bg-red-500 blur-2xl opacity-30 animate-pulse"></div>
      <svg width="250" height="250" viewBox="0 0 200 200" className="drop-shadow-[0_0_30px_rgba(220,38,38,1)]">
        <defs>
          <linearGradient id="fireGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor="#fef08a" />
            <stop offset="50%" stopColor="#ef4444" />
            <stop offset="100%" stopColor="#7f1d1d" />
          </linearGradient>
        </defs>
        <path d="M100 180 Q60 120 10 80 Q40 40 100 10 Q160 40 190 80 Q140 120 100 180" fill="url(#fireGrad)" />
        <path d="M10 80 Q-10 20 60 50" fill="#f97316" className="animate-bounce" style={{animationDuration: '2s'}} />
        <path d="M190 80 Q210 20 140 50" fill="#f97316" className="animate-bounce" style={{animationDuration: '2s', animationDelay: '0.1s'}} />
        <circle cx="100" cy="50" r="40" fill="#991b1b" opacity="0.2" />
        <circle cx="85" cy="60" r="8" fill="#fef08a" />
        <circle cx="115" cy="60" r="8" fill="#fef08a" />
      </svg>
      <div className="absolute -top-10 left-1/2 transform -translate-x-1/2">
         <Crown className="w-16 h-16 text-yellow-300 animate-bounce drop-shadow-lg" />
      </div>
    </div>
  );
};

// --- HI·ªÜU ·ª®NG PH√ÅO HOA GI·∫§Y (Confetti) ---
const Confetti = () => {
  return (
    <div className="absolute inset-0 pointer-events-none overflow-hidden z-50">
      {[...Array(30)].map((_, i) => (
        <div
          key={i}
          className="absolute w-2 h-2 rounded-full"
          style={{
            backgroundColor: ['#FFD700', '#FF4500', '#00CED1', '#FF69B4'][i % 4],
            left: `${Math.random() * 100}%`,
            top: `-10px`,
            animation: `fall ${1 + Math.random() * 2}s linear forwards`,
            animationDelay: `${Math.random() * 0.5}s`
          }}
        />
      ))}
      <style>{`
        @keyframes fall {
          to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
      `}</style>
    </div>
  );
};

// --- MAIN COMPONENT ---
export default function LegendReborn() {
  const [gameState, setGameState] = useState('intro'); // intro, playing, end
  const [currentQ, setCurrentQ] = useState(0);
  const [score, setScore] = useState(0);
  const [soundOn, setSoundOn] = useState(true);
  const [showFeedback, setShowFeedback] = useState(null); // 'correct', 'wrong'
  const [evolutionStage, setEvolutionStage] = useState(0); // 0: Egg, 1: Hatchling, 2: Warrior, 3: Legend

  // T√≠nh to√°n giai ƒëo·∫°n ti·∫øn h√≥a d·ª±a tr√™n s·ªë c√¢u ƒë√£ l√†m
  useEffect(() => {
    const progress = currentQ; 
    if (progress < 3) setEvolutionStage(0);
    else if (progress < 8) setEvolutionStage(1);
    else if (progress < 13) setEvolutionStage(2);
    else setEvolutionStage(3);
  }, [currentQ]);

  const handleStart = () => {
    setGameState('playing');
    setCurrentQ(0);
    setScore(0);
    setEvolutionStage(0);
    if (soundOn) playSound('evolve');
  };

  const handleAnswer = (index) => {
    if (showFeedback) return; // Ch·∫∑n click li√™n t·ª•c

    const isCorrect = index === questions[currentQ].correct;
    
    if (isCorrect) {
      setShowFeedback('correct');
      setScore(prev => prev + 10);
      if (soundOn) playSound('correct');
      
      const nextStageQ = currentQ + 1;
      if (nextStageQ === 3 || nextStageQ === 8 || nextStageQ === 13) {
        if (soundOn) setTimeout(() => playSound('evolve'), 500);
      }
    } else {
      setShowFeedback('wrong');
      if (soundOn) playSound('wrong');
    }

    setTimeout(() => {
      setShowFeedback(null);
      if (currentQ < questions.length - 1) {
        setCurrentQ(prev => prev + 1);
      } else {
        setGameState('end');
      }
    }, 2000);
  };

  const restartGame = () => {
    setGameState('intro');
  };

  return (
    <div className="min-h-screen bg-[#1a1a2e] text-white font-sans flex flex-col items-center justify-center relative overflow-hidden">
      
      {/* BACKGROUND EFFECTS */}
      <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/40 via-[#1a1a2e] to-[#0f0f1a] -z-10"></div>
      <div className="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none">
         {[...Array(20)].map((_, i) => (
           <div key={i} className="absolute bg-white rounded-full w-1 h-1 animate-ping" 
                style={{ 
                  top: `${Math.random()*100}%`, 
                  left: `${Math.random()*100}%`, 
                  animationDuration: `${2+Math.random()*3}s` 
                }} 
           />
         ))}
      </div>

      {/* HEADER (Sound Toggle) */}
      <div className="absolute top-4 right-4 z-20">
        <button onClick={() => setSoundOn(!soundOn)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition">
          {soundOn ? <Music size={24} /> : <VolumeX size={24} />}
        </button>
      </div>

      {/* --- INTRO SCREEN --- */}
      {gameState === 'intro' && (
        <div className="text-center z-10 max-w-md px-6 animate-fade-in">
          <div className="mb-8 relative inline-block">
            <div className="absolute inset-0 bg-orange-500 blur-3xl opacity-30 animate-pulse"></div>
            <PhoenixAvatar stage={3} />
          </div>
          <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-600 mb-4 drop-shadow-sm">
            HUY·ªÄN THO·∫†I T√ÅI SINH
          </h1>
          <p className="text-gray-300 mb-8 text-lg">
            To√°n 8 - H√¨nh B√¨nh H√†nh<br/>
            Tr·∫£ l·ªùi ƒë√∫ng ƒë·ªÉ ƒë√°nh th·ª©c Th·∫ßn Th√∫!
          </p>
          <button 
            onClick={handleStart}
            className="group relative px-8 py-4 bg-gradient-to-r from-orange-600 to-red-600 rounded-full text-xl font-bold shadow-lg hover:shadow-orange-500/50 transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-3 mx-auto"
          >
            <Play className="fill-current" /> ƒê√ÅNH TH·ª®C
          </button>
        </div>
      )}

      {/* --- GAME SCREEN --- */}
      {gameState === 'playing' && (
        <div className="w-full max-w-4xl flex flex-col md:flex-row items-center gap-8 p-4 z-10">
          
          {/* C·ªòT TR√ÅI: NH√ÇN V·∫¨T */}
          <div className="flex-1 flex flex-col items-center justify-center min-h-[300px]">
            <div className="relative transition-all duration-1000 transform hover:scale-110">
              <PhoenixAvatar stage={evolutionStage} />
              {showFeedback === 'correct' && <Confetti />}
            </div>
            
            <div className="mt-6 text-center">
              <h3 className="text-2xl font-bold text-orange-400">
                {evolutionStage === 0 ? "Tr·ª©ng Th·∫ßn" : 
                 evolutionStage === 1 ? "Ph∆∞·ª£ng Ho√†ng Non" :
                 evolutionStage === 2 ? "Chi·∫øn Binh L·ª≠a" : "Huy·ªÅn Tho·∫°i T·ªëi Th∆∞·ª£ng"}
              </h3>
              <div className="flex items-center justify-center gap-2 mt-2 text-gray-400">
                <Flame size={16} className={showFeedback === 'correct' ? "text-red-500 animate-bounce" : ""} />
                <span>Linh Kh√≠: {score}</span>
              </div>
              
              {/* Progress Bar */}
              <div className="w-48 h-2 bg-gray-700 rounded-full mt-4 overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-orange-500 to-red-600 transition-all duration-500"
                  style={{ width: `${((currentQ)/questions.length)*100}%` }}
                />
              </div>
              <p className="text-xs text-gray-500 mt-1">C√¢u {currentQ + 1}/15</p>
            </div>
          </div>

          {/* C·ªòT PH·∫¢I: C√ÇU H·ªéI */}
          <div className="flex-[1.5] w-full bg-gray-800/60 backdrop-blur-lg border border-gray-700 p-6 rounded-2xl shadow-2xl relative">
             {/* Badge M·ª©c ƒë·ªô */}
             <span className="absolute -top-3 -right-3 px-3 py-1 bg-blue-600 text-xs font-bold rounded-full uppercase tracking-wider border border-blue-400 shadow-lg">
               {questions[currentQ].level}
             </span>

             <h2 className="text-xl md:text-2xl font-semibold mb-6 leading-relaxed text-gray-100">
               {questions[currentQ].question}
             </h2>

             <div className="grid grid-cols-1 gap-3">
               {questions[currentQ].options.map((opt, idx) => {
                 let btnClass = "p-4 text-left rounded-xl border-2 border-gray-600 bg-gray-800 hover:bg-gray-700 transition-all duration-200 font-medium text-gray-200";
                 
                 if (showFeedback) {
                   if (idx === questions[currentQ].correct) {
                     btnClass = "p-4 text-left rounded-xl border-2 border-green-500 bg-green-900/50 text-green-200 shadow-[0_0_15px_rgba(34,197,94,0.4)]";
                   } else if (showFeedback === 'wrong' && idx !== questions[currentQ].correct) {
                     btnClass = "p-4 text-left rounded-xl border-2 border-gray-700 bg-gray-800 opacity-40";
                   }
                 }

                 return (
                   <button 
                     key={idx}
                     onClick={() => handleAnswer(idx)}
                     disabled={showFeedback !== null}
                     className={btnClass}
                   >
                     <div className="flex justify-between items-center">
                       <span>{opt}</span>
                       {showFeedback === 'correct' && idx === questions[currentQ].correct && <Sparkles className="text-yellow-400 animate-spin" />}
                       {showFeedback === 'correct' && idx === questions[currentQ].correct && <span className="text-2xl ml-2">üòÉ</span>}
                     </div>
                   </button>
                 )
               })}
             </div>

             {showFeedback === 'wrong' && (
               <div className="absolute inset-0 flex items-center justify-center bg-black/40 rounded-2xl pointer-events-none z-20">
                  <div className="bg-red-600 text-white px-6 py-2 rounded-full font-bold animate-shake shadow-lg">
                    Sai m·∫•t r·ªìi! üò¢
                  </div>
               </div>
             )}
          </div>
        </div>
      )}

      {/* --- END SCREEN --- */}
      {gameState === 'end' && (
        <div className="text-center z-10 animate-fade-in-up bg-gray-800/80 p-8 rounded-3xl border border-orange-500/50 backdrop-blur-md shadow-2xl max-w-lg mx-4">
          <div className="mb-6 transform scale-125">
            <PhoenixAvatar stage={3} />
          </div>
          
          <h2 className="text-4xl font-bold text-orange-500 mb-2">HO√ÄN TH√ÄNH S·ª® M·ªÜNH!</h2>
          <p className="text-gray-300 mb-6 text-lg">B·∫°n ƒë√£ t√°i sinh Th·∫ßn Th√∫ th√†nh c√¥ng.</p>
          
          <div className="grid grid-cols-2 gap-4 mb-8">
            <div className="bg-gray-700/50 p-4 rounded-xl border border-gray-600">
              <p className="text-gray-400 text-sm">T·ªïng ƒêi·ªÉm</p>
              <p className="text-3xl font-bold text-white">{score}</p>
            </div>
            <div className="bg-gray-700/50 p-4 rounded-xl border border-gray-600">
               <p className="text-gray-400 text-sm">Danh Hi·ªáu</p>
               <p className="text-xl font-bold text-yellow-400">
                 {score >= 130 ? "Th·∫ßn Tho·∫°i" : score >= 100 ? "ƒê·∫°i T∆∞·ªõng" : "Chi·∫øn Binh"}
               </p>
            </div>
          </div>

          <button 
            onClick={restartGame}
            className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg transition-colors flex items-center justify-center gap-2"
          >
            <RotateCcw size={20} /> CH∆†I L·∫†I
          </button>
        </div>
      )}

      <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-shake {
          animation: shake 0.3s ease-in-out;
        }
      `}</style>
    </div>
  );
}
