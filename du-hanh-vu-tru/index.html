<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Du H√†nh Gi·ªØa C√°c V√¨ Sao - To√°n 9</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #00cec9;
            --accent-color: #fdcb6e;
            --text-color: #ffffff;
            --bg-dark: #0f0f1e;
            --panel-bg: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            animation: starMove 100s linear infinite;
        }

        @keyframes starMove {
            from { background-position: 0 0, 40px 60px, 130px 270px; }
            to { background-position: 550px 550px, 390px 410px, 380px 520px; }
        }

        .container {
            width: 90%;
            max-width: 800px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Screens ch√≠nh (start, game, end) */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* M√†n chuy·ªÉn c·∫£nh gi·ªØa c√°c m√†n ch∆°i */
        .stage-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 50;
            animation: fadeIn 0.5s ease;
        }
        .stage-overlay.active {
            display: flex;
        }

        /* Typography */
        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--secondary-color);
            text-shadow: 0 0 10px var(--secondary-color);
        }

        h2 {
            margin-bottom: 15px;
            font-weight: normal;
        }

        p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 206, 201, 0.5);
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* Game UI */
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .spaceship-marker {
            font-size: 2rem;
            position: absolute;
            top: 15px;
            transition: left 0.5s ease;
            transform: translateX(-50%);
        }

        .question-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            margin-bottom: 25px;
            font-size: 1.3rem;
            border-left: 5px solid var(--accent-color);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .answer-btn.correct {
            background: #00b894;
            border-color: #00b894;
            color: white;
        }

        .answer-btn.wrong {
            background: #d63031;
            border-color: #d63031;
            color: white;
            opacity: 0.6;
        }

        .score-display {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Effects */
        #canvas-confetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .feedback-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .level-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .lvl-1 { background-color: #0984e3; } /* Nh·∫≠n bi·∫øt */
        .lvl-2 { background-color: #00b894; } /* Th√¥ng hi·ªÉu */
        .lvl-3 { background-color: #e17055; } /* V·∫≠n d·ª•ng */
        .lvl-4 { background-color: #d63031; } /* V·∫≠n d·ª•ng cao */

        /* Responsive */
        @media (max-width: 600px) {
            .answers-grid {
                grid-template-columns: 1fr;
            }
            h1 { font-size: 1.8rem; }
            .question-box { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

<canvas id="canvas-confetti"></canvas>

<div class="container">
    <!-- M√†n h√¨nh Ch√†o m·ª´ng -->
    <div id="start-screen" class="screen active">
        <h1>üöÄ Du H√†nh Gi·ªØa C√°c V√¨ Sao</h1>
        <h2>Chuy√™n ƒë·ªÅ: CƒÉn B·∫≠c Hai (To√°n 9)</h2>
        <p>Ch√†o m·ª´ng phi h√†nh gia! H√£y s·ª≠ d·ª•ng ki·∫øn th·ª©c To√°n h·ªçc ƒë·ªÉ ƒëi·ªÅu khi·ªÉn t√†u v≈© tr·ª• v∆∞·ª£t qua 15 th·ª≠ th√°ch.</p>
        <p>S·∫µn s√†ng ch∆∞a?</p>
        <button class="btn" onclick="startGame()">Kh·ªüi H√†nh</button>
    </div>

    <!-- M√†n h√¨nh Game -->
    <div id="game-screen" class="screen">
        <div class="score-display">ƒêi·ªÉm: <span id="score">0</span></div>
        
        <div class="progress-container">
            <div style="position: relative; height: 30px;">
                <div id="spaceship" class="spaceship-marker" style="left: 0%;">üöÄ</div>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Ti√™u ƒë·ªÅ 3 m√†n -->
        <div id="stage-title" style="margin: 8px 0 10px; font-weight: 700; color: var(--accent-color);">
            M√†n 1 ‚Äì Kh·ªüi ƒë·ªông: Nh·∫≠n bi·∫øt
        </div>

        <div id="feedback-area" style="height: 60px; display: flex; align-items: center; justify-content: center;">
            <!-- Feedback icons will appear here -->
        </div>

        <div id="level-indicator" class="level-badge lvl-1">M·ª©c ƒë·ªô: Nh·∫≠n bi·∫øt</div>
        <div class="question-box" id="question-text">
            ƒêang t·∫£i d·ªØ li·ªáu...
        </div>

        <div class="answers-grid" id="answers-container">
            <!-- Answers will be generated here -->
        </div>
    </div>

    <!-- M√†n h√¨nh K·∫øt th√∫c -->
    <div id="end-screen" class="screen">
        <h1>üéâ Nhi·ªám V·ª• Ho√†n Th√†nh!</h1>
        <div class="feedback-icon">üèÜ</div>
        <p>B·∫°n ƒë√£ ho√†n th√†nh chuy·∫øn du h√†nh.</p>
        <h2>T·ªïng ƒëi·ªÉm: <span id="final-score">0</span> / 150</h2>
        <p id="final-message">Tuy·ªát v·ªùi!</p>
        <button class="btn" onclick="restartGame()">Ch∆°i L·∫°i</button>
    </div>

    <!-- M√†n chuy·ªÉn c·∫£nh gi·ªØa c√°c m√†n (1‚Üí2, 2‚Üí3) -->
    <div id="stage-overlay" class="stage-overlay">
        <h1 id="stage-overlay-title">M√†n 2 ‚Äì Kh√°m ph√°: Th√¥ng hi·ªÉu</h1>
        <p id="stage-overlay-text" style="margin-bottom: 25px;">
            B·∫°n ƒë√£ v∆∞·ª£t qua M√†n 1! H√£y ti·∫øp t·ª•c h√†nh tr√¨nh v·ªõi c√°c c√¢u h·ªèi Th√¥ng hi·ªÉu nh√©.
        </p>
        <button id="stage-continue-btn" class="btn">Ti·∫øp t·ª•c</button>
    </div>
</div>

<script>
    // D·ªØ li·ªáu c√¢u h·ªèi - To√°n 9 B√†i 1: CƒÉn b·∫≠c hai
    const questionsData = [
        // --- M·ª©c 1: Nh·∫≠n bi·∫øt (6 c√¢u) ---
        {
            question: "CƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa s·ªë a kh√¥ng √¢m ƒë∆∞·ª£c k√≠ hi·ªáu l√†:",
            answers: ["‚àöa", "-‚àöa", "a¬≤", "a"],
            correct: 0,
            level: "Nh·∫≠n bi·∫øt"
        },
        {
            question: "S·ªë n√†o sau ƒë√¢y kh√¥ng c√≥ cƒÉn b·∫≠c hai?",
            answers: ["0", "1", "-9", "3"],
            correct: 2,
            level: "Nh·∫≠n bi·∫øt"
        },
        {
            question: "CƒÉn b·∫≠c hai c·ªßa s·ªë 36 l√†:",
            answers: ["6", "-6", "6 v√† -6", "36"],
            correct: 2,
            level: "Nh·∫≠n bi·∫øt"
        },
        {
            question: "ƒêi·ªÅu ki·ªán x√°c ƒë·ªãnh c·ªßa ‚àöa l√†:",
            answers: ["a > 0", "a < 0", "a ‚â• 0", "a ‚â† 0"],
            correct: 2,
            level: "Nh·∫≠n bi·∫øt"
        },
        {
            question: "S·ªë 0 c√≥ bao nhi√™u cƒÉn b·∫≠c hai?",
            answers: ["0", "1", "2", "V√¥ s·ªë"],
            correct: 1,
            level: "Nh·∫≠n bi·∫øt"
        },
        {
            question: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒë√∫ng v·ªõi hai s·ªë a, b kh√¥ng √¢m?",
            answers: ["a < b th√¨ ‚àöa < ‚àöb", "a < b th√¨ ‚àöa > ‚àöb", "a > b th√¨ ‚àöa < ‚àöb", "a = b th√¨ ‚àöa > ‚àöb"],
            correct: 0,
            level: "Nh·∫≠n bi·∫øt"
        },

        // --- M·ª©c 2: Th√¥ng hi·ªÉu (5 c√¢u) ---
        {
            question: "T√≠nh gi√° tr·ªã c·ªßa ‚àö0,81:",
            answers: ["0,09", "0,9", "9", "0,81"],
            correct: 1,
            level: "Th√¥ng hi·ªÉu"
        },
        {
            question: "T√¨m x bi·∫øt x¬≤ = 49:",
            answers: ["x = 7", "x = -7", "x = 7 ho·∫∑c x = -7", "x = 49"],
            correct: 2,
            level: "Th√¥ng hi·ªÉu"
        },
        {
            question: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh ‚àö(3)¬≤ l√†:",
            answers: ["3", "-3", "9", "‚àö3"],
            correct: 0,
            level: "Th√¥ng hi·ªÉu"
        },
        {
            question: "So s√°nh 3 v√† ‚àö8:",
            answers: ["3 > ‚àö8", "3 < ‚àö8", "3 = ‚àö8", "Kh√¥ng so s√°nh ƒë∆∞·ª£c"],
            correct: 0,
            level: "Th√¥ng hi·ªÉu"
        },
        {
            question: "Gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c ‚àö16 + ‚àö9 l√†:",
            answers: ["7", "5", "‚àö25", "25"],
            correct: 0,
            level: "Th√¥ng hi·ªÉu"
        },

        // --- M·ª©c 3: V·∫≠n d·ª•ng (3 c√¢u) ---
        {
            question: "T√¨m s·ªë x kh√¥ng √¢m, bi·∫øt ‚àöx = 5:",
            answers: ["x = 5", "x = 10", "x = 25", "x = ‚àö5"],
            correct: 2,
            level: "V·∫≠n d·ª•ng"
        },
        {
            question: "Gi·∫£i ph∆∞∆°ng tr√¨nh ‚àöx < 2 (v·ªõi x ‚â• 0):",
            answers: ["x < 2", "x < 4", "0 ‚â§ x < 2", "0 ‚â§ x < 4"],
            correct: 3,
            level: "V·∫≠n d·ª•ng"
        },
        {
            question: "(Th·ª±c t·∫ø) M·ªôt m·∫£nh v∆∞·ªùn h√¨nh vu√¥ng c√≥ di·ªán t√≠ch 144 m√©t vu√¥ng. H·ªèi ƒë·ªô d√†i c·∫°nh m·∫£nh v∆∞·ªùn l√† bao nhi√™u?",
            answers: ["12 m", "14 m", "72 m", "12 cm"],
            correct: 0,
            level: "V·∫≠n d·ª•ng"
        },

        // --- M·ª©c 4: V·∫≠n d·ª•ng cao (x·∫øp chung v√†o M√†n 3) ---
        {
            question: "T√¨m t·∫•t c·∫£ c√°c s·ªë nguy√™n x tho·∫£ m√£n: cƒÉn b·∫≠c hai s·ªë h·ªçc c·ªßa x nh·ªè h∆°n 3 (bi·∫øt x ‚â• 0).",
            answers: ["x ‚àà {0; 1; 2; 3}", "x ‚àà {1; 2; ...; 8}", "x ‚àà {0; 1; 2; ...; 8}", "x ‚àà {0; 1; ...; 9}"],
            correct: 2,
            level: "V·∫≠n d·ª•ng cao"
        }
    ];

    // Chia 3 m√†n theo index (d·ª±a theo th·ª© t·ª± tr√™n)
    const stageInfo = [
        {   // 0‚Äì5
            name: "M√†n 1 ‚Äì Kh·ªüi ƒë·ªông: Nh·∫≠n bi·∫øt",
            start: 0,
            end: 6
        },
        {   // 6‚Äì10
            name: "M√†n 2 ‚Äì Kh√°m ph√°: Th√¥ng hi·ªÉu",
            start: 6,
            end: 11
        },
        {   // 11‚Äì14
            name: "M√†n 3 ‚Äì Chinh ph·ª•c: V·∫≠n d·ª•ng",
            start: 11,
            end: questionsData.length
        }
    ];

    function getStageIndexByQuestion(qIndex) {
        for (let i = 0; i < stageInfo.length; i++) {
            const s = stageInfo[i];
            if (qIndex >= s.start && qIndex < s.end) return i;
        }
        return stageInfo.length - 1;
    }

    let currentQuestionIndex = 0;
    let score = 0;
    let audioContext = null;

    // --- Audio ---
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playSound(type) {
        if (!audioContext) initAudio();
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);

        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            osc.start();
            osc.stop(audioContext.currentTime + 0.5);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioContext.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioContext.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            osc.start();
            osc.stop(audioContext.currentTime + 0.3);
        } else if (type === 'win') {
            osc.type = 'triangle';
            const now = audioContext.currentTime;
            [440, 554, 659, 880].forEach((freq, i) => {
                const o = audioContext.createOscillator();
                const g = audioContext.createGain();
                o.connect(g);
                g.connect(audioContext.destination);
                o.frequency.value = freq;
                g.gain.setValueAtTime(0.1, now + i * 0.1);
                g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.5);
                o.start(now + i * 0.1);
                o.stop(now + i * 0.1 + 0.5);
            });
        }
    }

    // --- Confetti ---
    const canvas = document.getElementById('canvas-confetti');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function createConfetti() {
        for (let i = 0; i < 50; i++) {
            particles.push({
                x: canvas.width / 2,
                y: canvas.height / 2,
                vx: (Math.random() - 0.5) * 15,
                vy: (Math.random() - 0.5) * 15,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                life: 100
            });
        }
    }

    function updateConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particles.length; i++) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2;
            p.life--;
            p.vx *= 0.95;
            p.vy *= 0.95;
            
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
            ctx.fill();

            if (p.life <= 0) {
                particles.splice(i, 1);
                i--;
            }
        }
        requestAnimationFrame(updateConfetti);
    }
    updateConfetti();

    // --- Game Logic ---

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    function startGame() {
        initAudio();
        score = 0;
        currentQuestionIndex = 0;
        document.getElementById('score').innerText = score;
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('spaceship').style.left = '0%';
        document.getElementById('stage-title').innerText = stageInfo[0].name;

        switchScreen('game-screen');
        loadQuestion();
    }

    function updateStageTitle() {
        const stageIdx = getStageIndexByQuestion(currentQuestionIndex);
        document.getElementById('stage-title').innerText = stageInfo[stageIdx].name;
    }

    function loadQuestion() {
        const qData = questionsData[currentQuestionIndex];
        const questionEl = document.getElementById('question-text');
        const answersEl = document.getElementById('answers-container');
        const feedbackEl = document.getElementById('feedback-area');
        const levelEl = document.getElementById('level-indicator');

        updateStageTitle();

        questionEl.innerText = `C√¢u ${currentQuestionIndex + 1}: ${qData.question}`;
        feedbackEl.innerHTML = '';

        levelEl.innerText = `M·ª©c ƒë·ªô: ${qData.level}`;
        levelEl.className = 'level-badge';
        if (qData.level === "Nh·∫≠n bi·∫øt") levelEl.classList.add('lvl-1');
        else if (qData.level === "Th√¥ng hi·ªÉu") levelEl.classList.add('lvl-2');
        else if (qData.level.includes("V·∫≠n d·ª•ng cao")) levelEl.classList.add('lvl-4');
        else levelEl.classList.add('lvl-3');

        const progressPercent = (currentQuestionIndex / questionsData.length) * 100;
        document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        document.getElementById('spaceship').style.left = `${progressPercent}%`;

        answersEl.innerHTML = '';
        qData.answers.forEach((ans, index) => {
            const btn = document.createElement('div');
            btn.className = 'answer-btn';
            btn.innerText = ans;
            btn.onclick = () => checkAnswer(index, btn);
            answersEl.appendChild(btn);
        });
    }

    function showStageOverlay(newStageIndex) {
        const overlay = document.getElementById('stage-overlay');
        const title = document.getElementById('stage-overlay-title');
        const text = document.getElementById('stage-overlay-text');

        title.textContent = stageInfo[newStageIndex].name;
        if (newStageIndex === 1) {
            text.textContent = "B·∫°n ƒë√£ v∆∞·ª£t qua M√†n 1! Ti·∫øp theo l√† c√°c c√¢u h·ªèi Th√¥ng hi·ªÉu. C·ªë l√™n nh√©!";
        } else if (newStageIndex === 2) {
            text.textContent = "Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh M√†n 2. Gi·ªù l√† nh·ªØng th·ª≠ th√°ch V·∫≠n d·ª•ng v√† V·∫≠n d·ª•ng cao!";
        }

        overlay.classList.add('active');

        document.getElementById('stage-continue-btn').onclick = () => {
            overlay.classList.remove('active');
            loadQuestion();
        };
    }

    function checkAnswer(selectedIndex, btnElement) {
        const buttons = document.querySelectorAll('.answer-btn');
        buttons.forEach(b => b.onclick = null);

        const qData = questionsData[currentQuestionIndex];
        const feedbackEl = document.getElementById('feedback-area');

        if (selectedIndex === qData.correct) {
            btnElement.classList.add('correct');
            score += 10;
            document.getElementById('score').innerText = score;
            playSound('correct');
            feedbackEl.innerHTML = '<span class="feedback-icon">ü§©</span>';
            createConfetti();
        } else {
            btnElement.classList.add('wrong');
            buttons[qData.correct].classList.add('correct');
            playSound('wrong');
            feedbackEl.innerHTML = '<span class="feedback-icon">ü§î</span>';
        }

        setTimeout(() => {
            const prevStage = getStageIndexByQuestion(currentQuestionIndex);
            currentQuestionIndex++;

            if (currentQuestionIndex < questionsData.length) {
                const newStage = getStageIndexByQuestion(currentQuestionIndex);
                if (newStage !== prevStage) {
                    showStageOverlay(newStage);
                } else {
                    loadQuestion();
                }
            } else {
                endGame();
            }
        }, 2000);
    }

    function endGame() {
        switchScreen('end-screen');
        playSound('win');

        document.getElementById('progress-fill').style.width = `100%`;
        document.getElementById('spaceship').style.left = `100%`;

        const finalScore = score;
        document.getElementById('final-score').innerText = finalScore;

        const msgEl = document.getElementById('final-message');
        if (finalScore === 150) {
            msgEl.innerText = "Tuy·ªát ƒë·ªëi! B·∫°n l√† m·ªôt thi√™n t√†i to√°n h·ªçc v≈© tr·ª•! üåü";
        } else if (finalScore >= 120) {
            msgEl.innerText = "R·∫•t t·ªët! Ki·∫øn th·ª©c c·ªßa b·∫°n r·∫•t v·ªØng v√†ng! üöÄ";
        } else if (finalScore >= 80) {
            msgEl.innerText = "Kh√° l·∫Øm! H√£y c·ªë g·∫Øng h∆°n n·ªØa nh√©! ‚ú®";
        } else {
            msgEl.innerText = "ƒê·ª´ng n·∫£n l√≤ng! H√£y √¥n l·∫°i b√†i CƒÉn b·∫≠c hai v√† th·ª≠ l·∫°i nh√©! üìö";
        }

        createConfetti();
        setTimeout(createConfetti, 500);
        setTimeout(createConfetti, 1000);
    }

    function restartGame() {
        startGame();
    }
</script>

</body>
</html>
